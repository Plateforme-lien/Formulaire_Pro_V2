<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Visualisation de zone d'intervention</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#fff;
      --primary:#0ea5a4;
      --primary-dark:#0d8887;
      --muted:#6b7280;
    }
    body{font-family:Inter,Arial,sans-serif;background:var(--bg);margin:0;padding:24px;color:#0f1724;}
    .wrap{max-width:980px;margin:18px auto;}
    .card{background:var(--card);border-radius:16px;padding:32px 36px;box-shadow:0 8px 30px rgba(2,6,23,0.06);}
    h1{font-size:24px;margin:0 0 8px;}
    h2{font-size:17px;margin:0 0 16px;color:var(--muted);}
    label{display:block;margin-top:20px;font-weight:600;}
    select, button, textarea{width:100%;padding:12px;border:2px solid #e6eef6;border-radius:8px;margin-top:8px;}
    button{background:var(--primary);color:#fff;border:none;margin-top:16px;cursor:pointer;font-weight:600;}
    button:hover{background:var(--primary-dark);}
    #map{height:500px;margin-top:15px;border-radius:12px;border:2px solid #e6eef6;}
    .info-box{background:#e6f7f7;padding:16px;border-left:4px solid var(--primary);border-radius:8px;margin-bottom:20px;}
    textarea{min-height:150px;}
  </style>
</head>

<body>

<div class="wrap">
  <div class="card">
    <h1>üó∫Ô∏è Visualisation de votre zone d'intervention</h1>
    <h2>Visualisez les communes couvertes par votre rayon</h2>

    <div class="info-box">
      <strong>üí° Astuce :</strong> Votre commune et votre rayon devraient se remplir automatiquement.
    </div>

    <label for="commune">Commune centrale</label>
    <select id="commune"></select>

    <label for="rayon">Rayon d'intervention (km)</label>
    <select id="rayon">
      <option value="">-- Choisissez un rayon --</option>
      <option value="10">10 km</option>
      <option value="15">15 km</option>
      <option value="20">20 km</option>
      <option value="25">25 km</option>
      <option value="30">30 km</option>
      <option value="40">40 km</option>
      <option value="50">50 km</option>
    </select>

    <button id="afficher">üìç Afficher ma zone</button>

    <div id="map"></div>

    <h3>üìã Communes couvertes</h3>
    <textarea id="liste" placeholder="Elles appara√Ætront ici..."></textarea>
    
    <button class="btn-secondary" onclick="window.close()">‚Üê Retour</button>
  </div>
</div>

<script>
// R√©cup√©ration param√®tres URL
const params = new URLSearchParams(window.location.search);
const depChoisi = params.get("dep");
const communeChoisie = params.get("commune");
const rayonChoisi = params.get("rayon");

// Carte
const map = L.map('map').setView([46.5, 2], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(map);
L.control.scale({position:'bottomleft'}).addTo(map);

let communes = [];

// Charger communes du d√©partement re√ßu
async function chargerCommunes() {
  const select = document.getElementById("commune");
  select.innerHTML = "<option>‚è≥ Chargement...</option>";

  const url = `https://geo.api.gouv.fr/departements/${depChoisi}/communes?fields=nom,centre`;

  const res = await fetch(url);
  communes = await res.json();
  communes.sort((a,b)=>a.nom.localeCompare(b.nom));

  select.innerHTML = '<option value="">-- S√©lectionnez --</option>';
  communes.forEach(c=> {
    const o = document.createElement("option");
    o.value = c.nom; o.textContent = c.nom;
    select.appendChild(o);
  });

  if(communeChoisie) select.value = communeChoisie;
  if(rayonChoisi) document.getElementById("rayon").value = rayonChoisi;

  if(communeChoisie && rayonChoisi) {
    setTimeout(()=>document.getElementById("afficher").click(), 400);
  }
}
chargerCommunes();

// Bouton afficher
document.getElementById("afficher").addEventListener("click", ()=>{
  const nom = document.getElementById("commune").value;
  const rayon = parseFloat(document.getElementById("rayon").value);
  if(!nom || !rayon) return alert("S√©lectionnez une commune & un rayon");

  const centrale = communes.find(c=>c.nom===nom);
  const centre = L.latLng(centrale.centre.coordinates[1], centrale.centre.coordinates[0]);

  map.eachLayer(l=>{ if(l instanceof L.Marker || l instanceof L.Circle) map.removeLayer(l); });

  const cercle = L.circle(centre,{radius:rayon*1000,color:"#0ea5a4",fillColor:"#0ea5a4",fillOpacity:.15}).addTo(map);
  L.marker(centre).addTo(map).bindPopup(nom).openPopup();
  map.fitBounds(cercle.getBounds());

  const zones = communes.filter(c=>{
    const pt=L.latLng(c.centre.coordinates[1],c.centre.coordinates[0]);
    return map.distance(centre,pt)<=rayon*1000 && c.nom!==nom;
  });

  document.getElementById("liste").value =
    `Commune centrale : ${nom}\n`+
    `Rayon : ${rayon} km\n\n`+
    `Communes couvertes (${zones.length}) :\n\n`+
    zones.map(c=>`- ${c.nom}`).join("\n");
});
</script>

</body>
</html>

