<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Visualisation de zone d'intervention</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#fff;
      --primary:#0ea5a4;
      --primary-dark:#0d8887;
      --muted:#6b7280;
      --section-bg:#f9fafb;
    }
    
    body{
      font-family:Inter,Arial,Helvetica,sans-serif;
      background:var(--bg);
      margin:0;
      padding:24px;
      line-height:1.6;
      color:#0f1724;
    }

    .wrap{
      max-width:980px;
      margin:18px auto;
    }
    
    .card{
      background:var(--card);
      border-radius:16px;
      padding:32px 36px;
      box-shadow:0 8px 30px rgba(2,6,23,0.06);
      margin-bottom:24px;
    }
    
    h1{
      margin:0 0 8px;
      font-size:24px;
      color:#0f1724;
    }
    
    h2{
      margin:0 0 16px;
      color:var(--muted);
      font-size:17px;
      font-weight:600;
      line-height:1.6;
    }
    
    h3{
      margin:24px 0 12px;
      font-size:16px;
      font-weight:700;
      color:#0f1724;
    }
    
    p.lead{
      margin:0 0 24px;
      color:var(--muted);
      font-size:15px;
    }
    
    label{
      display:block;
      margin-top:20px;
      font-weight:600;
      color:#0f1724;
      font-size:15px;
    }
    
    label:first-of-type{
      margin-top:0;
    }
    
    select, button, textarea{
      width:100%;
      padding:12px 14px;
      margin-top:8px;
      border:2px solid #e6eef6;
      border-radius:8px;
      font-size:15px;
      transition:border-color 0.2s;
      box-sizing:border-box;
    }
    
    select:focus{
      outline:none;
      border-color:var(--primary);
    }
    
    button{
      background:var(--primary);
      color:#fff;
      border:none;
      margin-top:15px;
      cursor:pointer;
      font-weight:600;
      transition:all 0.2s;
      padding:12px 14px;
      border-radius:8px;
    }
    
    button:hover{
      background:var(--primary-dark);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(14,165,164,0.3);
    }
    
    button:active{
      transform:translateY(0);
    }
    
    .btn-secondary{
      background:#eef2f7;
      color:#0f1724;
      margin-top:20px;
    }
    
    .btn-secondary:hover{
      background:#e1e7ef;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }

    #map{
      height:500px;
      margin-top:15px;
      border-radius:12px;
      overflow:hidden;
      border:2px solid #e6eef6;
    }

    .info-box{
      background:#e6f7f7;
      padding:16px 20px;
      border-left:4px solid var(--primary);
      border-radius:8px;
      margin-bottom:20px;
      color:#0f1724;
    }
    
    .info-box strong{
      color:var(--primary);
    }

    textarea{
      font-family:Arial, sans-serif;
      line-height:1.4;
      min-height:150px;
      max-height:400px;
      resize:vertical;
      overflow-y:auto;
    }

    .leaflet-control-scale{
      z-index:1000 !important;
    }
    
    @media(max-width:768px){
      body{
        padding:16px;
      }
      .card{
        padding:24px 20px;
      }
      h1{
        font-size:20px;
      }
      #map{
        height:400px;
      }
    }
  </style>
</head>

<body>

<div class="wrap">
  <div class="card">
    <h1>üó∫Ô∏è Visualisation de votre zone d'intervention</h1>
    <h2>Identifiez facilement les communes couvertes par votre rayon d'action</h2>

    <div class="info-box">
      <strong>üí° Mode d'emploi :</strong> S√©lectionnez d'abord le d√©partement, puis la commune centrale et votre rayon d'intervention pour visualiser sur la carte toutes les communes que vous pouvez couvrir.
    </div>

    <!-- Nouveau : s√©lection du d√©partement -->
    <label for="departement">D√©partement</label>
    <select id="departement">
      <option value="">‚è≥ Chargement des d√©partements...</option>
    </select>

    <label for="commune">Commune centrale</label>
    <select id="commune">
      <option value="">-- choisissez d'abord le d√©partement --</option>
    </select>

    <label for="rayon">Rayon d'intervention (km)</label>
    <select id="rayon">
      <option value="10">10 km</option>
      <option value="15">15 km</option>
      <option value="20">20 km</option>
      <option value="25">25 km</option>
      <option value="30">30 km</option>
      <option value="40">40 km</option>
      <option value="50">50 km</option>
    </select>

    <button id="afficher">üìç Afficher ma zone d'intervention</button>

    <div id="map"></div>

    <h3>üìã Communes couvertes</h3>
    <textarea id="liste" rows="8" placeholder="Les communes appara√Ætront ici apr√®s avoir cliqu√© sur 'Afficher ma zone d'intervention'"></textarea>
    
    <button class="btn-secondary" onclick="window.close()">‚Üê Retour au questionnaire</button>
  </div>
</div>

<script>
/* ===========================
   Configuration / helpers
   =========================== */
const DEPT_API = "https://geo.api.gouv.fr/departements";
const COMMUNE_API = code => `https://geo.api.gouv.fr/departements/${code}/communes?fields=nom,centre`;

/* DOM */
const departSelect = document.getElementById('departement');
const communeSelect = document.getElementById('commune');
const rayonSelect = document.getElementById('rayon');
const afficherBtn = document.getElementById('afficher');
const listeBox = document.getElementById('liste');

/* Carte Leaflet - vue initiale large France */
const map = L.map('map').setView([46.8, 2.5], 6);

/* Fond de carte */
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '¬© OpenStreetMap'
}).addTo(map);

/* √âchelle */
L.control.scale({
  position: 'bottomleft',
  metric: true,
  imperial: false,
  maxWidth: 200
}).addTo(map);

/* stockage temporaire des communes charg√©es pour le d√©partement choisi */
let communes = [];

/* ===========================
   Charger d√©partements
   =========================== */
async function chargerDepartements(){
  departSelect.innerHTML = '<option value="">‚è≥ Chargement des d√©partements...</option>';
  try {
    const res = await fetch(DEPT_API);
    if(!res.ok) throw new Error("R√©ponse serveur d√©partements non OK");
    const data = await res.json();
    // tri par code (01,02,...)
    data.sort((a,b) => a.code.localeCompare(b.code));
    departSelect.innerHTML = '<option value="">-- S√©lectionnez un d√©partement --</option>';
    data.forEach(dep => {
      const opt = document.createElement('option');
      opt.value = dep.code;
      opt.textContent = `${dep.code} ‚Äî ${dep.nom}`;
      departSelect.appendChild(opt);
    });
  } catch(err){
    console.error("Erreur chargement d√©partements:", err);
    departSelect.innerHTML = '<option value="">Erreur de chargement</option>';
  }
}
chargerDepartements();

/* ===========================
   Lors du changement de d√©partement
   =========================== */
departSelect.addEventListener('change', async (e) => {
  const code = (e.target.value || "").trim();
  communes = [];
  communeSelect.innerHTML = '<option value="">‚è≥ Chargement des communes...</option>';
  listeBox.value = ''; // effacer la liste pr√©c√©dente
  if(!code){
    communeSelect.innerHTML = '<option value="">-- choisissez d\'abord le d√©partement --</option>';
    return;
  }

  try {
    const res = await fetch(COMMUNE_API(code));
    if(!res.ok) throw new Error("R√©ponse serveur communes non OK");
    const data = await res.json();
    // Trier alphab√©tiquement
    data.sort((a,b) => a.nom.localeCompare(b.nom));
    communes = data;

    // remplir le select commune
    communeSelect.innerHTML = '<option value="">-- S√©lectionnez votre commune --</option>';
    communes.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.nom;
      opt.text = c.nom;
      communeSelect.appendChild(opt);
    });

    // Zoomer sur l'√©tendue du d√©partement (approximation via bounding box des communes)
    if(communes.length > 0){
      const lats = communes.map(c => c.centre.coordinates[1]);
      const lngs = communes.map(c => c.centre.coordinates[0]);
      const minLat = Math.min(...lats);
      const maxLat = Math.max(...lats);
      const minLng = Math.min(...lngs);
      const maxLng = Math.max(...lngs);
      const bounds = [[minLat, minLng], [maxLat, maxLng]];
      // Protections au cas o√π bounds seraient invalides
      if(isFinite(minLat) && isFinite(maxLat) && isFinite(minLng) && isFinite(maxLng)) {
        map.fitBounds(bounds, { padding: [40,40] });
      }
    }

  } catch(err){
    console.error("Erreur chargement communes pour le d√©partement", code, err);
    communeSelect.innerHTML = '<option value="">Erreur de chargement</option>';
  }
});

/* ===========================
   Afficher la zone d'intervention
   =========================== */
afficherBtn.addEventListener('click', () => {
  const nomCentrale = communeSelect.value;
  const rayonKm = parseFloat(rayonSelect.value) || 0;

  if(!nomCentrale){
    alert("‚ö†Ô∏è Merci de s√©lectionner une commune centrale");
    return;
  }

  const centrale = communes.find(c => c.nom === nomCentrale);
  if(!centrale || !centrale.centre || !centrale.centre.coordinates){
    alert("‚ùå Commune centrale introuvable ou sans coordonn√©es");
    return;
  }

  const centre = L.latLng(centrale.centre.coordinates[1], centrale.centre.coordinates[0]);

  // Effacer anciens markers/cercle (on garde les tuiles)
  const toRemove = [];
  map.eachLayer(layer => {
    if (layer instanceof L.Marker || layer instanceof L.Circle) {
      toRemove.push(layer);
    }
  });
  toRemove.forEach(l => map.removeLayer(l));

  // Cercle
  const cercle = L.circle(centre, {
    radius: rayonKm * 1000,
    color: "#0ea5a4",
    fillColor: "#0ea5a4",
    fillOpacity: 0.15,
    weight: 2
  }).addTo(map);

  // Marker central
  L.marker(centre, {
    icon: L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    })
  }).addTo(map).bindPopup(`<strong>${nomCentrale}</strong><br><em>Commune centrale</em>`).openPopup();

  // Ajuster la vue pour que tout le cercle soit visible
  try {
    map.fitBounds(cercle.getBounds(), { padding: [30,30] });
  } catch(e) {
    // fallback simple
    map.setView(centre, 12);
  }

  // Communes dans rayon
  const communesDansZone = [];
  communes.forEach(c => {
    if(!c.centre || !c.centre.coordinates) return;
    const pt = L.latLng(c.centre.coordinates[1], c.centre.coordinates[0]);
    const distance = map.distance(centre, pt);
    if(distance <= rayonKm * 1000 && c.nom !== nomCentrale){
      communesDansZone.push(c);
      L.marker(pt).addTo(map).bindPopup(c.nom);
    }
  });

  // Formatage de la liste
  const total = communesDansZone.length + 1;
  const sortedNames = communesDansZone.map(c => c.nom).sort((a,b) => a.localeCompare(b));
  const listeFormattee = `üìç Commune centrale : ${nomCentrale}\n\n` +
    `‚úÖ ${communesDansZone.length} commune(s) suppl√©mentaire(s) couverte(s) :\n\n` +
    sortedNames.map((c,i) => `${i+1}. ${c}`).join("\n") +
    `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìä TOTAL : ${total} commune(s)`;

  listeBox.value = listeFormattee;
});

/* ===========================
   (Optionnel) charger un d√©partement par param√®tre d'URL
   ex: visualisation.html?dep=54&commune=Nancy&rayon=30
   =========================== */
function getQueryParams() {
  const params = {};
  const q = location.search.substring(1);
  if(!q) return params;
  q.split('&').forEach(p => {
    const [k,v] = p.split('=').map(decodeURIComponent);
    if(k) params[k] = v || '';
  });
  return params;
}

(async function initFromParams(){
  const params = getQueryParams();
  // attendre le chargement des d√©partements
  await new Promise(resolve => {
    const check = () => {
      if(departSelectReady()) resolve();
      else setTimeout(check, 150);
    };
    check();
  });

  if(params.dep){
    // s√©lectionne le d√©partement puis force le chargement des communes
    departSelect.value = params.dep;
    departSelect.dispatchEvent(new Event('change'));
    // attendre que les communes soient charg√©es (simple poll)
    const waitComm = () => new Promise(res => {
      const t0 = Date.now();
      const loop = () => {
        if(communes.length > 0) return res();
        if(Date.now() - t0 > 8000) return res(); // timeout 8s
        setTimeout(loop, 150);
      };
      loop();
    });
    await waitComm();
    if(params.commune){
      communeSelect.value = params.commune;
    }
    if(params.rayon){
      rayonSelect.value = params.rayon;
    }
    // si on a assez d'infos on peut afficher directement
    if(communeSelect.value) {
      // l√©g√®re attente pour laisser le rendu se faire
      setTimeout(() => afficherBtn.click(), 300);
    }
  }

  function departSelectReady(){
    return departSelect && departSelect.options && departSelect.options.length > 1;
  }
})();
</script>

</body>
</html>

