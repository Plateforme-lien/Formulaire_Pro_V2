<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Visualisation de zone d'intervention</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#fff;
      --primary:#0ea5a4;
      --primary-dark:#0d8887;
      --muted:#6b7280;
      --section-bg:#f9fafb;
    }
    
    body{
      font-family:Inter,Arial,Helvetica,sans-serif;
      background:var(--bg);
      margin:0;
      padding:24px;
      line-height:1.6;
      color:#0f1724;
    }

    .wrap{
      max-width:980px;
      margin:18px auto;
    }
    
    .card{
      background:var(--card);
      border-radius:16px;
      padding:32px 36px;
      box-shadow:0 8px 30px rgba(2,6,23,0.06);
      margin-bottom:24px;
    }
    
    h1{
      margin:0 0 8px;
      font-size:24px;
      color:#0f1724;
    }
    
    h2{
      margin:0 0 16px;
      color:var(--muted);
      font-size:17px;
      font-weight:600;
      line-height:1.6;
    }
    
    h3{
      margin:24px 0 12px;
      font-size:16px;
      font-weight:700;
      color:#0f1724;
    }
    
    label{
      display:block;
      margin-top:20px;
      font-weight:600;
      color:#0f1724;
      font-size:15px;
    }

    select, button, textarea{
      width:100%;
      padding:12px 14px;
      margin-top:8px;
      border:2px solid #e6eef6;
      border-radius:8px;
      font-size:15px;
      transition:border-color 0.2s;
      box-sizing:border-box;
    }

    select:focus{
      outline:none;
      border-color:var(--primary);
    }

    button{
      background:var(--primary);
      color:#fff;
      border:none;
      margin-top:15px;
      cursor:pointer;
      font-weight:600;
      transition:all 0.2s;
      padding:12px 14px;
      border-radius:8px;
    }

    button:hover{
      background:var(--primary-dark);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(14,165,164,0.3);
    }

    .btn-secondary{
      background:#eef2f7;
      color:#0f1724;
      margin-top:20px;
    }

    .btn-secondary:hover{
      background:#e1e7ef;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }

    #map{
      height:500px;
      margin-top:15px;
      border-radius:12px;
      overflow:hidden;
      border:2px solid #e6eef6;
    }

    .info-box{
      background:#e6f7f7;
      padding:16px 20px;
      border-left:4px solid var(--primary);
      border-radius:8px;
      margin-bottom:20px;
      color:#0f1724;
    }

    .info-box strong{
      color:var(--primary);
    }

    textarea{
      font-family:Arial, sans-serif;
      line-height:1.4;
      min-height:150px;
      resize:vertical;
      overflow-y:auto;
    }

    @media(max-width:768px){
      body{ padding:16px; }
      .card{ padding:24px 20px; }
      h1{ font-size:20px; }
      #map{ height:400px; }
    }
  </style>
</head>

<body>

<div class="wrap">
  <div class="card">
    <h1>üó∫Ô∏è Visualisation de votre zone d'intervention</h1>
    <h2>Identifiez facilement les communes couvertes par votre rayon d'action</h2>

    <div class="info-box">
      <strong>üí° Mode d'emploi :</strong> S√©lectionnez d'abord le d√©partement, puis la commune centrale et votre rayon d'intervention pour visualiser sur la carte toutes les communes couvertes.
    </div>

    <label for="departement">D√©partement</label>
    <select id="departement">
      <option value="">‚è≥ Chargement des d√©partements...</option>
    </select>

    <label for="commune">Commune centrale</label>
    <select id="commune">
      <option value="">-- choisissez d'abord le d√©partement --</option>
    </select>

    <label for="rayon">Rayon d'intervention (km)</label>
    <select id="rayon">
      <option value="10">10 km</option>
      <option value="15">15 km</option>
      <option value="20">20 km</option>
      <option value="25">25 km</option>
      <option value="30">30 km</option>
      <option value="40">40 km</option>
      <option value="50">50 km</option>
    </select>

    <button id="afficher">üìç Afficher ma zone d'intervention</button>

    <div id="map"></div>

    <h3>üìã Communes couvertes</h3>
    <textarea id="liste" rows="8" placeholder="Les communes appara√Ætront ici apr√®s avoir cliqu√© sur 'Afficher ma zone d'intervention'"></textarea>
    
    <button class="btn-secondary" onclick="window.close()">‚Üê Retour au questionnaire</button>
  </div>
</div>

<script>
// ==========================
//  CONFIGURATION / INIT
// ==========================
const DEPT_API = "https://geo.api.gouv.fr/departements";
const COMMUNE_API = code => `https://geo.api.gouv.fr/departements/${code}/communes?fields=nom,centre`;

const departSelect = document.getElementById('departement');
const communeSelect = document.getElementById('commune');
const rayonSelect = document.getElementById('rayon');
const afficherBtn = document.getElementById('afficher');
const listeBox = document.getElementById('liste');

const map = L.map('map').setView([46.8, 2.5], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '¬© OpenStreetMap'
}).addTo(map);
L.control.scale({ position: 'bottomleft', metric: true }).addTo(map);

let communes = [];

// ==========================
//  CHARGEMENT DES D√âPARTEMENTS
// ==========================
async function chargerDepartements(){
  departSelect.innerHTML = '<option value="">‚è≥ Chargement des d√©partements...</option>';
  try {
    const res = await fetch(DEPT_API);
    const data = await res.json();
    data.sort((a,b) => a.code.localeCompare(b.code));
    departSelect.innerHTML = '<option value="">-- S√©lectionnez un d√©partement --</option>';
    data.forEach(dep => {
      const opt = document.createElement('option');
      opt.value = dep.code;
      opt.textContent = `${dep.code} ‚Äî ${dep.nom}`;
      departSelect.appendChild(opt);
    });
  } catch {
    departSelect.innerHTML = '<option value="">Erreur de chargement</option>';
  }
}
chargerDepartements();

// ==========================
//  CHARGEMENT DES COMMUNES
// ==========================
departSelect.addEventListener('change', async e => {
  const code = e.target.value;
  communes = [];
  communeSelect.innerHTML = '<option>‚è≥ Chargement des communes...</option>';
  if(!code) return;

  try {
    const res = await fetch(COMMUNE_API(code));
    const data = await res.json();
    communes = data.sort((a,b) => a.nom.localeCompare(b.nom));
    communeSelect.innerHTML = '<option value="">-- S√©lectionnez votre commune --</option>';
    communes.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.nom;
      opt.text = c.nom;
      communeSelect.appendChild(opt);
    });

    // Zoom sur le d√©partement
    const lats = communes.map(c => c.centre.coordinates[1]);
    const lngs = communes.map(c => c.centre.coordinates[0]);
    const bounds = [[Math.min(...lats), Math.min(...lngs)], [Math.max(...lats), Math.max(...lngs)]];
    map.fitBounds(bounds, { padding: [30,30] });

  } catch {
    communeSelect.innerHTML = '<option value="">Erreur chargement</option>';
  }
});

// ==========================
//  AFFICHER LA ZONE D'INTERVENTION
// ==========================
afficherBtn.addEventListener('click', () => {
  const nomCentrale = communeSelect.value;
  const rayonKm = parseFloat(rayonSelect.value);
  if(!nomCentrale) return alert("‚ö†Ô∏è S√©lectionnez une commune centrale");

  const centrale = communes.find(c => c.nom === nomCentrale);
  if(!centrale) return alert("‚ùå Commune introuvable");

  const centre = L.latLng(centrale.centre.coordinates[1], centrale.centre.coordinates[0]);

  // Nettoyage ancien affichage
  map.eachLayer(layer => {
    if (layer instanceof L.Marker || layer instanceof L.Circle) map.removeLayer(layer);
  });

  // Cercle
  const cercle = L.circle(centre, {
    radius: rayonKm * 1000,
    color: "#0ea5a4",
    fillColor: "#0ea5a4",
    fillOpacity: 0.15,
    weight: 2
  }).addTo(map);

  // Marker central
  L.marker(centre).addTo(map)
    .bindPopup(`<strong>${nomCentrale}</strong><br><em>Commune centrale</em>`).openPopup();

  // Ajuster la vue pour montrer tout le cercle (avec marge)
  map.fitBounds(cercle.getBounds(), { padding: [50, 50] });

  // Communes dans le rayon
  const dansRayon = communes.filter(c => {
    const pt = L.latLng(c.centre.coordinates[1], c.centre.coordinates[0]);
    return map.distance(centre, pt) <= rayonKm * 1000 && c.nom !== nomCentrale;
  });

  dansRayon.forEach(c => {
    const pt = L.latLng(c.centre.coordinates[1], c.centre.coordinates[0]);
    L.marker(pt).addTo(map).bindPopup(c.nom);
  });

  // Liste
  const total = dansRayon.length + 1;
  listeBox.value = `üìç Commune centrale : ${nomCentrale}\n\n` +
    `‚úÖ ${dansRayon.length} commune(s) suppl√©mentaire(s) :\n\n` +
    dansRayon.map((c,i)=>`${i+1}. ${c.nom}`).join("\n") +
    `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìä TOTAL : ${total} commune(s)`;
});

// ==========================
//  PARAM√àTRES D'URL (pr√©-remplissage)
// ==========================
function getParams(){
  return Object.fromEntries(new URLSearchParams(location.search));
}

(async function initFromParams(){
  const p = getParams();
  if(!p.dep) return;

  // attendre d√©partements
  await new Promise(r => {
    const i = setInterval(()=>{
      if(departSelect.options.length>1){ clearInterval(i); r(); }
    },100);
  });

  departSelect.value = p.dep;
  departSelect.dispatchEvent(new Event('change'));

  // attendre communes
  await new Promise(r => {
    const i = setInterval(()=>{
      if(communes.length>0){ clearInterval(i); r(); }
    },150);
  });

  if(p.commune) communeSelect.value = p.commune;

  if(p.rayon){
    const match = p.rayon.match(/\d+/);
    if(match) rayonSelect.value = match[0];
  }

  if(p.commune) setTimeout(()=>afficherBtn.click(),300);
})();
</script>

</body>
</html>


