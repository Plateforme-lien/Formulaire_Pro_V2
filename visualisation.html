<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Visualisation de zone d'intervention</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#fff;
      --primary:#0ea5a4;
      --primary-dark:#0d8887;
      --muted:#6b7280;
      --section-bg:#f9fafb;
    }
    
    body{
      font-family:Inter,Arial,Helvetica,sans-serif;
      background:var(--bg);
      margin:0;
      padding:24px;
      line-height:1.6;
      color:#0f1724;
    }

    .wrap{
      max-width:980px;
      margin:18px auto;
    }
    
    .card{
      background:var(--card);
      border-radius:16px;
      padding:32px 36px;
      box-shadow:0 8px 30px rgba(2,6,23,0.06);
      margin-bottom:24px;
    }
    
    h1{
      margin:0 0 8px;
      font-size:24px;
      color:#0f1724;
    }
    
    h2{
      margin:0 0 16px;
      color:var(--muted);
      font-size:17px;
      font-weight:600;
      line-height:1.6;
    }
    
    h3{
      margin:24px 0 12px;
      font-size:16px;
      font-weight:700;
      color:#0f1724;
    }
    
    label{
      display:block;
      margin-top:20px;
      font-weight:600;
      color:#0f1724;
      font-size:15px;
    }

    select, button, textarea{
      width:100%;
      padding:12px 14px;
      margin-top:8px;
      border:2px solid #e6eef6;
      border-radius:8px;
      font-size:15px;
      transition:border-color 0.2s;
      box-sizing:border-box;
    }

    select:focus{
      outline:none;
      border-color:var(--primary);
    }

    button{
      background:var(--primary);
      color:#fff;
      border:none;
      margin-top:15px;
      cursor:pointer;
      font-weight:600;
      transition:all 0.2s;
      padding:12px 14px;
      border-radius:8px;
    }

    button:hover{
      background:var(--primary-dark);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(14,165,164,0.3);
    }

    .btn-secondary{
      background:#eef2f7;
      color:#0f1724;
      margin-top:20px;
    }

    .btn-secondary:hover{
      background:#e1e7ef;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }

    #map{
      height:500px;
      margin-top:15px;
      border-radius:12px;
      overflow:hidden;
      border:2px solid #e6eef6;
    }

    .info-box{
      background:#e6f7f7;
      padding:16px 20px;
      border-left:4px solid var(--primary);
      border-radius:8px;
      margin-bottom:20px;
      color:#0f1724;
    }

    .info-box strong{
      color:var(--primary);
    }

    textarea{
      font-family:Arial, sans-serif;
      line-height:1.4;
      min-height:150px;
      resize:vertical;
      overflow-y:auto;
    }

    .loading{
      text-align:center;
      padding:20px;
      color:var(--muted);
      font-style:italic;
    }

    .error-box{
      background:#fee;
      border-left:4px solid #dc2626;
      padding:16px 20px;
      border-radius:8px;
      margin-bottom:20px;
      color:#dc2626;
    }

    @media(max-width:768px){
      body{ padding:16px; }
      .card{ padding:24px 20px; }
      h1{ font-size:20px; }
      #map{ height:400px; }
    }
  </style>
</head>

<body>

<div class="wrap">
  <div class="card">
    <h1>üó∫Ô∏è Visualisation de votre zone d'intervention</h1>
    <h2>Identifiez facilement les communes couvertes par votre zone d'action</h2>

    <div class="info-box">
      <strong>üí° Mode d'emploi :</strong> S√©lectionnez le d√©partement, puis la commune centrale et votre crit√®re (temps de trajet en m√©tropole, rayon en km en Outre-mer).
    </div>

    <label for="departement">D√©partement</label>
    <select id="departement">
      <option value="">‚è≥ Chargement des d√©partements...</option>
    </select>

    <label for="commune">Commune centrale</label>
    <select id="commune">
      <option value="">-- choisissez d'abord le d√©partement --</option>
    </select>

    <div id="critereBlock" style="display:none;">
      <!-- Zone M√©tropole : Temps de trajet -->
      <div id="zoneMetropole" style="display:none;">
        <label for="temps">Temps de trajet maximal (minutes)</label>
        <select id="temps">
          <option value="">-- S√©lectionnez --</option>
          <option value="15">15 min</option>
          <option value="20">20 min</option>
          <option value="30">30 min</option>
          <option value="45">45 min</option>
          <option value="60">60 min</option>
        </select>
      </div>

      <!-- Zone Outre-mer : Rayon en km -->
      <div id="zoneOutreMer" style="display:none;">
        <label for="rayon">Rayon d'intervention (km)</label>
<select id="rayon">
  <option value="">-- S√©lectionnez --</option>
  <option value="10">10 km</option>
  <option value="15">15 km</option>
  <option value="20">20 km</option>
  <option value="25">25 km</option>
  <option value="30">30 km</option>
  <option value="40">40 km</option>
  <option value="50">50 km</option>
  <option value="Tout mon d√©partement">Tout mon d√©partement</option>
</select>
      </div>
    </div>

    <button id="afficher">üìç Afficher ma zone d'intervention</button>

    <div id="loadingMsg" class="loading" style="display:none;">
      ‚è≥ Calcul de la zone en cours...
    </div>

    <div id="errorMsg" class="error-box" style="display:none;"></div>

    <div id="map"></div>

    <h3>üìã Communes couvertes</h3>
    <textarea id="liste" rows="8" placeholder="Les communes appara√Ætront ici apr√®s avoir cliqu√© sur 'Afficher ma zone d'intervention'"></textarea>
    
    <button class="btn-secondary" onclick="window.close()">‚Üê Retour au questionnaire</button>
  </div>
</div>

<script>
// ==========================
//  CONFIGURATION
// ==========================
const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImYyNjcyNmMzZTU3YTQyNzk4Y2UxYzMxZmQ2YTZhYzZjIiwiaCI6Im11cm11cjY0In0=';
const DEPT_API = "https://geo.api.gouv.fr/departements";
const COMMUNE_API = code => `https://geo.api.gouv.fr/departements/${code}/communes?fields=nom,centre`;

const DEPS_METRO = ['01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','21','22','23','24','25','26','27','28','29','2A','2B','30','31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46','47','48','49','50','51','52','53','54','55','56','57','58','59','60','61','62','63','64','65','66','67','68','69','70','71','72','73','74','75','76','77','78','79','80','81','82','83','84','85','86','87','88','89','90','91','92','93','94','95'];
const DEPS_DOMTOM = ['971','972','973','974','976'];

const departSelect = document.getElementById('departement');
const communeSelect = document.getElementById('commune');
const tempsSelect = document.getElementById('temps');
const rayonSelect = document.getElementById('rayon');
const afficherBtn = document.getElementById('afficher');
const listeBox = document.getElementById('liste');
const loadingMsg = document.getElementById('loadingMsg');
const errorMsg = document.getElementById('errorMsg');

const map = L.map('map').setView([46.8, 2.5], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '¬© OpenStreetMap'
}).addTo(map);
L.control.scale({ position: 'bottomleft', metric: true }).addTo(map);

let communes = [];
let currentDeptCode = null;

// ==========================
//  CHARGEMENT DES D√âPARTEMENTS
// ==========================
async function chargerDepartements(){
  departSelect.innerHTML = '<option value="">‚è≥ Chargement des d√©partements...</option>';
  try {
    const res = await fetch(DEPT_API);
    const data = await res.json();
    data.sort((a,b) => a.code.localeCompare(b.code));
    departSelect.innerHTML = '<option value="">-- S√©lectionnez un d√©partement --</option>';
    data.forEach(dep => {
      const opt = document.createElement('option');
      opt.value = dep.code;
      opt.textContent = `${dep.code} ‚Äî ${dep.nom}`;
      departSelect.appendChild(opt);
    });
  } catch {
    departSelect.innerHTML = '<option value="">Erreur de chargement</option>';
  }
}
chargerDepartements();

// ==========================
//  CHARGEMENT DES COMMUNES
// ==========================
departSelect.addEventListener('change', async e => {
  const code = e.target.value;
  currentDeptCode = code;
  communes = [];
  communeSelect.innerHTML = '<option>‚è≥ Chargement des communes...</option>';
  
  document.getElementById('critereBlock').style.display = 'none';
  document.getElementById('zoneMetropole').style.display = 'none';
  document.getElementById('zoneOutreMer').style.display = 'none';
  
  if(!code) return;

  try {
    const res = await fetch(COMMUNE_API(code));
    const data = await res.json();
    communes = data.sort((a,b) => a.nom.localeCompare(b.nom));
    communeSelect.innerHTML = '<option value="">-- S√©lectionnez votre commune --</option>';
    communes.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.nom;
      opt.text = c.nom;
      communeSelect.appendChild(opt);
    });

    // Afficher le bon crit√®re selon le d√©partement
    document.getElementById('critereBlock').style.display = 'block';
    
    if (DEPS_METRO.includes(code)) {
      document.getElementById('zoneMetropole').style.display = 'block';
      document.getElementById('zoneOutreMer').style.display = 'none';
    } else if (DEPS_DOMTOM.includes(code)) {
      document.getElementById('zoneMetropole').style.display = 'none';
      document.getElementById('zoneOutreMer').style.display = 'block';
    }

    // Zoom sur le d√©partement
    const lats = communes.map(c => c.centre.coordinates[1]);
    const lngs = communes.map(c => c.centre.coordinates[0]);
    const bounds = [[Math.min(...lats), Math.min(...lngs)], [Math.max(...lats), Math.max(...lngs)]];
    map.fitBounds(bounds, { padding: [30,30] });

  } catch {
    communeSelect.innerHTML = '<option value="">Erreur chargement</option>';
  }
});

// ==========================
//  CALCUL ISOCHRONE (M√©tropole)
// ==========================
async function calculerIsochrone(lon, lat, minutes) {
  const url = `https://api.openrouteservice.org/v2/isochrones/driving-car`;
  
  const body = {
    locations: [[lon, lat]],
    range: [minutes * 60], // Convertir minutes en secondes
    range_type: 'time'
  };

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Authorization': ORS_API_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Erreur API ORS:', errorText);
      throw new Error(`Erreur API: ${response.status}`);
    }

    const data = await response.json();
    return data.features[0].geometry.coordinates[0];
    
  } catch (error) {
    console.error('Erreur calcul isochrone:', error);
    throw error;
  }
}

// ==========================
//  AFFICHER LA ZONE D'INTERVENTION
// ==========================
afficherBtn.addEventListener('click', async () => {
  const nomCentrale = communeSelect.value;
  
  if(!nomCentrale) {
    alert("‚ö†Ô∏è S√©lectionnez une commune centrale");
    return;
  }

  const centrale = communes.find(c => c.nom === nomCentrale);
  if(!centrale) {
    alert("‚ùå Commune introuvable");
    return;
  }

  const centre = L.latLng(centrale.centre.coordinates[1], centrale.centre.coordinates[0]);
  const lon = centrale.centre.coordinates[0];
  const lat = centrale.centre.coordinates[1];

  // Nettoyage ancien affichage
  map.eachLayer(layer => {
    if (layer instanceof L.Marker || layer instanceof L.Circle || layer instanceof L.Polygon) {
      map.removeLayer(layer);
    }
  });

  loadingMsg.style.display = 'block';
  errorMsg.style.display = 'none';
  listeBox.value = '';

  try {
    let dansZone = [];

    if (DEPS_METRO.includes(currentDeptCode)) {
      // ===== M√âTROPOLE : ISOCHRONE =====
      const minutes = parseInt(tempsSelect.value);
      
      if (!minutes) {
        alert("‚ö†Ô∏è S√©lectionnez un temps de trajet");
        loadingMsg.style.display = 'none';
        return;
      }

      // Calculer l'isochrone
      const isochroneCoords = await calculerIsochrone(lon, lat, minutes);
      
      // Convertir les coordonn√©es [lon, lat] en [lat, lon] pour Leaflet
      const polygonCoords = isochroneCoords.map(coord => [coord[1], coord[0]]);
      
      // Afficher le polygone
      const polygon = L.polygon(polygonCoords, {
        color: "#0ea5a4",
        fillColor: "#0ea5a4",
        fillOpacity: 0.15,
        weight: 2
      }).addTo(map);

      // Marker central
      L.marker(centre).addTo(map)
        .bindPopup(`<strong>${nomCentrale}</strong><br><em>Commune centrale</em>`).openPopup();

      // Ajuster la vue
      map.fitBounds(polygon.getBounds(), { padding: [50, 50] });

      // Trouver les communes dans la zone
      communes.forEach(c => {
        if (c.nom === nomCentrale) return; // Skip commune centrale
        
        const pt = L.latLng(c.centre.coordinates[1], c.centre.coordinates[0]);
        
        // V√©rifier si le point est dans le polygone
        if (polygon.getBounds().contains(pt)) {
          // V√©rification plus pr√©cise avec ray casting
          if (isPointInPolygon(pt, polygonCoords)) {
            dansZone.push(c);
            L.marker(pt).addTo(map).bindPopup(c.nom);
          }
        }
      });

      // Liste
      const total = dansZone.length + 1;
      listeBox.value = `üìç Commune centrale : ${nomCentrale}\n\n` +
        `‚úÖ ${dansZone.length} commune(s) accessible(s) en ${minutes} minutes :\n\n` +
        dansZone.map((c,i)=>`${i+1}. ${c.nom}`).join("\n") +
        `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìä TOTAL : ${total} commune(s)`;


      } else if (DEPS_DOMTOM.includes(currentDeptCode)) {
  // ===== OUTRE-MER : RAYON EN KM =====
  const rayonValue = rayonSelect.value;
  
  if (!rayonValue) {
    alert("‚ö†Ô∏è S√©lectionnez un rayon");
    loadingMsg.style.display = 'none';
    return;
  }

  if (rayonValue === "Tout mon d√©partement") {
    // Afficher toutes les communes du d√©partement
    dansZone = communes.filter(c => c.nom !== nomCentrale);

    dansZone.forEach(c => {
      const pt = L.latLng(c.centre.coordinates[1], c.centre.coordinates[0]);
      L.marker(pt).addTo(map).bindPopup(c.nom);
    });

    // Marker central
    L.marker(centre).addTo(map)
      .bindPopup(`<strong>${nomCentrale}</strong><br><em>Commune centrale</em>`).openPopup();

    // Ajuster la vue sur tout le d√©partement
    const lats = communes.map(c => c.centre.coordinates[1]);
    const lngs = communes.map(c => c.centre.coordinates[0]);
    const bounds = [[Math.min(...lats), Math.min(...lngs)], [Math.max(...lats), Math.max(...lngs)]];
    map.fitBounds(bounds, { padding: [50, 50] });

    // Liste
    const total = dansZone.length + 1;
    listeBox.value = `üìç Commune centrale : ${nomCentrale}\n\n` +
      `‚úÖ ${dansZone.length} commune(s) dans tout le d√©partement :\n\n` +
      dansZone.map((c,i)=>`${i+1}. ${c.nom}`).join("\n") +
      `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìä TOTAL : ${total} commune(s)`;

  } else {
    // Rayon en km normal
    const rayonKm = parseFloat(rayonValue);

      // Cercle
      const cercle = L.circle(centre, {
        radius: rayonKm * 1000,
        color: "#0ea5a4",
        fillColor: "#0ea5a4",
        fillOpacity: 0.15,
        weight: 2
      }).addTo(map);

      // Marker central
      L.marker(centre).addTo(map)
        .bindPopup(`<strong>${nomCentrale}</strong><br><em>Commune centrale</em>`).openPopup();

      // Ajuster la vue
      map.fitBounds(cercle.getBounds(), { padding: [50, 50] });

      // Communes dans le rayon
      dansZone = communes.filter(c => {
        const pt = L.latLng(c.centre.coordinates[1], c.centre.coordinates[0]);
        return map.distance(centre, pt) <= rayonKm * 1000 && c.nom !== nomCentrale;
      });

      dansZone.forEach(c => {
        const pt = L.latLng(c.centre.coordinates[1], c.centre.coordinates[0]);
        L.marker(pt).addTo(map).bindPopup(c.nom);
      });

      // Liste
      const total = dansZone.length + 1;
      listeBox.value = `üìç Commune centrale : ${nomCentrale}\n\n` +
        `‚úÖ ${dansZone.length} commune(s) dans un rayon de ${rayonKm} km :\n\n` +
        dansZone.map((c,i)=>`${i+1}. ${c.nom}`).join("\n") +
        `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìä TOTAL : ${total} commune(s)`;
    }

    loadingMsg.style.display = 'none';

  } catch (error) {
    console.error('Erreur:', error);
    loadingMsg.style.display = 'none';
    errorMsg.style.display = 'block';
    errorMsg.textContent = `‚ùå Erreur lors du calcul de la zone : ${error.message}. V√©rifiez votre connexion et r√©essayez.`;
  }
});

// ==========================
//  HELPER : Point dans polygone (Ray Casting)
// ==========================
function isPointInPolygon(point, polygon) {
  const x = point.lat;
  const y = point.lng;
  let inside = false;

  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i][0], yi = polygon[i][1];
    const xj = polygon[j][0], yj = polygon[j][1];

    const intersect = ((yi > y) !== (yj > y)) &&
      (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
    
    if (intersect) inside = !inside;
  }

  return inside;
}

// ==========================
//  PARAM√àTRES D'URL (pr√©-remplissage)
// ==========================
function getParams(){
  return Object.fromEntries(new URLSearchParams(location.search));
}

(async function initFromParams(){
  const p = getParams();
  if(!p.dep) return;

  // attendre d√©partements
  await new Promise(r => {
    const i = setInterval(()=>{
      if(departSelect.options.length>1){ clearInterval(i); r(); }
    },100);
  });

  departSelect.value = p.dep;
  departSelect.dispatchEvent(new Event('change'));

  // attendre communes
  await new Promise(r => {
    const i = setInterval(()=>{
      if(communes.length>0){ clearInterval(i); r(); }
    },150);
  });

  if(p.commune) communeSelect.value = p.commune;

  // Pr√©-remplir le crit√®re
 if(p.rayonOuTemps) {
    const valeur = p.rayonOuTemps;
    
    if (DEPS_METRO.includes(p.dep)) {
      // Extraire les minutes (ex: "30 min" ‚Üí 30)
      const match = valeur.match(/\d+/);
      if(match) tempsSelect.value = match[0];
    } else if (DEPS_DOMTOM.includes(p.dep)) {
      // Extraire les km (ex: "15 km" ‚Üí 15) ou garder "Tout mon d√©partement"
      if (valeur.includes('d√©partement')) {
        rayonSelect.value = 'Tout mon d√©partement';
      } else {
        const match = valeur.match(/\d+/);
        if(match) rayonSelect.value = match[0];
      }
    }
  }

  if(p.commune) setTimeout(()=>afficherBtn.click(),500);
})();
</script>
</body>
</html>


