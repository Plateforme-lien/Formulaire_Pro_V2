<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Visualisation de zone d'intervention</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#fff;
      --primary:#0ea5a4;
      --primary-dark:#0d8887;
      --muted:#6b7280;
      --section-bg:#f9fafb;
    }
    
    body{
      font-family:Inter,Arial,Helvetica,sans-serif;
      background:var(--bg);
      margin:0;
      padding:24px;
      line-height:1.6;
      color:#0f1724;
    }

    .wrap{
      max-width:980px;
      margin:18px auto;
    }
    
    .card{
      background:var(--card);
      border-radius:16px;
      padding:32px 36px;
      box-shadow:0 8px 30px rgba(2,6,23,0.06);
      margin-bottom:24px;
    }
    
    h1{
      margin:0 0 8px;
      font-size:24px;
      color:#0f1724;
    }
    
    h2{
      margin:0 0 16px;
      color:var(--muted);
      font-size:17px;
      font-weight:600;
      line-height:1.6;
    }
    
    h3{
      margin:24px 0 12px;
      font-size:16px;
      font-weight:700;
      color:#0f1724;
    }
    
    label{
      display:block;
      margin-top:20px;
      font-weight:600;
      color:#0f1724;
      font-size:15px;
    }

    select, button, textarea{
      width:100%;
      padding:12px 14px;
      margin-top:8px;
      border:2px solid #e6eef6;
      border-radius:8px;
      font-size:15px;
      transition:border-color 0.2s;
      box-sizing:border-box;
    }

    select:focus{
      outline:none;
      border-color:var(--primary);
    }

    button{
      background:var(--primary);
      color:#fff;
      border:none;
      margin-top:15px;
      cursor:pointer;
      font-weight:600;
      transition:all 0.2s;
      padding:12px 14px;
      border-radius:8px;
    }

    button:hover{
      background:var(--primary-dark);
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(14,165,164,0.3);
    }

    .btn-secondary{
      background:#eef2f7;
      color:#0f1724;
      margin-top:20px;
    }

    .btn-secondary:hover{
      background:#e1e7ef;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }

    #map{
      height:500px;
      margin-top:15px;
      border-radius:12px;
      overflow:hidden;
      border:2px solid #e6eef6;
    }

    .info-box{
      background:#e6f7f7;
      padding:16px 20px;
      border-left:4px solid var(--primary);
      border-radius:8px;
      margin-bottom:20px;
      color:#0f1724;
    }

    .info-box strong{
      color:var(--primary);
    }

    textarea{
      font-family:Arial, sans-serif;
      line-height:1.4;
      min-height:150px;
      resize:vertical;
      overflow-y:auto;
    }

    .loading{
      text-align:center;
      padding:20px;
      color:var(--muted);
      font-style:italic;
    }

    .error-box{
      background:#fee;
      border-left:4px solid #dc2626;
      padding:16px 20px;
      border-radius:8px;
      margin-bottom:20px;
      color:#dc2626;
    }

    @media(max-width:768px){
      body{ padding:16px; }
      .card{ padding:24px 20px; }
      h1{ font-size:20px; }
      #map{ height:400px; }
    }
  </style>
</head>

<body>

<div class="wrap">
  <div class="card">
    <h1>üó∫Ô∏è Visualisation de votre zone d'intervention</h1>
    <h2>Identifiez facilement les communes couvertes par votre zone d'action</h2>

    <div class="info-box">
      <strong>üí° Mode d'emploi :</strong> S√©lectionnez le d√©partement, puis la commune centrale et votre crit√®re (temps de trajet en m√©tropole, rayon en km en Outre-mer).
    </div>

    <label for="departement">D√©partement</label>
    <select id="departement">
      <option value="">‚è≥ Chargement des d√©partements...</option>
    </select>

    <label for="commune">Commune centrale</label>
    <select id="commune">
      <option value="">-- choisissez d'abord le d√©partement --</option>
    </select>

    <div id="critereBlock" style="display:none;">
      <div id="zoneMetropole" style="display:none;">
        <label for="tempsTrajet">Temps de trajet maximal (minutes)</label>
        <select id="tempsTrajet">
          <option value="">-- S√©lectionnez --</option>
          <option value="15">15 min</option>
          <option value="20">20 min</option>
          <option value="20">25 min</option>
          <option value="30">30 min</option>
          <option value="30">35 min</option>
          <option value="30">40 min</option>
          <option value="30">45 min</option>
          <option value="45">50 min</option>
          <option value="45">55 min</option>
          <option value="60">60 min</option>
        </select>
      </div>

      <div id="zoneOutreMer" style="display:none;">
        <label for="rayonKm">Rayon d'intervention (km)</label>
        <select id="rayonKm">
          <option value="">-- S√©lectionnez --</option>
          <option value="10">10 km</option>
          <option value="15">15 km</option>
          <option value="20">20 km</option>
          <option value="25">25 km</option>
          <option value="30">30 km</option>
          <option value="30">35 km</option>
          <option value="40">40 km</option>
          <option value="40">45 km</option>
          <option value="50">50 km</option>
          <option value="Tout mon d√©partement">Tout mon d√©partement</option>
        </select>
      </div>
    </div>

    <button id="afficher">üìç Afficher ma zone d'intervention</button>

    <div id="loadingMsg" class="loading" style="display:none;">
      ‚è≥ Calcul de la zone en cours...
    </div>

    <div id="errorMsg" class="error-box" style="display:none;"></div>

    <div id="map"></div>

    <h3>üìã Communes couvertes</h3>
    <textarea id="liste" rows="8" placeholder="Les communes appara√Ætront ici apr√®s avoir cliqu√© sur 'Afficher ma zone d'intervention'"></textarea>
    
    <button class="btn-secondary" onclick="window.close()">‚Üê Retour au questionnaire</button>
  </div>
</div>

<script>
/* ------------------------------
   CONFIGURATION
--------------------------------*/
const ORS_API_KEY = "TeyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImYyNjcyNmMzZTU3YTQyNzk4Y2UxYzMxZmQ2YTZhYzZjIiwiaCI6Im11cm11cjY0In0="; // ‚ö†Ô∏è √Ä remplacer par ta vraie cl√© (ou proxy s√©curis√©)
const DEPT_API = "https://geo.api.gouv.fr/departements";
const COMMUNE_API = code => `https://geo.api.gouv.fr/departements/${code}/communes?fields=nom,centre`;

const DEPS_METRO = [
  '01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','21','22','23','24','25','26','27','28','29','2A','2B','30','31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46','47','48','49','50','51','52','53','54','55','56','57','58','59','60','61','62','63','64','65','66','67','68','69','70','71','72','73','74','75','76','77','78','79','80','81','82','83','84','85','86','87','88','89','90','91','92','93','94','95'
];
const DEPS_DOMTOM = ['971','972','973','974','976'];

/* ------------------------------
   √âL√âMENTS DOM
--------------------------------*/
const departSelect = document.getElementById("departement");
const communeSelect = document.getElementById("commune");
const tempsSelect = document.getElementById("tempsTrajet");
const rayonSelect = document.getElementById("rayonKm");
const afficherBtn = document.getElementById("afficher");
const listeBox = document.getElementById("liste");
const loadingMsg = document.getElementById("loadingMsg");
const errorMsg = document.getElementById("errorMsg");

/* ------------------------------
   INITIALISATION CARTE LEAFLET
--------------------------------*/
const map = L.map("map").setView([46.8, 2.5], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18,
  attribution: "¬© OpenStreetMap"
}).addTo(map);
L.control.scale({ position: "bottomleft", metric: true }).addTo(map);

/* ------------------------------
   VARIABLES GLOBALES
--------------------------------*/
let communes = [];
let currentDeptCode = null;

/* ------------------------------
   CHARGER LES D√âPARTEMENTS
--------------------------------*/
async function chargerDepartements() {
  departSelect.innerHTML = "<option>‚è≥ Chargement...</option>";
  try {
    const res = await fetch(DEPT_API);
    const data = await res.json();
    data.sort((a,b) => a.code.localeCompare(b.code));
    departSelect.innerHTML = '<option value="">-- S√©lectionnez un d√©partement --</option>';
    data.forEach(dep => {
      const opt = document.createElement("option");
      opt.value = dep.code;
      opt.textContent = `${dep.code} ‚Äî ${dep.nom}`;
      departSelect.appendChild(opt);
    });
  } catch (err) {
    console.error("Erreur chargement d√©partements :", err);
    departSelect.innerHTML = "<option value=''>‚ùå Erreur de chargement</option>";
  }
}
chargerDepartements();

/* ------------------------------
   CHARGER LES COMMUNES
--------------------------------*/
departSelect.addEventListener("change", async e => {
  const code = e.target.value;
  currentDeptCode = code;
  communes = [];
  communeSelect.innerHTML = "<option>‚è≥ Chargement...</option>";
  document.getElementById("critereBlock").style.display = "none";
  document.getElementById("zoneMetropole").style.display = "none";
  document.getElementById("zoneOutreMer").style.display = "none";

  if (!code) return;

  try {
    const res = await fetch(COMMUNE_API(code));
    const data = await res.json();
    communes = data.sort((a,b) => a.nom.localeCompare(b.nom));
    communeSelect.innerHTML = '<option value="">-- S√©lectionnez votre commune --</option>';
    communes.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.nom;
      opt.textContent = c.nom;
      communeSelect.appendChild(opt);
    });

    // Affiche le bon bloc selon le d√©partement
    document.getElementById("critereBlock").style.display = "block";
    if (DEPS_METRO.includes(code)) {
      document.getElementById("zoneMetropole").style.display = "block";
    } else if (DEPS_DOMTOM.includes(code)) {
      document.getElementById("zoneOutreMer").style.display = "block";
    }

    // Zoom sur le d√©partement
    const lats = communes.map(c => c.centre.coordinates[1]);
    const lngs = communes.map(c => c.centre.coordinates[0]);
    const bounds = [[Math.min(...lats), Math.min(...lngs)], [Math.max(...lats), Math.max(...lngs)]];
    map.fitBounds(bounds, { padding: [30, 30] });

  } catch (err) {
    console.error("Erreur chargement communes :", err);
    communeSelect.innerHTML = "<option value=''>‚ùå Erreur de chargement</option>";
  }
});

/* ------------------------------
   CALCUL ISOCHRONE (M√©tropole)
--------------------------------*/
async function calculerIsochrone(lon, lat, minutes) {
  const url = "https://api.openrouteservice.org/v2/isochrones/driving-car";
  const body = {
    locations: [[lon, lat]],
    range: [minutes * 60],
    range_type: "time"
  };

  const response = await fetch(url, {
    method: "POST",
    headers: {
      "Authorization": ORS_API_KEY,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  if (!response.ok) {
    const txt = await response.text();
    console.error("Erreur ORS :", txt);
    throw new Error("Erreur API ORS");
  }

  const data = await response.json();
  return data.features[0].geometry.coordinates[0];
}

/* ------------------------------
   UTILITAIRE : Point dans polygone
--------------------------------*/
function isPointInPolygon(point, vs) {
  const x = point.lat, y = point.lng;
  let inside = false;
  for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
    const xi = vs[i][0], yi = vs[i][1];
    const xj = vs[j][0], yj = vs[j][1];
    const intersect = ((yi > y) !== (yj > y)) &&
      (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

/* ------------------------------
   G√âN√âRER 5 POINTS AUTOUR D‚ÄôUNE COMMUNE
--------------------------------*/
function genererPointsTest(commune) {
  const lat = commune.centre.coordinates[1];
  const lon = commune.centre.coordinates[0];
  const delta = 0.005; // ‚âà 500m
  return [
    L.latLng(lat, lon),
    L.latLng(lat + delta, lon),
    L.latLng(lat - delta, lon),
    L.latLng(lat, lon + delta),
    L.latLng(lat, lon - delta)
  ];
}

/* ------------------------------
   AFFICHER LA ZONE D‚ÄôINTERVENTION
--------------------------------*/
afficherBtn.addEventListener("click", async () => {
  const nomCentrale = communeSelect.value;
  if (!nomCentrale) return alert("‚ö†Ô∏è S√©lectionnez une commune centrale");

  const centrale = communes.find(c => c.nom === nomCentrale);
  if (!centrale) return alert("‚ùå Commune introuvable");

  const lat = centrale.centre.coordinates[1];
  const lon = centrale.centre.coordinates[0];
  const centre = L.latLng(lat, lon);

  // R√©initialiser la carte
  map.eachLayer(layer => {
    if (layer instanceof L.Marker || layer instanceof L.Circle || layer instanceof L.Polygon)
      map.removeLayer(layer);
  });

  loadingMsg.style.display = "block";
  errorMsg.style.display = "none";
  listeBox.value = "";

  try {
    let dansZone = [];

    if (DEPS_METRO.includes(currentDeptCode)) {
      const minutes = parseInt(tempsSelect.value);
      if (!minutes) {
        loadingMsg.style.display = "none";
        return alert("‚ö†Ô∏è S√©lectionnez un temps de trajet");
      }

      const isoCoords = await calculerIsochrone(lon, lat, minutes);
      const polygonCoords = isoCoords.map(c => [c[1], c[0]]);
      const polygon = L.polygon(polygonCoords, {
        color: "#0ea5a4",
        fillColor: "#0ea5a4",
        fillOpacity: 0.15,
        weight: 2
      }).addTo(map);

      L.marker(centre).addTo(map)
        .bindPopup(`<strong>${nomCentrale}</strong><br><em>Commune centrale</em>`).openPopup();

      map.fitBounds(polygon.getBounds(), { padding: [40, 40] });

      communes.forEach(c => {
        if (c.nom === nomCentrale) return;
        const points = genererPointsTest(c);
        for (const pt of points) {
          if (polygon.getBounds().contains(pt) && isPointInPolygon(pt, polygonCoords)) {
            dansZone.push(c);
            L.marker(L.latLng(c.centre.coordinates[1], c.centre.coordinates[0]))
              .addTo(map)
              .bindPopup(c.nom);
            break;
          }
        }
      });

      const total = dansZone.length + 1;
      listeBox.value = `üìç Commune centrale : ${nomCentrale}\n\n‚úÖ ${dansZone.length} commune(s) accessible(s) en ${minutes} min :\n\n` +
        dansZone.map((c,i)=>`${i+1}. ${c.nom}`).join("\n") +
        `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìä TOTAL : ${total} commune(s)`;

    } else if (DEPS_DOMTOM.includes(currentDeptCode)) {
      const rayonValue = rayonSelect.value;
      if (!rayonValue) {
        loadingMsg.style.display = "none";
        return alert("‚ö†Ô∏è S√©lectionnez un rayon");
      }

      if (rayonValue === "Tout mon d√©partement") {
        dansZone = communes.filter(c => c.nom !== nomCentrale);
        dansZone.forEach(c => {
          L.marker(L.latLng(c.centre.coordinates[1], c.centre.coordinates[0])).addTo(map).bindPopup(c.nom);
        });

        L.marker(centre).addTo(map).bindPopup(`<strong>${nomCentrale}</strong><br><em>Commune centrale</em>`).openPopup();

        const lats = communes.map(c => c.centre.coordinates[1]);
        const lngs = communes.map(c => c.centre.coordinates[0]);
        map.fitBounds([[Math.min(...lats), Math.min(...lngs)], [Math.max(...lats), Math.max(...lngs)]], { padding: [40,40] });

        const total = dansZone.length + 1;
        listeBox.value = `üìç Commune centrale : ${nomCentrale}\n\n‚úÖ ${dansZone.length} commune(s) (tout le d√©partement)\n\n` +
          dansZone.map((c,i)=>`${i+1}. ${c.nom}`).join("\n") +
          `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìä TOTAL : ${total} commune(s)`;

      } else {
        const rayonKm = parseFloat(rayonValue);
        const circle = L.circle(centre, { radius: rayonKm * 1000, color: "#0ea5a4", fillColor: "#0ea5a4", fillOpacity: 0.15 }).addTo(map);
        L.marker(centre).addTo(map).bindPopup(`<strong>${nomCentrale}</strong><br><em>Commune centrale</em>`).openPopup();
        map.fitBounds(circle.getBounds(), { padding: [40, 40] });

        communes.forEach(c => {
          if (c.nom === nomCentrale) return;
          const pt = L.latLng(c.centre.coordinates[1], c.centre.coordinates[0]);
          const distance = map.distance(centre, pt);
          if (distance <= rayonKm * 1000) {
            dansZone.push(c);
            L.marker(pt).addTo(map).bindPopup(c.nom);
          }
        });

        const total = dansZone.length + 1;
        listeBox.value = `üìç Commune centrale : ${nomCentrale}\n\n‚úÖ ${dansZone.length} commune(s) dans un rayon de ${rayonKm} km :\n\n` +
          dansZone.map((c,i)=>`${i+1}. ${c.nom}`).join("\n") +
          `\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nüìä TOTAL : ${total} commune(s)`;
      }
    }

  } catch (err) {
    console.error("Erreur affichage zone :", err);
    errorMsg.style.display = "block";
    errorMsg.textContent = "‚ùå Erreur lors du calcul de la zone.";
  } finally {
    loadingMsg.style.display = "none";
  }
});
</script>


</body>
</html>























