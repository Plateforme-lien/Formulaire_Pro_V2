<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Questionnaire de r√©f√©rencement ‚Äî Professionnels TSA</title>

<!-- Leaflet pour la carte -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --bg:#f6f8fb;
    --card:#fff;
    --primary:#0ea5a4;
    --primary-dark:#0d8887;
    --muted:#6b7280;
    --section-bg:#f9fafb;
    --prereq-bg:#e6f7f7;
  }
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:24px;line-height:1.6;color:#0f1724}
  .wrap{max-width:980px;margin:18px auto}
  .card{background:var(--card);border-radius:16px;padding:32px 36px;box-shadow:0 8px 30px rgba(2,6,23,0.06);margin-bottom:24px}

  /* Navigation Header */
  .nav-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;padding-bottom:16px;border-bottom:2px solid #e6eef6}
  .nav-header h1{margin:0;font-size:24px;color:#0f1724}
  .nav-links{display:flex;gap:16px;align-items:center}
  .nav-links a{color:var(--muted);text-decoration:none;font-size:14px;font-weight:600;transition:color 0.2s}
  .nav-links a:hover{color:var(--primary)}

  h2{margin:0 0 16px;color:var(--muted);font-size:17px;font-weight:600;line-height:1.6}
  h3{margin:24px 0 12px;font-size:16px;font-weight:700;color:#0f1724}

  .section-title{margin:32px 0 20px;font-size:20px;font-weight:700;color:#0f1724;border-bottom:3px solid var(--primary);padding-bottom:8px}
  .section-title:first-of-type{margin-top:0}

  label{display:block;margin-top:20px;font-weight:600;color:#0f1724;font-size:15px}

  input[type=text],input[type=email],input[type=tel],input[type=date],select,textarea,button{
    width:100%;
    padding:12px 14px;
    margin-top:8px;
    border:2px solid #e6eef6;
    border-radius:8px;
    font-size:15px;
    transition:border-color 0.2s;
    box-sizing:border-box;
    font-family:inherit;
  }
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary)}

  button{background:var(--primary);color:#fff;border:none;margin-top:15px;cursor:pointer;font-weight:600;transition:all 0.2s}
  button:hover{background:var(--primary-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(14,165,164,0.3)}
  button:disabled{background:#d1d5db;cursor:not-allowed;transform:none}

  .btn-secondary{background:#eef2f7;color:#0f1724;margin-top:20px}
  .btn-secondary:hover{background:#e1e7ef;box-shadow:0 2px 8px rgba(0,0,0,0.1)}

  .info-box{background:#e6f7f7;padding:16px 20px;border-left:4px solid var(--primary);border-radius:8px;margin-bottom:20px;color:#0f1724}
  .info-box strong{color:var(--primary)}

  .checkbox-group{margin-top:12px}
  .checkbox-item{display:flex;align-items:center;margin:10px 0}
  .checkbox-item input[type="checkbox"]{width:auto;margin:0 8px 0 0;cursor:pointer}
  .checkbox-item label{margin:0;font-weight:400;cursor:pointer}

  textarea{font-family:Arial, sans-serif;line-height:1.4;min-height:100px;resize:vertical}
  .help-text{font-size:13px;color:var(--muted);margin-top:6px;font-style:italic}
  
  label.required::after {
    content: " *";
    color: #ef4444;
    margin-left: 4px;
    font-weight: bold;
  }

  /* CARTE ET COMMUNES */
  #map{
    height:450px;
    margin-top:15px;
    border-radius:12px;
    overflow:hidden;
    border:2px solid #e6eef6;
    position:relative;
  }
  
  .map-search-container{
    position:absolute;
    top:15px;
    left:50%;
    transform:translateX(-50%);
    z-index:1000;
    width:90%;
    max-width:400px;
  }

  .map-search-input{
    width:100%;
    padding:12px 16px;
    border:2px solid #e6eef6;
    border-radius:8px;
    background:#fff;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    font-size:14px;
  }

  .map-search-results{
    position:absolute;
    top:100%;
    left:0;
    right:0;
    background:#fff;
    border:2px solid #e6eef6;
    border-radius:8px;
    margin-top:4px;
    max-height:200px;
    overflow-y:auto;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    display:none;
  }

  .map-search-results.active{
    display:block;
  }

  .map-search-item{
    padding:10px 16px;
    cursor:pointer;
    border-bottom:1px solid #f3f4f6;
  }

  .map-search-item:hover{
    background:#f0f9ff;
  }

  .map-search-item:last-child{
    border-bottom:none;
  }
  
  .zone-interactive{
    background:#f9fafb;
    border:2px solid #e6eef6;
    border-radius:12px;
    padding:20px;
    margin-top:20px;
  }

  /* 3 COLONNES */
  .communes-grid{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:16px;
    margin-top:20px;
  }

  .commune-column{
    background:#fff;
    border:2px solid #e6eef6;
    border-radius:8px;
    padding:16px;
  }

  .commune-column h4{
    margin:0 0 12px;
    font-size:15px;
    font-weight:700;
    color:#0f1724;
    display:flex;
    align-items:center;
    gap:8px;
    padding-bottom:8px;
    border-bottom:2px solid #e6eef6;
  }

  .commune-column-list{
    max-height:350px;
    overflow-y:auto;
  }

  .commune-item{
    display:flex;
    align-items:center;
    padding:8px;
    margin:4px 0;
    border-radius:6px;
    cursor:pointer;
    transition:all 0.2s;
    font-size:14px;
  }

  .commune-item:hover{
    background:#f0f9ff;
  }

  .commune-item.selected{
    background:#d1fae5;
    border-left:3px solid #10b981;
    font-weight:500;
  }

  .commune-item.unselected{
    background:#fff;
    color:#6b7280;
  }

  .commune-item input[type="checkbox"]{
    width:auto;
    margin:0 8px 0 0;
    cursor:pointer;
  }

  .commune-item-remove{
    margin-left:auto;
    background:#fee;
    color:#dc2626;
    border:none;
    padding:4px 8px;
    border-radius:4px;
    cursor:pointer;
    font-size:12px;
  }

  .commune-item-remove:hover{
    background:#fca5a5;
  }

  .search-input-wrapper{
    position:relative;
    margin-bottom:12px;
  }

  .search-input{
    width:100%;
    padding:10px 12px;
    border:2px solid #e6eef6;
    border-radius:6px;
    font-size:14px;
  }

  .search-results{
    position:absolute;
    top:100%;
    left:0;
    right:0;
    background:#fff;
    border:2px solid #e6eef6;
    border-radius:6px;
    margin-top:4px;
    max-height:200px;
    overflow-y:auto;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    z-index:100;
    display:none;
  }

  .search-results.active{
    display:block;
  }

  .search-result-item{
    padding:10px 12px;
    cursor:pointer;
    border-bottom:1px solid #f3f4f6;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }

  .search-result-item:hover{
    background:#f0f9ff;
  }

  .search-result-item:last-child{
    border-bottom:none;
  }

  .search-result-dept{
    font-size:12px;
    color:#6b7280;
  }

  .search-result-add{
    background:#10b981;
    color:#fff;
    border:none;
    padding:4px 12px;
    border-radius:4px;
    font-size:12px;
    cursor:pointer;
  }

  .search-result-add:hover{
    background:#059669;
  }

  .validate-zone-btn{
    width:100%;
    margin-top:24px;
    padding:16px;
    background:#10b981;
    color:#fff;
    border:none;
    border-radius:8px;
    font-size:16px;
    font-weight:700;
    cursor:pointer;
    transition:all 0.2s;
  }

  .validate-zone-btn:hover{
    background:#059669;
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(16,185,129,0.3);
  }

  .validate-zone-btn:disabled{
    background:#d1d5db;
    cursor:not-allowed;
    transform:none;
  }

  .legend-map{
    background:#fff;
    padding:12px;
    border-radius:8px;
    margin-top:12px;
    border:2px solid #e6eef6;
  }

  .legend-map h4{
    margin:0 0 8px;
    font-size:14px;
    font-weight:700;
  }

  .legend-item{
    display:flex;
    align-items:center;
    gap:8px;
    margin:6px 0;
    font-size:13px;
  }

  .legend-dot{
    width:12px;
    height:12px;
    border-radius:50%;
  }

  .legend-dot.blue{
    background:#3b82f6;
  }

  .legend-dot.green{
    background:#10b981;
  }

  .legend-dot.red{
    background:#dc2626;
  }

  @media(max-width:968px){
    .communes-grid{
      grid-template-columns:1fr;
    }
  }

  .stats-zone{
    display:flex;
    gap:16px;
    margin-top:12px;
    flex-wrap:wrap;
  }

  .stat-card{
    flex:1;
    min-width:150px;
    background:#fff;
    border:2px solid #e6eef6;
    border-radius:8px;
    padding:12px;
    text-align:center;
  }

  .stat-number{
    font-size:28px;
    font-weight:700;
    color:var(--primary);
  }

  .stat-label{
    font-size:13px;
    color:var(--muted);
    margin-top:4px;
  }

  .loading-overlay{
    position:absolute;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(255,255,255,0.9);
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:12px;
    z-index:1000;
  }

  .prereq-section{background:var(--prereq-bg);padding:18px;border-radius:12px;margin-top:24px;border-left:4px solid var(--primary);margin-bottom: 48px;}
  .error{color:#dc2626;margin-top:8px;font-weight:500}
  .small{font-size:13px;color:var(--muted);margin-top:8px;line-height:1.5}
  .hidden{display:none}
  .success-banner{background:#d1fae5;border:2px solid #10b981;padding:24px;border-radius:12px;margin-top:24px;text-align:center}
  .section-number{background:var(--primary);color:white;min-width:28px;width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0}

  @media(max-width:768px){
    body{padding:16px}
    .card{padding:24px 20px}
    .nav-header{flex-direction:column;align-items:flex-start;gap:12px}
    .nav-links{flex-wrap:wrap}
    #map{height:300px}
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- NAV HEADER -->
  <div class="nav-header">
    <h1>üìã Questionnaire de r√©f√©rencement</h1>
    <nav class="nav-links">
      <a href="index.html">üè† Accueil</a>
      <a href="mentions.html">üìÑ Mentions l√©gales</a>
    </nav>
  </div>
  
<div class="card">
  <div id="intro-section">
    <h2>Compl√©tez vos informations professionnelles pour √™tre r√©f√©renc√© sur la plateforme</h2>

    <div class="info-box">
      <strong>‚è±Ô∏è Temps estim√© :</strong> 5-10 minutes maximum
    </div>
  </div>

    <!-- === SECTION EMAIL === -->
    <div id="section-email">
      <h3 class="section-title">1Ô∏è‚É£ V√©rification de votre identit√©</h3>

      <p class="small" style="margin-top:8px">
        Les questions avec un <span style="color:#ef4444;font-weight:bold">*</span> sont obligatoires.
      </p>

      <label for="email" class="required">Adresse e-mail professionnelle</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="email" type="email" placeholder="exemple@professionnel.fr" autocomplete="email"/>
        <button id="sendCodeBtn" type="button">üìß V√©rifier mon mail</button>
      </div>
      <div id="emailMsg" class="small"></div>

      <div id="codeArea" class="hidden" style="margin-top:12px">
        <label for="code" class="required">Code de v√©rification (envoy√© par e-mail)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="code" type="text" placeholder="000000" inputmode="numeric"/>
          <button id="verifyBtn" type="button">Valider le code</button>
          <button id="resendBtn" class="btn-secondary" type="button" style="width:auto;padding:10px 14px">Renvoyer</button>
        </div>
        <div id="codeMsg" class="small"></div>
      </div>

      <div id="newUserMessage" class="hidden" style="background:#e6f7f7;border:2px solid #0ea5a4;padding:18px;border-radius:12px;margin-top:16px;text-align:center">
        <div style="font-size:36px;margin-bottom:8px">üëã</div>
        <h3 style="margin:0 0 8px;color:#0f1724;font-size:18px">Bienvenue !</h3>
        <p class="small" style="margin:0">Vous √™tes un nouvel utilisateur. Merci de remplir le formulaire ci-dessous.</p>
      </div>

      <div id="existingUserChoice" class="hidden" style="margin-top:16px">
        <div style="background:#f0f9ff;border:2px solid #3b82f6;padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:36px;margin-bottom:8px">‚úÖ</div>
          <h3 style="margin:0 0 8px;color:#0f1724;font-size:18px">Bon retour !</h3>
          <p class="small" style="margin:0 0 12px">Vos informations sont d√©j√† enregistr√©es. Que souhaitez-vous faire ?</p>
          <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
            <button id="modifyBtn" type="button" style="background:#3b82f6;padding:10px 18px;color:#fff;border-radius:8px">‚úèÔ∏è Modifier mes informations</button>
            <button id="deleteBtn" type="button" class="btn-secondary" style="background:#fee;color:#dc2626;border:2px solid #dc2626;padding:10px 18px;border-radius:8px">üóëÔ∏è Supprimer mes informations</button>
          </div>
        </div>
      </div>

      <div id="deleteConfirmation" class="hidden" style="margin-top:16px">
        <div style="background:#fee;border:2px solid #dc2626;padding:16px;border-radius:12px">
          <h3 style="margin:0 0 8px;color:#dc2626;font-size:16px">‚ö†Ô∏è Confirmer la suppression</h3>
          <p class="small" style="margin:0 0 12px">√ätes-vous s√ªr(e) de vouloir supprimer d√©finitivement vos informations ? Cette action est <strong>irr√©versible</strong>.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="confirmDeleteBtn" type="button" style="background:#dc2626;color:#fff;padding:10px 16px;border-radius:8px">‚úì Oui, supprimer</button>
            <button id="cancelDeleteBtn" type="button" class="btn-secondary" style="padding:10px 16px;border-radius:8px">‚úï Annuler</button>
          </div>
          <div id="deleteMsg" class="small" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <!-- === FORMULAIRE === -->
    <form id="form" class="hidden" onsubmit="return false;">
      <div class="prereq-section">
        <div style="font-weight:700;margin-bottom:8px">Pr√©requis</div>

        <label style="margin-top:0" class="required">Avez-vous un num√©ro professionnel ?</label>
        <div style="margin-top:12px">
          <label class="inline"><input type="radio" name="numType" value="siret"> Oui, j'ai un num√©ro SIRET</label>
          <label class="inline"><input type="radio" name="numType" value="none"> Non, je n'ai pas de num√©ro</label>
        </div>

        <div id="siretBlock" class="hidden">
          <label for="siretNum" class="required">Quel est votre num√©ro SIRET ?</label>
          <input id="siretNum" name="siretNum" type="text" maxlength="14" inputmode="numeric" placeholder="14 chiffres"/>
          <div id="siretErr" class="error"></div>
        </div>

        <div id="noNum" class="error hidden">Ce questionnaire n'est autoris√© que pour les professionnels ayant un num√©ro de SIRET.</div>
      </div>

      <div id="rest" class="hidden">
        <div class="section-title"><span class="section-number">1</span> Identit√© et coordonn√©es</div>

        <label for="nom" class="required">Nom</label>
        <input id="nom" name="nom" type="text"/>

        <label for="prenom" class="required">Pr√©nom</label>
        <input id="prenom" name="prenom" type="text"/>

        <label for="phone">T√©l√©phone (optionnel)</label>
        <input id="phone" name="phone" type="tel" placeholder="0X XX XX XX XX ou +33..."/>

        <div class="section-title"><span class="section-number">2</span> Activit√© professionnelle</div>

        <label for="profession" class="required">Profession</label>
        <select id="profession" name="profession">
          <option value="">-- s√©lectionnez --</option>
          <option>√âducateur sp√©cialis√©</option>
          <option>Ergoth√©rapeute</option>
          <option>Psychologue</option>
          <option>Psychomotricien</option>
          <option>Orthophoniste</option>
        </select>

        <label style="margin-top:24px" class="required">Aupr√®s de quel(s) public(s) intervenez-vous ?</label>
        <div class="small" style="margin-top:4px">Vous pouvez s√©lectionner plusieurs r√©ponses.</div>
        <div style="margin-top:12px">
          <label><input type="checkbox" name="public" value="0-6"> Enfants (0-6 ans)</label>
          <label><input type="checkbox" name="public" value="7-12"> Enfants (7-12 ans)</label>
          <label><input type="checkbox" name="public" value="13-18"> Adolescents (13-18 ans)</label>
          <label><input type="checkbox" name="public" value="18+"> Adultes (18+)</label>
        </div>
        
        <label style="margin-top:24px" class="required">Quel est votre mode d'intervention principal ?</label>
        <div class="small" style="margin-top:4px">S√©lectionnez l'option qui correspond le mieux √† votre pratique.</div>
        <div style="margin-top:12px">
          <label><input type="radio" name="modeIntervention" value="cabinet"> Uniquement en cabinet</label>
          <label><input type="radio" name="modeIntervention" value="deplacement"> Je me d√©place au domicile</label>
          <label><input type="radio" name="modeIntervention" value="mixte"> Les deux (cabinet + d√©placements)</label>
        </div>

        <label style="margin-top:24px" class="required">Proposez-vous des rendez-vous en visio ?</label>
        <div style="margin-top:12px">
          <label><input type="radio" name="visio" value="oui"> Oui</label>
          <label><input type="radio" name="visio" value="non"> Non</label>
        </div>

        <!-- === SECTION 3 : ZONE G√âOGRAPHIQUE === -->
        <div id="section-geo" class="hidden">
          <div class="section-title" style="margin-top:32px"><span class="section-number">3</span> Zone g√©ographique d'intervention</div>

          <!-- D√âPARTEMENT -->
          <label for="departement" class="required">Dans quel d√©partement intervenez-vous ?</label>
          <select id="departement" name="departement"><option value="">-- Chargement --</option></select>

          <!-- COMMUNE -->
          <div id="blocCommune" class="hidden">
            <label for="commune" class="required" id="labelCommune">Quelle est votre commune principale ?</label>
            <select id="commune" name="commune"><option value="">-- Choisissez le d√©partement --</option></select>
          </div>

          <!-- CRIT√àRES D√âPLACEMENTS -->
          <div id="questionsDeplacements" class="hidden">
            
            <!-- M√âTROPOLE : Temps -->
            <div id="zoneMetropole" class="hidden">
              <label for="tempsTrajet" class="required">Quel est votre temps de trajet maximal ?</label>
              <select id="tempsTrajet" name="tempsTrajet" style="margin-top:8px;">
                <option value="">-- S√©lectionnez --</option>
                <option>15 min</option>
                <option>20 min</option>
                <option>30 min</option>
                <option>45 min</option>
                <option>60 min</option>
              </select>
              <div class="small" style="margin-top:4px;">Temps de trajet en voiture depuis votre commune principale.</div>
            </div>

            <!-- OUTRE-MER : Rayon -->
            <div id="zoneOutreMer" class="hidden">
              <label for="rayonKm" class="required">Quel est votre rayon d'intervention (en km) ?</label>
              <select id="rayonKm" name="rayonKm" style="margin-top:8px;">
                <option value="">-- S√©lectionnez --</option>
                <option>10 km</option>
                <option>15 km</option>
                <option>20 km</option>
                <option>25 km</option>
                <option>30 km</option>
                <option>40 km</option>
                <option>Tout mon d√©partement</option>
              </select>
              <div class="small" style="margin-top:4px;">Distance √† vol d'oiseau depuis votre commune.</div>
            </div>

            <!-- ZONE INTERACTIVE (CARTE + COMMUNES) -->
            <div id="zoneInteractive" class="zone-interactive hidden">
              <label class="required" style="font-size:16px;margin-bottom:12px;display:block">Visualisez et ajustez vos communes d'intervention</label>
              
              <div class="info-box" style="margin-bottom:16px">
                <strong>üí° Mode d'emploi :</strong> La zone ci-dessous est calcul√©e automatiquement selon vos crit√®res. 
                Cochez au moins une commune pour valider votre zone d'intervention. Vous pouvez aussi ajouter des communes d'autres d√©partements via la recherche.
              </div>

              <!-- STATS -->
               <div class="stats-zone">
                <div class="stat-card">
                  <div class="stat-number" id="statSelectionnees">0</div>
                  <div class="stat-label">Communes s√©lectionn√©es</div>
                </div>
              </div>

              <!-- CARTE -->
              <div style="position:relative;">
                <div id="map"></div>
                
                <!-- RECHERCHE SUR LA CARTE -->
                <div class="map-search-container">
                  <input 
                    type="text" 
                    id="mapSearchInput" 
                    class="map-search-input" 
                    placeholder="üîç Rechercher une commune sur la carte..."
                  />
                  <div id="mapSearchResults" class="map-search-results"></div>
                </div>
              </div>

              <!-- L√âGENDE -->
              <div class="legend-map">
                <h4>üìå L√©gende</h4>
                <div class="legend-item">
                  <span class="legend-dot red"></span>
                  <span>Commune centrale (point de d√©part)</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot blue"></span>
                  <span>Communes calcul√©es automatiquement (rayon km/temps de trajet)</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot green"></span>
                  <span>Communes ajout√©es manuellement</span>
                </div>
              </div>


<!-- 2 COLONNES DE COMMUNES -->
<div class="communes-grid" style="grid-template-columns: 1fr 1fr;">
  
  <!-- COLONNE 1 : D√âPARTEMENT PRINCIPAL -->
  <div class="commune-column">
    <h4>
      <span style="font-size:20px">üìç</span>
      Mon d√©partement
    </h4>
    <div class="small" style="margin-bottom:8px;color:#0ea5a4">
      Cochez les communes que vous couvrez
    </div>
    
    <!-- BARRE DE RECHERCHE -->
    <div class="search-input-wrapper">
      <input 
        type="text" 
        id="departementSearchInput" 
        class="search-input" 
        placeholder="üîç Rechercher..."
      />
    </div>
    
    <div id="communesDepartement" class="commune-column-list"></div>
  </div>

  <!-- COLONNE 2 : AUTRES D√âPARTEMENTS -->
  <div class="commune-column">
    <h4>
      <span style="font-size:20px">‚ûï</span>
      Autres d√©partements
    </h4>
    <div class="small" style="margin-bottom:8px;color:#0ea5a4">
      Ajoutez des communes hors d√©partement
    </div>
    
    <!-- RECHERCHE -->
    <div class="search-input-wrapper">
      <input 
        type="text" 
        id="communeSearchInput" 
        class="search-input" 
        placeholder="üîç Rechercher..."
      />
      <div id="communeSearchResults" class="search-results"></div>
    </div>

    <!-- COMMUNES AJOUT√âES -->
    <div id="communesAjoutees" class="commune-column-list"></div>
  </div>
</div>
              
                            <!-- üìã LISTE R√âCAPITULATIVE -->
              <div style="margin-top:32px;padding:20px;background:#fff;border:2px solid #0ea5a4;border-radius:12px">
                <h4 style="margin:0 0 16px;color:#0f1724;font-size:16px;font-weight:700;display:flex;align-items:center;gap:8px">
                  <span style="font-size:24px">üìã</span>
                  Liste r√©capitulative de vos communes
                </h4>
                <div class="small" style="margin-bottom:12px;color:#6b7280">
                  Voici toutes les communes que vous avez s√©lectionn√©es (d√©partement principal + autres d√©partements)
                </div>
                <div id="listeRecapitulative" style="max-height:200px;overflow-y:auto;padding:12px;background:#f9fafb;border-radius:8px"></div>
              </div>

              <!-- PR√âCISIONS G√âOGRAPHIQUES -->
              <label for="precisionsGeo" style="margin-top:24px">Pr√©cisions g√©ographiques (optionnel)</label>
              <textarea id="precisionsGeo" name="precisionsGeo" rows="3" placeholder="Ex: Je ne couvre que certains quartiers, je privil√©gie telle zone..."></textarea>
              <div class="small" style="margin-top:4px;">Ajoutez ici toute pr√©cision utile sur votre zone d'intervention.</div>
            </div>

          </div>
        </div>
        
        <!-- === SECTION 4 : DISPONIBILIT√âS === -->
        <div class="section-title"><span class="section-number">4</span> Disponibilit√©s</div>
        <label class="required">Avez-vous des disponibilit√©s pour de nouveaux b√©n√©ficiaires ?</label>
        <div style="margin-top:12px">
          <label><input type="radio" name="dispo" value="oui"> Oui</label>
          <label><input type="radio" name="dispo" value="non"> Non</label>
        </div>
        
        <div id="dateBlock" class="hidden">
          <label for="dateDispo" class="required">√Ä partir de quelle date √™tes-vous disponible ?</label>
          <input id="dateDispo" name="dateDispo" type="date"/>
          
          <label for="placesDisponibles" class="required" style="margin-top:20px">
            Combien de nouveaux b√©n√©ficiaires pourrez-vous accueillir ?
          </label>
          <input 
            id="placesDisponibles" 
            name="placesDisponibles" 
            type="number" 
            min="1" 
            max="10" 
            placeholder="Ex: 1"
            style="width: 150px;margin-top:8px"
          />
          <div class="small" style="margin-top:6px;color:#6b7280">
            Indiquez le nombre de places disponibles (entre 1 et 10)
          </div>
        </div>

        <!-- === SECTION 5 : MODE DE CONTACT === -->
        <div id="modeContactBlock" class="hidden">
          <div class="section-title" style="margin-top:32px"><span class="section-number">5</span> Pr√©f√©rences de contact</div>
          
          <label class="required">Comment souhaitez-vous √™tre contact√© par les particuliers ?</label>
          <div class="info-box" style="margin-top:8px">
            <strong>‚ÑπÔ∏è Important :</strong> Cette option d√©termine si vos coordonn√©es (email et t√©l√©phone) 
            seront visibles directement ou si les particuliers devront passer par un formulaire de contact.
          </div>
          
          <div style="margin-top:12px">
            <label>
              <input type="radio" name="modeContact" value="direct" checked>
              <strong>üìß Contact direct</strong>
              <div class="small" style="margin-left:24px;margin-top:4px">
                Mon email et mon t√©l√©phone seront affich√©s. Les particuliers peuvent me contacter directement.
              </div>
            </label>
            
            <label style="margin-top:12px">
              <input type="radio" name="modeContact" value="formulaire">
              <strong>üìù Contact via formulaire uniquement</strong>
              <div class="small" style="margin-left:24px;margin-top:4px">
                Mes coordonn√©es restent priv√©es. Les particuliers m'envoient un message via un formulaire.
              </div>
            </label>
          </div>
        </div>
        
        <!-- === SECTION 6 : CONSENTEMENT === -->
        <div class="section-title" style="margin-top:32px"><span class="section-number" id="consentNumber">5</span> Consentement</div>
        <label style="margin-top:0;display:flex;align-items:start;gap:8px" class="required">
          <input id="consent" name="consent" type="checkbox" style="margin-top:4px"/>
          <span>J'accepte que mes donn√©es soient utilis√©es uniquement dans le cadre de cette mise en relation.</span>
        </label>

        <div class="actions" style="display:flex;gap:12px;align-items:center;margin-top:24px;flex-wrap:wrap">
          <button id="submit" type="button">‚úì Enregistrer mes informations</button>
          <button id="editBtn" type="button" class="hidden">‚úèÔ∏è Modifier mes informations</button>
          <button id="resetBtn" type="button" class="btn-secondary">R√©initialiser</button>
        </div>
        <div id="submitMsg" class="small" style="margin-top:12px"></div>
      </div>

      <div id="successBanner" class="success-banner hidden">
        <div style="font-size:64px;margin-bottom:16px">‚úÖ</div>
        <h3 style="margin:0 0 12px;color:#0f1724;font-size:24px;font-weight:700">Formulaire envoy√© avec succ√®s !</h3>
        <p style="margin:0 0 16px;color:#059669;font-size:16px;font-weight:600">Vous avez re√ßu un email de confirmation.</p>
        <p style="margin:0 0 24px;color:#6b7280;font-size:15px">Vos informations ont √©t√© enregistr√©es. Vous pouvez fermer cette page.</p>
      </div>
    </form>
  </div>

  <footer style="text-align:center;margin-top:48px;padding-top:32px;border-top:2px solid #e6eef6;color:var(--muted);font-size:14px">
    <p>
      <a href="index.html" style="color:var(--primary);text-decoration:none;font-weight:600">Accueil</a> ‚Ä¢ 
      <a href="mentions.html" style="color:var(--primary);text-decoration:none;font-weight:600">Mentions l√©gales</a>
    </p>
    <p style="margin-top:12px;font-size:13px">¬© 2025 - R√©f√©rencement Professionnels TSA</p>
  </footer>
  
</div>

<script>
/* ========== CONFIG ========== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbww78Q-FrcILGHJu0O0lRgajYaFn9qJPq8ViSwDEixSOQ_ZiTWgJVX64mMcNHwirwFf/exec"; 
const ORS_API_KEY = 'eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImYyNjcyNmMzZTU3YTQyNzk4Y2UxYzMxZmQ2YTZhYzZjIiwiaCI6Im11cm11cjY0In0=';
const DEPT_API = "https://geo.api.gouv.fr/departements";
const COMMUNE_API = code => `https://geo.api.gouv.fr/departements/${code}/communes?fields=nom,centre`;

const DEPS_METRO = ['01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','21','22','23','24','25','26','27','28','29','2A','2B','30','31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46','47','48','49','50','51','52','53','54','55','56','57','58','59','60','61','62','63','64','65','66','67','68','69','70','71','72','73','74','75','76','77','78','79','80','81','82','83','84','85','86','87','88','89','90','91','92','93','94','95'];
const DEPS_DOMTOM = ['971','972','973','974','976'];

/* ========== VARIABLES GLOBALES ========== */
let map = null;
let communesData = [];
let communesCalculees = new Set();
let communesSelectionnees = new Set();
let communesAjouteesManuel = new Map();
let communesAjouteesDepartement = new Set();
let polygonLayer = null;
let circleLayer = null;
let markersBleus = new Map();
let markersVerts = new Map();
let markerCentral = null;

let CURRENT_EMAIL = null;
let EXISTING = false;
let EXISTING_DATA = null;
let FORM_LOCKED = false;

/* ========== HELPERS VALIDATION ========== */
const isDigits = s => /^\d+$/.test(s||"");
const validSiret = v => isDigits(v) && v.length === 14;
const validPhone = v => {
  if(!v) return true;
  const c = v.replace(/\s|\-|\(|\)|\./g,"");
  return /^(0[1-9]\d{8}|\+33[1-9]\d{8})$/.test(c) || /^[0-9]{10,15}$/.test(c);
};

// FONCTION NORMALISER 
function normaliser(str) {
  if (!str) return "";
  return str.toString().trim().toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,"");
}

/* ========== DOM ELEMENTS ========== */
const emailEl = document.getElementById("email");
const sendCodeBtn = document.getElementById("sendCodeBtn");
const emailMsg = document.getElementById("emailMsg");
const codeArea = document.getElementById("codeArea");
const codeEl = document.getElementById("code");
const verifyBtn = document.getElementById("verifyBtn");
const resendBtn = document.getElementById("resendBtn");
const codeMsg = document.getElementById("codeMsg");
const formEl = document.getElementById("form");
const siretBlock = document.getElementById("siretBlock");
const noNum = document.getElementById("noNum");
const rest = document.getElementById("rest");
const siretNum = document.getElementById("siretNum");
const siretErr = document.getElementById("siretErr");
const submitBtn = document.getElementById("submit");
const editBtn = document.getElementById("editBtn");
const submitMsg = document.getElementById("submitMsg");
const departSelect = document.getElementById("departement");
const communeSelect = document.getElementById("commune");
const dateBlock = document.getElementById("dateBlock");
const dateInput = document.getElementById("dateDispo");
const resetBtn = document.getElementById("resetBtn");
const newUserMessage = document.getElementById("newUserMessage");
const existingUserChoice = document.getElementById("existingUserChoice");
const deleteConfirmation = document.getElementById("deleteConfirmation");
const modifyBtn = document.getElementById("modifyBtn");
const deleteBtn = document.getElementById("deleteBtn");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
const deleteMsg = document.getElementById("deleteMsg");
const successBanner = document.getElementById("successBanner");
const placesInput = document.getElementById("placesDisponibles");
const modeContactBlock = document.getElementById("modeContactBlock");
const consentNumber = document.getElementById("consentNumber");

/* ========== INITIALISATION CARTE ========== */
function initMap() {
  if (!map) {
    map = L.map('map').setView([46.8, 2.5], 6);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19,
      attribution: '¬© OpenStreetMap ¬© CARTO'
    }).addTo(map);
    
    // Forcer le rafra√Æchissement de la carte apr√®s initialisation
    setTimeout(() => {
      if (map) map.invalidateSize();
    }, 100);
  }
}

/* ========== GESTION MARKERS ========== */
function clearMarkers() {
  markersBleus.forEach(marker => map.removeLayer(marker));
  markersBleus.clear();
  markersVerts.forEach(marker => map.removeLayer(marker));
  markersVerts.clear();
  if (markerCentral) {
    map.removeLayer(markerCentral);
    markerCentral = null;
  }
}

function updateMarkers() {
  clearMarkers();

  const communeCentrale = communeSelect.value;
  const allPoints = []; // Pour calculer le zoom global

  // ‚úÖ MARKER ROUGE pour la commune centrale
  const communeCentraleData = communesData.find(c => c.nom === communeCentrale);
  if (communeCentraleData && communesSelectionnees.has(communeCentrale)) {
    markerCentral = L.marker([communeCentraleData.lat, communeCentraleData.lon], {
      icon: L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      })
    }).addTo(map).bindPopup(`<strong>${communeCentrale}</strong><br><em>Commune centrale</em>`);
    allPoints.push([communeCentraleData.lat, communeCentraleData.lon]);
  }

  // ‚úÖ Markers BLEUS pour communes calcul√©es automatiquement (sauf centrale)
  communesData.forEach(c => {
    if (communesSelectionnees.has(c.nom) && 
        c.nom !== communeCentrale && 
        communesCalculees.has(c.nom) &&
        !communesAjouteesDepartement.has(c.nom) &&
        !communesAjouteesManuel.has(c.nom)) {
      const marker = L.marker([c.lat, c.lon], {
        icon: L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })
      }).addTo(map).bindPopup(c.nom);
      markersBleus.set(c.nom, marker);
      allPoints.push([c.lat, c.lon]);
    }
  });

  // ‚úÖ Markers VERTS pour communes ajout√©es manuellement du d√©partement principal
  communesData.forEach(c => {
    if (communesSelectionnees.has(c.nom) && 
        c.nom !== communeCentrale && 
        communesAjouteesDepartement.has(c.nom)) {
      const marker = L.marker([c.lat, c.lon], {
        icon: L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })
      }).addTo(map).bindPopup(`${c.nom} (ajout√©e manuellement)`);
      markersVerts.set(c.nom, marker);
      allPoints.push([c.lat, c.lon]);
    }
  });

  // ‚úÖ Markers VERTS pour communes ajout√©es d'autres d√©partements
  communesAjouteesManuel.forEach((data, nom) => {
    if (communesSelectionnees.has(nom)) {
      const marker = L.marker([data.lat, data.lon], {
        icon: L.icon({
          iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
          shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        })
      }).addTo(map).bindPopup(`${nom} (${data.dept})`);
      markersVerts.set(nom, marker);
      allPoints.push([data.lat, data.lon]);
    }
  });

  // ‚úÖ ZOOM ADAPTATIF INTELLIGENT
  if (markersVerts.size > 0 && allPoints.length > 0) {
    const bounds = L.latLngBounds(allPoints);
    map.fitBounds(bounds, { padding: [80, 80], maxZoom: 9 });
    console.log(`üîç Zoom √©tendu pour inclure ${markersVerts.size} communes ajout√©es manuellement`);
  }
  
  updateStats();
  updateListeRecapitulative();
}

function updateStats() {
  const statSelectionnees = document.getElementById('statSelectionnees');
  if (statSelectionnees) {
    statSelectionnees.textContent = communesSelectionnees.size;
  }
  
  // Ne plus afficher statAjoutees car cet √©l√©ment n'existe plus
  // (on a chang√© l'affichage des stats)
}

/* ========== LISTE R√âCAPITULATIVE ========== */
function updateListeRecapitulative() {
  const container = document.getElementById('listeRecapitulative');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (communesSelectionnees.size === 0) {
    container.innerHTML = '<div style="color:#6b7280;text-align:center;padding:20px">Aucune commune s√©lectionn√©e</div>';
    return;
  }
  
  // Cr√©er un tableau avec toutes les communes + leur d√©partement
  const communesAvecDept = [];
  
  communesSelectionnees.forEach(nom => {
    let dept = departSelect.value.split(' ')[0]; // D√©partement par d√©faut
    
    // Si c'est une commune ajout√©e manuellement, r√©cup√©rer son vrai d√©partement
    if (communesAjouteesManuel.has(nom)) {
      dept = communesAjouteesManuel.get(nom).dept;
    }
    
    communesAvecDept.push({ nom, dept });
  });
  
  // Trier par d√©partement puis par nom
  communesAvecDept.sort((a, b) => {
    if (a.dept !== b.dept) return a.dept.localeCompare(b.dept);
    return a.nom.localeCompare(b.nom);
  });
  
  // Afficher
  let currentDept = '';
  communesAvecDept.forEach(({ nom, dept }) => {
    // Afficher le d√©partement si changement
    if (dept !== currentDept) {
      currentDept = dept;
      const deptHeader = document.createElement('div');
      deptHeader.style.cssText = 'font-weight:700;color:#0ea5a4;margin-top:12px;margin-bottom:4px;font-size:14px';
      deptHeader.textContent = `üìç D√©partement ${dept}`;
      container.appendChild(deptHeader);
    }
    
    // Afficher la commune
    const item = document.createElement('div');
    item.style.cssText = 'padding:6px 12px;margin:2px 0;background:#fff;border-radius:4px;display:flex;align-items:center;gap:8px;font-size:14px';
    item.innerHTML = `<span style="color:#10b981;font-weight:700">‚úì</span> ${nom}`;
    container.appendChild(item);
  });
}

/* ========== AFFICHA2 COLONNES ========== */
function afficher2Colonnes() {
  const colDepartement = document.getElementById('communesDepartement');
  
  if (!colDepartement) return;
  
  colDepartement.innerHTML = '';
  
  // COLONNE 1 : Toutes les communes du d√©partement
  const toutesCommunes = [];
  
  communesData.forEach(c => {
    toutesCommunes.push({
      nom: c.nom,
      selected: communesSelectionnees.has(c.nom)
    });
  });
  
  // Trier : coch√©es d'abord, puis alphab√©tique
  toutesCommunes.sort((a, b) => {
    if (a.selected && !b.selected) return -1;
    if (!a.selected && b.selected) return 1;
    return a.nom.localeCompare(b.nom);
  });

  if (toutesCommunes.length === 0) {
    colDepartement.innerHTML = '<div class="small" style="color:#6b7280;text-align:center;padding:20px">Aucune commune disponible</div>';
  } else {
    toutesCommunes.forEach(({nom, selected}) => {
      const item = createCommuneItem(nom, selected);
      colDepartement.appendChild(item);
    });
  }

  updateCommunesAjoutees();
  updateStats();
  updateListeRecapitulative();
}

function createCommuneItem(nom, isSelected) {
  const item = document.createElement('div');
  item.className = `commune-item ${isSelected ? 'selected' : 'unselected'}`;
  
  const checkbox = document.createElement('input');
  checkbox.type = 'checkbox';
  checkbox.checked = isSelected;
  checkbox.id = `commune-${nom}`;
  
  checkbox.addEventListener('change', () => {
    if (checkbox.checked) {
      communesSelectionnees.add(nom);
      // Si c'est une commune du d√©partement qui n'√©tait pas calcul√©e automatiquement
      if (!communesCalculees.has(nom)) {
        communesAjouteesDepartement.add(nom);
      }
    } else {
      communesSelectionnees.delete(nom);
      // Si c'√©tait ajout√©e manuellement, on la retire aussi de ce set
      communesAjouteesDepartement.delete(nom);
    }
    afficher2Colonnes();
    updateMarkers();
  });

  const label = document.createElement('label');
  label.htmlFor = `commune-${nom}`;
  label.textContent = nom;
  label.style.cursor = 'pointer';
  label.style.flex = '1';

  item.appendChild(checkbox);
  item.appendChild(label);
  
  return item;
}

function updateCommunesAjoutees() {
  const container = document.getElementById('communesAjoutees');
  container.innerHTML = '';
  

  if (communesAjouteesManuel.size === 0) {
    container.innerHTML = '<div class="small" style="color:#6b7280;text-align:center;padding:20px">Recherchez des communes √† ajouter</div>';
    return;
  }

  Array.from(communesAjouteesManuel.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([nom, data]) => {
    const item = document.createElement('div');
    item.className = `commune-item ${communesSelectionnees.has(nom) ? 'selected' : 'unselected'}`;
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = communesSelectionnees.has(nom);
    checkbox.id = `commune-ajoutee-${nom}`;
    
    checkbox.addEventListener('change', () => {
      if (checkbox.checked) {
        communesSelectionnees.add(nom);
      } else {
        communesSelectionnees.delete(nom);
      }
      updateCommunesAjoutees();
      updateMarkers();
    });

    const label = document.createElement('label');
    label.htmlFor = `commune-ajoutee-${nom}`;
    label.textContent = `${nom} (${data.dept})`;
    label.style.cursor = 'pointer';
    label.style.flex = '1';

    const removeBtn = document.createElement('button');
    removeBtn.className = 'commune-item-remove';
    removeBtn.textContent = 'üóëÔ∏è';
    removeBtn.onclick = (e) => {
      e.stopPropagation();
      communesAjouteesManuel.delete(nom);
      communesSelectionnees.delete(nom);
      updateCommunesAjoutees();
      updateMarkers();
      updateStats();
    };

    item.appendChild(checkbox);
    item.appendChild(label);
    item.appendChild(removeBtn);
    container.appendChild(item);
  });
  updateListeRecapitulative();
}

/* ========== RECHERCHE SUR LA CARTE ========== */
const mapSearchInput = document.getElementById('mapSearchInput');
const mapSearchResults = document.getElementById('mapSearchResults');
let mapSearchTimeout = null;

mapSearchInput.addEventListener('input', (e) => {
  const query = e.target.value.trim();
  
  clearTimeout(mapSearchTimeout);
  
  if (query.length < 2) {
    mapSearchResults.classList.remove('active');
    return;
  }

  mapSearchTimeout = setTimeout(async () => {
    try {
      const url = `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(query)}&fields=nom,code,codeDepartement,centre&boost=population&limit=8`;
      const response = await fetch(url);
      const communes = await response.json();

      if (communes.length === 0) {
        mapSearchResults.innerHTML = '<div class="map-search-item">Aucune commune trouv√©e</div>';
        mapSearchResults.classList.add('active');
        return;
      }

      mapSearchResults.innerHTML = '';
      communes.forEach(c => {
        const item = document.createElement('div');
        item.className = 'map-search-item';
        item.innerHTML = `<strong>${c.nom}</strong> <span style="color:#6b7280;font-size:12px">(${c.codeDepartement})</span>`;
        
        item.onclick = () => {
          const lat = c.centre.coordinates[1];
          const lon = c.centre.coordinates[0];
          map.setView([lat, lon], 10); // Zoom 10 au lieu de 13 pour voir plus large
          
          mapSearchResults.classList.remove('active');
          mapSearchInput.value = '';
        };
        
        mapSearchResults.appendChild(item);
      });

      mapSearchResults.classList.add('active');
    } catch (error) {
      console.error('Erreur recherche carte:', error);
    }
  }, 300);
});

document.addEventListener('click', (e) => {
  if (!mapSearchInput.contains(e.target) && !mapSearchResults.contains(e.target)) {
    mapSearchResults.classList.remove('active');
  }
});

/* ========== RECHERCHE COLONNE 3 ========== */
const communeSearchInput = document.getElementById('communeSearchInput');
const communeSearchResults = document.getElementById('communeSearchResults');
let communeSearchTimeout = null;

communeSearchInput.addEventListener('input', (e) => {
  const query = e.target.value.trim();
  
  clearTimeout(communeSearchTimeout);
  
  if (query.length < 2) {
    communeSearchResults.classList.remove('active');
    return;
  }

  communeSearchTimeout = setTimeout(async () => {
    try {
      const url = `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(query)}&fields=nom,code,codeDepartement,centre&boost=population&limit=10`;
      const response = await fetch(url);
      const communes = await response.json();

      if (communes.length === 0) {
        communeSearchResults.innerHTML = '<div class="search-result-item">Aucune commune trouv√©e</div>';
        communeSearchResults.classList.add('active');
        return;
      }

      communeSearchResults.innerHTML = '';
      communes.forEach(c => {
        if (communesAjouteesManuel.has(c.nom)) return;

        const item = document.createElement('div');
        item.className = 'search-result-item';
        
        const info = document.createElement('div');
        info.innerHTML = `<strong>${c.nom}</strong><br><span class="search-result-dept">${c.codeDepartement}</span>`;
        
        const addBtn = document.createElement('button');
        addBtn.className = 'search-result-add';
        addBtn.textContent = '+ Ajouter';
        addBtn.onclick = () => {
          communesAjouteesManuel.set(c.nom, {
            nom: c.nom,
            dept: c.codeDepartement,
            lat: c.centre.coordinates[1],
            lon: c.centre.coordinates[0]
          });
          communesSelectionnees.add(c.nom);
          
          updateCommunesAjoutees();
          updateMarkers();
          updateStats();
          
          communeSearchResults.classList.remove('active');
          communeSearchInput.value = '';
        };
        
        item.appendChild(info);
        item.appendChild(addBtn);
        communeSearchResults.appendChild(item);
      });

      communeSearchResults.classList.add('active');
    } catch (error) {
      console.error('Erreur recherche commune:', error);
    }
  }, 300);
});

document.addEventListener('click', (e) => {
  if (!communeSearchInput.contains(e.target) && !communeSearchResults.contains(e.target)) {
    communeSearchResults.classList.remove('active');
  }
});

/* ========== RECHERCHE COLONNE D√âPARTEMENT ========== */
const departementSearchInput = document.getElementById('departementSearchInput');

if (departementSearchInput) {
  departementSearchInput.addEventListener('input', (e) => {
    const query = e.target.value.toLowerCase().trim();
    const items = document.querySelectorAll('#communesDepartement .commune-item');
    
    items.forEach(item => {
      const label = item.querySelector('label');
      if (label) {
        const text = label.textContent.toLowerCase();
        if (text.includes(query)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      }
    });
  });
}

/* ========== CALCUL ZONE M√âTROPOLE ========== */
async function calculerZoneMetropole(coords, communeCentrale) {
  const tempsValue = document.getElementById('tempsTrajet').value;
  if (!tempsValue) {
    alert('‚ö†Ô∏è S√©lectionnez un temps de trajet');
    throw new Error('Temps manquant');
  }

  const minutes = parseInt(tempsValue.match(/\d+/)?.[0] || 0);
  
  const isochrone = await calculerIsochrone(coords.lon, coords.lat, minutes);
  if (!isochrone) throw new Error('√âchec calcul isochrone');

  const polygonCoords = isochrone.map(coord => [coord[1], coord[0]]);
  polygonLayer = L.polygon(polygonCoords, {
    color: "#0ea5a4",
    fillColor: "#0ea5a4",
    fillOpacity: 0.15,
    weight: 2
  }).addTo(map);

 
  communesCalculees.clear();
  communesSelectionnees.clear();
  communesAjouteesDepartement.clear();
  communesAjouteesDepartement.clear();
  clearMarkers();

  communesCalculees.add(communeCentrale);
  communesSelectionnees.add(communeCentrale);

  communesData.forEach(c => {
    if (c.nom === communeCentrale) return;
    
    const pt = L.latLng(c.lat, c.lon);
    if (polygonLayer.getBounds().contains(pt) && isPointInPolygon(pt, polygonCoords)) {
      communesCalculees.add(c.nom);
      communesSelectionnees.add(c.nom);
    }
  });
  
  // Zoom initial sur la zone calcul√©e uniquement
  const boundsInitial = polygonLayer.getBounds();
  map.fitBounds(boundsInitial, { padding: [80, 80], maxZoom: 9 });

  afficher2Colonnes();
  updateMarkers(); // updateMarkers s'occupe du zoom √©tendu si besoin
}

/* ========== CALCUL ZONE OUTRE-MER ========== */
async function calculerZoneOutreMer(coords, communeCentrale) {
  const rayonValue = document.getElementById('rayonKm').value;
  if (!rayonValue) {
    alert('‚ö†Ô∏è S√©lectionnez un rayon');
    throw new Error('Rayon manquant');
  }

  communesCalculees.clear();
  communesSelectionnees.clear();
  communesAjouteesDepartement.clear();
  clearMarkers();

  communesCalculees.add(communeCentrale);
  communesSelectionnees.add(communeCentrale);

  if (rayonValue === "Tout mon d√©partement") {
    communesData.forEach(c => {
      communesCalculees.add(c.nom);
      communesSelectionnees.add(c.nom);
    });
    const lats = communesData.map(c => c.lat);
    const lngs = communesData.map(c => c.lon);
    const bounds = [[Math.min(...lats), Math.min(...lngs)], [Math.max(...lats), Math.max(...lngs)]];
    map.fitBounds(bounds, { padding: [80, 80], maxZoom: 9 });

  } else {
    const rayonKm = parseFloat(rayonValue.match(/\d+/)?.[0] || 0);
    
    circleLayer = L.circle([coords.lat, coords.lon], {
      radius: rayonKm * 1000,
      color: "#0ea5a4",
      fillColor: "#0ea5a4",
      fillOpacity: 0.15
    }).addTo(map);

    communesData.forEach(c => {
      if (c.nom === communeCentrale) return;
      
      const distance = calculerDistance(coords.lat, coords.lon, c.lat, c.lon);
      if (distance <= rayonKm) {
        communesCalculees.add(c.nom);
        communesSelectionnees.add(c.nom);
      }
    });
    // Zoom initial sur le cercle
    const boundsInitial = circleLayer.getBounds();
    map.fitBounds(boundsInitial, { padding: [80, 80], maxZoom: 9 });
  }

  afficher2Colonnes();
  updateMarkers(); // updateMarkers s'occupe du zoom √©tendu si besoin
}

/* ========== CALCUL AUTOMATIQUE DE LA ZONE ========== */
async function calculerZoneAutomatique() {
  const commune = communeSelect.value;
  const codeDept = departSelect.value;
  
  if (!commune || !codeDept) return;

  const modeIntervention = document.querySelector('input[name="modeIntervention"]:checked');
  if (!modeIntervention || modeIntervention.value === 'cabinet') return;

  let critereRempli = false;
  
  if (DEPS_METRO.includes(codeDept)) {
    const tempsValue = document.getElementById('tempsTrajet').value;
    critereRempli = tempsValue && tempsValue !== "-- S√©lectionnez --";
  } else if (DEPS_DOMTOM.includes(codeDept)) {
    const rayonValue = document.getElementById('rayonKm').value;
    critereRempli = rayonValue && rayonValue !== "-- S√©lectionnez --";
  }

  if (!critereRempli) return;

  try {
    initMap();
    const coordsCentrale = await getCommuneCoordinates(codeDept, commune);
    if (!coordsCentrale) throw new Error('Impossible de trouver la commune');

    communesData = await getCommunesDepartement(codeDept);
    clearMap();

    if (DEPS_METRO.includes(codeDept)) {
      await calculerZoneMetropole(coordsCentrale, commune);
    } else if (DEPS_DOMTOM.includes(codeDept)) {
      await calculerZoneOutreMer(coordsCentrale, commune);
    }

document.getElementById('zoneInteractive').classList.remove('hidden');

// Forcer le rafra√Æchissement de la carte apr√®s affichage
setTimeout(() => {
  if (map) map.invalidateSize();
}, 300);
  } catch (error) {
    console.error('Erreur calcul zone:', error);
  }
}

/* ========== √âCOUTEURS POUR CALCUL AUTOMATIQUE ========== */
document.getElementById('tempsTrajet').addEventListener('change', calculerZoneAutomatique);
document.getElementById('rayonKm').addEventListener('change', calculerZoneAutomatique);

/* ========== FONCTIONS UTILITAIRES ========== */
function clearMap() {
  if (polygonLayer) {
    map.removeLayer(polygonLayer);
    polygonLayer = null;
  }
  if (circleLayer) {
    map.removeLayer(circleLayer);
    circleLayer = null;
  }
  clearMarkers();
}

async function getCommuneCoordinates(codeDept, nomCommune) {
  const response = await fetch(COMMUNE_API(codeDept));
  const communes = await response.json();
  const commune = communes.find(c => c.nom.toLowerCase() === nomCommune.toLowerCase());
  return commune ? {
    lon: commune.centre.coordinates[0],
    lat: commune.centre.coordinates[1]
  } : null;
}

async function getCommunesDepartement(codeDept) {
  const response = await fetch(COMMUNE_API(codeDept));
  const communes = await response.json();
  return communes.map(c => ({
    nom: c.nom,
    lon: c.centre.coordinates[0],
    lat: c.centre.coordinates[1]
  }));
}

async function calculerIsochrone(lon, lat, minutes) {
  const url = 'https://api.openrouteservice.org/v2/isochrones/driving-car';
  
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': ORS_API_KEY,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      locations: [[lon, lat]],
      range: [minutes * 60],
      range_type: 'time'
    })
  });

  if (!response.ok) throw new Error('API Error');
  
  const data = await response.json();
  return data.features[0].geometry.coordinates[0];
}

function isPointInPolygon(point, polygon) {
  const x = point.lat;
  const y = point.lng;
  let inside = false;

  for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
    const xi = polygon[i][0], yi = polygon[i][1];
    const xj = polygon[j][0], yj = polygon[j][1];
    const intersect = ((yi > y) !== (yj > y)) &&
      (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
    if (intersect) inside = !inside;
  }
  return inside;
}

function calculerDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

/* ========== GESTION MODE INTERVENTION ========== */
document.querySelectorAll('input[name="modeIntervention"]').forEach(radio => {
  radio.addEventListener('change', updateSectionGeo);
});

function updateSectionGeo() {
  const modeIntervention = document.querySelector('input[name="modeIntervention"]:checked');
  const codeDept = departSelect.value;
  
  const sectionGeo = document.getElementById('section-geo');
  const blocCommune = document.getElementById('blocCommune');
  const questionsDeplacements = document.getElementById('questionsDeplacements');
  const zoneMetropole = document.getElementById('zoneMetropole');
  const zoneOutreMer = document.getElementById('zoneOutreMer');
  const labelCommune = document.getElementById('labelCommune');
  const zoneInteractive = document.getElementById('zoneInteractive');
  
  sectionGeo.classList.add('hidden');
  blocCommune.classList.add('hidden');
  questionsDeplacements.classList.add('hidden');
  zoneMetropole.classList.add('hidden');
  zoneOutreMer.classList.add('hidden');
  zoneInteractive.classList.add('hidden');
  
  if (!modeIntervention) return;
  
  const valeur = modeIntervention.value;
  
  if (valeur === 'cabinet') {
    sectionGeo.classList.remove('hidden');
    labelCommune.textContent = 'Quelle est votre commune d\'intervention ?';
    
    if (codeDept) {
      blocCommune.classList.remove('hidden');
    }
    
  } else if (valeur === 'deplacement' || valeur === 'mixte') {
    sectionGeo.classList.remove('hidden');
    labelCommune.textContent = 'Quelle est votre commune principale d\'intervention ?';
    
    if (codeDept) {
      blocCommune.classList.remove('hidden');
      questionsDeplacements.classList.remove('hidden');
      
      if (DEPS_METRO.includes(codeDept)) {
        zoneMetropole.classList.remove('hidden');
      } else if (DEPS_DOMTOM.includes(codeDept)) {
        zoneOutreMer.classList.remove('hidden');
      }
    }
  }
}

/* ========== CHARGEMENT D√âPARTEMENTS ========== */
async function loadDepartements() {
  departSelect.innerHTML = '<option value="">-- chargement --</option>';
  
  try {
    const response = await fetch(DEPT_API);
    const data = await response.json();
    departSelect.innerHTML = '<option value="">-- s√©lectionnez --</option>';
    
    data.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.code;
      opt.textContent = `${d.code} ‚Äî ${d.nom}`;
      departSelect.appendChild(opt);
    });
  } catch (err) {
    departSelect.innerHTML = '<option value="">Erreur de chargement</option>';
  }
}

departSelect.addEventListener('change', async e => {
  const code = e.target.value;
  
  if (!code) {
    communeSelect.innerHTML = '<option value="">-- choisissez le d√©partement --</option>';
    return;
  }
  
  communeSelect.innerHTML = '<option>‚è≥ Chargement des communes...</option>';
  
  try {
    const response = await fetch(COMMUNE_API(code));
    const data = await response.json();
    communeSelect.innerHTML = '<option value="">-- s√©lectionnez --</option>';
    
    data.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.nom;
      opt.textContent = c.nom;
      communeSelect.appendChild(opt);
    });
  } catch {
    communeSelect.innerHTML = '<option value="">Erreur chargement</option>';
  }
  
  updateSectionGeo();
});
communeSelect.addEventListener('change', calculerZoneAutomatique);

/* ========== EMAIL ET CODES ========== */
sendCodeBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  if (!mail) { 
    emailMsg.textContent = "Merci d'indiquer une adresse e-mail."; 
    return; 
  }
  
  emailMsg.textContent = "Envoi du code en cours...";
  sendCodeBtn.disabled = true;
  
  try {
    const r = await fetch(`${SCRIPT_URL}?action=sendCode&email=${encodeURIComponent(mail)}&_t=${Date.now()}`);
    const j = await r.json();
    
    if (j.error === "DAILY_LIMIT_REACHED") {
      if (j.minutesRestantes && j.minutesRestantes > 0) {
        const heures = Math.floor(j.minutesRestantes / 60);
        const minutes = j.minutesRestantes % 60;
        const tempsRestant = heures > 0
          ? `${heures}h${minutes > 0 ? minutes + 'min' : ''}`
          : `${minutes} minutes`;

        emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Vous avez d√©j√† demand√© trois codes aujourd'hui</span><br>
          <span style="color:#6b7280">Le dernier vous a √©t√© envoy√© il y a moins de 15 minutes. Il est encore valable pendant environ ${tempsRestant}.</span>`;
      } else {
        emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ùå Limite quotidienne atteinte</span><br>
          <span style="color:#6b7280">Vous avez d√©j√† demand√© ${j.codesEnvoyes || 3} codes aujourd'hui. Maximum autoris√© : 3 codes par jour. R√©essayez demain.</span>`;
      }
      sendCodeBtn.disabled = false;
      return;
    }

    if (j.error === "COOLDOWN_ACTIVE") {
      const heures = Math.floor(j.minutesRestantes / 60);
      const minutes = j.minutesRestantes % 60;
      const tempsRestant = heures > 0 ? `${heures}h${minutes > 0 ? minutes + 'min' : ''}` : `${minutes} minutes`;
      
      emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Veuillez patienter</span><br>
        <span style="color:#6b7280">Vous avez r√©cemment soumis le formulaire. Vous pourrez redemander un code dans environ ${tempsRestant}.</span>`;
      sendCodeBtn.disabled = false;
      return;
    }

    if (j.error === "SERVICE_QUOTA_EXCEEDED") {
      emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ö†Ô∏è Service temporairement indisponible</span><br>
        <span style="color:#6b7280">Le quota d'emails quotidien est atteint. Merci de r√©essayer demain.</span>`;
      sendCodeBtn.disabled = false;
      return;
    }
    
    if (j.ok) {
      if (j.alreadySent) {
        emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Code d√©j√† envoy√©</span><br>
        <span style="color:#6b7280">Un code vous a d√©j√† √©t√© envoy√© il y a moins de 15 minutes. Le code est encore valable.</span>`;
      } else {
        emailMsg.innerHTML = `<span style="color:#059669;font-weight:600">‚úì Code envoy√© avec succ√®s</span><br>
        <span style="color:#6b7280">V√©rifiez votre bo√Æte mail (pensez aux spams).</span>`;
      }
      
      CURRENT_EMAIL = mail;
      codeArea.classList.remove("hidden");
      sendCodeBtn.style.display = "none";
      codeEl.focus();
    } else {
      emailMsg.innerHTML = `<span style="color:#dc2626">Erreur : ${j.error || "Impossible d'envoyer le code"}</span>`;
    }
  } catch (err) {
    console.error("Erreur r√©seau:", err);
    emailMsg.innerHTML = `<span style="color:#dc2626">Erreur r√©seau lors de l'envoi du code</span>`;
  } finally {
    sendCodeBtn.disabled = false;
  }
});

emailEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendCodeBtn.click();
  }
});

resendBtn.addEventListener("click", async () => {
  emailMsg.textContent = "Renvoi du code en cours...";
  codeMsg.textContent = ""; 
  resendBtn.disabled = true;
  
  const mail = (emailEl.value || "").trim().toLowerCase();
  
  try {
    const r = await fetch(`${SCRIPT_URL}?action=sendCode&email=${encodeURIComponent(mail)}&_t=${Date.now()}`);
    const j = await r.json();
    
    if (j.alreadySent) {
      emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Code d√©j√† envoy√© r√©cemment</span><br>
      <span style="color:#6b7280">Un code vous a d√©j√† √©t√© envoy√© il y a moins de 15 minutes. Le code est encore valable.</span>`;
    } else if (j.ok) {
      emailMsg.innerHTML = `<span style="color:#059669;font-weight:600">‚úì Code renvoy√© avec succ√®s</span><br>
      <span style="color:#6b7280">V√©rifiez votre bo√Æte mail (pensez aux spams).</span>`;
    } else if (j.error === "DAILY_LIMIT_REACHED") {
      emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ùå Limite quotidienne atteinte</span><br>
      <span style="color:#6b7280">Maximum 3 codes par jour. R√©essayez demain.</span>`;
    } else {
      emailMsg.innerHTML = `<span style="color:#dc2626">Erreur : ${j.error || "Impossible de renvoyer"}</span>`;
    }
  } catch (err) {
    emailMsg.innerHTML = `<span style="color:#dc2626">Erreur r√©seau</span>`;
  } finally {
    resendBtn.disabled = false;
  }
});

codeEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    verifyBtn.click();
  }
});

verifyBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  const code = (codeEl.value || "").trim();
  
  if (!mail || !code) { 
    codeMsg.textContent = "Merci d'indiquer l'adresse e-mail et le code."; 
    return; 
  }
  
  codeMsg.textContent = "V√©rification...";
  
  try {
    const r = await fetch(`${SCRIPT_URL}?action=verifyCode&email=${encodeURIComponent(mail)}&code=${encodeURIComponent(code)}&_t=${Date.now()}`);
    const j = await r.json();
    
    if (!j.ok) { 
      codeMsg.textContent = "Erreur : " + (j.error||"code invalide"); 
      return; 
    }
    
    codeMsg.textContent = "‚úÖ E-mail v√©rifi√© avec succ√®s !";
    CURRENT_EMAIL = mail;
    codeArea.style.display = "none";
    emailMsg.style.display = "none";
    emailEl.disabled = true;
    sendCodeBtn.style.display = "none";
    
    await loadDepartements();
    
    if (j.existing && j.data) {
      EXISTING = true;
      EXISTING_DATA = j.data;
      existingUserChoice.classList.remove("hidden");
    } else {
      EXISTING = false;
      EXISTING_DATA = null;
      newUserMessage.classList.remove("hidden");
      formEl.classList.remove("hidden");
      rest.classList.add("hidden");
    }
  } catch (err) {
    codeMsg.textContent = "Erreur r√©seau lors de la v√©rification.";
  }
});

modifyBtn.addEventListener("click", async () => {
  existingUserChoice.classList.add("hidden");
  await showFormAndPrefill(EXISTING_DATA);
});

deleteBtn.addEventListener("click", () => {
  existingUserChoice.classList.add("hidden");
  deleteConfirmation.classList.remove("hidden");
});

cancelDeleteBtn.addEventListener("click", () => {
  deleteConfirmation.classList.add("hidden");
  existingUserChoice.classList.remove("hidden");
  deleteMsg.textContent = "";
});

confirmDeleteBtn.addEventListener("click", async () => {
  deleteMsg.textContent = "Suppression en cours...";
  confirmDeleteBtn.disabled = true;
  
  try {
    const fd = new FormData();
    fd.append("action", "deleteUser");
    fd.append("email", CURRENT_EMAIL);
    
    const res = await fetch(SCRIPT_URL, { method: "POST", body: fd });
    const j = await res.json();
    
    if (j.ok) {
      deleteMsg.innerHTML = '<span style="color:#059669;font-weight:600">‚úÖ Vos informations ont √©t√© supprim√©es avec succ√®s.</span>';
      setTimeout(() => {
        location.reload();
      }, 2000);
    } else {
      deleteMsg.innerHTML = '<span style="color:#dc2626">‚ùå Erreur : ' + (j.error || "Impossible de supprimer") + '</span>';
      confirmDeleteBtn.disabled = false;
    }
  } catch (err) {
    deleteMsg.innerHTML = '<span style="color:#dc2626">‚ùå Erreur r√©seau lors de la suppression.</span>';
    confirmDeleteBtn.disabled = false;
  }
});

async function showFormAndPrefill(data) {
  formEl.classList.remove("hidden");
  rest.classList.remove("hidden");
  
  const numType = data && data.numType ? data.numType : "";
  if (numType === "siret") {
    document.querySelector('input[name="numType"][value="siret"]').checked = true;
    siretBlock.classList.remove("hidden");
    noNum.classList.add("hidden");
    siretNum.value = data.numPro || "";
  }
  
  if (data) {
    document.getElementById("nom").value = data.nom || "";
    document.getElementById("prenom").value = data.prenom || "";
    document.getElementById("phone").value = data.phone || "";
    document.getElementById("profession").value = data.profession || "";
    
    if (data.publics) {
      const publicsArr = data.publics.split(",").map(s => s.trim()).filter(Boolean);
      document.querySelectorAll('input[name="public"]').forEach(ch => {
        ch.checked = publicsArr.includes(ch.value);
      });
    }
    
    if (data.modeIntervention) {
      const modeRadio = document.querySelector(`input[name="modeIntervention"][value="${data.modeIntervention}"]`);
      if (modeRadio) modeRadio.checked = true;
    }
    
if (data.visio) {
  const visioValue = normaliser(data.visio);
  const visioRadio = document.querySelector(`input[name="visio"][value="${visioValue}"]`);
  if (visioRadio) {
    visioRadio.checked = true;
    console.log('‚úÖ Visio restaur√©e:', visioValue);
  } else {
    console.warn('‚ö†Ô∏è Valeur visio inconnue:', data.visio);
  }
}
    
if (data.departement) {
  let deptCode = String(data.departement).trim();
  if (deptCode.length === 1) deptCode = "0" + deptCode;
  
  setTimeout(async () => {
    departSelect.value = deptCode;
    
    if (data.commune) {
      await loadCommunes(deptCode, data.commune);
    }

    const codeDept = deptCode.split('-')[0].trim();

    if (DEPS_METRO.includes(codeDept) && data.temps) {
      document.getElementById("zoneMetropole").classList.remove("hidden");
      const select = document.getElementById("tempsTrajet");
      select.value = data.temps;
    } else if (DEPS_DOMTOM.includes(codeDept) && data.rayon) {
      document.getElementById("zoneOutreMer").classList.remove("hidden");
      const select = document.getElementById("rayonKm");
      select.value = data.rayon;
    }

    document.getElementById("precisionsGeo").value = data.precisionsGeo || "";
    



// ‚úÖ RESTAURER LES COMMUNES S√âLECTIONN√âES
    if (data.communesCouvertes) {
      const communesSauvegardees = data.communesCouvertes.split('|').map(c => c.trim()).filter(c => c);
      console.log('üìç Restauration de', communesSauvegardees.length, 'communes:', communesSauvegardees);
      
      // Afficher la section g√©ographique
      await updateSectionGeo();
      
      // Si mode d√©placement/mixte : calculer d'abord la zone
      if (data.modeIntervention === 'deplacement' || data.modeIntervention === 'mixte') {
        // Calculer la zone automatique
        await calculerZoneAutomatique();
        
        // ATTENDRE que le calcul soit termin√©
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Charger les donn√©es du d√©partement
        communesData = await getCommunesDepartement(codeDept);
        
        // ‚úÖ VIDER communesSelectionnees (IMPORTANT !)
        communesSelectionnees.clear();
        
        // ‚úÖ RESTAURER TOUTES LES COMMUNES
        for (const nomCommune of communesSauvegardees) {
          const nomNormalise = normaliser(nomCommune);
          
          // Chercher dans le d√©partement
          const communeDept = communesData.find(c => normaliser(c.nom) === nomNormalise);
          
          if (communeDept) {
            // Commune du d√©partement : ajouter
            communesSelectionnees.add(communeDept.nom);
            console.log('‚úÖ Commune d√©partement:', communeDept.nom);
          } else {
            // Commune hors d√©partement : chercher via API
            try {
              const url = `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(nomCommune)}&fields=nom,code,codeDepartement,centre&limit=1`;
              const response = await fetch(url);
              const communes = await response.json();
              
              if (communes.length > 0) {
                const c = communes[0];
                // Ajouter aux communes manuelles
                communesAjouteesManuel.set(c.nom, {
                  nom: c.nom,
                  dept: c.codeDepartement,
                  lat: c.centre.coordinates[1],
                  lon: c.centre.coordinates[0]
                });
                communesSelectionnees.add(c.nom);
                console.log('‚úÖ Commune hors d√©partement:', c.nom, `(${c.codeDepartement})`);
              }
            } catch (error) {
              console.error('‚ùå Erreur:', nomCommune, error);
            }
          }
        }
        
        // Mettre √† jour l'affichage
        afficher2Colonnes();
        updateMarkers();
        updateListeRecapitulative();
        
        console.log('‚úÖ Restauration termin√©e:', communesSelectionnees.size, 'communes');
      }
    } else {
      // Pas de communes sauvegard√©es : calcul normal
      await updateSectionGeo();
      if (data.modeIntervention === 'deplacement' || data.modeIntervention === 'mixte') {
        setTimeout(async () => {
          await calculerZoneAutomatique();
        }, 500);
      }
    }
  }, 200);
}

    if (data.disponibilite) {
      const dispoRadio = document.querySelector(`input[name="dispo"][value="${data.disponibilite}"]`);
      if (dispoRadio) {
        dispoRadio.checked = true;
        if (data.disponibilite === "oui") {
          dateBlock.classList.remove("hidden");
          modeContactBlock.classList.remove("hidden");
          consentNumber.textContent = "6";
          
          if (data.dateDisponibilite) dateInput.value = data.dateDisponibilite;
          if (data.placesDisponibles) placesInput.value = data.placesDisponibles;
          if (data.modeContact) {
            const modeContactRadio = document.querySelector(`input[name="modeContact"][value="${data.modeContact}"]`);
            if (modeContactRadio) modeContactRadio.checked = true;
          }
        } else {
          modeContactBlock.classList.add("hidden");
          consentNumber.textContent = "5";
        }
      }
    }

    const consentValue = String(data.consentement || "").toLowerCase();
    document.getElementById("consent").checked = (consentValue === "oui" || consentValue === "true");
    submitBtn.textContent = "‚úì Mettre √† jour mes informations";
  }
}

async function loadCommunes(deptCode, preselect) {
  communeSelect.innerHTML = '<option>Chargement...</option>';
  
  try {
    const response = await fetch(COMMUNE_API(deptCode));
    const list = await response.json();
    communeSelect.innerHTML = '<option value="">-- s√©lectionnez --</option>';
    
    list.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.nom;
      opt.textContent = c.nom;
      communeSelect.appendChild(opt);
    });
    
    if (preselect) {
      communeSelect.value = preselect;
    }
  } catch (err) {
    communeSelect.innerHTML = '<option value="">Erreur chargement</option>';
  }
}

document.querySelectorAll('input[name="numType"]').forEach(r => r.addEventListener('change', e => {
  const v = e.target.value;
  siretErr.textContent = "";
  siretNum.value = "";
  siretBlock.classList.add("hidden"); 
  noNum.classList.add("hidden");
  rest.classList.add("hidden");
  if (v === "siret") siretBlock.classList.remove("hidden");
  else noNum.classList.remove("hidden");
}));

siretNum.addEventListener('input', () => {
  const v = siretNum.value.trim();
  if (v.length === 14 && validSiret(v)) {
    siretErr.textContent = ""; 
    rest.classList.remove("hidden");
  } else if (v.length === 14) {
    siretErr.textContent = "Un num√©ro SIRET doit contenir exactement 14 chiffres."; 
    rest.classList.add("hidden");
  }
});

siretNum.addEventListener('blur', () => {
  const v = siretNum.value.trim();
  if (!validSiret(v)) { 
    siretErr.textContent = "Un num√©ro SIRET doit contenir exactement 14 chiffres."; 
    rest.classList.add("hidden"); 
  } else { 
    siretErr.textContent = ""; 
    rest.classList.remove("hidden");
  }
});

document.querySelectorAll('input[name="dispo"]').forEach(r => r.addEventListener('change', e => {
  const show = e.target.value === "oui";
  dateBlock.classList.toggle("hidden", !show);
  modeContactBlock.classList.toggle("hidden", !show);
  
  consentNumber.textContent = show ? "6" : "5";
  
  if (show) {
    dateInput.setAttribute("min", new Date().toISOString().split("T")[0]);
  } else {
    dateInput.value = "";
    placesInput.value = "";
    document.querySelector('input[name="modeContact"][value="direct"]').checked = true;
  }
}));

placesInput.addEventListener('input', function() {
  const value = parseInt(this.value);
  if (value < 1) this.value = 1;
  else if (value > 99) this.value = 99;
});

/* ========== SUBMIT FORM ========== */
submitBtn.addEventListener('click', async () => {
  submitMsg.textContent = "";
  successBanner.classList.add("hidden");
  
  const numTypeChecked = document.querySelector('input[name="numType"]:checked');
  if (!numTypeChecked) { 
    submitMsg.textContent = "Vous devez indiquer votre type de num√©ro professionnel."; 
    return; 
  }
  
  const numType = numTypeChecked.value;
  if (numType === "siret" && !validSiret(siretNum.value.trim())) { 
    submitMsg.textContent = "Num√©ro SIRET invalide."; 
    return; 
  }
  
  if (!document.getElementById("nom").value.trim()) { 
    submitMsg.textContent = "Nom requis."; 
    return; 
  }
  
  if (!document.getElementById("prenom").value.trim()) { 
    submitMsg.textContent = "Pr√©nom requis."; 
    return; 
  }
  
  if (!validPhone(document.getElementById("phone").value.trim())) { 
    submitMsg.textContent = "T√©l√©phone invalide."; 
    return; 
  }
  
  if (!document.getElementById("profession").value) { 
    submitMsg.textContent = "Profession requise."; 
    return; 
  }
  
  if (!Array.from(document.querySelectorAll('input[name="public"]:checked')).length) { 
    submitMsg.textContent = "S√©lectionnez au moins un public."; 
    return; 
  }
  
  const modeInterventionChecked = document.querySelector('input[name="modeIntervention"]:checked');
  if (!modeInterventionChecked) { 
    submitMsg.textContent = "S√©lectionnez votre mode d'intervention."; 
    return; 
  }
  
  if (!document.querySelector('input[name="visio"]:checked')) { 
    submitMsg.textContent = "Indiquez si vous proposez des RDV en visio."; 
    return; 
  }
  
  if (!departSelect.value) { 
    submitMsg.textContent = "D√©partement requis."; 
    return; 
  }
  
  if (!communeSelect.value) { 
    submitMsg.textContent = "Commune requise."; 
    return; 
  }
  
if (modeInterventionChecked.value === 'deplacement' || modeInterventionChecked.value === 'mixte') {
  const codeDept = departSelect.value.split(' ')[0];
  
  if (DEPS_METRO.includes(codeDept)) {
    const tempsValue = document.getElementById("tempsTrajet").value.trim();
    if (!tempsValue || tempsValue === "-- S√©lectionnez --") { 
      submitMsg.textContent = "Indiquez votre temps de trajet maximal."; 
      return; 
    }
  } else if (DEPS_DOMTOM.includes(codeDept)) {
    const rayonValue = document.getElementById("rayonKm").value.trim();
    if (!rayonValue || rayonValue === "-- S√©lectionnez --") { 
      submitMsg.textContent = "Indiquez votre rayon d'intervention."; 
      return; 
    }
  }
  
  // V√âRIFICATION : Au moins 1 commune coch√©e
  if (communesSelectionnees.size === 0) {
    submitMsg.textContent = "‚ö†Ô∏è Vous devez s√©lectionner au moins une commune d'intervention";
    document.getElementById('zoneInteractive').scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }
}
  
  const dispoChecked = document.querySelector('input[name="dispo"]:checked');
  if (!dispoChecked) { 
    submitMsg.textContent = "R√©pondez √† la question disponibilit√©s."; 
    return; 
  }
  
  if (dispoChecked.value === "oui") {
    if (!dateInput.value) { 
      submitMsg.textContent = "Indiquez la date de disponibilit√©."; 
      return; 
    }
    
    const places = parseInt(placesInput.value);
    if (!places || places < 1 || places > 10) {
      submitMsg.textContent = "Indiquez le nombre de places disponibles (entre 1 et 10).";
      return;
    }
    
    const modeContactChecked = document.querySelector('input[name="modeContact"]:checked');
    if (!modeContactChecked) { 
      submitMsg.textContent = "Indiquez comment vous souhaitez √™tre contact√©."; 
      return; 
    }
  }
  
  if (!document.getElementById("consent").checked) { 
    submitMsg.textContent = "Le consentement est obligatoire."; 
    return; 
  }
  
  submitBtn.disabled = true;
  submitMsg.innerHTML = '<span style="color:#6b7280">‚è≥ Envoi en cours...</span>';
  
  const fd = new FormData();
  fd.append("action", "submitForm");
  fd.append("email", (CURRENT_EMAIL || emailEl.value || "").trim().toLowerCase());
  fd.append("numType", numType);
  fd.append("siretNum", siretNum.value.trim());
  fd.append("nom", document.getElementById("nom").value.trim());
  fd.append("prenom", document.getElementById("prenom").value.trim());
  fd.append("phone", document.getElementById("phone").value.trim());
  fd.append("profession", document.getElementById("profession").value);
  fd.append("publics", Array.from(document.querySelectorAll('input[name="public"]:checked')).map(i=>i.value).join(","));
  
  fd.append("modeIntervention", modeInterventionChecked.value);
  fd.append("visio", document.querySelector('input[name="visio"]:checked').value);
  
  fd.append("departement", departSelect.value);
  fd.append("commune", communeSelect.value);

  const codeDept = departSelect.value.split(' ')[0];
  if (DEPS_METRO.includes(codeDept)) {
    fd.append("rayon", "");
    fd.append("temps", document.getElementById("tempsTrajet").value);
  } else if (DEPS_DOMTOM.includes(codeDept)) {
    fd.append("rayon", document.getElementById("rayonKm").value);
    fd.append("temps", "");
  }
  
  fd.append("precisionsGeo", document.getElementById("precisionsGeo").value.trim());
  fd.append("dispo", dispoChecked.value);
  fd.append("dateDispo", dateInput.value);
  fd.append("placesDisponibles", placesInput.value || "");
  fd.append("modeContact", document.querySelector('input[name="modeContact"]:checked')?.value || "direct");
  fd.append("consent", document.getElementById("consent").checked ? "oui" : "non");
  
if (modeInterventionChecked.value === 'deplacement' || modeInterventionChecked.value === 'mixte') {
    // S√©parer les communes du d√©partement et les autres
    const communesDept = [];
    const communesAutres = [];
    
    communesSelectionnees.forEach(nom => {
      if (communesAjouteesManuel.has(nom)) {
        communesAutres.push(nom);
      } else {
        communesDept.push(nom);
      }
    });
    
    fd.append("communesDepartement", communesDept.join('|'));
    fd.append("communesAutres", communesAutres.join('|'));
    fd.append("communesCouvertes", Array.from(communesSelectionnees).join('|'));

    console.log('üìç Communes d√©partement:', communesDept.join('|'));
    console.log('üìç Communes autres:', communesAutres.join('|'));
  } else {
    fd.append("communesDepartement", communeSelect.value);
    fd.append("communesAutres", "");
    fd.append("communesCouvertes", communeSelect.value);
  }
  
  const timeoutPromise = new Promise((_, reject) => 
    setTimeout(() => reject(new Error('TIMEOUT')), 30000)
  );
  
  const fetchPromise = fetch(SCRIPT_URL, { method: "POST", body: fd });
  
  try {
    const res = await Promise.race([fetchPromise, timeoutPromise]);
    const j = await res.json();
    
    if (j.ok) {
      lockForm();
    } else {
      submitBtn.disabled = false;
      
      if (j.error === "SIRET_ALREADY_EXISTS") {
        submitMsg.innerHTML = '<span style="color:#dc2626;font-weight:600">‚ùå SIRET d√©j√† enregistr√©</span><br>' +
          '<span style="color:#6b7280">Ce num√©ro SIRET est d√©j√† utilis√© par un autre professionnel.</span>';
      } else {
        submitMsg.innerHTML = '<span style="color:#dc2626;font-weight:600">‚ùå Erreur lors de l\'envoi</span><br>' +
          '<span style="color:#6b7280">' + (j.error || j.detail || "Erreur inconnue") + '</span>';
      }
    }
  } catch (err) {
    console.error("Erreur r√©seau:", err);
    submitBtn.disabled = false;
    
    if (err.message === 'TIMEOUT') {
      submitMsg.innerHTML = '<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è D√©lai d\'attente d√©pass√©</span><br>' +
        '<span style="color:#6b7280">Le serveur met trop de temps √† r√©pondre.</span>';
    } else {
      submitMsg.innerHTML = '<span style="color:#dc2626;font-weight:600">‚ùå Erreur r√©seau</span><br>' +
        '<span style="color:#6b7280">Impossible de communiquer avec le serveur.</span>';
    }
  }
});

function lockForm() {
  FORM_LOCKED = true;
  
  // Masquer toutes les sections du formulaire
  rest.style.display = 'none';
  document.querySelector('.prereq-section').style.display = 'none';
  newUserMessage.classList.add('hidden');
  document.getElementById('section-email').style.display = 'none';
  
  // Masquer l'introduction (titre + temps estim√©)
  const introSection = document.getElementById('intro-section');
  if (introSection) introSection.style.display = 'none';
  
  // Masquer les boutons
  submitBtn.classList.add('hidden');
  resetBtn.classList.add('hidden');
  editBtn.classList.add('hidden');
  
  // Afficher le message de succ√®s
  successBanner.classList.remove('hidden');
  successBanner.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
  
function unlockForm() {
  FORM_LOCKED = false;
  
  submitBtn.classList.remove('hidden');
  editBtn.classList.add('hidden');
  resetBtn.classList.remove('hidden');
  
  successBanner.classList.add('hidden');
  submitMsg.textContent = "";
}

editBtn.addEventListener('click', () => {
  unlockForm();
});

resetBtn.addEventListener('click', () => {
  formEl.reset();
  document.getElementById("consent").checked = false;
  placesInput.value = "";
  modeContactBlock.classList.add("hidden");
  consentNumber.textContent = "5";
  document.querySelector('input[name="modeContact"][value="direct"]').checked = true;
  rest.classList.add("hidden");
  siretBlock.classList.add("hidden");
  noNum.classList.add("hidden");
  submitMsg.textContent = "";
  successBanner.classList.add("hidden");
  
  document.getElementById('section-geo').classList.add('hidden');
  document.getElementById('blocCommune').classList.add('hidden');
  document.getElementById('questionsDeplacements').classList.add('hidden');
  document.getElementById('zoneMetropole').classList.add('hidden');
  document.getElementById('zoneOutreMer').classList.add('hidden');
  document.getElementById('zoneInteractive').classList.add('hidden');
  document.getElementById('precisionsGeo').value = '';
  
  communesSelectionnees.clear();
  communesData = [];
  communesCalculees.clear();
  communesAjouteesManuel.clear();
  communesAjouteesDepartement.clear(); 
  
  if (map) {
    clearMap();
  }
  
  unlockForm();
});

console.log('‚úÖ Formulaire charg√© avec succ√®s');
</script>
</body>
</html>
