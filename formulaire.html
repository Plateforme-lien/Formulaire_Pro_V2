<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Questionnaire de r√©f√©rencement ‚Äî Professionnels TSA</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{
    --bg:#f6f8fb;
    --card:#fff;
    --primary:#0ea5a4;
    --primary-dark:#0d8887;
    --muted:#6b7280;
    --section-bg:#f9fafb;
    --prereq-bg:#e6f7f7;
  }
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:24px;line-height:1.6;color:#0f1724}
  .wrap{max-width:980px;margin:18px auto}
  .card{background:var(--card);border-radius:16px;padding:32px 36px;box-shadow:0 8px 30px rgba(2,6,23,0.06);margin-bottom:24px}

  .nav-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;padding-bottom:16px;border-bottom:2px solid #e6eef6}
  .nav-header h1{margin:0;font-size:24px;color:#0f1724}
  
  .nav-links{display:flex;gap:8px;align-items:center;}
  .nav-links a{color:var(--muted);text-decoration:none;font-size:14px;font-weight:600;padding:8px 16px;border-radius:8px;transition:all 0.2s;position:relative;}
  .nav-links a:hover{color:var(--primary);background:rgba(14, 165, 164, 0.08);}
  .nav-links a.active{color:var(--primary);background:rgba(14, 165, 164, 0.12);font-weight:700;}
  .nav-links a.active::after{content:'';position:absolute;bottom:4px;left:16px;right:16px;height:2px;background:var(--primary);border-radius:2px;}

  h2{margin:0 0 16px;color:var(--muted);font-size:17px;font-weight:600;line-height:1.6}
  h3{margin:24px 0 12px;font-size:16px;font-weight:700;color:#0f1724}

  .section-title{margin:32px 0 20px;font-size:20px;font-weight:700;color:#0f1724;border-bottom:3px solid var(--primary);padding-bottom:8px}
  .section-title:first-of-type{margin-top:0}

  label{display:block;margin-top:20px;font-weight:600;color:#0f1724;font-size:15px}

  input[type=text],input[type=email],input[type=tel],input[type=date],input[type=number],select,textarea,button{
    width:100%;
    padding:12px 14px;
    margin-top:8px;
    border:2px solid #e6eef6;
    border-radius:8px;
    font-size:15px;
    transition:border-color 0.2s;
    box-sizing:border-box;
    font-family:inherit;
  }
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary)}

  button{background:var(--primary);color:#fff;border:none;margin-top:15px;cursor:pointer;font-weight:600;transition:all 0.2s}
  button:hover{background:var(--primary-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(14,165,164,0.3)}
  button:disabled{background:#d1d5db;cursor:not-allowed;transform:none}

  .btn-secondary{background:#eef2f7;color:#0f1724;margin-top:20px}
  .btn-secondary:hover{background:#e1e7ef;box-shadow:0 2px 8px rgba(0,0,0,0.1)}

  .info-box{background:#e6f7f7;padding:16px 20px;border-left:4px solid var(--primary);border-radius:8px;margin-bottom:20px;color:#0f1724}
  .info-box strong{color:var(--primary)}

  textarea{font-family:Arial, sans-serif;line-height:1.4;min-height:100px;resize:vertical}
  .help-text{font-size:13px;color:var(--muted);margin-top:6px;font-style:italic}
  label.required {color: #0f1724;}
  label.required::after {content: " *";color: #ef4444;margin-left: 4px;font-weight: bold;}

  footer{text-align:center;margin-top:48px;padding-top:32px;border-top:2px solid #e6eef6;color:var(--muted);font-size:14px}
  footer a{color:var(--primary);text-decoration:none;font-weight:600}
  footer a:hover{text-decoration:underline}

  .prereq-section{background:var(--prereq-bg);padding:18px;border-radius:12px;margin-top:24px;border-left:4px solid var(--primary);margin-bottom: 48px;}
  .error{color:#dc2626;margin-top:8px;font-weight:500}
  .small{font-size:13px;color:var(--muted);margin-top:8px;line-height:1.5}
  .hidden{display:none}

  .champ-requis-manquant {
  border: 3px solid #ef4444 !important;
  background: #fef2f2 !important;
  animation: shake 0.5s;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

.error-message-inline {
  color: #dc2626;
  font-weight: 600;
  font-size: 14px;
  margin-top: 6px;
  display: block;
}

.zone-communes-encadree {
  border: 2px solid #3b82f6;
  border-radius: 12px;
  padding: 0;
  margin-top: 20px;
}
  
  .custom-tooltip {
    background: white;
    border: 2px solid #0ea5a4;
    border-radius: 8px;
    padding: 8px 12px;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  .success-banner{background:#d1fae5;border:2px solid #10b981;padding:24px;border-radius:12px;margin-top:24px;text-align:center}
  .section-number{background:var(--primary);color:white;min-width:28px;width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0}

  .zone-communes-container {
    background: white;
    border-radius: 12px;
    padding: 0;
    margin-top: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }

  .zone-communes-header {
  padding: 8px 28px 20px 28px;
  border-bottom: 2px solid #f3f4f6;
}

  .zone-communes-title {
    margin: 0 0 8px 0;
    font-size: 18px;
    font-weight: 700;
    color: #0f1724;
  }

  .zone-communes-stats {
    margin: 0;
    font-size: 14px;
    color: #6b7280;
    font-weight: 500;
  }

  .info-discrete {
    background: #f9fafb;
    border-left: 3px solid #3b82f6;
    padding: 16px 20px;
    margin: 20px 28px;
    border-radius: 8px;
    font-size: 14px;
    line-height: 1.6;
    color: #4b5563;
  }

  .deux-colonnes {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    background: #e5e7eb;
    margin: 0;
  }

  .colonne {
    background: white;
    padding: 24px 28px;
  }

  .colonne-titre {
    font-size: 15px;
    font-weight: 600;
    color: #0f1724;
    margin: 0 0 16px 0;
  }

  .liste-communes-colonne {
    max-height: 350px;
    overflow-y: auto;
    background: #f9fafb;
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    line-height: 1.8;
    color: #4b5563;
  }

  .liste-communes-colonne > div {
    padding: 4px 0;
    border-bottom: 1px solid #f3f4f6;
  }

  .carte-colonne {
    height: 350px;
    background: #f9fafb;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    position: relative;
  }

  .carte-legende {
    display: flex;
    gap: 16px;
    margin-top: 12px;
    font-size: 13px;
    color: #6b7280;
  }

  .carte-legende-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .carte-legende-point {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }

  .actions-communes {
    padding: 24px 28px;
    border-top: 2px solid #f3f4f6;
  }

  .btn-principal-epure {
    padding: 12px 24px;
    background: #0ea5a4;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 15px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-principal-epure:hover {
    background: #0d8887;
    transform: translateY(-1px);
  }

  .lien-secondaire {
    color: #6b7280;
    font-size: 14px;
    text-decoration: none;
    cursor: pointer;
    border-bottom: 1px dashed #d1d5db;
    padding-bottom: 2px;
  }

  .recherche-moderne {
    position: relative;
  }

  .recherche-moderne input {
    width: 100%;
    padding: 12px 16px 12px 40px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
  }

  .recherche-moderne::before {
    content: 'üîç';
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 16px;
  }

  @media(max-width:768px){
    .deux-colonnes{grid-template-columns: 1fr;}
  }
</style>
</head>
  
<body>
<div class="wrap">
  <div class="nav-header">
    <h1>Questionnaire de r√©f√©rencement</h1>
    <nav class="nav-links">
      <a href="index.html">Accueil</a>
      <a href="formulaire.html" class="active">Formulaire</a>
      <a href="faq.html">FAQ</a>
      <a href="mentions.html">Mentions l√©gales</a>
    </nav>
  </div>
  
  <div class="card">
    <div id="headerTexts">
      <h2>Compl√©tez vos informations professionnelles pour √™tre r√©f√©renc√© sur la plateforme</h2>
      <div class="info-box">
        <strong>‚è±Ô∏è Temps estim√© :</strong> 5 √† 10 minutes maximum
      </div>
    </div>

    <div id="section-email">
      <h3 class="section-title">1Ô∏è‚É£ V√©rification de votre identit√©</h3>
      <p class="small" style="margin-top:8px">
        Les questions avec un <span style="color:#ef4444;font-weight:bold">*</span> sont obligatoires.
      </p>

      <label for="email" class="required">Adresse e-mail professionnelle</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="email" type="email" placeholder="exemple@professionnel.fr" autocomplete="email"/>
        <button id="sendCodeBtn" type="button">üìß V√©rifier mon mail</button>
      </div>
      <div id="emailMsg" class="small"></div>

      <div id="codeArea" class="hidden" style="margin-top:12px">
        <label for="code" class="required">Code de v√©rification (envoy√© par e-mail)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="code" type="text" placeholder="000000" inputmode="numeric"/>
          <button id="verifyBtn" type="button">Valider le code</button>
          <button id="resendBtn" class="btn-secondary" type="button" style="width:auto;padding:10px 14px">Renvoyer</button>
        </div>
        <div id="codeMsg" class="small"></div>
      </div>

      <div id="newUserMessage" class="hidden" style="background:#e6f7f7;border:2px solid #0ea5a4;padding:18px;border-radius:12px;margin-top:16px;text-align:center">
        <div style="font-size:36px;margin-bottom:8px">üëã</div>
        <h3 style="margin:0 0 8px;color:#0f1724;font-size:18px">Bienvenue !</h3>
        <p class="small" style="margin:0">Vous √™tes un nouvel utilisateur. Merci de remplir le formulaire ci-dessous.</p>
      </div>

      <div id="existingUserChoice" class="hidden" style="margin-top:16px">
        <div style="background:#f0f9ff;border:2px solid #3b82f6;padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:36px;margin-bottom:8px">‚úÖ</div>
          <h3 style="margin:0 0 8px;color:#0f1724;font-size:18px">Bon retour !</h3>
          <p class="small" style="margin:0 0 12px">Vos informations sont d√©j√† enregistr√©es. Que souhaitez-vous faire ?</p>
          <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
            <button id="modifyBtn" type="button" style="background:#3b82f6;padding:10px 18px;color:#fff;border-radius:8px">‚úèÔ∏è Modifier mes informations</button>
            <button id="deleteBtn" type="button" class="btn-secondary" style="background:#fee;color:#dc2626;border:2px solid #dc2626;padding:10px 18px;border-radius:8px">üóëÔ∏è Supprimer mes informations</button>
          </div>
        </div>
      </div>

      <div id="deleteConfirmation" class="hidden" style="margin-top:16px">
        <div style="background:#fee;border:2px solid #dc2626;padding:16px;border-radius:12px">
          <h3 style="margin:0 0 8px;color:#dc2626;font-size:16px">‚ö†Ô∏è Confirmer la suppression</h3>
          <p class="small" style="margin:0 0 12px">√ätes-vous s√ªr(e) de vouloir supprimer d√©finitivement vos informations ? Cette action est <strong>irr√©versible</strong>.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="confirmDeleteBtn" type="button" style="background:#dc2626;color:#fff;padding:10px 16px;border-radius:8px">‚úì Oui, supprimer</button>
            <button id="cancelDeleteBtn" type="button" class="btn-secondary" style="padding:10px 16px;border-radius:8px">‚úï Annuler</button>
          </div>
          <div id="deleteMsg" class="small" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <form id="form" class="hidden" onsubmit="return false;">
      <div class="prereq-section">
        <div style="font-weight:700;margin-bottom:8px">Pr√©requis</div>
        <label style="margin-top:0" class="required">Avez-vous un num√©ro professionnel ?</label>
        <div style="margin-top:12px">
          <label class="inline"><input type="radio" name="numType" value="siret"> Oui, j'ai un num√©ro SIRET</label>
          <label class="inline"><input type="radio" name="numType" value="none"> Non, je n'ai pas de num√©ro</label>
        </div>

        <div id="siretBlock" class="hidden">
          <label for="siretNum" class="required">Quel est votre num√©ro SIRET ?</label>
          <input id="siretNum" name="siretNum" type="text" maxlength="14" inputmode="numeric" placeholder="14 chiffres"/>
          <div id="siretErr" class="error"></div>
        </div>

        <div id="noNum" class="error hidden">Ce questionnaire n'est autoris√© que pour les professionnels ayant un num√©ro de SIRET.</div>
      </div>

      <div id="rest" class="hidden">
        <div class="section-title"><span class="section-number">1</span> Identit√© et coordonn√©es</div>

        <label for="nom" class="required">Nom</label>
        <input id="nom" name="nom" type="text"/>

        <label for="prenom" class="required">Pr√©nom</label>
        <input id="prenom" name="prenom" type="text"/>

        <label for="phone">T√©l√©phone (optionnel)</label>
        <input id="phone" name="phone" type="tel" placeholder="0X XX XX XX XX ou +33..."/>

        <div class="section-title"><span class="section-number">2</span> Activit√© professionnelle</div>

        <label for="profession" class="required">Profession</label>
        <select id="profession" name="profession">
          <option value="">-- s√©lectionnez --</option>
          <option>√âducateur sp√©cialis√©</option>
          <option>Ergoth√©rapeute</option>
          <option>Psychologue</option>
          <option>Psychomotricien</option>
          <option>Orthophoniste</option>
        </select>

        <label style="margin-top:24px" class="required">Aupr√®s de quel(s) public(s) intervenez-vous ?</label>
        <div class="small" style="margin-top:4px">Vous pouvez s√©lectionner plusieurs r√©ponses.</div>
        <div style="margin-top:12px">
          <label><input type="checkbox" name="public" value="0-6"> Enfants (0-6 ans)</label>
          <label><input type="checkbox" name="public" value="7-12"> Enfants (7-12 ans)</label>
          <label><input type="checkbox" name="public" value="13-18"> Adolescents (13-18 ans)</label>
          <label><input type="checkbox" name="public" value="18+"> Adultes (18+)</label>
        </div>
        
        <label style="margin-top:24px" class="required">Quel est votre mode d'intervention principal ?</label>
        <div style="margin-top:12px">
          <label><input type="radio" name="modeIntervention" value="cabinet"> Uniquement en cabinet</label>
          <label><input type="radio" name="modeIntervention" value="deplacement"> Je me d√©place au domicile</label>
          <label><input type="radio" name="modeIntervention" value="mixte"> Les deux (cabinet + d√©placements)</label>
        </div>

        <label style="margin-top:24px" class="required">Proposez-vous des rendez-vous en visio ?</label>
        <div style="margin-top:12px">
          <label><input type="radio" name="visio" value="oui"> Oui</label>
          <label><input type="radio" name="visio" value="non"> Non</label>
        </div>

        <div id="section-geo" class="hidden">
          <div class="section-title" style="margin-top:32px"><span class="section-number">3</span> Zone g√©ographique d'intervention</div>

          <label for="departement" class="required">Dans quel d√©partement intervenez-vous ?</label>
          <select id="departement" name="departement"><option value="">-- Chargement --</option></select>

          <div id="blocCommune" class="hidden">
            <label for="commune" class="required" id="labelCommune">Quelle est votre commune d'intervention ?</label>
            <select id="commune" name="commune"><option value="">-- Choisissez le d√©partement --</option></select>
          </div>

          <div id="questionsDeplacements" class="hidden">
            
            <div id="zoneMetropole" class="hidden">
              <label for="tempsTrajet" class="required">Quel est votre temps de trajet maximal ?</label>
              <select id="tempsTrajet" name="tempsTrajet" style="margin-top:8px;">
                <option value="">-- S√©lectionnez --</option>
                <option>15 min</option>
                <option>20 min</option>
                <option>25 min</option>
                <option>30 min</option> 
                <option>35 min</option>
                <option>40 min</option>                
                <option>45 min</option>
              </select>
              <div class="small" style="margin-top:4px;">Temps de trajet en voiture depuis votre commune principale.</div>
            </div>

            <div id="zoneOutreMer" class="hidden">
              <label for="rayonKm" class="required">Quel est votre rayon d'intervention (en km) ?</label>
              <select id="rayonKm" name="rayonKm" style="margin-top:8px;">
                <option value="">-- S√©lectionnez --</option>
                <option>10 km</option>
                <option>15 km</option>
                <option>20 km</option>
                <option>25 km</option>
                <option>30 km</option>
                <option>40 km</option>
                <option>Tout mon d√©partement</option>
              </select>
              <div class="small" style="margin-top:4px;">Distance √† vol d'oiseau depuis votre commune.</div>

              <label for="precisionsGeo" style="margin-top:20px">Pr√©cisions g√©ographiques (optionnel)</label>
              <textarea id="precisionsGeo" name="precisionsGeo" rows="3" placeholder="Ex: Je couvre uniquement certains quartiers..."></textarea>
            </div>

            <div id="communesCalculeesZone" class="hidden">
                <div class="zone-communes-encadree">
              <div class="zone-communes-container">
                <div class="zone-communes-header">
                  <h4 class="zone-communes-title">Communes couvertes par votre intervention</h4>
                  <p class="zone-communes-stats" id="communesCalculeesInfo">Calcul en cours...</p>
                </div>
                
                <div class="deux-colonnes">
                  <div class="colonne">
                    
                    <div id="vueListeCommunes">
                      <h5 class="colonne-titre">üìã Liste des communes</h5>
                      <div id="communesCalculeesListe" class="liste-communes-colonne">
                        <div style="text-align: center; color: #999; padding: 20px;">Calcul en cours...</div>
                      </div>
                    </div>

                    <div id="vuePersonnalisation" class="hidden">
                      <h5 class="colonne-titre">‚úèÔ∏è Personnaliser ma zone</h5>
                      <div style="background: #f0f9ff; border-left: 3px solid #3b82f6; padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; font-size: 13px; line-height: 1.5; color: #1e40af;">
                        <strong>üí° Comment √ßa marche ?</strong><br>
                        D√©cochez les communes o√π vous n'intervenez pas. 
                        Vous pouvez aussi ajouter n'importe quelle commune en France (m√™me hors d√©partement) avec la recherche ci-dessous.
                      </div>
                      <!-- 1Ô∏è‚É£ D'ABORD : Cochez/d√©cochez -->
                       <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                          <p style="margin: 0; font-size: 13px; color: #6b7280; font-weight: 600;">Cochez/d√©cochez les communes</p>
                          <span id="compteurCommunes" style="font-size: 14px; color: #6b7280; font-weight: 600;">0 commune(s)</span>
                        </div>
                        <div style="background: white; border: 2px solid #e5e7eb; border-radius: 8px; max-height: 300px; overflow-y: auto;">
                          <div id="listeCommunesCheckboxes">
                            <p style="color: #999; text-align: center; padding: 20px; margin: 0;">Chargement...</p>
                          </div>
                        </div>
                      </div>
                      <!-- 2Ô∏è‚É£ ENSUITE : Rechercher et ajouter -->
                       <div>
                        <p style="margin: 0 0 12px 0; font-size: 13px; color: #6b7280; font-weight: 600;">Ajouter une commune manquante</p>
                        <div class="recherche-moderne">
                          <input type="text" id="rechercheCommune" placeholder="Ex: Nancy, Paris..." oninput="rechercherCommuneEnTempsReel()" autocomplete="off"/>
                        </div>
                        <div id="resultatsRecherche" style="margin-top: 8px;"></div>
                      </div>
                    </div>
                   </div>
                  
                  <div class="colonne">
                    <h5 class="colonne-titre">üó∫Ô∏è Visualisation g√©ographique</h5>
                    <div class="carte-colonne">
                      <div id="mapLoadingIndicator" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: center;">
                        <div style="font-size: 36px; margin-bottom: 12px;">‚è≥</div>
                        <div style="font-size: 14px; font-weight: 600; color: #0ea5a4;">Chargement de la carte...</div>
                      </div>
                      <div id="mapPrincipal" style="height: 100%; width: 100%;"></div>
                    </div>
                    <div class="carte-legende">
                      <div class="carte-legende-item">
                        <span class="carte-legende-point" style="background: #ef4444;"></span>
                        <span>Commune centrale</span>
                      </div>
                      <div class="carte-legende-item">
                        <span class="carte-legende-point" style="background: #3b82f6;"></span>
                        <span>Autres communes</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="actions-communes" id="btnGroupeCommunes" style="display: none;">
                  <!-- Message d'avertissement (masqu√© par d√©faut) -->
                   <div id="avertissementCommunes" style="display: none; background: #fff3cd; border-left: 4px solid #f59e0b; padding: 16px 20px; border-radius: 8px; margin-bottom: 16px;">
                    <strong style="color: #92400e; font-size: 15px;">‚ö†Ô∏è V√©rification recommand√©e</strong>
                    <p style="margin: 8px 0 0 0; line-height: 1.5; font-size: 14px; color: #78350f;">
                      Cette liste est <strong>g√©n√©r√©e automatiquement</strong> et peut contenir des erreurs. 
                      <strong>Nous vous conseillons vivement de la v√©rifier</strong> pour √©viter des demandes hors de votre zone ou de manquer des opportunit√©s.
                    </p>
                  </div>
  
  <div id="boutons-validation" style="display: flex; gap: 20px; flex-wrap: wrap;">
    <button type="button" onclick="afficherInterfaceModification()" class="btn-principal-epure">V√©rifier et ajuster</button>
    <a href="#" onclick="validerCommunes(); return false;" class="lien-secondaire">Cette liste me convient</a>
  </div>
                
                
                  
                  <div id="boutons-personnalisation" class="hidden" style="display: flex; gap: 12px;">
                    <button type="button" onclick="validerModifications()" class="btn-principal-epure" style="flex: 1;">‚úì Enregistrer mes choix</button>
                    <button type="button" onclick="annulerModifications()" style="flex: 1; padding: 12px 24px; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">‚úï Annuler</button>
                  </div>
                  
                  <div id="zone-validee-badge" class="hidden" style="width: 100%;">
                    <div style="padding: 14px 24px; background: #d1fae5; border: 2px solid #10b981; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                      <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 24px;">‚úÖ</span>
                        <div>
                          <div style="font-size: 15px; font-weight: 700; color: #059669;">Zone valid√©e</div>
                          <div id="zone-validee-nb" style="font-size: 13px; color: #047857; margin-top: 2px;">0 communes</div>
                        </div>
                      </div>
                      <button type="button" onclick="afficherInterfaceModification()" style="padding: 8px 16px; background: white; color: #059669; border: 2px solid #10b981; border-radius: 6px; font-weight: 600; cursor: pointer;">‚úèÔ∏è Modifier</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
        
        <div class="section-title"><span class="section-number">4</span> Disponibilit√©s</div>
        <label class="required">Avez-vous des disponibilit√©s pour de nouveaux b√©n√©ficiaires ?</label>
        <div style="margin-top:12px">
          <label><input type="radio" name="dispo" value="oui"> Oui</label>
          <label><input type="radio" name="dispo" value="non"> Non</label>
        </div>
        
        <div id="dateBlock" class="hidden">
          <label for="dateDispo" class="required">√Ä partir de quelle date √™tes-vous disponible ?</label>
          <input id="dateDispo" name="dateDispo" type="date"/>
          
          <label for="placesDisponibles" class="required" style="margin-top:20px">Combien de nouveaux b√©n√©ficiaires pourrez-vous accueillir ?</label>
          <input id="placesDisponibles" name="placesDisponibles" type="number" min="1" max="10" placeholder="Ex: 1" style="width: 150px;margin-top:8px"/>
          <div class="small" style="margin-top:6px;">Indiquez le nombre de places disponibles (entre 1 et 10)</div>
        </div>

        <div id="modeContactBlock" class="hidden">
          <div class="section-title" style="margin-top:32px"><span class="section-number">5</span> Pr√©f√©rences de contact</div>
          
          <label class="required">Comment souhaitez-vous √™tre contact√© par les particuliers ?</label>
          <div class="info-box" style="margin-top:8px">
            <strong>‚ÑπÔ∏è Important :</strong> Cette option d√©termine si vos coordonn√©es seront visibles directement.
          </div>
          
          <div style="margin-top:12px">
            <label>
              <input type="radio" name="modeContact" value="direct">
              <strong>üìß Contact direct</strong>
              <div class="small" style="margin-left:24px;margin-top:4px">Mon email et mon t√©l√©phone seront affich√©s.</div>
            </label>
            
            <label style="margin-top:12px">
              <input type="radio" name="modeContact" value="formulaire">
              <strong>üìù Contact via formulaire uniquement</strong>
              <div class="small" style="margin-left:24px;margin-top:4px">Mes coordonn√©es restent priv√©es.</div>
            </label>
          </div>
        </div>
        
        <div class="section-title" style="margin-top:32px"><span class="section-number" id="consentNumber">5</span> Consentement</div>
        <label style="margin-top:0;display:flex;align-items:start;gap:8px" class="required">
          <input id="consent" name="consent" type="checkbox" style="margin-top:4px"/>
          <span>J'accepte que mes donn√©es soient utilis√©es uniquement dans le cadre de cette mise en relation.</span>
        </label>

        <div class="actions" style="display:flex;gap:12px;align-items:center;margin-top:24px;flex-wrap:wrap">
          <button id="submit" type="button">‚úì Enregistrer mes informations</button>
          <button id="editBtn" type="button" class="hidden">‚úèÔ∏è Modifier mes informations</button>
          <button id="resetBtn" type="button" class="btn-secondary">R√©initialiser</button>
        </div>
        <div id="submitMsg" class="small" style="margin-top:12px"></div>
      </div>
    </form>

    <div id="successBanner" class="success-banner hidden">
      <div style="font-size:64px;margin-bottom:16px">‚úÖ</div>
      <h3 style="margin:0 0 12px;color:#0f1724;font-size:24px;font-weight:700">Formulaire envoy√© avec succ√®s !</h3>
      <p style="margin:0 0 16px;color:#059669;font-size:16px;font-weight:600">Vous avez re√ßu un email de confirmation.</p>
    </div>
  </div>

  <footer>
    <p>
      <a href="index.html">Accueil</a> ‚Ä¢ 
      <a href="faq.html">FAQ</a> ‚Ä¢ 
      <a href="mentions.html">Mentions l√©gales</a>
    </p>
    <p style="margin-top:12px;font-size:13px">¬© 2025 - R√©f√©rencement Professionnels TSA</p>
  </footer>
  
</div>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbww78Q-FrcILGHJu0O0lRgajYaFn9qJPq8ViSwDEixSOQ_ZiTWgJVX64mMcNHwirwFf/exec"; 
const DEPT_API = "https://geo.api.gouv.fr/departements";

// 
async function fetchWithErrorHandling(url, options = {}) {
  try {
    const response = await fetch(url, {
      ...options,
      signal: AbortSignal.timeout(15000)
    });
    
    if (!response.ok) {
      throw new Error('NETWORK_ERROR');
    }
    
    const result = await response.json();
    return { ok: true, data: result };
    
  } catch (error) {
    console.error('Erreur fetch:', error);
    
    // Messages adapt√©s selon le type d'erreur
    if (error.name === 'AbortError' || error.message === 'NETWORK_ERROR') {
      return { 
        ok: false, 
        error: 'CONNECTION_ERROR',
        message: 'üåê Connexion impossible. V√©rifiez votre connexion internet et r√©essayez dans quelques instants.'
      };
    }
    
    return { 
      ok: false, 
      error: 'UNKNOWN_ERROR',
      message: '‚ö†Ô∏è Une erreur temporaire est survenue. Veuillez r√©essayer dans quelques minutes.'
    };
  }
}

let communesCalculeesSaved = [];
let communesValidees = false;
let listeModifieeManuelle = false;
let mapPrincipal = null;
let communeLayersPrincipal = {};

const isDigits = s => /^\d+$/.test(s||"");
const validSiret = v => isDigits(v) && v.length === 14;
const validPhone = v => {
  if(!v) return true;
  const c = v.replace(/\s|\-|\(|\)|\./g,"");
  return /^(0[1-9]\d{8}|\+33[1-9]\d{8})$/.test(c) || /^[0-9]{10,15}$/.test(c);
};

const emailEl = document.getElementById("email");
const sendCodeBtn = document.getElementById("sendCodeBtn");
const emailMsg = document.getElementById("emailMsg");
const codeArea = document.getElementById("codeArea");
const codeEl = document.getElementById("code");
const verifyBtn = document.getElementById("verifyBtn");
const resendBtn = document.getElementById("resendBtn");
const codeMsg = document.getElementById("codeMsg");  // ‚Üê D√âPLAC√â ICI EN PREMIER
const formEl = document.getElementById("form");
const siretBlock = document.getElementById("siretBlock");
const noNum = document.getElementById("noNum");
const rest = document.getElementById("rest");
const siretNum = document.getElementById("siretNum");
const siretErr = document.getElementById("siretErr");
const submitBtn = document.getElementById("submit");
const editBtn = document.getElementById("editBtn");
const submitMsg = document.getElementById("submitMsg");
const departSelect = document.getElementById("departement");
const communeSelect = document.getElementById("commune");
const dateBlock = document.getElementById("dateBlock");
const dateInput = document.getElementById("dateDispo");
const resetBtn = document.getElementById("resetBtn");
const newUserMessage = document.getElementById("newUserMessage");
const existingUserChoice = document.getElementById("existingUserChoice");
const deleteConfirmation = document.getElementById("deleteConfirmation");
const modifyBtn = document.getElementById("modifyBtn");
const deleteBtn = document.getElementById("deleteBtn");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
const deleteMsg = document.getElementById("deleteMsg");
const successBanner = document.getElementById("successBanner");
const placesInput = document.getElementById("placesDisponibles");
const modeContactBlock = document.getElementById("modeContactBlock");
const consentNumber = document.getElementById("consentNumber");

// ============================================================
// BOUTON RENVOYER LE CODE
// ============================================================
resendBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  if (!mail) {
    codeMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ö†Ô∏è Adresse email requise</span>`;
    return;
  }
  
  resendBtn.disabled = true;
  resendBtn.textContent = "‚è≥ Envoi...";
  codeMsg.textContent = "";
  
  const result = await fetchWithErrorHandling(
    `${SCRIPT_URL}?action=sendCode&email=${encodeURIComponent(mail)}&_t=${Date.now()}`
  );
  
  resendBtn.disabled = false;
  resendBtn.textContent = "Renvoyer";
  
  if (!result.ok) {
    codeMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">${result.message}</span>`;
    return;
  }
  
  const j = result.data;
  
  // ‚úÖ ORDRE CORRECT DES V√âRIFICATIONS :
  
  // 1. Cooldown (PRIORITAIRE)
  if (j.error === "COOLDOWN_ACTIVE") {
    codeMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è ${j.message}</span>`;
    return;
  }
  
  // 2. Quota quotidien
  if (j.error === "DAILY_LIMIT_REACHED") {
    codeMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ùå ${j.message}</span>`;
    return;
  }
  
  // 3. Quota service
  if (j.error === "SERVICE_QUOTA_EXCEEDED") {
    codeMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚ö†Ô∏è ${j.message}</span>`;
    return;
  }
  
  // 4. Email invalide
  if (j.error === "EMAIL_INVALIDE") {
    codeMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ùå ${j.message}</span>`;
    return;
  }
  
  // 5. Code d√©j√† valide
  if (j.alreadySent) {
    codeMsg.innerHTML = `<span style="color:#059669;font-weight:600">‚úÖ ${j.message}</span>`;
    return;
  }
  
  // 6. Succ√®s
  if (j.ok) {
    codeMsg.innerHTML = `<span style="color:#059669;font-weight:600">‚úÖ Nouveau code envoy√© !</span>`;
    codeEl.value = "";
    codeEl.focus();
  } else {
    codeMsg.innerHTML = `<span style="color:#dc2626">‚ùå ${j.error || "Erreur"}</span>`;
  }
});


let CURRENT_EMAIL = null;
let EXISTING = false;
let EXISTING_DATA = null;
let FORM_LOCKED = false;

const DEPS_METRO = ['01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','21','22','23','24','25','26','27','28','29','2A','2B','30','31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46','47','48','49','50','51','52','53','54','55','56','57','58','59','60','61','62','63','64','65','66','67','68','69','70','71','72','73','74','75','76','77','78','79','80','81','82','83','84','85','86','87','88','89','90','91','92','93','94','95'];
const DEPS_DOMTOM = ['971','972','973','974','976'];

function updateSectionGeo() {
  const modeIntervention = document.querySelector('input[name="modeIntervention"]:checked');
  const codeDept = departSelect.value;
  
  const sectionGeo = document.getElementById('section-geo');
  const blocCommune = document.getElementById('blocCommune');
  const questionsDeplacements = document.getElementById('questionsDeplacements');
  const zoneMetropole = document.getElementById('zoneMetropole');
  const zoneOutreMer = document.getElementById('zoneOutreMer');
  const labelCommune = document.getElementById('labelCommune');
  
  sectionGeo.classList.add('hidden');
  blocCommune.classList.add('hidden');
  questionsDeplacements.classList.add('hidden');
  zoneMetropole.classList.add('hidden');
  zoneOutreMer.classList.add('hidden');
  
  if (!modeIntervention) return;
  
  const valeur = modeIntervention.value;
  
  if (valeur === 'cabinet') {
    sectionGeo.classList.remove('hidden');
    labelCommune.textContent = 'Quelle est votre commune d\'intervention ?';
    questionsDeplacements.classList.add('hidden');
    
    if (departSelect.value) {
      blocCommune.classList.remove('hidden');
    }
    
  } else if (valeur === 'deplacement' || valeur === 'mixte') {
    sectionGeo.classList.remove('hidden');
    labelCommune.textContent = 'Quelle est votre commune principale d\'intervention ?';
    
    if (departSelect.options.length <= 1) {
      loadDepartements();
    }
    
    if (codeDept) {
      blocCommune.classList.remove('hidden');
      questionsDeplacements.classList.remove('hidden');
      
      if (DEPS_METRO.includes(codeDept)) {
        zoneMetropole.classList.remove('hidden');
        zoneOutreMer.classList.add('hidden');
        
      } else if (DEPS_DOMTOM.includes(codeDept)) {
        zoneMetropole.classList.add('hidden');
        zoneOutreMer.classList.remove('hidden');
      }
    }
  }
}

document.querySelectorAll('input[name="modeIntervention"]').forEach(radio => {
  radio.addEventListener('change', () => {
    // R√©initialiser les s√©lections
    departSelect.value = "";
    communeSelect.innerHTML = '<option value="">-- Choisissez d\'abord un d√©partement --</option>';
    
    // R√©initialiser les temps/rayons
    const tempsTrajet = document.getElementById("tempsTrajet");
    const rayonKm = document.getElementById("rayonKm");
    if (tempsTrajet) tempsTrajet.value = "";
    if (rayonKm) rayonKm.value = "";
    
    resetZoneCommunes();
    communesValidees = false;
    communesCalculeesSaved = [];
    listeModifieeManuelle = false;
    updateSectionGeo();
  });
});

function lockForm() {
  FORM_LOCKED = true;
  formEl.style.display = 'none';
  
  const sectionEmail = document.getElementById('section-email');
  if (sectionEmail) sectionEmail.style.display = 'none';
  
  const h2 = document.querySelector('.card h2');
  if (h2) h2.style.display = 'none';
  
  const infoBox = document.querySelector('.info-box');
  if (infoBox) infoBox.style.display = 'none';
  
  successBanner.classList.remove('hidden');
  
  setTimeout(() => {
    successBanner.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 300);
}
  
function unlockForm() {
  FORM_LOCKED = false;
  formEl.style.display = 'block';
  
  document.querySelectorAll('#form input, #form select, #form textarea').forEach(el => {
    el.disabled = false;
  });
  
  submitBtn.classList.remove('hidden');
  editBtn.classList.add('hidden');
  resetBtn.classList.remove('hidden');
  
  successBanner.classList.add('hidden');
  submitMsg.textContent = "";
}

editBtn.addEventListener('click', () => {
  unlockForm();
});

sendCodeBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  if (!mail) { 
    emailMsg.textContent = "Merci d'indiquer une adresse e-mail."; 
    return; 
  }
  
  emailMsg.textContent = "Envoi du code en cours...";
  sendCodeBtn.disabled = true;
  
  const result = await fetchWithErrorHandling(
    `${SCRIPT_URL}?action=sendCode&email=${encodeURIComponent(mail)}&_t=${Date.now()}`
  );
  
  sendCodeBtn.disabled = false;
  
  if (!result.ok) {
    emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">${result.message}</span>`;
    return;
  }

  const j = result.data;
    
    if (j.error === "DAILY_LIMIT_REACHED") {
      emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ùå Limite quotidienne atteinte</span>`;
      sendCodeBtn.disabled = false;
      return;
    }
  
  if (j.error === "COOLDOWN_ACTIVE") {
    emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">${j.message}</span>`;
    sendCodeBtn.disabled = false;
    return;
  }
  
  if (j.error === "SERVICE_QUOTA_EXCEEDED") {
    emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚ö†Ô∏è Service temporairement satur√©</span><br><span style="color:#6b7280;font-size:13px">Trop de demandes aujourd'hui. R√©essayez demain.</span>`;
    sendCodeBtn.disabled = false;
    return;
  }
  
  if (j.error === "EMAIL_INVALIDE") {
    emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ùå Email invalide</span><br><span style="color:#6b7280;font-size:13px">V√©rifiez votre adresse email.</span>`;
    sendCodeBtn.disabled = false;
    return;
  }
    
    if (j.ok) {
      emailMsg.innerHTML = `<span style="color:#059669;font-weight:600">‚úì Code envoy√©</span><br><span style="color:#6b7280">V√©rifiez votre bo√Æte mail.</span>`;
      CURRENT_EMAIL = mail;
      codeArea.classList.remove("hidden");
      sendCodeBtn.style.display = "none";
      codeEl.focus();
    } else {
      emailMsg.innerHTML = `<span style="color:#dc2626">Erreur : ${j.error || "Impossible d'envoyer"}</span>`;
    }
});

codeEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    verifyBtn.click();
  }
});

emailEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendCodeBtn.click();
  }
});

verifyBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  const code = (codeEl.value || "").trim();
  if (!mail || !code) { codeMsg.textContent = "Merci d'indiquer l'adresse e-mail et le code."; return; }
  codeMsg.textContent = "V√©rification...";
  
  const result = await fetchWithErrorHandling(
    `${SCRIPT_URL}?action=verifyCode&email=${encodeURIComponent(mail)}&code=${encodeURIComponent(code)}&_t=${Date.now()}`
  );
  
  if (!result.ok) {
    codeMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">${result.message}</span>`;
    return;
  }
  const j = result.data;
    if (!j.ok) { codeMsg.textContent = "Erreur : " + (j.error||"code invalide"); return; }
    
    codeMsg.textContent = "‚úÖ E-mail v√©rifi√© !";
    CURRENT_EMAIL = mail;
    codeArea.style.display = "none";
    emailMsg.style.display = "none";
    emailEl.disabled = true;
    sendCodeBtn.style.display = "none";
    
    await loadDepartements();
    
    if (j.existing && j.data) {
      EXISTING = true;
      EXISTING_DATA = j.data;
      existingUserChoice.classList.remove("hidden");
    } else {
      EXISTING = false;
      EXISTING_DATA = null;
      newUserMessage.classList.remove("hidden");
      formEl.classList.remove("hidden");
      rest.classList.add("hidden");
    }
});

modifyBtn.addEventListener("click", async () => {
  existingUserChoice.classList.add("hidden");
  await showFormAndPrefill(EXISTING_DATA);
});

deleteBtn.addEventListener("click", () => {
  existingUserChoice.classList.add("hidden");
  deleteConfirmation.classList.remove("hidden");
});

cancelDeleteBtn.addEventListener("click", () => {
  deleteConfirmation.classList.add("hidden");
  existingUserChoice.classList.remove("hidden");
  deleteMsg.textContent = "";
});

confirmDeleteBtn.addEventListener("click", async () => {
  deleteMsg.textContent = "Suppression en cours...";
  confirmDeleteBtn.disabled = true;
  cancelDeleteBtn.disabled = true;
  
  try {
    const fd = new FormData();
  fd.append("action", "deleteUser");
  fd.append("email", CURRENT_EMAIL);
  
  const result = await fetchWithErrorHandling(SCRIPT_URL, { method: "POST", body: fd });
  
  if (!result.ok) {
    deleteMsg.innerHTML = `<span style="color:#dc2626">‚ùå ${result.message}</span>`;
    confirmDeleteBtn.disabled = false;
    cancelDeleteBtn.disabled = false;
    return;
  }
  
  const j = result.data;
    
    if (j.ok) {
      document.body.innerHTML = `
        <div style="max-width: 600px; margin: 80px auto; text-align: center; padding: 0 20px;">
          <div style="background: #d1fae5; border: 2px solid #10b981; padding: 48px 32px; border-radius: 16px;">
            <div style="font-size: 72px; margin-bottom: 24px;">‚úÖ</div>
            <h2 style="margin: 0 0 16px; color: #0f1724;">Suppression effectu√©e</h2>
            <p style="color: #059669;">Vos informations ont √©t√© supprim√©es.</p>
            <a href="index.html" style="display: inline-block; margin-top: 24px; padding: 12px 24px; background: #0ea5a4; color: white; text-decoration: none; border-radius: 8px;">‚Üê Retour</a>
          </div>
        </div>
      `;
    } else {
      deleteMsg.innerHTML = '<span style="color:#dc2626">‚ùå Erreur</span>';
      confirmDeleteBtn.disabled = false;
      cancelDeleteBtn.disabled = false;
    }
  } catch (error) {
    console.error('Erreur suppression:', error);
    deleteMsg.innerHTML = '<span style="color:#dc2626">‚ùå Erreur de connexion</span>';
    confirmDeleteBtn.disabled = false;
    cancelDeleteBtn.disabled = false;
  }
});

document.querySelectorAll('input[name="numType"]').forEach(r => r.addEventListener('change', e => {
  const v = e.target.value;
  siretErr.textContent = "";
  siretNum.value = "";
  siretBlock.classList.add("hidden"); 
  noNum.classList.add("hidden");
  rest.classList.add("hidden");
  if (v === "siret") siretBlock.classList.remove("hidden");
  else noNum.classList.remove("hidden");
}));

siretNum.addEventListener('input', () => {
  const v = siretNum.value.trim();
  if (v.length === 14 && validSiret(v)) {
    siretErr.textContent = ""; 
    rest.classList.remove("hidden");
  } else if (v.length === 14) {
    siretErr.textContent = "SIRET invalide."; 
    rest.classList.add("hidden");
  }
});

document.querySelectorAll('input[name="dispo"]').forEach(r => r.addEventListener('change', e => {
  const show = e.target.value === "oui";
  dateBlock.classList.toggle("hidden", !show);
  modeContactBlock.classList.toggle("hidden", !show);
  
  consentNumber.textContent = show ? "6" : "5";
  
  if (show) {
    dateInput.setAttribute("min", new Date().toISOString().split("T")[0]);
  } else {
    dateInput.value = "";
    placesInput.value = "";
    document.querySelectorAll('input[name="modeContact"]').forEach(r => r.checked = false);
  }
}));

placesInput.addEventListener('input', function() {
  const value = parseInt(this.value);
  if (value < 1) this.value = 1;
  else if (value > 99) this.value = 99;
});

async function loadDepartements(){
  departSelect.innerHTML = '<option value="">-- chargement --</option>';
  try {
    const r = await fetch(DEPT_API);
    const list = await r.json();
    departSelect.innerHTML = '<option value="">-- s√©lectionnez --</option>';
    list.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.code;
      opt.textContent = `${d.code} ‚Äî ${d.nom}`;
      departSelect.appendChild(opt);
    });
  } catch (err) {
  console.error('Erreur chargement d√©partements:', err);
  departSelect.innerHTML = '<option value="">‚ö†Ô∏è Connexion impossible</option>';
  }
}

async function loadCommunes(deptCode, preselect){
  communeSelect.innerHTML = '<option>Chargement...</option>';
  try {
    const url = `https://geo.api.gouv.fr/departements/${deptCode}/communes?fields=nom,codesPostaux`;
    const r = await fetch(url);
    const list = await r.json();
    
    communeSelect.innerHTML = '<option value="">-- s√©lectionnez --</option>';
    
    list.forEach(c => {
      const opt = document.createElement("option");
      const codePostal = c.codesPostaux && c.codesPostaux.length > 0 ? c.codesPostaux[0] : '';
      const communeAvecCP = codePostal ? `${c.nom} (${codePostal})` : c.nom;
      
      opt.value = communeAvecCP;
      opt.textContent = communeAvecCP;
      
      communeSelect.appendChild(opt);
    });
    
    if (preselect) {
      const options = Array.from(communeSelect.options);
      const matchingOption = options.find(opt => 
        opt.value.startsWith(preselect.split('(')[0].trim())
      );
      
      if (matchingOption) {
        communeSelect.value = matchingOption.value;
      }
    }
  } catch (err) {
  console.error('Erreur chargement communes:', err);
  communeSelect.innerHTML = '<option value="">‚ö†Ô∏è Connexion impossible</option>';
  }
}

departSelect.addEventListener('change', e => {
  const v = e.target.value;
  resetZoneCommunes();
  communesValidees = false;
  communesCalculeesSaved = [];
  listeModifieeManuelle = false;
  
  if (!v) { 
    communeSelect.innerHTML = '<option value="">-- choisissez le d√©partement --</option>'; 
    return; 
  }
  loadCommunes(v);
  updateSectionGeo();
});

communeSelect.addEventListener("change", function() {
  const modeIntervention = document.querySelector('input[name="modeIntervention"]:checked');
  if (modeIntervention && modeIntervention.value !== 'cabinet' && this.value) {
    resetZoneCommunes();
    communesValidees = false;
    communesCalculeesSaved = [];
    listeModifieeManuelle = false;
    calculerEtAfficherCommunes(false, true);
  }
});

document.getElementById("tempsTrajet")?.addEventListener("change", function() {
  if (communeSelect.value) {
    resetZoneCommunes();
    communesValidees = false;
    communesCalculeesSaved = [];
    listeModifieeManuelle = false;
    calculerEtAfficherCommunes(false, true);
  }
});

document.getElementById("rayonKm")?.addEventListener("change", function() {
  if (communeSelect.value) {
    resetZoneCommunes();
    communesValidees = false;
    communesCalculeesSaved = [];
    listeModifieeManuelle = false;
    calculerEtAfficherCommunes(false, true);
  }
});

function resetZoneCommunes() {
  const zoneCommunes = document.getElementById('communesCalculeesZone');
  const btnGroupe = document.getElementById('btnGroupeCommunes');
  const vueListeCommunes = document.getElementById('vueListeCommunes');
  const vuePersonnalisation = document.getElementById('vuePersonnalisation');
  
  if (zoneCommunes) {
    zoneCommunes.classList.add('hidden');
  }
  
  if (btnGroupe) {
    btnGroupe.style.display = 'none';
  }
  
  // IMPORTANT : Forcer le retour √† la vue liste
  if (vuePersonnalisation) {
    vuePersonnalisation.classList.add('hidden');
  }
  if (vueListeCommunes) {
    vueListeCommunes.classList.remove('hidden');
  }
  
  communesCalculeesSaved = [];
  communesValidees = false;
  listeModifieeManuelle = false;
}
async function calculerEtAfficherCommunes(ouvrirVisualisation = false, silencieux = false) {
  const dep = departSelect.value;
  const commune = communeSelect.value;
  const codeDept = dep ? dep.split(' ')[0] : '';
  
  if (!dep || !commune) {
    if (!silencieux) alert("‚ö†Ô∏è S√©lectionnez d√©partement et commune.");
    return;
  }

  let rayonOuTemps = '';
  
  if (DEPS_METRO.includes(codeDept)) {
    rayonOuTemps = document.getElementById("tempsTrajet")?.value;
    if (!rayonOuTemps) {
      if (!silencieux) alert("‚ö†Ô∏è S√©lectionnez un temps de trajet.");
      return;
    }
  } else if (DEPS_DOMTOM.includes(codeDept)) {
    rayonOuTemps = document.getElementById("rayonKm")?.value;
    if (!rayonOuTemps) {
      if (!silencieux) alert("‚ö†Ô∏è S√©lectionnez un rayon.");
      return;
    }
  } else {
    return;
  }

  const zoneCommunes = document.getElementById('communesCalculeesZone');
  const listeDiv = document.getElementById('communesCalculeesListe');
  const infoDiv = document.getElementById('communesCalculeesInfo');
  const btnGroupe = document.getElementById('btnGroupeCommunes');
  
  if (!zoneCommunes || !listeDiv || !infoDiv) return;
  
  zoneCommunes.classList.remove('hidden');
  listeDiv.innerHTML = '<div style="text-align:center; padding:40px; color:#0ea5a4;"><div style="font-size:48px; margin-bottom:16px;">‚è≥</div><div>Calcul en cours...</div></div>';  
  infoDiv.innerHTML = '<span style="color:#0ea5a4; font-weight:600;">Recherche...</span>';
  
  if (btnGroupe) btnGroupe.style.display = 'none';
  
  communesValidees = false;
  
  if (!mapPrincipal) initMapPrincipal();
  
  try {
    const url = `${SCRIPT_URL}?action=calculerCommunes&modeIntervention=deplacement&departement=${encodeURIComponent(dep)}&commune=${encodeURIComponent(commune)}&rayonOuTemps=${encodeURIComponent(rayonOuTemps)}`;
    
    const response = await fetch(url);
    const result = await response.json();
    
    if (result.ok && result.communes && result.communes.length > 0) {
      communesCalculeesSaved = result.communes;
      
      infoDiv.innerHTML = `${result.nbCommunes} communes ‚Ä¢ ${result.departements.length} d√©partement(s)`;
      
      updateListeCommunes();
      
      if (btnGroupe) {
        const boutonsValidation = document.getElementById('boutons-validation');
        const boutonsPersonnalisation = document.getElementById('boutons-personnalisation');
        const zoneValideeBadge = document.getElementById('zone-validee-badge');
        
        if (boutonsValidation) {
          boutonsValidation.style.display = 'flex';
          boutonsValidation.classList.remove('hidden');
        }
        
        const avertissement = document.getElementById('avertissementCommunes');
        if (avertissement) {
          avertissement.style.display = 'block';
        }
        
        if (boutonsPersonnalisation) {
          boutonsPersonnalisation.style.display = 'none';
          boutonsPersonnalisation.classList.add('hidden');
        }
        if (zoneValideeBadge) {
          zoneValideeBadge.style.display = 'none';
          zoneValideeBadge.classList.add('hidden');
        }
        
        btnGroupe.style.display = 'block';
      }
      
      updateMapPrincipal();
      
    } else {
      communesCalculeesSaved = [];
      
      if (!result.ok) {
        communesCalculeesSaved = [];
        infoDiv.innerHTML = '<span style="color:#dc2626; font-weight:700;">‚ö†Ô∏è Erreur</span>';
        
        listeDiv.innerHTML = `
          <div style="background:#fff3cd; border:2px solid #ffc107; padding:32px; border-radius:12px; text-align:center;">
            <div style="font-size:56px; margin-bottom:20px;">‚ö†Ô∏è</div>
            <h3 style="margin:0 0 12px; color:#856404; font-size:20px;">Service temporairement indisponible</h3>
            <p style="margin:0; font-size:16px; line-height:1.8; color:#856404;">
              Le calcul automatique a √©chou√©.<br>
              <strong>V√©rifiez votre connexion et r√©essayez.</strong>
            </p>
          </div>
        `;
        
        if (btnGroupe) btnGroupe.style.display = 'none';
      }
    }
  } catch (error) {
    console.error('Erreur calcul communes:', error);
    
    const listeDiv = document.getElementById('communesCalculeesListe');
    const infoDiv = document.getElementById('communesCalculeesInfo');
    
    if (listeDiv) {
      listeDiv.innerHTML = `
        <div style="background:#fff3cd; border:2px solid #ffc107; padding:32px; border-radius:12px; text-align:center;">
          <div style="font-size:56px; margin-bottom:20px;">‚ö†Ô∏è</div>
          <h3 style="margin:0 0 12px; color:#856404; font-size:20px;">Service temporairement indisponible</h3>
          <p style="margin:0; font-size:16px; line-height:1.8; color:#856404;">
            Le calcul automatique a √©chou√©.<br>
            <strong>V√©rifiez votre connexion et r√©essayez.</strong>
          </p>
        </div>
      `;
    }
    
    if (infoDiv) {
      infoDiv.innerHTML = '<span style="color:#dc2626; font-weight:700;">‚ö†Ô∏è Erreur</span>';
    }
      if (loadingIndicator) loadingIndicator.style.display = 'none'; 
  }
}

function updateListeCommunes() {
  const listeDiv = document.getElementById('communesCalculeesListe');
  if (!listeDiv) return;
  
  if (!communesCalculeesSaved || communesCalculeesSaved.length === 0) {
    listeDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Aucune commune</div>';
    return;
  }
  
  listeDiv.innerHTML = communesCalculeesSaved
    .sort((a, b) => a.localeCompare(b, 'fr', { sensitivity: 'base' }))
    .map(c => `<div>${c}</div>`)
    .join('');
}

function validerCommunes() {
  if (communesCalculeesSaved.length === 0) {
    alert("‚ö†Ô∏è Aucune commune √† valider.");
    return;
  }
  
  communesValidees = true;
  effacerErreurZoneCommunes(); 
  listeModifieeManuelle = false;
  
  const avertissement = document.getElementById('avertissementCommunes');
  if (avertissement) avertissement.style.display = 'none';
  
  const infoDiv = document.getElementById('communesCalculeesInfo');
  if (infoDiv) {
    infoDiv.innerHTML = `${communesCalculeesSaved.length} communes ‚Ä¢ <span style="background: #d1fae5; color: #059669; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 13px;">‚úì Valid√©e</span>`;
  }
  
  const boutonsValidation = document.getElementById('boutons-validation');
  const zoneValideeBadge = document.getElementById('zone-validee-badge');
  const zoneValideeNb = document.getElementById('zone-validee-nb');
  
  // Masquer les boutons de validation
  if (boutonsValidation) {
    boutonsValidation.style.display = 'none';
    boutonsValidation.classList.add('hidden');
  }
  
  // Afficher UNIQUEMENT le badge valid√©
  if (zoneValideeBadge) {
    zoneValideeBadge.style.display = 'block';
    zoneValideeBadge.classList.remove('hidden');

    if (zoneValideeNb) zoneValideeNb.textContent = `${communesCalculeesSaved.length} communes`;
  }
}

function afficherInterfaceModification() {
  const vueListeCommunes = document.getElementById('vueListeCommunes');
  const vuePersonnalisation = document.getElementById('vuePersonnalisation');
  const boutonsValidation = document.getElementById('boutons-validation');
  const boutonsPersonnalisation = document.getElementById('boutons-personnalisation');
  const zoneValideeBadge = document.getElementById('zone-validee-badge');
  const infoDiv = document.getElementById('communesCalculeesInfo');
  const avertissement = document.getElementById('avertissementCommunes');

  communesValidees = false; 
  
  if (avertissement) avertissement.style.display = 'none';
  
  // Masquer la liste, afficher la personnalisation
  if (vueListeCommunes) vueListeCommunes.classList.add('hidden');
  if (vuePersonnalisation) vuePersonnalisation.classList.remove('hidden');
  
  // IMPORTANT : Masquer TOUS les autres boutons
  if (boutonsValidation) {
    boutonsValidation.style.display = 'none';
    boutonsValidation.classList.add('hidden');
  }
  if (zoneValideeBadge) {
    zoneValideeBadge.style.display = 'none';
    zoneValideeBadge.classList.add('hidden');
  }
  
  // Afficher UNIQUEMENT les boutons de personnalisation
  // Afficher UNIQUEMENT les boutons de personnalisation
  if (boutonsPersonnalisation) {
    boutonsPersonnalisation.style.display = 'flex';
    boutonsPersonnalisation.classList.remove('hidden');
  }
  
  if (infoDiv) {
    const nbCommunes = communesCalculeesSaved.length;
    infoDiv.innerHTML = `<span style="color:#f59e0b; font-weight:600;">‚úèÔ∏è Mode √©dition</span> ‚Ä¢ ${nbCommunes} communes`;
  }
  
  genererCheckboxesCommunes();
  
  document.getElementById('rechercheCommune').value = '';
  document.getElementById('resultatsRecherche').innerHTML = '';
  
  setTimeout(() => {
    updateMapPrincipalAvecSelection();
  }, 100);
}

function genererCheckboxesCommunes() {
  
  const container = document.getElementById('listeCommunesCheckboxes');
  
  if (!container) return;
  
  if (!communesCalculeesSaved || communesCalculeesSaved.length === 0) {
    container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px; margin: 0;">Aucune commune</p>';
    updateCompteurCommunes();
    return;
  }
  
  const communesTriees = [...communesCalculeesSaved].sort((a, b) => {
    return a.localeCompare(b, 'fr', { sensitivity: 'base' });
  });
  
  const html = communesTriees.map((commune, index) => {
    const communeEchapee = commune.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    
    return `
      <div style="padding: 10px 8px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">        
        <input type="checkbox" id="commune_${index}" value="${communeEchapee}" checked onchange="updateCompteurCommunes()" style="margin-right: 10px; cursor: pointer; width: 18px; height: 18px;"/>
        <label for="commune_${index}" style="cursor: pointer; flex: 1; margin: 0; font-size: 14px;">${communeEchapee}</label>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
  updateCompteurCommunes();
}

function updateCompteurCommunes() {
  const checkboxes = document.querySelectorAll('#listeCommunesCheckboxes input[type="checkbox"]');
  const nbCochees = Array.from(checkboxes).filter(cb => cb.checked).length;
  
  const compteur = document.getElementById('compteurCommunes');
  if (compteur) compteur.textContent = `${nbCochees} commune(s)`;
  
  updateMapPrincipalAvecSelection();
}

async function updateMapPrincipalAvecSelection() {
  if (!mapPrincipal) {
    initMapPrincipal();
    setTimeout(() => updateMapPrincipalAvecSelection(), 500);
    return;
  }
  
  const loadingIndicator = document.getElementById('mapLoadingIndicator');
  if (loadingIndicator) loadingIndicator.style.display = 'block';
  
  Object.values(communeLayersPrincipal).forEach(layer => mapPrincipal.removeLayer(layer));
  communeLayersPrincipal = {};
  
  const checkboxes = document.querySelectorAll('#listeCommunesCheckboxes input[type="checkbox"]');
  const communesCochees = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
  
  if (communesCochees.length === 0) {
    if (loadingIndicator) loadingIndicator.style.display = 'none';
    return;
  }
  
  const communeCentrale = communeSelect.value.split('(')[0].trim();
  const bounds = [];
  
  for (const communeAvecCP of communesCochees) {
    const communeNom = communeAvecCP.split('(')[0].trim();
    const isCentrale = (communeNom.toLowerCase() === communeCentrale.toLowerCase());
    
    try {
      const match = communeAvecCP.match(/\((\d{5})\)/);
      const codePostal = match ? match[1] : null;
      
      const url = `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(communeNom)}&fields=nom,codesPostaux,contour&format=geojson&geometry=contour`;
      const response = await fetch(url);
      const data = await response.json();
      
      if (!data.features || data.features.length === 0) continue;
      
      let feature = data.features[0];
      
      if (codePostal && data.features.length > 1) {
        const matchingFeature = data.features.find(f => 
          f.properties.codesPostaux && f.properties.codesPostaux.includes(codePostal)
        );
        if (matchingFeature) feature = matchingFeature;
      }
      
      const layer = L.geoJSON(feature, {
        style: {
          fillColor: isCentrale ? '#ef4444' : '#3b82f6',
          fillOpacity: isCentrale ? 0.6 : 0.4,
          color: isCentrale ? '#dc2626' : '#1e40af',
          weight: isCentrale ? 3 : 2
        },
        onEachFeature: (feature, layer) => {
          const cp = feature.properties.codesPostaux ? feature.properties.codesPostaux[0] : '';
          const tooltipContent = isCentrale 
            ? `üìç <strong>${communeNom}</strong>${cp ? ' (' + cp + ')' : ''}<br><em>Commune centrale</em>`
            : `${communeNom}${cp ? ' (' + cp + ')' : ''}`;
          
          layer.bindTooltip(tooltipContent, {
            permanent: false,
            direction: 'top',
            className: 'custom-tooltip'
          });
        }
      }).addTo(mapPrincipal);
      
      communeLayersPrincipal[communeNom] = layer;
      
      const geojsonBounds = layer.getBounds();
      bounds.push([geojsonBounds.getSouth(), geojsonBounds.getWest()]);
      bounds.push([geojsonBounds.getNorth(), geojsonBounds.getEast()]);
      
    } catch (error) {
      console.warn(`‚ö†Ô∏è Impossible de charger ${communeNom}:`, error);
    }
  }
  
  if (bounds.length > 0) {
    mapPrincipal.fitBounds(bounds, { padding: [20, 20] });
  }
  
  if (loadingIndicator) loadingIndicator.style.display = 'none';
}

let rechercheTimeout;

function rechercherCommuneEnTempsReel() {
  clearTimeout(rechercheTimeout);
  
  const resultatsDiv = document.getElementById('resultatsRecherche');
  if (!resultatsDiv) return;
  
  rechercheTimeout = setTimeout(() => {
    const recherche = document.getElementById('rechercheCommune').value.trim();
    
    if (recherche.length === 0) {
      resultatsDiv.innerHTML = '';
      return;
    }
    
    if (recherche.length < 3) {
      resultatsDiv.innerHTML = '<div style="background: #fff3cd; border: 1px solid #ffc107; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #856404;">‚ö†Ô∏è Tapez au moins 3 caract√®res</div>';
      return;
    }
    
    rechercherCommune();
  }, 500);
}

function rechercherCommune() {
  const recherche = document.getElementById('rechercheCommune').value.trim();
  const resultatsDiv = document.getElementById('resultatsRecherche');
  
  if (recherche.length < 3) return;
  
  resultatsDiv.innerHTML = '<div style="background: #e6f7f7; border: 1px solid #0ea5a4; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #0d8887;">üîÑ Recherche...</div>';
  
  const url = `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(recherche)}&fields=nom,codesPostaux,departement&limit=10`;
  
  fetch(url)
    .then(response => response.json())
    .then(communes => {
      if (!communes || communes.length === 0) {
        resultatsDiv.innerHTML = `<div style="background: #fee; border: 1px solid #dc2626; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #dc2626;">‚ùå Aucune commune trouv√©e</div>`;
        return;
      }
      
      const html = communes.map(c => {
        const cp = c.codesPostaux && c.codesPostaux.length > 0 ? c.codesPostaux[0] : '';
        const nomComplet = cp ? `${c.nom} (${cp})` : c.nom;
        const deptCode = c.departement.code || '';
        
        const nomEchape = nomComplet.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        return `
          <div onclick="ajouterCommuneManuellement('${nomEchape}')" style="padding: 12px; cursor: pointer; border-bottom: 1px solid #f3f4f6;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background='white'">
            <span style="font-weight: 600; color: #0f1724; font-size: 14px;">${nomComplet}</span>
            <span style="color: #6b7280; font-size: 12px; margin-left: 12px;">${deptCode}</span>
          </div>
        `;
      }).join('');
      
      resultatsDiv.innerHTML = `<div style="background: white; border: 2px solid #0ea5a4; border-radius: 8px; max-height: 250px; overflow-y: auto;">${html}</div>`;
    })
    .catch(error => {
      resultatsDiv.innerHTML = `<div style="background: #fee; border: 1px solid #dc2626; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #dc2626;">‚ùå Erreur</div>`;
    });
}

function ajouterCommuneManuellement(communeNom) {
  const communeNettoyee = communeNom.trim();
  
  const dejaPresente = communesCalculeesSaved.some(c => 
    c.toLowerCase() === communeNettoyee.toLowerCase()
  );
  
  if (dejaPresente) {
    document.getElementById('resultatsRecherche').innerHTML = '<div style="background: #fff3cd; border: 1px solid #ffc107; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #856404;">‚ö†Ô∏è D√©j√† dans la liste</div>';
    return;
  }
  
  communesCalculeesSaved.push(communeNettoyee);
  genererCheckboxesCommunes();
  
  const resultatsDiv = document.getElementById('resultatsRecherche');
  resultatsDiv.innerHTML = `<div style="background: #d1fae5; border: 1px solid #10b981; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #059669;">‚úÖ Commune ajout√©e</div>`;
  
  setTimeout(() => {
    resultatsDiv.innerHTML = '';
  }, 3000);
  
  const champRecherche = document.getElementById('rechercheCommune');
  if (champRecherche) {
    champRecherche.value = '';
    champRecherche.focus();
  }
} 

function validerModifications() {
  const checkboxes = document.querySelectorAll('#listeCommunesCheckboxes input[type="checkbox"]');
  const communesSelectionnees = [];
  
  checkboxes.forEach(checkbox => {
    if (checkbox.checked) {
      communesSelectionnees.push(checkbox.value);
    }
  });
  
  if (communesSelectionnees.length === 0) {
    alert('‚ö†Ô∏è S√©lectionnez au moins une commune');
    return;
  }
  
  communesCalculeesSaved = communesSelectionnees.sort((a, b) => {
    return a.localeCompare(b, 'fr', { sensitivity: 'base' });
  });
  
  communesValidees = true;
  listeModifieeManuelle = true;
  effacerErreurZoneCommunes();
  
  const vueListeCommunes = document.getElementById('vueListeCommunes');
  const vuePersonnalisation = document.getElementById('vuePersonnalisation');
  const boutonsValidation = document.getElementById('boutons-validation');
  const boutonsPersonnalisation = document.getElementById('boutons-personnalisation');
  const zoneValideeBadge = document.getElementById('zone-validee-badge');
  const zoneValideeNb = document.getElementById('zone-validee-nb');
  
  if (vuePersonnalisation) vuePersonnalisation.classList.add('hidden');
  if (vueListeCommunes) vueListeCommunes.classList.remove('hidden');
  
    // Masquer les boutons de personnalisation
  if (boutonsPersonnalisation) {
    boutonsPersonnalisation.style.display = 'none';
    boutonsPersonnalisation.classList.add('hidden');
  }
  
  // Masquer les boutons de validation
  if (boutonsValidation) {
    boutonsValidation.style.display = 'none';
    boutonsValidation.classList.add('hidden');
  }
  
  // Afficher UNIQUEMENT le badge valid√©
  if (zoneValideeBadge) {
    zoneValideeBadge.style.display = 'block';
    zoneValideeBadge.classList.remove('hidden');
    if (zoneValideeNb) zoneValideeNb.textContent = `${communesSelectionnees.length} communes`;
  }
  
  // Masquer l'avertissement apr√®s validation
  const avertissement = document.getElementById('avertissementCommunes');
  if (avertissement) {
    avertissement.style.display = 'none';
  }
  
  updateListeCommunes();
  
  const infoDiv = document.getElementById('communesCalculeesInfo');
  if (infoDiv) {
    infoDiv.innerHTML = `${communesSelectionnees.length} communes ‚Ä¢ <span style="background: #d1fae5; color: #059669; padding: 4px 12px; border-radius: 20px; font-weight: 700; font-size: 13px;">‚úì Personnalis√©e</span>`;
  }
  
  updateMapPrincipal();
}

function annulerModifications() {
  const vueListeCommunes = document.getElementById('vueListeCommunes');
  const vuePersonnalisation = document.getElementById('vuePersonnalisation');
  const boutonsValidation = document.getElementById('boutons-validation');
  const boutonsPersonnalisation = document.getElementById('boutons-personnalisation');
  const zoneValideeBadge = document.getElementById('zone-validee-badge');
  
  if (vuePersonnalisation) vuePersonnalisation.classList.add('hidden');
  if (vueListeCommunes) vueListeCommunes.classList.remove('hidden');
  
  // Masquer les boutons de personnalisation
  if (boutonsPersonnalisation) {
    boutonsPersonnalisation.style.display = 'none';
    boutonsPersonnalisation.classList.add('hidden');
  }
  
  // Afficher les bons boutons selon l'√©tat
  if (communesValidees) {
    // Zone valid√©e : afficher uniquement le badge
    if (boutonsValidation) {
      boutonsValidation.style.display = 'none';
      boutonsValidation.classList.add('hidden');
    }
    if (zoneValideeBadge) {
      zoneValideeBadge.style.display = 'block';
      zoneValideeBadge.classList.remove('hidden');
    }
  } else {
    // Zone non valid√©e : afficher les boutons de validation
    if (boutonsValidation) {
      boutonsValidation.style.display = 'flex';
      boutonsValidation.classList.remove('hidden');
    }
    if (zoneValideeBadge) {
      zoneValideeBadge.style.display = 'none';
      zoneValideeBadge.classList.add('hidden');
    }
  }
  
  document.getElementById('rechercheCommune').value = '';
  document.getElementById('resultatsRecherche').innerHTML = '';
  
  // Si la zone n'est pas valid√©e, r√©afficher l'avertissement
  if (!communesValidees) {
    const avertissement = document.getElementById('avertissementCommunes');
    if (avertissement) {
      avertissement.style.display = 'block';
    }
  }
  
  updateMapPrincipal();
}

async function showFormAndPrefill(data) {
  formEl.classList.remove("hidden");
  rest.classList.remove("hidden");
  
  const numType = data && data.numType ? data.numType : "";
  if (numType === "siret") {
    document.querySelector('input[name="numType"][value="siret"]').checked = true;
    siretBlock.classList.remove("hidden");
    noNum.classList.add("hidden");
    siretNum.value = data.numPro || "";
  }
  
  if (data) {
    document.getElementById("nom").value = data.nom || "";
    document.getElementById("prenom").value = data.prenom || "";
    document.getElementById("phone").value = data.phone || "";
    document.getElementById("profession").value = data.profession || "";
    
    if (data.publics) {
      const publicsArr = data.publics.split(",").map(s => s.trim()).filter(Boolean);
      document.querySelectorAll('input[name="public"]').forEach(ch => {
        ch.checked = publicsArr.includes(ch.value);
      });
    }
    
    if (data.modeIntervention) {
      const modeRadio = document.querySelector(`input[name="modeIntervention"][value="${data.modeIntervention}"]`);
      if (modeRadio) modeRadio.checked = true;
    }
    
    if (data.visio !== undefined && data.visio !== null) {
      const visioValue = String(data.visio).toLowerCase().trim();
      const visioRadio = document.querySelector(`input[name="visio"][value="${visioValue}"]`);
      if (visioRadio) visioRadio.checked = true;
    }
    
    if (data.departement) {
      let deptCode = String(data.departement).trim();
      if (deptCode.length === 1) deptCode = "0" + deptCode;
      
      setTimeout(async () => {
        departSelect.value = deptCode;
        
        if (data.commune) {
          await loadCommunes(deptCode, data.commune);
          if (data.commune.includes('(')) {
            communeSelect.value = data.commune;
          }
        }

        const codeDept = deptCode.split('-')[0].trim();

        if (DEPS_METRO.includes(codeDept) && data.temps) {
          document.getElementById("zoneMetropole").classList.remove("hidden");
          const select = document.getElementById("tempsTrajet");
          const optionExists = Array.from(select.options).some(opt => opt.value === data.temps);
          if (!optionExists) {
            const opt = document.createElement("option");
            opt.value = data.temps;
            opt.textContent = data.temps;
            select.appendChild(opt);
          }
          select.value = data.temps;

        } else if (DEPS_DOMTOM.includes(codeDept) && data.rayon) {
          document.getElementById("zoneOutreMer").classList.remove("hidden");
          const select = document.getElementById("rayonKm");
          const optionExists = Array.from(select.options).some(opt => opt.value === data.rayon);
          if (!optionExists) {
            const opt = document.createElement("option");
            opt.value = data.rayon;
            opt.textContent = data.rayon;
            select.appendChild(opt);
          }
          select.value = data.rayon;
        }

        document.getElementById("precisionsGeo").value = data.precisionsGeo || "";
      }, 200);
    }

    if (data.disponibilite) {
      const dispoRadio = document.querySelector(`input[name="dispo"][value="${data.disponibilite}"]`);
      if (dispoRadio) {
        dispoRadio.checked = true;
        if (data.disponibilite === "oui") {
          dateBlock.classList.remove("hidden");
          modeContactBlock.classList.remove("hidden");
          consentNumber.textContent = "6";
          
          if (data.dateDispo) dateInput.value = data.dateDispo;
          if (data.placesDisponibles) placesInput.value = data.placesDisponibles;
          if (data.modeContact) {
            const modeContactRadio = document.querySelector(`input[name="modeContact"][value="${data.modeContact}"]`);
            if (modeContactRadio) modeContactRadio.checked = true;
          }
        }
      }
    }

    const consentValue = String(data.consent || "").toLowerCase();
    document.getElementById("consent").checked = (consentValue === "oui" || consentValue === "true");
    submitBtn.textContent = "‚úì Mettre √† jour mes informations";
    
    setTimeout(() => updateSectionGeo(), 300);
  }
  
  setTimeout(async () => {
    const modeIntervention = document.querySelector('input[name="modeIntervention"]:checked');
    if (modeIntervention && modeIntervention.value !== 'cabinet') {
      
      if (data.communesCouvertes && data.communesCouvertes.trim() !== '') {
        communesCalculeesSaved = data.communesCouvertes.split('|').filter(c => c.trim());
        communesValidees = true; 
        listeModifieeManuelle = true;
        // R√©initialiser la validation si temps/rayon chang√©
        document.getElementById("tempsTrajet")?.addEventListener("change", () => {
          communesValidees = false;
        });
        document.getElementById("rayonKm")?.addEventListener("change", () => {
          communesValidees = false;
        });
        
        const zoneCommunes = document.getElementById('communesCalculeesZone');
        const infoDiv = document.getElementById('communesCalculeesInfo');
        
        if (zoneCommunes && infoDiv) {
          zoneCommunes.classList.remove('hidden');
          
          infoDiv.innerHTML = `‚úÖ ${communesCalculeesSaved.length} communes enregistr√©es`;
          
          updateListeCommunes();
          
          const btnGroupe = document.getElementById('btnGroupeCommunes');
          const zoneValideeBadge = document.getElementById('zone-validee-badge');
          const zoneValideeNb = document.getElementById('zone-validee-nb');
          const boutonsValidation = document.getElementById('boutons-validation');
          const boutonsPersonnalisation = document.getElementById('boutons-personnalisation');
          
          if (btnGroupe && zoneValideeBadge) {
            // Masquer TOUS les boutons sauf le badge valid√©
            if (boutonsValidation) {
              boutonsValidation.style.display = 'none';
              boutonsValidation.classList.add('hidden');
            }
            if (boutonsPersonnalisation) {
              boutonsPersonnalisation.style.display = 'none';
              boutonsPersonnalisation.classList.add('hidden');
            }
            // Masquer l'avertissement pour les utilisateurs existants
            const avertissement = document.getElementById('avertissementCommunes');
            if (avertissement) {
              avertissement.style.display = 'none';
            }
            
            // Afficher UNIQUEMENT le badge
            if (zoneValideeNb) zoneValideeNb.textContent = `${communesCalculeesSaved.length} communes`;
            zoneValideeBadge.style.display = 'block';
            zoneValideeBadge.classList.remove('hidden');
            btnGroupe.style.display = 'block';
          }
          
          if (!mapPrincipal) initMapPrincipal();
          setTimeout(() => {
            updateMapPrincipal();
          }, 500);
        }
      }
    }
  }, 1000);
}

function effacerErreurZoneCommunes() {
  console.log('üßπ D√©but nettoyage erreurs communes');
  
  // 1Ô∏è‚É£ Effacer le message DANS la zone communes
  const zoneCommunes = document.getElementById('communesCalculeesZone');
  if (zoneCommunes) {
    // Chercher DANS la zone
    const errorsInside = zoneCommunes.querySelectorAll('.error-message-inline');
    errorsInside.forEach(msg => {
      console.log('  ‚ûú Suppression message DANS zone:', msg.textContent);
      msg.remove();
    });
    
    // Chercher APR√àS la zone (nextSibling)
    let nextEl = zoneCommunes.nextElementSibling;
    while (nextEl) {
      if (nextEl.classList && nextEl.classList.contains('error-message-inline')) {
        const texte = nextEl.textContent.toLowerCase();
        if (texte.includes('commune') || texte.includes('valider')) {
          console.log('  ‚ûú Suppression message APR√àS zone:', nextEl.textContent);
          const toRemove = nextEl;
          nextEl = nextEl.nextElementSibling;
          toRemove.remove();
          continue;
        }
      }
      nextEl = nextEl.nextElementSibling;
    }
    
    // Retirer le rouge
    zoneCommunes.classList.remove('champ-requis-manquant');
  }
  
  // 2Ô∏è‚É£ Effacer le message global en bas
  if (submitMsg) {
    console.log('  ‚ûú Effacement submitMsg');
    submitMsg.textContent = "";
    submitMsg.innerHTML = "";
  }
  
  // 3Ô∏è‚É£ S√©curit√© : Effacer TOUS les messages li√©s aux communes PARTOUT
  document.querySelectorAll('.error-message-inline').forEach(msg => {
    const texte = msg.textContent.toLowerCase();
    if (texte.includes('commune') || texte.includes('valider') || texte.includes('liste')) {
      console.log('  ‚ûú Suppression message global:', msg.textContent);
      msg.remove();
    }
  });
  
  console.log('‚úÖ Nettoyage termin√©');
} 

function validerChamps() {
  // Nettoyer TOUTES les anciennes erreurs ET le message global
  document.querySelectorAll('.champ-requis-manquant').forEach(el => {
    el.classList.remove('champ-requis-manquant');
  });
  document.querySelectorAll('.error-message-inline').forEach(el => el.remove());
  submitMsg.textContent = ""; //  effacer le message global
  
  const erreurs = [];
  
  // Type de num√©ro
  const numTypeChecked = document.querySelector('input[name="numType"]:checked');
  if (!numTypeChecked) {
    erreurs.push({ element: document.querySelector('.prereq-section'), message: "S√©lectionnez votre type de num√©ro professionnel" });
  } else if (numTypeChecked.value === "siret" && !validSiret(siretNum.value.trim())) {
    siretNum.classList.add('champ-requis-manquant');
    erreurs.push({ element: siretNum, message: "SIRET invalide (14 chiffres)" });
  }
  
  // Nom
  if (!document.getElementById("nom").value.trim()) {
    document.getElementById("nom").classList.add('champ-requis-manquant');
    erreurs.push({ element: document.getElementById("nom"), message: "Le nom est obligatoire" });
  }
  
  // Pr√©nom
  if (!document.getElementById("prenom").value.trim()) {
    document.getElementById("prenom").classList.add('champ-requis-manquant');
    erreurs.push({ element: document.getElementById("prenom"), message: "Le pr√©nom est obligatoire" });
  }
  
  // Profession
  if (!document.getElementById("profession").value) {
    document.getElementById("profession").classList.add('champ-requis-manquant');
    erreurs.push({ element: document.getElementById("profession"), message: "S√©lectionnez votre profession" });
  }
  
  // Public
  if (!Array.from(document.querySelectorAll('input[name="public"]:checked')).length) {
    erreurs.push({ element: document.querySelector('input[name="public"]').closest('div'), message: "S√©lectionnez au moins un public" });
  }
  
  // Mode d'intervention
  if (!document.querySelector('input[name="modeIntervention"]:checked')) {
    erreurs.push({ element: document.querySelector('input[name="modeIntervention"]').closest('div'), message: "S√©lectionnez votre mode d'intervention" });
  }
  
  // Visio
  if (!document.querySelector('input[name="visio"]:checked')) {
    erreurs.push({ element: document.querySelector('input[name="visio"]').closest('div'), message: "Indiquez si vous proposez la visio" });
  }
  
  // D√©partement
  if (!departSelect.value) {
    departSelect.classList.add('champ-requis-manquant');
    erreurs.push({ element: departSelect, message: "S√©lectionnez votre d√©partement" });
  }
  
  // Commune
  if (!communeSelect.value) {
    communeSelect.classList.add('champ-requis-manquant');
    erreurs.push({ element: communeSelect, message: "S√©lectionnez votre commune" });
  }
  
  // Temps/rayon pour d√©placements
 // Temps/rayon pour d√©placements
  const modeInterventionChecked = document.querySelector('input[name="modeIntervention"]:checked');
  if (modeInterventionChecked && modeInterventionChecked.value !== 'cabinet') {
    const codeDept = departSelect.value ? departSelect.value.split(' ')[0] : '';
    
    if (DEPS_METRO.includes(codeDept)) {
      const tempsSelect = document.getElementById("tempsTrajet");
      if (tempsSelect && !tempsSelect.value) {
        tempsSelect.classList.add('champ-requis-manquant');
        erreurs.push({ element: tempsSelect, message: "S√©lectionnez un temps de trajet" });
      }
    } else if (DEPS_DOMTOM.includes(codeDept)) {
      const rayonSelect = document.getElementById("rayonKm");
      if (rayonSelect && !rayonSelect.value) {
        rayonSelect.classList.add('champ-requis-manquant');
        erreurs.push({ element: rayonSelect, message: "S√©lectionnez un rayon" });
      }
    }
    
   // Communes valid√©es
    const zoneCalculee = document.getElementById('communesCalculeesZone');
    const estVisible = zoneCalculee && !zoneCalculee.classList.contains('hidden');
    if (estVisible) {
      if (!communesValidees) {
        erreurs.push({ 
          element: zoneCalculee, 
          message: "Vous devez valider ou personnaliser la liste des communes avant d'enregistrer"
        });
      } else if (!communesCalculeesSaved || communesCalculeesSaved.length === 0) {
        erreurs.push({ 
          element: zoneCalculee, 
          message: "La liste des communes est vide"
        });
      }
    } else if (!communesCalculeesSaved || communesCalculeesSaved.length === 0) {
      erreurs.push({ 
        element: departSelect, 
        message: "Les communes doivent √™tre calcul√©es avant validation"
      });
    }
  }  
  
  // Disponibilit√©s
  const dispoChecked = document.querySelector('input[name="dispo"]:checked');
  if (!dispoChecked) {
    erreurs.push({ element: document.querySelector('input[name="dispo"]').closest('div'), message: "R√©pondez sur vos disponibilit√©s" });
  } else if (dispoChecked.value === "oui") {
    if (!dateInput.value) {
      dateInput.classList.add('champ-requis-manquant');
      erreurs.push({ element: dateInput, message: "Date de disponibilit√© obligatoire" });
    }
    
    const places = parseInt(placesInput.value);
    if (!places || places < 1 || places > 10) {
      placesInput.classList.add('champ-requis-manquant');
      erreurs.push({ element: placesInput, message: "Nombre de places (1-10)" });
    }
    
    if (!document.querySelector('input[name="modeContact"]:checked')) {
      erreurs.push({ element: document.querySelector('input[name="modeContact"]').closest('div'), message: "Mode de contact obligatoire" });
    }
  }
  
  // Consentement
  if (!document.getElementById("consent").checked) {
    erreurs.push({ element: document.getElementById("consent").parentElement, message: "Le consentement est obligatoire" });
  }
  
  // Afficher les erreurs
  erreurs.forEach(err => {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'error-message-inline';
    msgDiv.textContent = '‚ö†Ô∏è ' + err.message;
    if (err.element.nextSibling) {
      err.element.parentNode.insertBefore(msgDiv, err.element.nextSibling);
    } else {
      err.element.parentNode.appendChild(msgDiv);
    }
  });
  
  // Scroller vers la premi√®re erreur
  if (erreurs.length > 0) {
    submitMsg.innerHTML = `<span style="color:#dc2626;font-weight:600;">‚ùå ${erreurs.length} champ(s) manquant(s) - voir ci-dessus</span>`;
    erreurs[0].element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return false;
  }
  
 return true;
}

// SUPPRIMER LE ROUGE AUTOMATIQUEMENT QUAND L'UTILISATEUR CORRIGE
function retirerRougeAutomatique() {
  // Pour les inputs normaux (text, date, number, etc.)
  document.querySelectorAll('input:not([type="checkbox"]):not([type="radio"]), select, textarea').forEach(element => {
    element.addEventListener('input', function() {
      effacerErreurChamp(this);
    });
    
    element.addEventListener('change', function() {
      effacerErreurChamp(this);
    });
  });
  
// Pour les radio buttons - effacer l'erreur d√®s qu'on coche
  document.querySelectorAll('input[type="radio"]').forEach(element => {
    element.addEventListener('change', function() {
      const groupName = this.name;
      // Trouver le conteneur de tout le groupe de radios
      const container = this.closest('div').parentElement;
      if (container) {
        const errorMsg = container.querySelector('.error-message-inline');
        if (errorMsg) errorMsg.remove();
      }
      // Effacer le message global
      if (submitMsg) submitMsg.textContent = "";
    });
  });
  
  // Pour les checkboxes - effacer l'erreur d√®s qu'on coche
  document.querySelectorAll('input[type="checkbox"]').forEach(element => {
    element.addEventListener('change', function() {
      const container = this.closest('div').parentElement;
      if (container) {
        const errorMsg = container.querySelector('.error-message-inline');
        if (errorMsg) errorMsg.remove();
      }
      // Effacer le message global
      if (submitMsg) submitMsg.textContent = "";
    });
  });
}

//  fonction helper pour effacer les erreurs
function effacerErreurChamp(element) {
  // Retirer le rouge uniquement de l'√©l√©ment modifi√©
  if (element.classList.contains('champ-requis-manquant')) {
    element.classList.remove('champ-requis-manquant');
  }
  
  // Chercher le message d'erreur IMM√âDIATEMENT apr√®s l'√©l√©ment (son nextSibling direct)
  let nextElement = element.nextElementSibling;
  if (nextElement && nextElement.classList && nextElement.classList.contains('error-message-inline')) {
    nextElement.remove();
  }
    
  // Effacer le message global uniquement s'il n'y a plus aucune erreur
  const erreursRestantes = document.querySelectorAll('.error-message-inline');
  if (erreursRestantes.length === 0 && submitMsg) {
    submitMsg.textContent = "";
  }
}
retirerRougeAutomatique();

submitBtn.addEventListener('click', async () => {

  submitMsg.textContent = "";
  successBanner.classList.add("hidden");
  
  // Valider tous les champs
  if (!validerChamps()) {
    return;
  }
  
  submitBtn.disabled = true;
  resetBtn.disabled = true;
  
  const numTypeChecked = document.querySelector('input[name="numType"]:checked');
  const numType = numTypeChecked.value;
  if (numType === "siret" && !validSiret(siretNum.value.trim())) { 
    submitMsg.textContent = "SIRET invalide."; 
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    return; 
  }
  if (!document.getElementById("nom").value.trim()) { 
    submitMsg.textContent = "Nom requis."; 
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    return; 
  }
  if (!document.getElementById("prenom").value.trim()) { 
    submitMsg.textContent = "Pr√©nom requis."; 
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    return; 
  }
  if (!document.getElementById("profession").value) { 
    submitMsg.textContent = "Profession requise."; 
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    return; 
  }
  if (!Array.from(document.querySelectorAll('input[name="public"]:checked')).length) { 
    submitMsg.textContent = "S√©lectionnez au moins un public."; 
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    return; 
  }
  if (!document.querySelector('input[name="modeIntervention"]:checked')) { 
    submitMsg.textContent = "S√©lectionnez votre mode d'intervention."; 
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    return; 
  }
  if (!document.querySelector('input[name="visio"]:checked')) { 
    submitMsg.textContent = "Indiquez si vous proposez des RDV en visio."; 
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    return; 
  }
  if (!departSelect.value) { 
    submitMsg.textContent = "D√©partement requis."; 
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    return; 
  }
  if (!communeSelect.value) { 
    submitMsg.textContent = "Commune requise."; 
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    return; 
  }
  
  const dispoChecked = document.querySelector('input[name="dispo"]:checked');
  if (!dispoChecked) { 
    submitMsg.textContent = "R√©pondez √† la question disponibilit√©s."; 
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    return; 
  }
  
  if (dispoChecked.value === "oui") {
    if (!dateInput.value) { 
      submitMsg.textContent = "Indiquez la date de disponibilit√©."; 
      submitBtn.disabled = false;
      resetBtn.disabled = false;
      return; 
    }
    const places = parseInt(placesInput.value);
    if (!places || places < 1 || places > 10) {
      submitMsg.textContent = "Indiquez le nombre de places (entre 1 et 10).";
      submitBtn.disabled = false;
      resetBtn.disabled = false;
      return;
    }
    
    const modeContactChecked = document.querySelector('input[name="modeContact"]:checked');
    if (!modeContactChecked) { 
      submitMsg.textContent = "Indiquez comment vous souhaitez √™tre contact√©."; 
      submitBtn.disabled = false;
      resetBtn.disabled = false;
      return; 
    }
  }
  
  if (!document.getElementById("consent").checked) { 
    submitMsg.textContent = "Le consentement est obligatoire."; 
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    return; 
  }
  
  submitMsg.innerHTML = '<span style="color:#6b7280">‚è≥ Envoi...</span>';
  
  const fd = new FormData();
  fd.append("action", "submitForm");
  fd.append("email", (CURRENT_EMAIL || emailEl.value || "").trim().toLowerCase());
  fd.append("numType", numType);
  fd.append("siretNum", siretNum.value.trim());
  fd.append("nom", document.getElementById("nom").value.trim());
  fd.append("prenom", document.getElementById("prenom").value.trim());
  fd.append("phone", document.getElementById("phone").value.trim());
  fd.append("profession", document.getElementById("profession").value);
  fd.append("publics", Array.from(document.querySelectorAll('input[name="public"]:checked')).map(i=>i.value).join(","));
  
  const modeIntervention = document.querySelector('input[name="modeIntervention"]:checked');
  fd.append("modeIntervention", modeIntervention ? modeIntervention.value : "");
  
  fd.append("departement", departSelect.value);
  fd.append("commune", communeSelect.value);

  if (communesValidees && communesCalculeesSaved.length > 0) {
    fd.append("communesModifiees", communesCalculeesSaved.join('|'));
  } else {
    fd.append("communesModifiees", "");
  } 
  
  const codeDept = departSelect.value.split(' ')[0];

  if (DEPS_METRO.includes(codeDept)) {
    fd.append("rayon", "");
    fd.append("temps", document.getElementById("tempsTrajet").value);
  } else if (DEPS_DOMTOM.includes(codeDept)) {
    fd.append("rayon", document.getElementById("rayonKm").value);
    fd.append("temps", "");
  }
  
  fd.append("visio", document.querySelector('input[name="visio"]:checked').value);
  fd.append("precisionsGeo", document.getElementById("precisionsGeo").value.trim());
  fd.append("dispo", dispoChecked.value);
  
  if (dispoChecked.value === "oui") {
    fd.append("dateDispo", dateInput.value);
    fd.append("placesDisponibles", placesInput.value || "");
    fd.append("modeContact", document.querySelector('input[name="modeContact"]:checked')?.value || "direct");
  } else {
    fd.append("dateDispo", "");
    fd.append("placesDisponibles", "");
    fd.append("modeContact", "direct");
  }
  
  fd.append("consent", document.getElementById("consent").checked ? "oui" : "non");
  
  try {
    const result = await fetchWithErrorHandling(SCRIPT_URL, { method: "POST", body: fd });
  
  submitBtn.disabled = false;
  resetBtn.disabled = false;
  
  if (!result.ok) {
    submitMsg.innerHTML = `<span style="color:#dc2626">‚ùå ${result.message}</span>`;
    return;
  }
  
  const j = result.data;
  
    if (j.ok) {
    lockForm();
  } else {
    submitMsg.innerHTML = '<span style="color:#dc2626">‚ùå Erreur : ' + (j.error || "Erreur inconnue") + '</span>';
  }
  } catch (error) {
    console.error('Erreur soumission formulaire:', error);
    submitBtn.disabled = false;
    resetBtn.disabled = false;
    submitMsg.innerHTML = '<span style="color:#dc2626">‚ùå Erreur de connexion</span>';
  }
});

resetBtn.addEventListener('click', () => {
  formEl.reset();
  document.getElementById("consent").checked = false;
  placesInput.value = "";
  modeContactBlock.classList.add("hidden");
  consentNumber.textContent = "5";
  document.querySelectorAll('input[name="modeContact"]').forEach(radio => { radio.checked = false;});
  rest.classList.add("hidden");
  siretBlock.classList.add("hidden");
  noNum.classList.add("hidden");
  submitMsg.textContent = "";
  successBanner.classList.add("hidden");
  
  document.getElementById('section-geo').classList.add('hidden');
  document.getElementById('blocCommune').classList.add('hidden');
  document.getElementById('questionsDeplacements').classList.add('hidden');
  document.getElementById('zoneMetropole').classList.add('hidden');
  document.getElementById('zoneOutreMer').classList.add('hidden');
  document.getElementById('precisionsGeo').value = '';
  
  resetZoneCommunes();
  
  unlockForm();
});

function initMapPrincipal() {
  if (mapPrincipal) return;
  
  const container = document.getElementById('mapPrincipal');
  if (!container) return;
  
  mapPrincipal = L.map('mapPrincipal').setView([46.603354, 1.888334], 6);
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    maxZoom: 18
  }).addTo(mapPrincipal);
}

async function updateMapPrincipal() {
  if (!mapPrincipal) {
    initMapPrincipal();
    setTimeout(() => updateMapPrincipal(), 500);
    return;
  }
  
  const loadingIndicator = document.getElementById('mapLoadingIndicator');
  if (loadingIndicator) loadingIndicator.style.display = 'block';
  
  Object.values(communeLayersPrincipal).forEach(layer => mapPrincipal.removeLayer(layer));
  communeLayersPrincipal = {};
  
  if (!communesCalculeesSaved || communesCalculeesSaved.length === 0) {
    if (loadingIndicator) loadingIndicator.style.display = 'none';
    return;
  }
  
  const communeCentrale = communeSelect.value.split('(')[0].trim();
  const bounds = [];
  
  for (const communeAvecCP of communesCalculeesSaved) {
    const communeNom = communeAvecCP.split('(')[0].trim();
    const isCentrale = (communeNom.toLowerCase() === communeCentrale.toLowerCase());
    
    try {
      const match = communeAvecCP.match(/\((\d{5})\)/);
      const codePostal = match ? match[1] : null;
      
      const url = `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(communeNom)}&fields=nom,codesPostaux,contour&format=geojson&geometry=contour`;
      const response = await fetch(url);
      const data = await response.json();
      
      if (!data.features || data.features.length === 0) continue;
      
      let feature = data.features[0];
      
      if (codePostal && data.features.length > 1) {
        const matchingFeature = data.features.find(f => 
          f.properties.codesPostaux && f.properties.codesPostaux.includes(codePostal)
        );
        if (matchingFeature) feature = matchingFeature;
      }
      
      const layer = L.geoJSON(feature, {
        style: {
          fillColor: isCentrale ? '#ef4444' : '#3b82f6',
          fillOpacity: isCentrale ? 0.6 : 0.4,
          color: isCentrale ? '#dc2626' : '#1e40af',
          weight: isCentrale ? 3 : 2
        },
        onEachFeature: (feature, layer) => {
          const cp = feature.properties.codesPostaux ? feature.properties.codesPostaux[0] : '';
          const tooltipContent = isCentrale 
            ? `üìç <strong>${communeNom}</strong>${cp ? ' (' + cp + ')' : ''}<br><em>Commune centrale</em>`
            : `${communeNom}${cp ? ' (' + cp + ')' : ''}`;
          
          layer.bindTooltip(tooltipContent, {
            permanent: false,
            direction: 'top',
            className: 'custom-tooltip'
          });
        }
      }).addTo(mapPrincipal);
      
      communeLayersPrincipal[communeNom] = layer;
      
      const geojsonBounds = layer.getBounds();
      bounds.push([geojsonBounds.getSouth(), geojsonBounds.getWest()]);
      bounds.push([geojsonBounds.getNorth(), geojsonBounds.getEast()]);
      
    } catch (error) {
      console.warn(`‚ö†Ô∏è Impossible de charger ${communeNom}:`, error);
    }
  }
  
  if (bounds.length > 0) {
    mapPrincipal.fitBounds(bounds, { padding: [20, 20] });
  }
  
  if (loadingIndicator) loadingIndicator.style.display = 'none';
}

</script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>
</html>

