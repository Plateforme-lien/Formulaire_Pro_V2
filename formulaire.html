<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Questionnaire de r√©f√©rencement ‚Äî Professionnels TSA</title>
<style>
  :root{
    --bg:#f6f8fb;
    --card:#fff;
    --primary:#0ea5a4;
    --primary-dark:#0d8887;
    --muted:#6b7280;
    --section-bg:#f9fafb;
    --prereq-bg:#e6f7f7;
  }
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:24px;line-height:1.6;color:#0f1724}
  .wrap{max-width:980px;margin:18px auto}
  .card{background:var(--card);border-radius:16px;padding:32px 36px;box-shadow:0 8px 30px rgba(2,6,23,0.06);margin-bottom:24px}

  .nav-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:32px;padding-bottom:16px;border-bottom:2px solid #e6eef6}
  .nav-header h1{margin:0;font-size:24px;color:#0f1724}
  .nav-links{display:flex;gap:16px;align-items:center}
  .nav-links a{color:var(--muted);text-decoration:none;font-size:14px;font-weight:600;transition:color 0.2s}
  .nav-links a:hover{color:var(--primary)}

  h2{margin:0 0 16px;color:var(--muted);font-size:17px;font-weight:600;line-height:1.6}
  h3{margin:24px 0 12px;font-size:16px;font-weight:700;color:#0f1724}

  .section-title{margin:32px 0 20px;font-size:20px;font-weight:700;color:#0f1724;border-bottom:3px solid var(--primary);padding-bottom:8px}
  .section-title:first-of-type{margin-top:0}

  label{display:block;margin-top:20px;font-weight:600;color:#0f1724;font-size:15px}

  input[type=text],input[type=email],input[type=tel],input[type=date],input[type=number],select,textarea,button{
    width:100%;
    padding:12px 14px;
    margin-top:8px;
    border:2px solid #e6eef6;
    border-radius:8px;
    font-size:15px;
    transition:border-color 0.2s;
    box-sizing:border-box;
    font-family:inherit;
  }
  input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary)}

  button{background:var(--primary);color:#fff;border:none;margin-top:15px;cursor:pointer;font-weight:600;transition:all 0.2s}
  button:hover{background:var(--primary-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(14,165,164,0.3)}
  button:disabled{background:#d1d5db;cursor:not-allowed;transform:none}

  .btn-secondary{background:#eef2f7;color:#0f1724;margin-top:20px}
  .btn-secondary:hover{background:#e1e7ef;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
  .btn-danger{background:#ef4444;color:#fff;margin-top:20px}
  .btn-danger:hover{background:#dc2626}

  .info-box{background:#e6f7f7;padding:16px 20px;border-left:4px solid var(--primary);border-radius:8px;margin-bottom:20px;color:#0f1724}
  .info-box strong{color:var(--primary)}

  .checkbox-group{margin-top:12px}
  .checkbox-item{display:flex;align-items:center;margin:10px 0}
  .checkbox-item input[type="checkbox"]{width:auto;margin:0 8px 0 0;cursor:pointer}
  .checkbox-item label{margin:0;font-weight:400;cursor:pointer}

  textarea{font-family:Arial, sans-serif;line-height:1.4;min-height:100px;resize:vertical}
  .help-text{font-size:13px;color:var(--muted);margin-top:6px;font-style:italic}
  label.required {color: #0f1724;}
  label.required::after {content: " *";color: #ef4444;margin-left: 4px;font-weight: bold;}

  footer{text-align:center;margin-top:48px;padding-top:32px;border-top:2px solid #e6eef6;color:var(--muted);font-size:14px}
  footer a{color:var(--primary);text-decoration:none;font-weight:600}
  footer a:hover{text-decoration:underline}

  .prereq-section{background:var(--prereq-bg);padding:18px;border-radius:12px;margin-top:24px;border-left:4px solid var(--primary);margin-bottom: 48px;}
  .error{color:#dc2626;margin-top:8px;font-weight:500}
  .small{font-size:13px;color:var(--muted);margin-top:8px;line-height:1.5}
  .hidden{display:none}
  .success-banner{background:#d1fae5;border:2px solid #10b981;padding:24px;border-radius:12px;margin-top:24px;text-align:center}
  .section-number{background:var(--primary);color:white;min-width:28px;width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;flex-shrink:0}

  @media(max-width:768px){
    body{padding:16px}
    .card{padding:24px 20px}
    .nav-header{flex-direction:column;align-items:flex-start;gap:12px}
    .nav-links{flex-wrap:wrap}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="nav-header">
    <h1>üìã Questionnaire de r√©f√©rencement</h1>
    <nav class="nav-links">
      <a href="index.html">üè† Accueil</a>
      <a href="mentions.html">üìã Mentions l√©gales</a>
    </nav>
  </div>
  
  <div class="card">
    <h2>Compl√©tez vos informations professionnelles pour √™tre r√©f√©renc√© sur la plateforme</h2>

    <div class="info-box">
      <strong>‚è±Ô∏è Temps estim√© :</strong> 5 minutes maximum
    </div>

    <div id="section-email">
      <h3 class="section-title">1Ô∏è‚É£ V√©rification de votre identit√©</h3>

      <p class="small" style="margin-top:8px">
        Les questions avec un <span style="color:#ef4444;font-weight:bold">*</span> sont obligatoires.
      </p>

      <label for="email" class="required">Adresse e-mail professionnelle</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="email" type="email" placeholder="exemple@professionnel.fr" autocomplete="email"/>
        <button id="sendCodeBtn" type="button">üìß V√©rifier mon mail</button>
      </div>
      <div id="emailMsg" class="small"></div>

      <div id="codeArea" class="hidden" style="margin-top:12px">
        <label for="code" class="required">Code de v√©rification (envoy√© par e-mail)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="code" type="text" placeholder="000000" inputmode="numeric"/>
          <button id="verifyBtn" type="button">Valider le code</button>
          <button id="resendBtn" class="btn-secondary" type="button" style="width:auto;padding:10px 14px">Renvoyer</button>
        </div>
        <div id="codeMsg" class="small"></div>
      </div>

      <div id="newUserMessage" class="hidden" style="background:#e6f7f7;border:2px solid #0ea5a4;padding:18px;border-radius:12px;margin-top:16px;text-align:center">
        <div style="font-size:36px;margin-bottom:8px">üëã</div>
        <h3 style="margin:0 0 8px;color:#0f1724;font-size:18px">Bienvenue !</h3>
        <p class="small" style="margin:0">Vous √™tes un nouvel utilisateur. Merci de remplir le formulaire ci-dessous.</p>
      </div>

      <div id="existingUserChoice" class="hidden" style="margin-top:16px">
        <div style="background:#f0f9ff;border:2px solid #3b82f6;padding:16px;border-radius:12px;text-align:center">
          <div style="font-size:36px;margin-bottom:8px">‚úÖ</div>
          <h3 style="margin:0 0 8px;color:#0f1724;font-size:18px">Bon retour !</h3>
          <p class="small" style="margin:0 0 12px">Vos informations sont d√©j√† enregistr√©es. Que souhaitez-vous faire ?</p>
          <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
            <button id="modifyBtn" type="button" style="background:#3b82f6;padding:10px 18px;color:#fff;border-radius:8px">‚úèÔ∏è Modifier mes informations</button>
            <button id="deleteBtn" type="button" class="btn-secondary" style="background:#fee;color:#dc2626;border:2px solid #dc2626;padding:10px 18px;border-radius:8px">üóëÔ∏è Supprimer mes informations</button>
          </div>
        </div>
      </div>

      <div id="deleteConfirmation" class="hidden" style="margin-top:16px">
        <div style="background:#fee;border:2px solid #dc2626;padding:16px;border-radius:12px">
          <h3 style="margin:0 0 8px;color:#dc2626;font-size:16px">‚ö†Ô∏è Confirmer la suppression</h3>
          <p class="small" style="margin:0 0 12px">√ätes-vous s√ªr(e) de vouloir supprimer d√©finitivement vos informations ? Cette action est <strong>irr√©versible</strong>.</p>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="confirmDeleteBtn" type="button" style="background:#dc2626;color:#fff;padding:10px 16px;border-radius:8px">‚úì Oui, supprimer</button>
            <button id="cancelDeleteBtn" type="button" class="btn-secondary" style="padding:10px 16px;border-radius:8px">‚úï Annuler</button>
          </div>
          <div id="deleteMsg" class="small" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <form id="form" class="hidden" onsubmit="return false;">
      <div class="prereq-section">
        <div style="font-weight:700;margin-bottom:8px">Pr√©requis</div>

        <label style="margin-top:0" class="required">Avez-vous un num√©ro professionnel ?</label>
        <div style="margin-top:12px">
          <label class="inline"><input type="radio" name="numType" value="siret"> Oui, j'ai un num√©ro SIRET</label>
          <label class="inline"><input type="radio" name="numType" value="none"> Non, je n'ai pas de num√©ro</label>
        </div>

        <div id="siretBlock" class="hidden">
          <label for="siretNum" class="required">Quel est votre num√©ro SIRET ?</label>
          <input id="siretNum" name="siretNum" type="text" maxlength="14" inputmode="numeric" placeholder="14 chiffres"/>
          <div id="siretErr" class="error"></div>
        </div>

        <div id="noNum" class="error hidden">Ce questionnaire n'est autoris√© que pour les professionnels ayant un num√©ro de SIRET.</div>
      </div>

      <div id="rest" class="hidden">
        <div class="section-title"><span class="section-number">1</span> Identit√© et coordonn√©es</div>

        <label for="nom" class="required">Nom</label>
        <input id="nom" name="nom" type="text"/>

        <label for="prenom" class="required">Pr√©nom</label>
        <input id="prenom" name="prenom" type="text"/>

        <label for="phone">T√©l√©phone (optionnel)</label>
        <input id="phone" name="phone" type="tel" placeholder="0X XX XX XX XX ou +33..."/>

        <div class="section-title"><span class="section-number">2</span> Activit√© professionnelle</div>

        <label for="profession" class="required">Profession</label>
        <select id="profession" name="profession">
          <option value="">-- s√©lectionnez --</option>
          <option>√âducateur sp√©cialis√©</option>
          <option>Ergoth√©rapeute</option>
          <option>Psychologue</option>
          <option>Psychomotricien</option>
          <option>Orthophoniste</option>
        </select>

        <label style="margin-top:24px" class="required">Aupr√®s de quel(s) public(s) intervenez-vous ?</label>
        <div class="small" style="margin-top:4px">Vous pouvez s√©lectionner plusieurs r√©ponses.</div>
        <div style="margin-top:12px">
          <label><input type="checkbox" name="public" value="0-6"> Enfants (0-6 ans)</label>
          <label><input type="checkbox" name="public" value="7-12"> Enfants (7-12 ans)</label>
          <label><input type="checkbox" name="public" value="13-18"> Adolescents (13-18 ans)</label>
          <label><input type="checkbox" name="public" value="18+"> Adultes (18+)</label>
        </div>
        
        <label style="margin-top:24px" class="required">Quel est votre mode d'intervention principal ?</label>
        <div class="small" style="margin-top:4px">S√©lectionnez l'option qui correspond le mieux √† votre pratique.</div>
        <div style="margin-top:12px">
          <label><input type="radio" name="modeIntervention" value="cabinet"> Uniquement en cabinet</label>
          <label><input type="radio" name="modeIntervention" value="deplacement"> Je me d√©place au domicile</label>
          <label><input type="radio" name="modeIntervention" value="mixte"> Les deux (cabinet + d√©placements)</label>
        </div>

        <label style="margin-top:24px" class="required">Proposez-vous des rendez-vous en visio ?</label>
        <div style="margin-top:12px">
          <label><input type="radio" name="visio" value="oui"> Oui</label>
          <label><input type="radio" name="visio" value="non"> Non</label>
        </div>

        <div id="section-geo" class="hidden">
          <div class="section-title" style="margin-top:32px"><span class="section-number">3</span> Zone g√©ographique d'intervention</div>

          <label for="departement" class="required">Dans quel d√©partement intervenez-vous ?</label>
          <select id="departement" name="departement"><option value="">-- Chargement --</option></select>

          <div id="blocCommune" class="hidden">
            <label for="commune" class="required" id="labelCommune">Quelle est votre commune d'intervention ?</label>
            <select id="commune" name="commune"><option value="">-- Choisissez le d√©partement --</option></select>
          </div>

          <div id="questionsDeplacements" class="hidden">
            
            <div id="zoneMetropole" class="hidden">
              <label for="tempsTrajet" class="required">Quel est votre temps de trajet maximal ?</label>
              <select id="tempsTrajet" name="tempsTrajet" style="margin-top:8px;">
                <option value="">-- S√©lectionnez --</option>
                <option>15 min</option>
                <option>20 min</option>
                <option>25 min</option>
                <option>30 min</option> 
                <option>35 min</option>
                <option>40 min</option>                
                <option>45 min</option>
              </select>
              <div class="small" style="margin-top:4px;">Temps de trajet en voiture depuis votre commune principale.</div>
              
              <div style="margin-top:12px;">
                <a href="#" id="visualiserLinkMetro" style="color:var(--primary);text-decoration:none;font-size:14px;font-weight:600;">
                  üìç Visualiser les communes couvertes
                </a>
              </div>
            </div>

            <div id="zoneOutreMer" class="hidden">
              <label for="rayonKm" class="required">Quel est votre rayon d'intervention (en km) ?</label>
              <select id="rayonKm" name="rayonKm" style="margin-top:8px;">
                <option value="">-- S√©lectionnez --</option>
                <option>10 km</option>
                <option>15 km</option>
                <option>20 km</option>
                <option>25 km</option>
                <option>30 km</option>
                <option>40 km</option>
                <option>Tout mon d√©partement</option>
              </select>
              <div class="small" style="margin-top:4px;">Distance √† vol d'oiseau depuis votre commune.</div>

              <label for="precisionsGeo" style="margin-top:20px">Pr√©cisions g√©ographiques (optionnel)</label>
              <textarea id="precisionsGeo" name="precisionsGeo" rows="3" placeholder="Ex: Je couvre uniquement certains quartiers..."></textarea>
              <div class="small" style="margin-top:4px;">Indiquez ici toute pr√©cision utile.</div>
              
              <div style="margin-top:12px;">
                <a href="#" id="visualiserLinkOM" style="color:var(--primary);text-decoration:none;font-size:14px;font-weight:600;">
                  üìç Visualiser les communes couvertes
                </a>
              </div>
            </div>

            <!-- üÜï ZONE D'AFFICHAGE DES COMMUNES CALCUL√âES -->
            <div id="communesCalculeesZone" class="hidden" style="margin-top: 20px;">
              <div style="background: #f0f9ff; border: 2px solid #3b82f6; padding: 20px; border-radius: 12px;">
                <h4 style="margin: 0 0 12px; color: #1e40af; font-size: 16px;">
                    üìç Communes couvertes par votre intervention <span style="color: #ef4444; font-weight: bold;">*</span>
                </h4>
                
                <div id="communesCalculeesInfo" style="margin-bottom: 12px; color: #666; font-size: 14px;">
                  <!-- Stats affich√©es ici -->
                </div>
                
                <div id="communesCalculeesListe" style="
                  max-height: 300px; 
                  overflow-y: auto; 
                  background: white; 
                  border: 1px solid #e5e7eb; 
                  border-radius: 8px; 
                  padding: 12px;
                ">
                  <div style="text-align: center; color: #999; padding: 20px;">
                    Cliquez sur "Visualiser" pour calculer les communes
                  </div>
                </div>
                
                <!-- üÜï BOUTONS VALIDER / MODIFIER -->
                <div id="btnGroupeCommunes" style="display: none; margin-top: 16px; gap: 8px;">
                  <button 
                    type="button" 
                    id="btnValiderCommunes" 
                    onclick="validerCommunes()" 
                    style="
                      width: 100%;
                      padding: 12px;
                      background: var(--primary);
                      color: white;
                      border: none;
                      border-radius: 8px;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.2s;
                    "
                  >
                    ‚úì Valider cette liste de communes
                  </button>
                  
                  <button 
                    type="button" 
                    id="btnModifierCommunes" 
                    onclick="afficherInterfaceModification()" 
                    style="
                      width: 100%;
                      padding: 12px;
                      background: #f59e0b;
                      color: white;
                      border: none;
                      border-radius: 8px;
                      font-weight: 600;
                      cursor: pointer;
                      transition: all 0.2s;
                      margin-top: 8px;
                    "
                  >
                    ‚úèÔ∏è Modifier cette liste manuellement
                  </button>
                </div>

                <!-- üÜï INTERFACE DE MODIFICATION DES COMMUNES -->
                <div id="interfaceModificationCommunes" class="hidden" style="margin-top: 20px;">
                  <div style="background: #fff9e6; border: 2px solid #ffc107; padding: 20px; border-radius: 12px;">
                    <h4 style="margin: 0 0 16px; color: #856404; font-size: 16px; font-weight: 700;">
                      ‚úèÔ∏è Personnaliser la liste des communes
                    </h4>
                    
                    <!-- BARRE DE RECHERCHE -->
                    <div style="margin-bottom: 20px;">
                      <label style="font-weight: 600; margin-bottom: 8px; display: block; color: #0f1724; font-size: 14px;">
                        üîç Ajouter une commune manuellement
                      </label>
                      <div class="small" style="margin-bottom: 8px; color: #6b7280;">
                        Recherchez n'importe quelle commune en France (minimum 3 lettres)
                      </div>
                      
<div style="display: flex; gap: 8px; align-items: stretch;">
<input 
  type="text" 
  id="rechercheCommune" 
  placeholder="Ex: Nancy, Paris, Marseille..."
  oninput="rechercherCommuneEnTempsReel()"
  onkeypress="if(event.key==='Enter'){event.preventDefault();}"
  autocomplete="off"
  autocorrect="off"
  autocapitalize="off"
  spellcheck="false"
  style="
    flex: 1 !important; 
    width: auto !important;
    padding: 10px 12px !important; 
    border: 2px solid #e6eef6 !important; 
    border-radius: 8px !important;
    font-size: 14px !important;
    margin-top: 0 !important;
  "
/>

<button 
  type="button" 
  onclick="rechercherCommune()" 
  style="
    width: auto !important;
    flex: 0 0 auto !important;
    padding: 10px 16px !important; 
    background: var(--primary) !important; 
    color: white !important; 
    border: none !important; 
    border-radius: 8px !important; 
    cursor: pointer !important; 
    font-weight: 600 !important;
    white-space: nowrap !important;
    font-size: 14px !important;
    margin-top: 0 !important;
    display: none !important;
  "
>
  Rechercher
</button>
</div>
                      <div id="resultatsRecherche" style="margin-top: 8px;"></div>
                    </div>
                    
                    <!-- LISTE DES COMMUNES AVEC CHECKBOXES -->
                    <div style="margin-top: 20px;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label style="font-weight: 600; display: block; color: #0f1724; margin: 0; font-size: 14px;">
                          üìã Communes s√©lectionn√©es
                        </label>
                        <span id="compteurCommunes" style="font-size: 13px; color: #6b7280; font-weight: 600;">
                          0 commune(s)
                        </span>
                      </div>
                      <div class="small" style="margin-bottom: 8px; color: #6b7280;">
                        Cochez/d√©cochez les communes √† inclure dans votre zone d'intervention
                      </div>
                      <div style="background: white; border: 2px solid #e6eef6; border-radius: 8px; padding: 8px; margin-top: 8px;">
                        <div id="listeCommunesCheckboxes" style="max-height: 300px; overflow-y: auto;" title="">
                          <p style="color: #999; text-align: center; padding: 20px; margin: 0;">
                            Chargement...
                          </p>
                        </div>
                      </div>
                    </div>
                    
                    <!-- BOUTONS ACTIONS -->
                    <div style="display: flex; gap: 8px; margin-top: 20px;">
                      <button 
                        type="button" 
                        onclick="validerModifications()" 
                        style="
                          flex: 1;
                          padding: 12px;
                          background: #10b981;
                          color: white;
                          border: none;
                          border-radius: 8px;
                          font-weight: 600;
                          cursor: pointer;
                          transition: all 0.2s;
                        "
                      >
                        ‚úì Enregistrer mes modifications
                      </button>
                      
                      <button 
                        type="button" 
                        onclick="annulerModifications()" 
                        style="
                          flex: 1;
                          padding: 12px;
                          background: #6b7280;
                          color: white;
                          border: none;
                          border-radius: 8px;
                          font-weight: 600;
                          cursor: pointer;
                          transition: all 0.2s;
                        "
                      >
                        ‚úï Annuler
                      </button>
                    </div>
                  </div>
                </div>
                
                <!-- Message explicatif (change selon le mode) -->
                <div id="messageExplicatif" class="small" style="margin-top: 12px; color: #6b7280; font-style: italic;">
                    üí° Cette liste est une <strong>estimation automatique</strong> bas√©e sur votre temps de trajet / rayon.
                </div>
              </div>
            </div>

          </div> <!-- FIN questionsDeplacements -->
        </div> <!-- FIN section-geo -->
                
        <div class="section-title"><span class="section-number">4</span> Disponibilit√©s</div>
        <label class="required">Avez-vous des disponibilit√©s pour de nouveaux b√©n√©ficiaires ?</label>
        <div style="margin-top:12px">
          <label><input type="radio" name="dispo" value="oui"> Oui</input></label>
          <label><input type="radio" name="dispo" value="non"> Non</label>
        </div>
        
        <div id="dateBlock" class="hidden">
          <label for="dateDispo" class="required">√Ä partir de quelle date √™tes-vous disponible ?</label>
          <input id="dateDispo" name="dateDispo" type="date"/>
          
          <label for="placesDisponibles" class="required" style="margin-top:20px">
            Combien de nouveaux b√©n√©ficiaires pourrez-vous accueillir ?
          </label>
          <input 
            id="placesDisponibles" 
            name="placesDisponibles" 
            type="number" 
            min="1" 
            max="10" 
            placeholder="Ex: 1"
            style="width: 150px;margin-top:8px"
          />
          <div class="small" style="margin-top:6px;color:#6b7280">
            Indiquez le nombre de places disponibles (entre 1 et 10)
          </div>
        </div>

        <div id="modeContactBlock" class="hidden">
          <div class="section-title" style="margin-top:32px"><span class="section-number">5</span> Pr√©f√©rences de contact</div>
          
          <label class="required">Comment souhaitez-vous √™tre contact√© par les particuliers ?</label>
          <div class="info-box" style="margin-top:8px">
            <strong>‚ÑπÔ∏è Important :</strong> Cette option d√©termine si vos coordonn√©es (email et t√©l√©phone) 
            seront visibles directement ou si les particuliers devront passer par un formulaire de contact.
          </div>
          
          <div style="margin-top:12px">
            <label>
              <input type="radio" name="modeContact" value="direct">
              <strong>üìß Contact direct</strong>
              <div class="small" style="margin-left:24px;margin-top:4px">
                Mon email et mon t√©l√©phone seront affich√©s. Les particuliers peuvent me contacter directement.
              </div>
            </label>
            
            <label style="margin-top:12px">
              <input type="radio" name="modeContact" value="formulaire">
              <strong>üìù Contact via formulaire uniquement</strong>
              <div class="small" style="margin-left:24px;margin-top:4px">
                Mes coordonn√©es restent priv√©es. Les particuliers m'envoient un message via un formulaire.
              </div>
            </label>
          </div>
        </div>
        
        <div class="section-title" style="margin-top:32px"><span class="section-number" id="consentNumber">5</span> Consentement</div>
        <label style="margin-top:0;display:flex;align-items:start;gap:8px" class="required">
          <input id="consent" name="consent" type="checkbox" style="margin-top:4px"/>
          <span>J'accepte que mes donn√©es soient utilis√©es uniquement dans le cadre de cette mise en relation.</span>
        </label>

        <div class="actions" style="display:flex;gap:12px;align-items:center;margin-top:24px;flex-wrap:wrap">
          <button id="submit" type="button">‚úì Enregistrer mes informations</button>
          <button id="editBtn" type="button" class="hidden">‚úèÔ∏è Modifier mes informations</button>
          <button id="resetBtn" type="button" class="btn-secondary">R√©initialiser</button>
        </div>
        <div id="submitMsg" class="small" style="margin-top:12px"></div>
      </div>

      <div id="successBanner" class="success-banner hidden">
        <div style="font-size:64px;margin-bottom:16px">‚úÖ</div>
        <h3 style="margin:0 0 12px;color:#0f1724;font-size:24px;font-weight:700">Formulaire envoy√© avec succ√®s !</h3>
        <p style="margin:0 0 16px;color:#059669;font-size:16px;font-weight:600">Vous avez re√ßu un email de confirmation.</p>
        <p style="margin:0 0 24px;color:#6b7280;font-size:15px">Vos informations ont √©t√© enregistr√©es. Vous pouvez fermer cette page.</p>
      </div>
    </form>
  </div>

  <footer>
    <p>
      <a href="index.html">Accueil</a> ‚Ä¢ 
      <a href="mentions.html">Mentions l√©gales</a> ‚Ä¢ 
      <a href="mentions.html#confidentialite">Politique de confidentialit√©</a> ‚Ä¢ 
      <a href="mentions.html#contact">Contact</a>
    </p>
    <p style="margin-top:12px;font-size:13px">¬© 2025 - R√©f√©rencement Professionnels TSA</p>
  </footer>
  
</div>
<script>
/* ========== CONFIG ========== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbww78Q-FrcILGHJu0O0lRgajYaFn9qJPq8ViSwDEixSOQ_ZiTWgJVX64mMcNHwirwFf/exec"; 
const DEPT_API = "https://geo.api.gouv.fr/departements";
const COMMUNE_API = code => `https://geo.api.gouv.fr/departements/${code}/communes`;

// üÜï VARIABLES GLOBALES pour gestion des communes
let communesCalculeesSaved = [];
let communesValidees = false;

/* ========== HELPERS VALIDATION ========== */
const isDigits = s => /^\d+$/.test(s||"");
const validSiret = v => isDigits(v) && v.length === 14;
const validPhone = v => {
  if(!v) return true;
  const c = v.replace(/\s|\-|\(|\)|\./g,"");
  return /^(0[1-9]\d{8}|\+33[1-9]\d{8})$/.test(c) || /^[0-9]{10,15}$/.test(c);
};

/* ========== DOM ========= */
const emailEl = document.getElementById("email");
const sendCodeBtn = document.getElementById("sendCodeBtn");
const emailMsg = document.getElementById("emailMsg");
const codeArea = document.getElementById("codeArea");
const codeEl = document.getElementById("code");
const verifyBtn = document.getElementById("verifyBtn");
const resendBtn = document.getElementById("resendBtn");
const codeMsg = document.getElementById("codeMsg");
const formEl = document.getElementById("form");
const siretBlock = document.getElementById("siretBlock");
const noNum = document.getElementById("noNum");
const rest = document.getElementById("rest");
const siretNum = document.getElementById("siretNum");
const siretErr = document.getElementById("siretErr");
const submitBtn = document.getElementById("submit");
const editBtn = document.getElementById("editBtn");
const submitMsg = document.getElementById("submitMsg");
const departSelect = document.getElementById("departement");
const communeSelect = document.getElementById("commune");
const dateBlock = document.getElementById("dateBlock");
const dateInput = document.getElementById("dateDispo");
const resetBtn = document.getElementById("resetBtn");
const newUserMessage = document.getElementById("newUserMessage");
const existingUserChoice = document.getElementById("existingUserChoice");
const deleteConfirmation = document.getElementById("deleteConfirmation");
const modifyBtn = document.getElementById("modifyBtn");
const deleteBtn = document.getElementById("deleteBtn");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
const deleteMsg = document.getElementById("deleteMsg");
const successBanner = document.getElementById("successBanner");
const visualiserLinkMetro = document.getElementById("visualiserLinkMetro");
const visualiserLinkOM = document.getElementById("visualiserLinkOM");
const placesInput = document.getElementById("placesDisponibles");
const modeContactBlock = document.getElementById("modeContactBlock");
const consentNumber = document.getElementById("consentNumber");

let CURRENT_EMAIL = null;
let EXISTING = false;
let EXISTING_DATA = null;
let FORM_LOCKED = false;

/* ========== AFFICHAGE DYNAMIQUE SECTION 3 (MODE + D√âPARTEMENT) ========== */
const DEPS_METRO = ['01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','21','22','23','24','25','26','27','28','29','2A','2B','30','31','32','33','34','35','36','37','38','39','40','41','42','43','44','45','46','47','48','49','50','51','52','53','54','55','56','57','58','59','60','61','62','63','64','65','66','67','68','69','70','71','72','73','74','75','76','77','78','79','80','81','82','83','84','85','86','87','88','89','90','91','92','93','94','95'];
const DEPS_DOMTOM = ['971','972','973','974','976'];

function updateSectionGeo() {
  const modeIntervention = document.querySelector('input[name="modeIntervention"]:checked');
  const codeDept = departSelect.value;
  
  const sectionGeo = document.getElementById('section-geo');
  const blocCommune = document.getElementById('blocCommune');
  const questionsDeplacements = document.getElementById('questionsDeplacements');
  const zoneMetropole = document.getElementById('zoneMetropole');
  const zoneOutreMer = document.getElementById('zoneOutreMer');
  const labelCommune = document.getElementById('labelCommune');
  
  sectionGeo.classList.add('hidden');
  blocCommune.classList.add('hidden');
  questionsDeplacements.classList.add('hidden');
  zoneMetropole.classList.add('hidden');
  zoneOutreMer.classList.add('hidden');
  
  if (!modeIntervention) return;
  
  const valeur = modeIntervention.value;
  
  if (valeur === 'cabinet') {
    sectionGeo.classList.remove('hidden');
    labelCommune.textContent = 'Quelle est votre commune d\'intervention ?';
    questionsDeplacements.classList.add('hidden');
    
    if (departSelect.value) {
      blocCommune.classList.remove('hidden');
    }
    
  } else if (valeur === 'deplacement' || valeur === 'mixte') {
    sectionGeo.classList.remove('hidden');
    labelCommune.textContent = 'Quelle est votre commune principale d\'intervention ?';
    
    if (departSelect.options.length <= 1) {
      loadDepartements();
    }
    
    if (codeDept) {
      blocCommune.classList.remove('hidden');
      questionsDeplacements.classList.remove('hidden');
      
      if (DEPS_METRO.includes(codeDept)) {
        zoneMetropole.classList.remove('hidden');
        zoneOutreMer.classList.add('hidden');
        document.getElementById('precisionsGeo').value = '';
        
      } else if (DEPS_DOMTOM.includes(codeDept)) {
        zoneMetropole.classList.add('hidden');
        zoneOutreMer.classList.remove('hidden');
      }
    }
  }
}

document.querySelectorAll('input[name="modeIntervention"]').forEach(radio => {
  radio.addEventListener('change', updateSectionGeo);
});

/* ========== FONCTIONS DE VERROUILLAGE ========== */
function lockForm() {
  FORM_LOCKED = true;
  
  rest.style.display = 'none';
  document.querySelector('.prereq-section').style.display = 'none';
  newUserMessage.classList.add('hidden');
  
  document.getElementById('section-email').style.display = 'none';
  document.querySelectorAll('label.required').forEach(label => { label.style.display = 'none'; });
  document.querySelector('h1').style.display = 'none';
  document.querySelector('h2').style.display = 'none';
  document.querySelector('.info-box').style.display = 'none';
  emailEl.parentElement.parentElement.querySelector('label').style.display = 'none';
  emailEl.parentElement.style.display = 'none';
  
  submitBtn.classList.add('hidden');
  resetBtn.classList.add('hidden');
  editBtn.classList.add('hidden');
  
  successBanner.classList.remove('hidden');
  successBanner.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
  
function unlockForm() {
  FORM_LOCKED = false;
  
  document.querySelectorAll('#form input, #form select, #form textarea').forEach(el => {
    el.disabled = false;
  });
  
  submitBtn.classList.remove('hidden');
  editBtn.classList.add('hidden');
  resetBtn.classList.remove('hidden');
  
  successBanner.classList.add('hidden');
  submitMsg.textContent = "";
}

/* ========== BOUTON MODIFIER ========== */
editBtn.addEventListener('click', () => {
  unlockForm();
});

/* ========== SEND CODE ========== */
sendCodeBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  if (!mail) { 
    emailMsg.textContent = "Merci d'indiquer une adresse e-mail."; 
    return; 
  }
  
  emailMsg.textContent = "Envoi du code en cours...";
  sendCodeBtn.disabled = true;
  
  try {
    const r = await fetch(`${SCRIPT_URL}?action=sendCode&email=${encodeURIComponent(mail)}&_t=${Date.now()}`);
    const j = await r.json();
    
    console.log("R√©ponse serveur sendCode:", j);
    if (j.alreadySent) {
      console.log("üîç Code d√©j√† envoy√© r√©cemment - pas de nouvel email");
    } else if (j.ok) {
      console.log("‚úÖ Nouveau code envoy√© par email");
    }

    if (j.error === "DAILY_LIMIT_REACHED") {
      if (j.minutesRestantes && j.minutesRestantes > 0) {
        const heures = Math.floor(j.minutesRestantes / 60);
        const minutes = j.minutesRestantes % 60;
        const tempsRestant = heures > 0
          ? `${heures}h${minutes > 0 ? minutes + 'min' : ''}`
          : `${minutes} minutes`;

        emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Vous avez d√©j√† demand√© trois codes aujourd'hui</span><br>
          <span style="color:#6b7280">Le dernier vous a √©t√© envoy√© il y a moins de 15 minutes. Il est encore valable pendant environ ${tempsRestant}.</span>`;
      } else {
        emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ùå Limite quotidienne atteinte</span><br>
          <span style="color:#6b7280">Vous avez d√©j√† demand√© ${j.codesEnvoyes || 3} codes aujourd'hui. Maximum autoris√© : 3 codes par jour. R√©essayez demain.</span>`;
      }
      sendCodeBtn.disabled = false;
      return;
    }

    if (j.error === "COOLDOWN_ACTIVE") {
      const heures = Math.floor(j.minutesRestantes / 60);
      const minutes = j.minutesRestantes % 60;
      const tempsRestant = heures > 0 ? `${heures}h${minutes > 0 ? minutes + 'min' : ''}` : `${minutes} minutes`;
      
      emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Veuillez patienter</span><br>
        <span style="color:#6b7280">Vous avez r√©cemment soumis le formulaire. Vous pourrez redemander un code dans environ ${tempsRestant}.</span>`;
      sendCodeBtn.disabled = false;
      return;
    }

    if (j.error === "SERVICE_QUOTA_EXCEEDED") {
      emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ö†Ô∏è Service temporairement indisponible</span><br>
        <span style="color:#6b7280">Le quota d'emails quotidien est atteint. Merci de r√©essayer demain.</span>`;
      sendCodeBtn.disabled = false;
      return;
    }
    
    if (j.ok) {
        if (j.alreadySent) {
          emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Code d√©j√† envoy√©</span><br>
          <span style="color:#6b7280">Un code vous a d√©j√† √©t√© envoy√© il y a moins de 15 minutes. Le code est encore valable.</span>`;
          codeMsg.textContent = "";
        } else {
          emailMsg.innerHTML = `<span style="color:#059669;font-weight:600">‚úì Code envoy√© avec succ√®s</span><br>
          <span style="color:#6b7280">V√©rifiez votre bo√Æte mail (pensez aux spams).</span>`;
          codeMsg.textContent = ""; 
        }
      
      CURRENT_EMAIL = mail;
      codeArea.classList.remove("hidden");
      sendCodeBtn.style.display = "none";
      codeEl.focus();
    } else {
      emailMsg.innerHTML = `<span style="color:#dc2626">Erreur : ${j.error || "Impossible d'envoyer le code"}</span>`;
    }
  } catch (err) {
    console.error("Erreur r√©seau:", err);
    emailMsg.innerHTML = `<span style="color:#dc2626">Erreur r√©seau lors de l'envoi du code</span>`;
  } finally {
    sendCodeBtn.disabled = false;
  }
});

emailEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendCodeBtn.click();
  }
});

/* ========== RESEND ========== */
resendBtn.addEventListener("click", async () => {
  emailMsg.textContent = "Renvoi du code en cours...";
  codeMsg.textContent = ""; 
  resendBtn.disabled = true;
  
  const mail = (emailEl.value || "").trim().toLowerCase();
  
  try {
    const r = await fetch(`${SCRIPT_URL}?action=sendCode&email=${encodeURIComponent(mail)}&_t=${Date.now()}`);
    const j = await r.json();
    
    if (j.alreadySent) {
      emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Code d√©j√† envoy√© r√©cemment</span><br>
      <span style="color:#6b7280">Un code vous a d√©j√† √©t√© envoy√© il y a moins de 15 minutes. Le code est encore valable.</span>`;
    } else if (j.ok) {
      emailMsg.innerHTML = `<span style="color:#059669;font-weight:600">‚úì Code renvoy√© avec succ√®s</span><br>
      <span style="color:#6b7280">V√©rifiez votre bo√Æte mail (pensez aux spams).</span>`;
    } else if (j.error === "DAILY_LIMIT_REACHED") {
      if (j.minutesRestantes && j.minutesRestantes > 0) {
        const heures = Math.floor(j.minutesRestantes / 60);
        const minutes = j.minutesRestantes % 60;
        const tempsRestant = heures > 0
          ? `${heures}h${minutes > 0 ? minutes + 'min' : ''}`
          : `${minutes} minutes`;
        
        emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Vous avez d√©j√† demand√© trois codes aujourd'hui</span><br>
          <span style="color:#6b7280">Le dernier vous a √©t√© envoy√© il y a moins de 15 minutes. Il est encore valable pendant environ ${tempsRestant}.</span>`;
      } else {
        emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ùå Limite quotidienne atteinte</span><br>
        <span style="color:#6b7280">Maximum 3 codes par jour. R√©essayez demain.</span>`;
      }
    } else {
      emailMsg.innerHTML = `<span style="color:#dc2626">Erreur : ${j.error || "Impossible de renvoyer"}</span>`;
    }
  } catch (err) {
    emailMsg.innerHTML = `<span style="color:#dc2626">Erreur r√©seau</span>`;
  } finally {
    resendBtn.disabled = false;
  }
});

/* ========== TOUCHE ENTR√âE POUR VALIDER LE CODE ========== */
codeEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    verifyBtn.click();
  }
});

/* ========== VERIFY CODE ========== */
verifyBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  const code = (codeEl.value || "").trim();
  if (!mail || !code) { codeMsg.textContent = "Merci d'indiquer l'adresse e-mail et le code."; return; }
  codeMsg.textContent = "V√©rification...";
  try {
    const r = await fetch(`${SCRIPT_URL}?action=verifyCode&email=${encodeURIComponent(mail)}&code=${encodeURIComponent(code)}&_t=${Date.now()}`);
    const j = await r.json();
    if (!j.ok) { codeMsg.textContent = "Erreur : " + (j.error||"code invalide"); return; }
    
    codeMsg.textContent = "‚úÖ E-mail v√©rifi√© avec succ√®s !";
    CURRENT_EMAIL = mail;
    codeArea.style.display = "none";
    emailMsg.style.display = "none";
    emailEl.disabled = true;
    sendCodeBtn.style.display = "none";
    
    await loadDepartements();
    
    if (j.existing && j.data) {
      EXISTING = true;
      EXISTING_DATA = j.data;
      existingUserChoice.classList.remove("hidden");
    } else {
      EXISTING = false;
      EXISTING_DATA = null;
      newUserMessage.classList.remove("hidden");
      formEl.classList.remove("hidden");
      rest.classList.add("hidden");
    }
  } catch (err) {
    codeMsg.textContent = "Erreur r√©seau lors de la v√©rification.";
  }
});

/* ========== BOUTON MODIFIER (utilisateur existant) ========== */
modifyBtn.addEventListener("click", async () => {
  existingUserChoice.classList.add("hidden");
  await showFormAndPrefill(EXISTING_DATA);
});

/* ========== BOUTON SUPPRIMER (utilisateur existant) ========== */
deleteBtn.addEventListener("click", () => {
  existingUserChoice.classList.add("hidden");
  deleteConfirmation.classList.remove("hidden");
});

/* ========== ANNULER LA SUPPRESSION ========== */
cancelDeleteBtn.addEventListener("click", () => {
  deleteConfirmation.classList.add("hidden");
  existingUserChoice.classList.remove("hidden");
  deleteMsg.textContent = "";
});

/* ========== CONFIRMER LA SUPPRESSION ========== */
confirmDeleteBtn.addEventListener("click", async () => {
  deleteMsg.textContent = "Suppression en cours...";
  confirmDeleteBtn.disabled = true;
  
  try {
    const fd = new FormData();
    fd.append("action", "deleteUser");
    fd.append("email", CURRENT_EMAIL);
    
    const res = await fetch(SCRIPT_URL, { method: "POST", body: fd });
    const j = await res.json();
    
    if (j.ok) {
      deleteMsg.innerHTML = '<span style="color:#059669;font-weight:600">‚úÖ Vos informations ont √©t√© supprim√©es avec succ√®s.</span>';
      setTimeout(() => {
        location.reload();
      }, 2000);
    } else {
      deleteMsg.innerHTML = '<span style="color:#dc2626">‚ùå Erreur : ' + (j.error || "Impossible de supprimer") + '</span>';
      confirmDeleteBtn.disabled = false;
    }
  } catch (err) {
    deleteMsg.innerHTML = '<span style="color:#dc2626">‚ùå Erreur r√©seau lors de la suppression.</span>';
    confirmDeleteBtn.disabled = false;
  }
});

/* ========== üÜï FONCTION CALCULER ET AFFICHER COMMUNES ========== */
async function calculerEtAfficherCommunes(ouvrirVisualisation = false, silencieux = false) {
  const dep = departSelect.value;
  const commune = communeSelect.value;
  const codeDept = dep ? dep.split(' ')[0] : '';
  
  if (!dep || !commune) {
    if (!silencieux) {
      alert("‚ö†Ô∏è Veuillez d'abord s√©lectionner le d√©partement et la commune.");
    }
    return;
  }

  let rayonOuTemps = '';
  
  if (DEPS_METRO.includes(codeDept)) {
    rayonOuTemps = document.getElementById("tempsTrajet")?.value;
    if (!rayonOuTemps) {
      if (!silencieux) alert("‚ö†Ô∏è S√©lectionnez un temps de trajet.");
      return;
    }
  } else if (DEPS_DOMTOM.includes(codeDept)) {
    rayonOuTemps = document.getElementById("rayonKm")?.value;
    if (!rayonOuTemps) {
      if (!silencieux) alert("‚ö†Ô∏è S√©lectionnez un rayon d'intervention.");
      return;
    }
  } else {
    return;
  }

  const zoneCommunes = document.getElementById('communesCalculeesZone');
  const listeDiv = document.getElementById('communesCalculeesListe');
  const infoDiv = document.getElementById('communesCalculeesInfo');
  const btnValider = document.getElementById('btnValiderCommunes');
  
  if (!zoneCommunes || !listeDiv || !infoDiv) {
    console.error('‚ùå √âl√©ments DOM introuvables');
    return;
  }
  
  zoneCommunes.classList.remove('hidden');
listeDiv.innerHTML = `
  <div style="text-align:center; padding:40px; color:#0ea5a4;">
    <div style="font-size:48px; margin-bottom:16px;">‚è≥</div>
    <div style="font-size:18px; font-weight:600; margin-bottom:8px;">Calcul en cours...</div>
    <div style="font-size:14px; color:#6b7280;">Analyse des communes accessibles selon votre zone d'intervention</div>
  </div> 
`;  
infoDiv.innerHTML = '<span style="color:#0ea5a4; font-weight:600;">üîÑ Calcul en cours, veuillez patienter...</span>';
if (btnValider) {
    btnValider.disabled = true;
    btnValider.style.display = 'none';
  }

  
  communesValidees = false;
  
  try {
    const url = `${SCRIPT_URL}?action=calculerCommunes&modeIntervention=deplacement&departement=${encodeURIComponent(dep)}&commune=${encodeURIComponent(commune)}&rayonOuTemps=${encodeURIComponent(rayonOuTemps)}`;
    
    console.log('üìû Appel API:', url);
    
    const response = await fetch(url);
    const result = await response.json();
    
    console.log('üì¶ R√©sultat:', result);
    
    if (result.ok && result.communes && result.communes.length > 0) {
      communesCalculeesSaved = result.communes;
      
      infoDiv.innerHTML = `
        <strong style="color:#059669;">‚úÖ ${result.nbCommunes} communes trouv√©es</strong> 
        dans <strong>${result.departements.length} d√©partement(s)</strong> : 
        ${result.departements.join(', ')}
      `;
      
      listeDiv.innerHTML = result.communes
        .sort()
        .map(c => `<div style="padding: 6px 0; border-bottom: 1px solid #f3f4f6;">${c}</div>`)
        .join('');
      
// Afficher le groupe de boutons Valider/Modifier
const btnGroupe = document.getElementById('btnGroupeCommunes');
if (btnGroupe) {
  btnGroupe.style.display = 'flex';
  btnGroupe.style.flexDirection = 'column';
}
      
      if (ouvrirVisualisation) {
        const urlVisu = `visualisation.html?dep=${encodeURIComponent(codeDept)}&commune=${encodeURIComponent(commune)}&${DEPS_METRO.includes(codeDept) ? 'tempsTrajet' : 'rayonKm'}=${encodeURIComponent(rayonOuTemps)}`;
        window.open(urlVisu, "_blank");
      }
      
    } else {
      communesCalculeesSaved = [];
      infoDiv.innerHTML = `<span style="color:#dc2626;">‚ùå Aucune commune trouv√©e</span>`;
      listeDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Aucun r√©sultat</div>';
      if (btnValider) btnValider.style.display = 'none';
    }
    
  } catch (error) {
    console.error('‚ùå Erreur:', error);
    communesCalculeesSaved = [];
    infoDiv.innerHTML = `<span style="color:#dc2626;">‚ùå Erreur lors du calcul</span>`;
    listeDiv.innerHTML = `<div style="text-align:center; padding:20px; color:#dc2626;">Erreur r√©seau</div>`;
    if (btnValider) btnValider.style.display = 'none';
  }
}

/* ========== üÜï FONCTION VALIDER COMMUNES ========== */
function validerCommunes() {
  if (communesCalculeesSaved.length === 0) {
    alert("‚ö†Ô∏è Aucune commune √† valider. Veuillez d'abord calculer la liste.");
    return;
  }
  
  communesValidees = true;
  
  const btnValider = document.getElementById('btnValiderCommunes');
  const infoDiv = document.getElementById('communesCalculeesInfo');
  
  if (btnValider) {
    btnValider.innerHTML = '‚úÖ Liste valid√©e';
    btnValider.disabled = true;
    btnValider.style.background = '#059669';
  }
  
  if (infoDiv) {
    const existingText = infoDiv.innerHTML;
    infoDiv.innerHTML = existingText + '<br><strong style="color:#059669;">‚úÖ Liste valid√©e et pr√™te √† √™tre enregistr√©e</strong>';
  }
  
  console.log('‚úÖ Communes valid√©es:', communesCalculeesSaved.length);
}


/* ========== üÜï GESTION INTERFACE MODIFICATION COMMUNES ========== */

// Variable pour tracker si la liste a √©t√© modifi√©e manuellement
let listeModifieeManuelle = false;

function afficherInterfaceModification() {
  const interfaceModif = document.getElementById('interfaceModificationCommunes');
  const btnGroupe = document.getElementById('btnGroupeCommunes');
  
  // Masquer les boutons Valider/Modifier
  btnGroupe.style.display = 'none';
  
  // Afficher l'interface de modification
  interfaceModif.classList.remove('hidden');
  
  // G√©n√©rer les checkboxes √† partir de communesCalculeesSaved
  genererCheckboxesCommunes();
  
  // Vider la recherche et les r√©sultats
  document.getElementById('rechercheCommune').value = '';
  document.getElementById('resultatsRecherche').innerHTML = '';
  
  // Scroll vers l'interface
  setTimeout(() => {
    interfaceModif.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

function genererCheckboxesCommunes() {
  const container = document.getElementById('listeCommunesCheckboxes');
  
  if (!container) {
    console.error('‚ùå Conteneur listeCommunesCheckboxes introuvable');
    return;
  }
  
  console.log('üìã G√©n√©ration checkboxes pour', communesCalculeesSaved.length, 'commune(s)');
  
  if (!communesCalculeesSaved || communesCalculeesSaved.length === 0) {
    container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px; margin: 0;">Aucune commune √† afficher</p>';
    updateCompteurCommunes();
    return;
  }
  
  // üÜï M√âMORISER L'√âTAT ACTUEL DES CHECKBOXES AVANT DE R√âG√âN√âRER
  const etatCheckboxes = {};
  const checkboxesActuelles = container.querySelectorAll('input[type="checkbox"]');
  checkboxesActuelles.forEach(cb => {
    etatCheckboxes[cb.value] = cb.checked;
  });
  
  console.log('üíæ √âtats sauvegard√©s:', Object.keys(etatCheckboxes).length, 'communes');
  
  // Trier les communes par ordre alphab√©tique
  const communesTriees = [...communesCalculeesSaved].sort((a, b) => {
    return a.localeCompare(b, 'fr', { sensitivity: 'base' });
  });
  
  // G√©n√©rer le HTML
  const html = communesTriees.map((commune, index) => {
    // √âchapper les caract√®res sp√©ciaux pour √©viter les probl√®mes HTML/JS
    const communeEchapee = commune
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
    
    // RESTAURER L'√âTAT DE LA CHECKBOX (ou cocher par d√©faut si nouvelle commune)
    const isChecked = etatCheckboxes.hasOwnProperty(communeEchapee) 
      ? etatCheckboxes[communeEchapee]  // Restaurer l'√©tat pr√©c√©dent
      : true;  // Nouvelle commune = coch√©e par d√©faut
    
        return `
      <div style="padding: 10px 8px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; transition: background 0.2s;" title="" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">        
      <input 
          type="checkbox" 
          id="commune_${index}" 
          value="${communeEchapee}" 
          ${isChecked ? 'checked' : ''}
          onchange="updateCompteurCommunes()"
          title=""
          style="margin-right: 10px; cursor: pointer; width: 18px; height: 18px; flex-shrink: 0;"
        />
        <label for="commune_${index}" style="cursor: pointer; flex: 1; margin: 0; font-size: 14px; line-height: 1.4;" title="">
          ${communeEchapee}
        </label>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
  console.log('‚úÖ Checkboxes g√©n√©r√©es avec √©tats restaur√©s');
  
  updateCompteurCommunes();
}

function updateCompteurCommunes() {
  const checkboxes = document.querySelectorAll('#listeCommunesCheckboxes input[type="checkbox"]');
  const nbCochees = Array.from(checkboxes).filter(cb => cb.checked).length;
  
  const compteur = document.getElementById('compteurCommunes');
  if (compteur) {
    compteur.textContent = `${nbCochees} commune(s)`;
  }
}

function rechercherCommune() {
  const recherche = document.getElementById('rechercheCommune').value.trim();
  const resultatsDiv = document.getElementById('resultatsRecherche');
  
  console.log('üîç Recherche lanc√©e pour:', recherche);
  
  if (recherche.length < 3) {
    resultatsDiv.innerHTML = '<div style="background: #fff3cd; border: 1px solid #ffc107; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #856404; margin-top: 8px;">‚ö†Ô∏è Tapez au moins 3 caract√®res</div>';
    return;
  }
  
  resultatsDiv.innerHTML = '<div style="background: #e6f7f7; border: 1px solid #0ea5a4; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #0d8887; margin-top: 8px;">üîÑ Recherche en cours...</div>';
  
  const url = `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(recherche)}&fields=nom,codesPostaux,departement&limit=10`;
  console.log('üåê URL appel√©e:', url);
  
  fetch(url, {
    method: 'GET',
    headers: {
      'Accept': 'application/json'
    }
  })
    .then(response => {
      console.log('üì° Status HTTP:', response.status);
      if (!response.ok) {
        throw new Error(`Erreur API (${response.status})`);
      }
      return response.json();
    })
    .then(communes => {
      console.log('üì¶ R√©sultats:', communes.length, 'commune(s)');
      
      if (!communes || communes.length === 0) {
        resultatsDiv.innerHTML = `<div style="background: #fee; border: 1px solid #dc2626; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #dc2626; margin-top: 8px;">‚ùå Aucune commune trouv√©e pour "${recherche}"</div>`;
        return;
      }
      
      const html = communes.map(c => {
        const cp = c.codesPostaux && c.codesPostaux.length > 0 ? c.codesPostaux[0] : '';
        const nomComplet = cp ? `${c.nom} (${cp})` : c.nom;
        const deptNom = c.departement.nom || '';
        const deptCode = c.departement.code || '';
        
        // √âchapper les guillemets pour √©viter les erreurs JavaScript
        const nomEchape = nomComplet.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const deptNomEchape = deptNom.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        return `
          <div 
              onclick="ajouterCommuneManuellement('${nomEchape}')"
            style="
              padding: 12px; 
              cursor: pointer; 
              border-bottom: 1px solid #f3f4f6;
              transition: background 0.2s;
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
            onmouseover="this.style.background='#f0f9ff'"
            onmouseout="this.style.background='white'"
          >
          <span style="font-weight: 600; color: #0f1724; font-size: 14px;" title="">${nomComplet}</span>
            <span style="color: #6b7280; font-size: 12px; white-space: nowrap; margin-left: 12px;">${deptCode} - ${deptNomEchape}</span>
          </div>
        `;
      }).join('');
      
      resultatsDiv.innerHTML = `
        <div style="
          background: white; 
          border: 2px solid #0ea5a4; 
          border-radius: 8px; 
          margin-top: 8px; 
          max-height: 250px; 
          overflow-y: auto;
        ">
          ${html}
        </div>
      `;
    })
    .catch(error => {
      console.error('‚ùå Erreur:', error);
      resultatsDiv.innerHTML = `<div style="background: #fee; border: 1px solid #dc2626; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #dc2626; margin-top: 8px;">‚ùå Erreur : ${error.message}</div>`;
    });
}
// RECHERCHE EN TEMPS R√âEL (sans clic sur bouton)
let rechercheTimeout;

function rechercherCommuneEnTempsReel() {
  // Annuler la recherche pr√©c√©dente si l'utilisateur tape encore
  clearTimeout(rechercheTimeout);
  
  const resultatsDiv = document.getElementById('resultatsRecherche');
  
  // NETTOYER LES ANCIENS MESSAGES D'ERREUR
  if (!resultatsDiv) return;
  
  // Attendre 500ms apr√®s la derni√®re frappe avant de chercher
  rechercheTimeout = setTimeout(() => {
    const recherche = document.getElementById('rechercheCommune').value.trim();
    
    if (recherche.length === 0) {
      // Vider les r√©sultats si le champ est vide
      resultatsDiv.innerHTML = '';
      return;
    }
    
    if (recherche.length < 3) {
      resultatsDiv.innerHTML = 
        '<div style="background: #fff3cd; border: 1px solid #ffc107; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #856404; margin-top: 8px;">‚ö†Ô∏è Tapez au moins 3 caract√®res</div>';
      return;
    }
    
    // Lancer la recherche
    rechercherCommune();
  }, 500);
}

function ajouterCommuneManuellement(communeNom) {
  console.log('‚ûï Tentative ajout:', communeNom);
  
  // Nettoyer le nom de la commune (enlever les espaces inutiles)
  const communeNettoyee = communeNom.trim();
  
  // V√©rifier si la commune n'est pas d√©j√† dans la liste
  const dejaPresente = communesCalculeesSaved.some(c => 
    c.toLowerCase() === communeNettoyee.toLowerCase()
  );
  
  if (dejaPresente) {
    document.getElementById('resultatsRecherche').innerHTML = `
      <div style="background: #fff3cd; border: 1px solid #ffc107; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #856404; margin-top: 8px;">
        ‚ö†Ô∏è Cette commune est d√©j√† dans votre liste
      </div>
    `;
    console.log('‚ö†Ô∏è Commune d√©j√† pr√©sente:', communeNettoyee);
    return;
  }
  
  // Ajouter √† la liste
  communesCalculeesSaved.push(communeNettoyee);
  console.log('‚úÖ Commune ajout√©e. Nouvelle taille:', communesCalculeesSaved.length);
  
  // R√©g√©n√©rer les checkboxes avec la nouvelle commune
  genererCheckboxesCommunes();
  
  // Afficher confirmation avec timeout pour que l'utilisateur puisse la voir
  const resultatsDiv = document.getElementById('resultatsRecherche');
  resultatsDiv.innerHTML = `
    <div style="background: #d1fae5; border: 1px solid #10b981; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #059669; margin-top: 8px;">
      ‚úÖ Commune ajout√©e : <strong>${communeNettoyee}</strong>
    </div>
  `;
  
  // Effacer le message de confirmation apr√®s 3 secondes
  setTimeout(() => {
    resultatsDiv.innerHTML = '';
  }, 3000);
  
  // Vider le champ de recherche
  const champRecherche = document.getElementById('rechercheCommune');
  if (champRecherche) {
    champRecherche.value = '';
    champRecherche.focus(); // Remettre le focus pour une nouvelle recherche
  }
  
  // Scroll vers la liste pour voir la nouvelle commune
  const listeDiv = document.getElementById('listeCommunesCheckboxes');
  if (listeDiv) {
    setTimeout(() => {
      listeDiv.scrollTop = listeDiv.scrollHeight;
    }, 100);
  }
} 

function validerModifications() {
  console.log('üíæ Validation des modifications...');
  
  // R√©cup√©rer toutes les communes coch√©es
  const checkboxes = document.querySelectorAll('#listeCommunesCheckboxes input[type="checkbox"]');
  const communesSelectionnees = [];
  
  checkboxes.forEach(checkbox => {
    if (checkbox.checked) {
      communesSelectionnees.push(checkbox.value);
    }
  });
  
  console.log('üìä Communes coch√©es:', communesSelectionnees.length);
  
  if (communesSelectionnees.length === 0) {
    alert('‚ö†Ô∏è Vous devez s√©lectionner au moins une commune');
    return;
  }
  
  // Mettre √† jour la liste sauvegard√©e (avec tri)
  communesCalculeesSaved = communesSelectionnees.sort((a, b) => {
    return a.localeCompare(b, 'fr', { sensitivity: 'base' });
  });
  
  // Marquer comme valid√© ET modifi√© manuellement
  communesValidees = true;
  listeModifieeManuelle = true;
  
  console.log('‚úÖ Liste mise √† jour:', communesCalculeesSaved.length, 'communes');
  console.log('üîß Mode manuel activ√©:', listeModifieeManuelle);
  
  // Masquer l'interface de modification
  const interfaceModif = document.getElementById('interfaceModificationCommunes');
  if (interfaceModif) {
    interfaceModif.classList.add('hidden');
  }
  
  // Mettre √† jour le message explicatif
  const messageExplicatif = document.getElementById('messageExplicatif');
  if (messageExplicatif) {
    messageExplicatif.innerHTML = '‚úÖ <strong>Liste personnalis√©e valid√©e</strong> - Vous avez modifi√© manuellement la liste des communes.';
    messageExplicatif.style.color = '#059669';
    messageExplicatif.style.fontWeight = '600';
  }
  
  // Afficher confirmation dans l'info
  const infoDiv = document.getElementById('communesCalculeesInfo');
  if (infoDiv) {
    infoDiv.innerHTML = `
      <strong style="color:#059669;">‚úÖ ${communesSelectionnees.length} communes s√©lectionn√©es (liste personnalis√©e)</strong>
    `;
  }
  
  // Mettre √† jour l'affichage de la liste avec les communes tri√©es
  const listeDiv = document.getElementById('communesCalculeesListe');
  if (listeDiv) {
    listeDiv.innerHTML = communesCalculeesSaved
      .map(c => `<div style="padding: 6px 0; border-bottom: 1px solid #f3f4f6;">‚úì ${c}</div>`)
      .join('');
  }
  
  // R√©afficher le bouton "Modifier" pour permettre une nouvelle modification
  const btnGroupe = document.getElementById('btnGroupeCommunes');
  if (btnGroupe) {
    btnGroupe.style.display = 'flex';
    btnGroupe.style.flexDirection = 'column';
  }
  
  // Masquer le bouton "Valider" (d√©j√† valid√©)
  const btnValider = document.getElementById('btnValiderCommunes');
  if (btnValider) {
    btnValider.style.display = 'none';
  }
  
  console.log('‚úÖ Modifications valid√©es avec succ√®s');
  
  // Scroll vers le haut pour voir la confirmation
  const zoneCommunes = document.getElementById('communesCalculeesZone');
  if (zoneCommunes) {
    zoneCommunes.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function annulerModifications() {
  // Masquer l'interface de modification
  document.getElementById('interfaceModificationCommunes').classList.add('hidden');
  
  // R√©afficher les boutons
  const btnGroupe = document.getElementById('btnGroupeCommunes');
  btnGroupe.style.display = 'flex';
  btnGroupe.style.flexDirection = 'column';
  
  // Vider la recherche
  document.getElementById('rechercheCommune').value = '';
  document.getElementById('resultatsRecherche').innerHTML = '';
  
  console.log('‚ùå Modifications annul√©es');
}

// üÜï Modifier la fonction validerCommunes() originale
function validerCommunes() {
  if (communesCalculeesSaved.length === 0) {
    alert("‚ö†Ô∏è Aucune commune √† valider. Veuillez d'abord calculer la liste.");
    return;
  }
  
  communesValidees = true;
  listeModifieeManuelle = false; // Pas de modification manuelle
  
  const btnValider = document.getElementById('btnValiderCommunes');
  const infoDiv = document.getElementById('communesCalculeesInfo');
  
  if (btnValider) {
    btnValider.innerHTML = '‚úÖ Liste valid√©e';
    btnValider.disabled = true;
    btnValider.style.background = '#059669';
  }
  
  if (infoDiv) {
    const existingText = infoDiv.innerHTML;
    infoDiv.innerHTML = existingText + '<br><strong style="color:#059669;">‚úÖ Liste valid√©e et pr√™te √† √™tre enregistr√©e</strong>';
  }
  
  // Masquer le bouton Valider, garder le bouton Modifier visible
  if (btnValider) {
    btnValider.style.display = 'none';
  }
  
  console.log('‚úÖ Communes valid√©es:', communesCalculeesSaved.length);
}


/* ========== PREFILL FUNCTION ========== */
async function showFormAndPrefill(data) {
  console.log("Donn√©es re√ßues pour pr√©-remplissage:", data);

  formEl.classList.remove("hidden");
  rest.classList.remove("hidden");
  
  const numType = data && data.numType ? data.numType : "";
  if (numType === "siret") {
    document.querySelector('input[name="numType"][value="siret"]').checked = true;
    siretBlock.classList.remove("hidden");
    noNum.classList.add("hidden");
    siretNum.value = data.numPro || "";
  }
  
  if (data) {
    document.getElementById("nom").value = data.nom || "";
    document.getElementById("prenom").value = data.prenom || "";
    document.getElementById("phone").value = data.phone || "";
    document.getElementById("profession").value = data.profession || "";
    
    if (data.publics) {
      const publicsArr = data.publics.split(",").map(s => s.trim()).filter(Boolean);
      document.querySelectorAll('input[name="public"]').forEach(ch => {
        ch.checked = publicsArr.includes(ch.value);
      });
    }
    
    if (data.modeIntervention) {
      const modeRadio = document.querySelector(`input[name="modeIntervention"][value="${data.modeIntervention}"]`);
      if (modeRadio) modeRadio.checked = true;
    }
    
    if (data.visio !== undefined && data.visio !== null) {
  const visioValue = String(data.visio).toLowerCase().trim();
  const visioRadio = document.querySelector(`input[name="visio"][value="${visioValue}"]`);
  if (visioRadio) {
    visioRadio.checked = true;
  } else {
    console.warn("‚ö†Ô∏è Aucun bouton radio trouv√© pour visio =", visioValue);
  }
}
    
   if (data.departement) {
  let deptCode = String(data.departement).trim();
  // ‚úÖ G√©rer les codes √† 1, 2 ou 3 chiffres
  if (deptCode.length === 1) {
    deptCode = "0" + deptCode;
  }
  // Les codes √† 2 ou 3 chiffres passent directement
      
      setTimeout(async () => {
        departSelect.value = deptCode;
        
        if (data.commune) {
          await loadCommunes(deptCode, data.commune);
          // Si la commune est d√©j√† avec code postal, la s√©lectionner directement
          if (data.commune.includes('(')) {
            communeSelect.value = data.commune;
          }
        }

        const codeDept = deptCode.split('-')[0].trim();

        if (DEPS_METRO.includes(codeDept) && data.temps) {
          document.getElementById("zoneMetropole").classList.remove("hidden");
          const select = document.getElementById("tempsTrajet");
          const optionExists = Array.from(select.options).some(opt => opt.value === data.temps);
          if (!optionExists) {
            const opt = document.createElement("option");
            opt.value = data.temps;
            opt.textContent = data.temps;
            select.appendChild(opt);
          }
          select.value = data.temps;

        } else if (DEPS_DOMTOM.includes(codeDept) && data.rayon) {
          document.getElementById("zoneOutreMer").classList.remove("hidden");
          const select = document.getElementById("rayonKm");
          const optionExists = Array.from(select.options).some(opt => opt.value === data.rayon);
          if (!optionExists) {
            const opt = document.createElement("option");
            opt.value = data.rayon;
            opt.textContent = data.rayon;
            select.appendChild(opt);
          }
          select.value = data.rayon;
        }

        document.getElementById("precisionsGeo").value = data.precisionsGeo || "";
      }, 200);
    }

    if (data.disponibilite) {
      const dispoRadio = document.querySelector(`input[name="dispo"][value="${data.disponibilite}"]`);
      if (dispoRadio) {
        dispoRadio.checked = true;
        if (data.disponibilite === "oui") {
          dateBlock.classList.remove("hidden");
          modeContactBlock.classList.remove("hidden");
          consentNumber.textContent = "6";
          
          if (data.dateDispo) dateInput.value = data.dateDispo;
          if (data.placesDisponibles) placesInput.value = data.placesDisponibles;
          if (data.modeContact) {
            const modeContactRadio = document.querySelector(`input[name="modeContact"][value="${data.modeContact}"]`);
            if (modeContactRadio) modeContactRadio.checked = true;
          }
        } else {
          modeContactBlock.classList.add("hidden");
          consentNumber.textContent = "5";
        }
      }
    }

    const consentValue = String(data.consent || "").toLowerCase();
    document.getElementById("consent").checked = (consentValue === "oui" || consentValue === "true");
    submitBtn.textContent = "‚úì Mettre √† jour mes informations";
    
    setTimeout(() => updateSectionGeo(), 300);
  }
  
// üÜï CHARGEMENT DES COMMUNES SAUVEGARD√âES
  setTimeout(async () => {
    const modeIntervention = document.querySelector('input[name="modeIntervention"]:checked');
    if (modeIntervention && modeIntervention.value !== 'cabinet') {
      
      // üì¶ CHARGER LES COMMUNES DEPUIS LES DONN√âES EXISTANTES
      if (data.communesCouvertes && data.communesCouvertes.trim() !== '') {
        console.log('üì¶ Chargement des communes sauvegard√©es...');
        
        // Convertir la cha√Æne en tableau
        communesCalculeesSaved = data.communesCouvertes.split('|').filter(c => c.trim());
        communesValidees = true;
        listeModifieeManuelle = true; // Consid√©rer comme modifi√©es pour √©viter le recalcul
        
        console.log(`‚úÖ ${communesCalculeesSaved.length} communes charg√©es depuis la BDD`);
        
        // Afficher la zone des communes
        const zoneCommunes = document.getElementById('communesCalculeesZone');
        const listeDiv = document.getElementById('communesCalculeesListe');
        const infoDiv = document.getElementById('communesCalculeesInfo');
        
        if (zoneCommunes && listeDiv && infoDiv) {
          zoneCommunes.classList.remove('hidden');
          
          // Afficher les infos
          const departements = data.departementsCouvertes || 'N/A';
          infoDiv.innerHTML = `
            <strong style="color:#059669;">‚úÖ ${communesCalculeesSaved.length} communes enregistr√©es</strong> 
            dans <strong>${departements}</strong>
          `;
          
          // Afficher la liste
          listeDiv.innerHTML = communesCalculeesSaved
            .sort()
            .map(c => `<div style="padding: 6px 0; border-bottom: 1px solid #f3f4f6;">‚úì ${c}</div>`)
            .join('');
          
          // Afficher le bouton Modifier
          const btnGroupe = document.getElementById('btnGroupeCommunes');
          if (btnGroupe) {
            btnGroupe.style.display = 'flex';
            btnGroupe.style.flexDirection = 'column';
          }
          
          // Masquer le bouton Valider (d√©j√† valid√©)
          const btnValider = document.getElementById('btnValiderCommunes');
          if (btnValider) {
            btnValider.style.display = 'none';
          }
          
          // Message personnalis√©
          const messageExplicatif = document.getElementById('messageExplicatif');
          if (messageExplicatif) {
            messageExplicatif.innerHTML = '‚úÖ <strong>Liste sauvegard√©e</strong> - Ces communes ont √©t√© enregistr√©es lors de votre derni√®re modification.';
            messageExplicatif.style.color = '#059669';
            messageExplicatif.style.fontWeight = '600';
          }
        }
      }
    }
  }, 1000);
}

/* ========== LISTENERS: numType toggles ========== */
document.querySelectorAll('input[name="numType"]').forEach(r => r.addEventListener('change', e => {
  const v = e.target.value;
  siretErr.textContent = "";
  siretNum.value = "";
  siretBlock.classList.add("hidden"); noNum.classList.add("hidden");
  rest.classList.add("hidden");
  if (v === "siret") siretBlock.classList.remove("hidden");
  else noNum.classList.remove("hidden");
}));

/* ========== VALIDATION on blur for SIRET ========== */
siretNum.addEventListener('input', () => {
  const v = siretNum.value.trim();
  if (v.length === 14 && validSiret(v)) {
    siretErr.textContent = ""; 
    rest.classList.remove("hidden");
  } else if (v.length === 14) {
    siretErr.textContent = "Un num√©ro SIRET doit contenir exactement 14 chiffres."; 
    rest.classList.add("hidden");
  }
});

siretNum.addEventListener('blur', () => {
  const v = siretNum.value.trim();
  if (!validSiret(v)) { 
    siretErr.textContent = "Un num√©ro SIRET doit contenir exactement 14 chiffres."; 
    rest.classList.add("hidden"); 
  } else { 
    siretErr.textContent = ""; 
    rest.classList.remove("hidden");
  }
});

/* ========== DISPO date logic ========== */
document.querySelectorAll('input[name="dispo"]').forEach(r => r.addEventListener('change', e => {
  const show = e.target.value === "oui";
  dateBlock.classList.toggle("hidden", !show);
  modeContactBlock.classList.toggle("hidden", !show);
  
  consentNumber.textContent = show ? "6" : "5";
  
  if (show) {
    dateInput.setAttribute("min", new Date().toISOString().split("T")[0]);
  } else {
    dateInput.value = "";
    placesInput.value = "";
    document.querySelector('input[name="modeContact"][value="direct"]').checked = true;
  }
}));

/* ========== VALIDATION NOMBRE DE PLACES ========== */
placesInput.addEventListener('input', function() {
  const value = parseInt(this.value);
  if (value < 1) this.value = 1;
  else if (value > 99) this.value = 99;
});

/* ========== DEPARTEMENTS / COMMUNES ========== */
async function loadDepartements(){
  departSelect.innerHTML = '<option value="">-- chargement --</option>';
  try {
    const r = await fetch(DEPT_API);
    const list = await r.json();
    departSelect.innerHTML = '<option value="">-- s√©lectionnez --</option>';
    list.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.code;
      opt.textContent = `${d.code} ‚Äî ${d.nom}`;
      departSelect.appendChild(opt);
    });
  } catch (err) {
    departSelect.innerHTML = '<option value="">Erreur de chargement</option>';
  }
}

async function loadCommunes(deptCode, preselect){
  communeSelect.innerHTML = '<option>Chargement...</option>';
  try {
    // üÜï Demander les codes postaux en plus
    const url = `https://geo.api.gouv.fr/departements/${deptCode}/communes?fields=nom,codesPostaux`;
    const r = await fetch(url);
    const list = await r.json();
    
    communeSelect.innerHTML = '<option value="">-- s√©lectionnez --</option>';
    
    list.forEach(c => {
      const opt = document.createElement("option");
      
      // üÜï Stocker "Commune (CodePostal)" dans value ET text
      const codePostal = c.codesPostaux && c.codesPostaux.length > 0 ? c.codesPostaux[0] : '';
      const communeAvecCP = codePostal ? `${c.nom} (${codePostal})` : c.nom;
      
      opt.value = communeAvecCP;  // ‚Üê Changement ici
      opt.textContent = communeAvecCP;  // ‚Üê Changement ici
      
      communeSelect.appendChild(opt);
    });
    
    if (preselect) {
      // üÜï Chercher la commune qui commence par le nom pr√©-s√©lectionn√©
      const options = Array.from(communeSelect.options);
      const matchingOption = options.find(opt => 
        opt.value.startsWith(preselect.split('(')[0].trim())
      );
      
      if (matchingOption) {
        communeSelect.value = matchingOption.value;
      } else {
        communeSelect.value = preselect; // Fallback
      }
    }
  } catch (err) {
    communeSelect.innerHTML = '<option value="">Erreur chargement</option>';
  }
}

departSelect.addEventListener('change', e => {
  const v = e.target.value;
  
  // üÜï R√©initialiser la zone de communes ET fermer l'interface de modification
  const modeIntervention = document.querySelector('input[name="modeIntervention"]:checked');
  if (modeIntervention && modeIntervention.value !== 'cabinet') {
    // Fermer l'interface de modification si elle est ouverte
    const interfaceModif = document.getElementById('interfaceModificationCommunes');
    if (interfaceModif && !interfaceModif.classList.contains('hidden')) {
      interfaceModif.classList.add('hidden');
      console.log('üîÑ Interface de modification ferm√©e (changement d√©partement)');
    }
    
    // R√©initialiser les donn√©es
    const zoneCommunes = document.getElementById('communesCalculeesZone');
    if (zoneCommunes) {
      zoneCommunes.classList.add('hidden');
      communesCalculeesSaved = [];
      communesValidees = false;
      listeModifieeManuelle = false;
    }
    
    // üÜï R√âINITIALISER LE MESSAGE EXPLICATIF
    const messageExplicatif = document.getElementById('messageExplicatif');
    if (messageExplicatif) {
      messageExplicatif.innerHTML = 'üí° Cette liste est une <strong>estimation automatique</strong> bas√©e sur votre temps de trajet / rayon.';
      messageExplicatif.style.color = '#6b7280';
      messageExplicatif.style.fontWeight = 'normal';
      messageExplicatif.style.fontStyle = 'italic';
    }
  }
  
  if (!v) { 
    communeSelect.innerHTML = '<option value="">-- choisissez d\'abord le d√©partement --</option>'; 
    return; 
  }
  loadCommunes(v);
  updateSectionGeo();
});

//  Sur changement de commune
communeSelect.addEventListener("change", function() {
  const modeIntervention = document.querySelector('input[name="modeIntervention"]:checked');
  if (modeIntervention && modeIntervention.value !== 'cabinet' && this.value) {
    // Fermer l'interface de modification si elle est ouverte
    const interfaceModif = document.getElementById('interfaceModificationCommunes');
    if (interfaceModif && !interfaceModif.classList.contains('hidden')) {
      interfaceModif.classList.add('hidden');
      console.log('üîÑ Interface de modification ferm√©e (changement commune)');
    }
    
    // R√©initialiser l'√©tat
    communesValidees = false;
    listeModifieeManuelle = false;
    
    // üÜï R√âINITIALISER LE MESSAGE EXPLICATIF
    const messageExplicatif = document.getElementById('messageExplicatif');
    if (messageExplicatif) {
      messageExplicatif.innerHTML = 'üí° Cette liste est une <strong>estimation automatique</strong> bas√©e sur votre temps de trajet / rayon.';
      messageExplicatif.style.color = '#6b7280';
      messageExplicatif.style.fontWeight = 'normal';
      messageExplicatif.style.fontStyle = 'italic';
    }
    
    // Recalculer les communes
    calculerEtAfficherCommunes(false, true);
  }
});

//  √âV√âNEMENTS SUR LIENS VISUALISER
if (visualiserLinkMetro) {
  visualiserLinkMetro.addEventListener("click", function(e) {
    e.preventDefault();
    calculerEtAfficherCommunes(true, false);
  });
}

if (visualiserLinkOM) {
  visualiserLinkOM.addEventListener("click", function(e) {
    e.preventDefault();
    calculerEtAfficherCommunes(true, false);
  });
}

// Sur changement de temps/rayon
document.getElementById("tempsTrajet")?.addEventListener("change", function() {
  if (communeSelect.value) {
    // Fermer l'interface de modification si elle est ouverte
    const interfaceModif = document.getElementById('interfaceModificationCommunes');
    if (interfaceModif && !interfaceModif.classList.contains('hidden')) {
      interfaceModif.classList.add('hidden');
      console.log('üîÑ Interface de modification ferm√©e (changement temps)');
    }
    
    // R√©initialiser l'√©tat
    communesValidees = false;
    listeModifieeManuelle = false;
    
    // üÜï R√âINITIALISER LE MESSAGE EXPLICATIF
    const messageExplicatif = document.getElementById('messageExplicatif');
    if (messageExplicatif) {
      messageExplicatif.innerHTML = 'üí° Cette liste est une <strong>estimation automatique</strong> bas√©e sur votre temps de trajet / rayon.';
      messageExplicatif.style.color = '#6b7280';
      messageExplicatif.style.fontWeight = 'normal';
      messageExplicatif.style.fontStyle = 'italic';
    }
    
    // Recalculer les communes
    calculerEtAfficherCommunes(false, true);
  }
});

document.getElementById("rayonKm")?.addEventListener("change", function() {
  if (communeSelect.value) {
    // Fermer l'interface de modification si elle est ouverte
    const interfaceModif = document.getElementById('interfaceModificationCommunes');
    if (interfaceModif && !interfaceModif.classList.contains('hidden')) {
      interfaceModif.classList.add('hidden');
      console.log('üîÑ Interface de modification ferm√©e (changement rayon)');
    }
    
    // R√©initialiser l'√©tat
    communesValidees = false;
    listeModifieeManuelle = false;
    
    // üÜï R√âINITIALISER LE MESSAGE EXPLICATIF
    const messageExplicatif = document.getElementById('messageExplicatif');
    if (messageExplicatif) {
      messageExplicatif.innerHTML = 'üí° Cette liste est une <strong>estimation automatique</strong> bas√©e sur votre temps de trajet / rayon.';
      messageExplicatif.style.color = '#6b7280';
      messageExplicatif.style.fontWeight = 'normal';
      messageExplicatif.style.fontStyle = 'italic';
    }
    
    // Recalculer les communes
    calculerEtAfficherCommunes(false, true);
  }
});

/* ========== SUBMIT FORM ========== */
submitBtn.addEventListener('click', async () => {
  submitMsg.textContent = "";
  successBanner.classList.add("hidden");
  
  //  VALIDATION DES COMMUNES pour mode d√©placement
  const modeInterventionChecked = document.querySelector('input[name="modeIntervention"]:checked');
  if (modeInterventionChecked && modeInterventionChecked.value !== 'cabinet') {
    if (!communesValidees || communesCalculeesSaved.length === 0) {
      submitMsg.innerHTML = '<span style="color:#dc2626;font-weight:600">‚ùå Liste de communes non valid√©e</span><br>' +
        '<span style="color:#6b7280">Vous devez calculer et valider la liste des communes couvertes avant de soumettre le formulaire.</span>';
      
      const zoneCommunes = document.getElementById('communesCalculeesZone');
      if (zoneCommunes) {
        zoneCommunes.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      return;
    }
  }
  
  const numTypeChecked = document.querySelector('input[name="numType"]:checked');
  if (!numTypeChecked) { submitMsg.textContent = "Vous devez indiquer votre type de num√©ro professionnel."; return; }
  const numType = numTypeChecked.value;
  if (numType === "siret" && !validSiret(siretNum.value.trim())) { submitMsg.textContent = "Num√©ro SIRET invalide."; return; }
  if (!document.getElementById("nom").value.trim()) { submitMsg.textContent = "Nom requis."; return; }
  if (!document.getElementById("prenom").value.trim()) { submitMsg.textContent = "Pr√©nom requis."; return; }
  if (!validPhone(document.getElementById("phone").value.trim())) { submitMsg.textContent = "T√©l√©phone invalide."; return; }
  if (!document.getElementById("profession").value) { submitMsg.textContent = "Profession requise."; return; }
  if (!Array.from(document.querySelectorAll('input[name="public"]:checked')).length) { submitMsg.textContent = "S√©lectionnez au moins un public."; return; }
  
  if (!document.querySelector('input[name="modeIntervention"]:checked')) { 
    submitMsg.textContent = "S√©lectionnez votre mode d'intervention."; 
    return; 
  }
  
  if (!document.querySelector('input[name="visio"]:checked')) { submitMsg.textContent = "Indiquez si vous proposez des RDV en visio."; return; }
  if (!departSelect.value) { submitMsg.textContent = "D√©partement requis."; return; }
  if (!communeSelect.value) { submitMsg.textContent = "Commune requise."; return; }
  
  const modeInterventionChecked2 = document.querySelector('input[name="modeIntervention"]:checked');
  if (modeInterventionChecked2 && modeInterventionChecked2.value !== 'cabinet') {
    const codeDept = departSelect.value.split(' ')[0];
    
    if (DEPS_METRO.includes(codeDept)) {
      const tempsValue = document.getElementById("tempsTrajet").value.trim();
      if (!tempsValue || tempsValue === "-- S√©lectionnez --") { 
        submitMsg.textContent = "Indiquez votre temps de trajet maximal."; 
        return; 
      }
    } else if (DEPS_DOMTOM.includes(codeDept)) {
      const rayonValue = document.getElementById("rayonKm").value.trim();
      if (!rayonValue || rayonValue === "-- S√©lectionnez --") { 
        submitMsg.textContent = "Indiquez votre rayon d'intervention."; 
        return; 
      }
    }
  }
  
  const dispoChecked = document.querySelector('input[name="dispo"]:checked');
  if (!dispoChecked) { submitMsg.textContent = "R√©pondez √† la question disponibilit√©s."; return; }
  if (dispoChecked.value === "oui") {
    if (!dateInput.value) { submitMsg.textContent = "Indiquez la date de disponibilit√©."; return; }
    const places = parseInt(placesInput.value);
    if (!places || places < 1 || places > 10) {
      submitMsg.textContent = "Indiquez le nombre de places disponibles (entre 1 et 10).";
      return;
    }
    
    const modeContactChecked = document.querySelector('input[name="modeContact"]:checked');
    if (!modeContactChecked) { 
      submitMsg.textContent = "Indiquez comment vous souhaitez √™tre contact√©."; 
      return; 
    }
  }
  
  if (!document.getElementById("consent").checked) { submitMsg.textContent = "Le consentement est obligatoire."; return; }
  
  submitBtn.disabled = true;
  submitMsg.innerHTML = '<span style="color:#6b7280">‚è≥ Envoi en cours...</span>';
  
const fd = new FormData();
  fd.append("action", "submitForm");
  fd.append("email", (CURRENT_EMAIL || emailEl.value || "").trim().toLowerCase());
  fd.append("numType", numType);
  fd.append("siretNum", siretNum.value.trim());
  fd.append("nom", document.getElementById("nom").value.trim());
  fd.append("prenom", document.getElementById("prenom").value.trim());
  fd.append("phone", document.getElementById("phone").value.trim());
  fd.append("profession", document.getElementById("profession").value);
  fd.append("publics", Array.from(document.querySelectorAll('input[name="public"]:checked')).map(i=>i.value).join(","));
  
  const modeIntervention = document.querySelector('input[name="modeIntervention"]:checked');
  fd.append("modeIntervention", modeIntervention ? modeIntervention.value : "");
  
  fd.append("departement", departSelect.value);
  fd.append("commune", communeSelect.value);

  // üÜï GESTION AM√âLIOR√âE DE L'ENVOI DES COMMUNES
  if (listeModifieeManuelle && communesCalculeesSaved.length > 0) {
    // L'utilisateur a modifi√© manuellement la liste
    const communesString = communesCalculeesSaved.join('|');
    fd.append("communesModifiees", communesString);
    
    console.log('üìù Envoi communes modifi√©es manuellement');
    console.log('üìä Nombre:', communesCalculeesSaved.length);
    console.log('üìã Aper√ßu:', communesString.substring(0, 200) + '...');
    
  } else if (communesValidees && communesCalculeesSaved.length > 0) {
    // L'utilisateur a valid√© la liste calcul√©e automatiquement SANS la modifier
    const communesString = communesCalculeesSaved.join('|');
    fd.append("communesModifiees", communesString);
    
    console.log('‚úÖ Envoi communes calcul√©es automatiquement (valid√©es)');
    console.log('üìä Nombre:', communesCalculeesSaved.length);
    console.log('üìã Aper√ßu:', communesString.substring(0, 200) + '...');
    
  } else {
    // Aucune commune valid√©e (mode cabinet ou erreur)
    fd.append("communesModifiees", "");
    console.log('‚ö†Ô∏è Aucune commune √† envoyer');
  } 
  
  const codeDept = departSelect.value.split(' ')[0];

  if (DEPS_METRO.includes(codeDept)) {
    fd.append("rayon", "");
    fd.append("temps", document.getElementById("tempsTrajet").value);
  } else if (DEPS_DOMTOM.includes(codeDept)) {
    fd.append("rayon", document.getElementById("rayonKm").value);
    fd.append("temps", "");
  }
  
  fd.append("visio", document.querySelector('input[name="visio"]:checked').value);
  fd.append("precisionsGeo", document.getElementById("precisionsGeo").value.trim());
  fd.append("dispo", document.querySelector('input[name="dispo"]:checked').value);
  fd.append("dateDispo", dateInput.value);
  fd.append("placesDisponibles", placesInput.value || "");
  fd.append("modeContact", document.querySelector('input[name="modeContact"]:checked')?.value || "direct");
  fd.append("consent", document.getElementById("consent").checked ? "oui" : "non");
  
  const timeoutPromise = new Promise((_, reject) => 
    setTimeout(() => reject(new Error('TIMEOUT')), 30000)
  );
  
  const fetchPromise = fetch(SCRIPT_URL, { method: "POST", body: fd });
  
  try {
    const res = await Promise.race([fetchPromise, timeoutPromise]);
    const j = await res.json();
    
    console.log("R√©ponse serveur submitForm:", j);
    
    if (j.ok) {
      lockForm();
    } else {
      submitBtn.disabled = false;
      
      if (j.error === "SIRET_ALREADY_EXISTS") {
        submitMsg.innerHTML = '<span style="color:#dc2626;font-weight:600">‚ùå SIRET d√©j√† enregistr√©</span><br>' +
          '<span style="color:#6b7280">Ce num√©ro SIRET est d√©j√† utilis√© par un autre professionnel. ' +
          'Si vous pensez qu\'il s\'agit d\'une erreur, contactez-nous.</span>';
      } else {
        submitMsg.innerHTML = '<span style="color:#dc2626;font-weight:600">‚ùå Erreur lors de l\'envoi</span><br>' +
          '<span style="color:#6b7280">' + (j.error || j.detail || "Erreur inconnue") + '</span>';
      }
    }
  } catch (err) {
    console.error("Erreur r√©seau:", err);
    submitBtn.disabled = false;
    
    if (err.message === 'TIMEOUT') {
      submitMsg.innerHTML = '<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è D√©lai d\'attente d√©pass√©</span><br>' +
        '<span style="color:#6b7280">Le serveur met trop de temps √† r√©pondre. Vos donn√©es ont peut-√™tre √©t√© enregistr√©es. V√©rifiez vos emails de confirmation.</span>';
    } else {
      submitMsg.innerHTML = '<span style="color:#dc2626;font-weight:600">‚ùå Erreur r√©seau</span><br>' +
        '<span style="color:#6b7280">Impossible de communiquer avec le serveur. V√©rifiez votre connexion et r√©essayez.</span>';
    }
  }
});

/* ========== RESET ========== */
resetBtn.addEventListener('click', () => {
  formEl.reset();
  document.getElementById("consent").checked = false;
  placesInput.value = "";
  modeContactBlock.classList.add("hidden");
  consentNumber.textContent = "5";
  document.querySelectorAll('input[name="modeContact"]').forEach(radio => { radio.checked = false;});
  rest.classList.add("hidden");
  siretBlock.classList.add("hidden");
  noNum.classList.add("hidden");
  submitMsg.textContent = "";
  successBanner.classList.add("hidden");
  
  document.getElementById('section-geo').classList.add('hidden');
  document.getElementById('blocCommune').classList.add('hidden');
  document.getElementById('questionsDeplacements').classList.add('hidden');
  document.getElementById('zoneMetropole').classList.add('hidden');
  document.getElementById('zoneOutreMer').classList.add('hidden');
  document.getElementById('precisionsGeo').value = '';
  
  // üÜï R√©initialiser la zone communes
  document.getElementById('communesCalculeesZone').classList.add('hidden');
  communesCalculeesSaved = [];
  communesValidees = false;
  
  unlockForm();
});
</script>
</body>
</html>













