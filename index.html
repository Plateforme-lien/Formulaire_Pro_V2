<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Questionnaire ‚Äî Professionnels</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--primary:#0ea5a4;--primary-dark:#0d8887;--muted:#6b7280;--section-bg:#f9fafb;--prereq-bg:#e6f7f7;}
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:24px;line-height:1.6}
  .wrap{max-width:980px;margin:18px auto}
  .card{background:var(--card);border-radius:16px;padding:32px 36px;box-shadow:0 8px 30px rgba(2,6,23,0.06)}
  h1{margin:0 0 8px;font-size:24px;color:#0f1724}
  h2{margin:0 0 24px;color:var(--muted);font-size:17px;font-weight:600;line-height:1.6}
  p.lead{margin:0 0 24px;color:var(--muted);font-size:15px}
  
  label{display:block;margin-top:24px;font-weight:600;color:#0f1724;font-size:15px}
  label:first-of-type{margin-top:0}
  
  .required::after{content:" *";color:#dc2626;font-weight:700}
  
  input[type=text],input[type=email],input[type=tel],input[type=date],select,textarea{
    width:100%;
    padding:12px 14px;
    border:2px solid #e6eef6;
    border-radius:8px;
    margin-top:8px;
    font-size:15px;
    transition:border-color 0.2s;
    box-sizing:border-box;  
  }
  input[type=text]:focus,input[type=email]:focus,input[type=tel]:focus,input[type=date]:focus,select:focus{
    outline:none;border-color:var(--primary);
  }
  
  input:disabled,select:disabled,textarea:disabled{
    background:#f3f4f6;
    color:#9ca3af;
    cursor:not-allowed;
  }
  
  .question-section{
    background:var(--section-bg);
    padding:24px;
    border-radius:12px;
    margin-top:32px;
    border-left:4px solid var(--primary);
  }
  .question-section:first-child{margin-top:24px}
  .section-title{
    font-size:17px;
    font-weight:700;
    color:#0f1724;
    margin:0 0 20px 0;
    display:flex;
    align-items:center;
    gap:10px;
  }
  
  .section-number{
    background:var(--primary);
    color:white;
    min-width:28px;     
    width:28px;
    height:28px;
    border-radius:50%;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    font-weight:700;
    flex-shrink:0;      
  }

  .prereq-section{
    background:var(--prereq-bg);
    padding:24px;
    border-radius:12px;
    margin-top:24px;
    border:2px solid #b3e5e4;
    border-left:4px solid var(--primary);
  }
  
  .prereq-title{
    font-size:17px;
    font-weight:700;
    color:#0f1724;
    margin:0 0 20px 0;
  }
  
  fieldset{margin-top:0;border:2px solid #e6eef6;padding:20px;border-radius:12px;background:white}
  legend{font-weight:700;font-size:16px;color:#0f1724;padding:0 8px}
  
  button{background:var(--primary);color:#fff;padding:12px 20px;border-radius:8px;border:0;cursor:pointer;
    font-size:15px;font-weight:600;transition:all 0.2s}
  button:hover{background:var(--primary-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(14,165,164,0.3)}
  button:active{transform:translateY(0)}
  button:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
  button:disabled::after{content:" ‚è≥";animation:pulse 1.5s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
  .btn-ghost{background:#eef2f7;color:#0f1724}
  .btn-ghost:hover{background:#e1e7ef;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
  
  #submit{
    background:linear-gradient(135deg, #0ea5a4 0%, #0d8887 100%);
    padding:16px 40px;
    font-size:17px;
    font-weight:700;
    border-radius:12px;
    box-shadow:0 4px 16px rgba(14,165,164,0.4);
    margin-top:32px;
  }
  #submit:hover{
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(14,165,164,0.5);
  }
  
  #editBtn{
    background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    padding:16px 40px;
    font-size:17px;
    font-weight:700;
    border-radius:12px;
    box-shadow:0 4px 16px rgba(59,130,246,0.4);
    margin-top:32px;
  }
  #editBtn:hover{
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(59,130,246,0.5);
  }
  
  .actions{display:flex;gap:12px;align-items:center;margin-top:32px;flex-wrap:wrap}
  
  .small{font-size:13px;color:var(--muted);margin-top:8px;line-height:1.5}
  .error{color:#dc2626;margin-top:8px;font-weight:500}
  
  .inline{display:inline-block;margin-right:16px;margin-bottom:8px}
  input[type=radio],input[type=checkbox]{margin-right:6px;cursor:pointer}
  input[type=radio]:disabled,input[type=checkbox]:disabled{cursor:not-allowed;}
  label:has(input[type=radio]),label:has(input[type=checkbox]){font-weight:500;cursor:pointer}
  label:has(input[type=radio]:disabled),label:has(input[type=checkbox]:disabled){color:#9ca3af;cursor:not-allowed;}
  
  .hidden{display:none}
  
  .success-banner{
    background:#d1fae5;
    border:2px solid #10b981;
    padding:24px;
    border-radius:12px;
    margin-top:24px;
    text-align:center;
  }
  
  @media(max-width:768px){
    .card{padding:24px 20px}
    .question-section{padding:20px}
    h1{font-size:20px}
    #submit,#editBtn{padding:14px 32px;font-size:16px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>R√©f√©rencement de professionnels sp√©cialis√©s TSA</h1>
      <h2>Renseignez ou actualisez vos informations pour que les particuliers puissent vous trouver selon votre secteur d'intervention, vos disponibilit√©s et le public que vous accompagnez.</h2>
      
      <p class="lead">Commencez par v√©rifier votre e-mail ‚Äî un code sera envoy√©. Si vous avez d√©j√† rempli le formulaire auparavant, il sera pr√©-rempli.</p>
      <p class="small" style="margin-top:-16px;margin-bottom:16px">Les champs marqu√©s d'un <span style="color:#dc2626;font-weight:700">*</span> sont obligatoires.</p>

      <!-- EMAIL -->
      <label for="email" class="required">Adresse e-mail</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="email" type="email" placeholder="votre@email.com" autocomplete="email"/>
        <button id="sendCodeBtn" type="button">V√©rifier mon mail</button>
      </div>
      <div id="emailMsg" class="small"></div>

      <!-- CODE -->
      <div id="codeArea" class="hidden" style="margin-top:12px">
        <label for="code" class="required">Code de v√©rification (envoy√© par e-mail)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="code" type="text" placeholder="000000" inputmode="numeric"/>
          <button id="verifyBtn" type="button">Valider le code</button>
          <button id="resendBtn" class="btn-ghost" type="button">Renvoyer</button>
        </div>
        <div id="codeMsg" class="small"></div>
      </div>

      <!-- MESSAGE NOUVEL UTILISATEUR -->
      <div id="newUserMessage" class="hidden" style="background:#e6f7f7;border:2px solid #0ea5a4;padding:24px;border-radius:12px;margin-top:24px;text-align:center">
        <div style="font-size:48px;margin-bottom:12px">üëã</div>
        <h3 style="margin:0 0 8px;color:#0f1724;font-size:20px">Bienvenue !</h3>
        <p style="margin:0;color:#6b7280;font-size:15px">Vous √™tes un nouvel utilisateur. Merci de remplir le formulaire ci-dessous.</p>
      </div>

      <!-- CHOIX UTILISATEUR EXISTANT -->
      <div id="existingUserChoice" class="hidden" style="margin-top:24px">
        <div style="background:#f0f9ff;border:2px solid #3b82f6;padding:24px;border-radius:12px;text-align:center">
          <div style="font-size:48px;margin-bottom:12px">‚úÖ</div>
          <h3 style="margin:0 0 8px;color:#0f1724;font-size:20px">Bon retour !</h3>
          <p style="margin:0 0 20px;color:#6b7280;font-size:15px">Vos informations sont d√©j√† enregistr√©es. Que souhaitez-vous faire ?</p>
          
          <div style="display:flex;gap:16px;justify-content:center;flex-wrap:wrap;margin-top:24px">
            <button id="modifyBtn" type="button" style="background:#3b82f6;padding:16px 32px;font-size:16px;font-weight:600">
              ‚úèÔ∏è Modifier mes informations
            </button>
            <button id="deleteBtn" type="button" class="btn-ghost" style="padding:16px 32px;font-size:16px;font-weight:600;background:#fee;color:#dc2626;border:2px solid #dc2626">
              üóëÔ∏è Supprimer mes informations
            </button>
          </div>
        </div>
      </div>

      <!-- CONFIRMATION SUPPRESSION -->
      <div id="deleteConfirmation" class="hidden" style="margin-top:24px">
        <div style="background:#fee;border:2px solid #dc2626;padding:24px;border-radius:12px">
          <h3 style="margin:0 0 12px;color:#dc2626;font-size:18px">‚ö†Ô∏è Confirmer la suppression</h3>
          <p style="margin:0 0 20px;color:#6b7280;font-size:15px">
            √ätes-vous s√ªr(e) de vouloir supprimer d√©finitivement vos informations de la plateforme ? 
            Cette action est <b>irr√©versible</b>.
          </p>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <button id="confirmDeleteBtn" type="button" style="background:#dc2626;padding:12px 24px">
              ‚úì Oui, supprimer mes donn√©es
            </button>
            <button id="cancelDeleteBtn" type="button" class="btn-ghost">
              ‚úï Annuler
            </button>
          </div>
          <div id="deleteMsg" class="small" style="margin-top:12px"></div>
        </div>
      </div>

      <!-- FORM -->
      <form id="form" class="hidden" onsubmit="return false;">
        <!-- Num√©ro professionnel -->
         <div class="prereq-section">
          <div class="prereq-title">
            Pr√©requis
          </div>
          
          <label style="margin-top:0" class="required">Avez-vous un num√©ro professionnel ?</label>
          <div style="margin-top:12px">
            <label class="inline"><input type="radio" name="numType" value="siret"> Oui, j'ai un num√©ro SIRET</label>
            <label class="inline"><input type="radio" name="numType" value="none"> Non, je n'ai pas de num√©ro</label>
          </div>
          
          <div id="siretBlock" class="hidden">
            <label for="siretNum" class="required">Quel est votre num√©ro SIRET ?</label>
            <input id="siretNum" name="siretNum" type="text" maxlength="14" inputmode="numeric" placeholder="14 chiffres"/>
            <div id="siretErr" class="error"></div>
          </div>
          
          <div id="noNum" class="error hidden">Ce questionnaire n'est autoris√© que pour les professionnels ayant un num√©ro de SIRET.</div>
        </div>

        <!-- Rest of form -->
        <div id="rest" class="hidden">
          <!-- Section 1 : Identit√© -->
          <div class="question-section">
            <div class="section-title">
              <span class="section-number">1</span>
              Identit√© et coordonn√©es
            </div>
            
            <label for="nom" class="required">Nom</label>
            <input id="nom" name="nom" type="text"/>

            <label for="prenom" class="required">Pr√©nom</label>
            <input id="prenom" name="prenom" type="text"/>

            <label for="phone">T√©l√©phone (optionnel)</label>
            <input id="phone" name="phone" type="tel" placeholder="0X XX XX XX XX ou +33..."/>
          </div>

          <!-- Section 2 : Profession -->
          <div class="question-section">
            <div class="section-title">
              <span class="section-number">2</span>
                Activit√© professionnelle
            </div>
            
            <label for="profession" class="required">Profession</label>
            <select id="profession" name="profession">
              <option value="">-- s√©lectionnez --</option>
              <option>√âducateur sp√©cialis√©</option>
              <option>Ergoth√©rapeute</option>
              <option>Psychologue</option>
              <option>Psychomotricien</option>
              <option>Orthophoniste</option>
            </select>

            <label style="margin-top:24px" class="required">Aupr√®s de quel(s) public(s) intervenez-vous ?</label>
            <div class="small" style="margin-top:4px">Vous pouvez s√©lectionner plusieurs r√©ponses.</div>
            <div style="margin-top:12px">
              <label><input type="checkbox" name="public" value="0-6"> Enfants (0-6 ans)</label>
              <label><input type="checkbox" name="public" value="7-12"> Enfants (7-12 ans)</label>
              <label><input type="checkbox" name="public" value="13-18"> Adolescents (13-18 ans)</label>
              <label><input type="checkbox" name="public" value="18+"> Adultes (18+)</label>
            </div>
            
            <label style="margin-top:24px" class="required">Quel(s) sont vos modes d'intervention ?</label>
            <div class="small" style="margin-top:4px">Vous pouvez s√©lectionner plusieurs r√©ponses.</div>
            <div style="margin-top:12px">
              <label><input type="checkbox" name="mode" value="domicile"> Se d√©place √† domicile</label>
              <label><input type="checkbox" name="mode" value="cabinet"> En cabinet</label>
            </div>
              
            <label style="margin-top:24px" class="required">Proposez-vous des rendez-vous en visio ?</label>
            <div style="margin-top:12px">
              <label><input type="radio" name="visio" value="oui"> Oui</label>
              <label><input type="radio" name="visio" value="non"> Non</label>
            </div>
          </div>

          <!-- Section 3 : Zone g√©ographique -->
          <div class="question-section">
            <div class="section-title">
              <span class="section-number">3</span>
              Zone g√©ographique d'intervention
            </div>
            
            <label for="departement" class="required">Dans quel d√©partement intervenez-vous principalement ?</label>
            <select id="departement" name="departement"><option value="">-- chargement --</option></select>

            <label for="commune" class="required">Quelle est votre commune principale d'intervention ?</label>
            <select id="commune" name="commune"><option value="">-- choisissez le d√©partement --</option></select>

            <label for="rayon" class="required">Quel est votre rayon d'intervention ?</label>
            <select id="rayon" name="rayon">
              <option value="">-- s√©lectionnez --</option>
              <option>Aucun - en cabinet</option>
              <option>10 km</option>
              <option>15 km</option>
              <option>20 km</option>
              <option>25 km</option>
              <option>30 km</option>
              <option>40 km</option>
              <option>Tout mon d√©partement</option>
            </select>
            <a href="#" id="visualiserLink" target="_blank" style="display:inline-block;margin-top:8px;color:var(--primary);text-decoration:none;font-size:14px;font-weight:600;">
              üó∫Ô∏è Visualiser les communes couvertes par mon rayon
            </a>
            <div class="small">Si vous intervenez uniquement en cabinet, s√©lectionnez "Aucun - en cabinet".</div>
          </div>

          <!-- Section 4 : Disponibilit√©s -->
          <div class="question-section">
            <div class="section-title">
              <span class="section-number">4</span>
              Disponibilit√©s
            </div>
            
            <label class="required">Avez-vous des disponibilit√©s pour de nouveaux b√©n√©ficiaires ?</label>
            <div style="margin-top:12px">
              <label><input type="radio" name="dispo" value="oui"> Oui</label>
              <label><input type="radio" name="dispo" value="non"> Non</label>
            </div>

            <div id="dateBlock" class="hidden">
              <label for="dateDispo" class="required">√Ä partir de quelle date √™tes-vous disponible ?</label>
              <input id="dateDispo" name="dateDispo" type="date"/>
            </div>
          </div>

          <!-- Section 5 : Consentement -->
          <div class="question-section">
            <div class="section-title">
              <span class="section-number">5</span>
              Consentement
            </div>
            
            <label style="margin-top:0;display:flex;align-items:start;gap:8px" class="required">
              <input id="consent" name="consent" type="checkbox" style="margin-top:4px"/> 
              <span>J'accepte que mes donn√©es soient utilis√©es uniquement dans le cadre de cette mise en relation.</span>
            </label>
          </div>
          
          <div class="actions">
            <button id="submit" type="button">‚úì Enregistrer mes informations</button>
            <button id="editBtn" type="button" class="hidden">‚úèÔ∏è Modifier mes informations</button>
            <button id="resetBtn" type="button" class="btn-ghost">R√©initialiser</button>
          </div>
          <div id="submitMsg" class="small"></div>
        </div>
        
        <!-- BANNI√àRE EN DEHORS DE REST -->
        <div id="successBanner" class="success-banner hidden">
          <div style="font-size:64px;margin-bottom:16px">‚úÖ</div>
          <h3 style="margin:0 0 12px;color:#0f1724;font-size:24px;font-weight:700">Formulaire envoy√© avec succ√®s !</h3>
          <p style="margin:0 0 16px;color:#059669;font-size:16px;font-weight:600">Vous avez re√ßu un email de confirmation.</p>
          <p style="margin:0 0 24px;color:#6b7280;font-size:15px">Vos informations ont √©t√© enregistr√©es. Vous pouvez fermer cette page.</p>
          </div>
        </div>
      </form>
    </div>
  </div>

<script>
/* ========== CONFIG ========== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbww78Q-FrcILGHJu0O0lRgajYaFn9qJPq8ViSwDEixSOQ_ZiTWgJVX64mMcNHwirwFf/exec"; 
const DEPT_API = "https://geo.api.gouv.fr/departements";
const COMMUNE_API = code => `https://geo.api.gouv.fr/departements/${code}/communes`;

/* ========== HELPERS VALIDATION ========== */
const isDigits = s => /^\d+$/.test(s||"");
const validSiret = v => isDigits(v) && v.length === 14;
const validPhone = v => {
  if(!v) return true;
  const c = v.replace(/\s|\-|\(|\)|\./g,"");
  return /^(0[1-9]\d{8}|\+33[1-9]\d{8})$/.test(c) || /^[0-9]{10,15}$/.test(c);
};

/* ========== DOM ========= */
const emailEl = document.getElementById("email");
const sendCodeBtn = document.getElementById("sendCodeBtn");
const emailMsg = document.getElementById("emailMsg");
const codeArea = document.getElementById("codeArea");
const codeEl = document.getElementById("code");
const verifyBtn = document.getElementById("verifyBtn");
const resendBtn = document.getElementById("resendBtn");
const codeMsg = document.getElementById("codeMsg");
const formEl = document.getElementById("form");
const siretBlock = document.getElementById("siretBlock");
const noNum = document.getElementById("noNum");
const rest = document.getElementById("rest");
const siretNum = document.getElementById("siretNum");
const siretErr = document.getElementById("siretErr");
const submitBtn = document.getElementById("submit");
const editBtn = document.getElementById("editBtn");
const submitMsg = document.getElementById("submitMsg");
const departSelect = document.getElementById("departement");
const communeSelect = document.getElementById("commune");
const dateBlock = document.getElementById("dateBlock");
const dateInput = document.getElementById("dateDispo");
const resetBtn = document.getElementById("resetBtn");
const newUserMessage = document.getElementById("newUserMessage");
const existingUserChoice = document.getElementById("existingUserChoice");
const deleteConfirmation = document.getElementById("deleteConfirmation");
const modifyBtn = document.getElementById("modifyBtn");
const deleteBtn = document.getElementById("deleteBtn");
const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
const deleteMsg = document.getElementById("deleteMsg");
const successBanner = document.getElementById("successBanner");

let CURRENT_EMAIL = null;
let EXISTING = false;
let EXISTING_DATA = null;
let FORM_LOCKED = false;

/* ========== FONCTIONS DE VERROUILLAGE ========== */
function lockForm() {
  FORM_LOCKED = true;
  
  // Masquer TOUT sauf la banni√®re
  rest.style.display = 'none';
  document.querySelector('.prereq-section').style.display = 'none';
  newUserMessage.classList.add('hidden');  // ‚Üê MODIFIEZ CETTE LIGNE
  
  // Masquer le titre, sous-titre et section email (avant le form)
  document.querySelector('h1').style.display = 'none';
  document.querySelector('h2').style.display = 'none';
  document.querySelector('.lead').style.display = 'none';
  document.querySelectorAll('.small')[0].style.display = 'none';
  emailEl.parentElement.parentElement.querySelector('label').style.display = 'none';
  emailEl.parentElement.style.display = 'none';
  
  // Masquer tous les boutons d'action
  submitBtn.classList.add('hidden');
  resetBtn.classList.add('hidden');
  editBtn.classList.add('hidden');
  
  // Afficher la banni√®re de succ√®s
  successBanner.classList.remove('hidden');
  
  // Faire d√©filer vers la banni√®re
  successBanner.scrollIntoView({ behavior: 'smooth', block: 'center' });
}
  
function unlockForm() {
  FORM_LOCKED = false;
  
  // R√©activer tous les inputs
  document.querySelectorAll('#form input, #form select, #form textarea').forEach(el => {
    el.disabled = false;
  });
  
  // Afficher le bouton submit, masquer le bouton edit
  submitBtn.classList.remove('hidden');
  editBtn.classList.add('hidden');
  resetBtn.classList.remove('hidden');
  
  // Masquer la banni√®re de succ√®s
  successBanner.classList.add('hidden');
  
  submitMsg.textContent = "";
}

/* ========== BOUTON MODIFIER ========== */
editBtn.addEventListener('click', () => {
  unlockForm();
});

/* ========== SEND CODE ========== */
sendCodeBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  if (!mail) { 
    emailMsg.textContent = "Merci d'indiquer une adresse e-mail."; 
    return; 
  }
  
  emailMsg.textContent = "Envoi du code en cours...";
  sendCodeBtn.disabled = true;
  
  try {
    const r = await fetch(`${SCRIPT_URL}?action=sendCode&email=${encodeURIComponent(mail)}&_t=${Date.now()}`);
    const j = await r.json();
    
    console.log("R√©ponse serveur sendCode:", j);
    if (j.alreadySent) {
      console.log("üîç Code d√©j√† envoy√© r√©cemment - pas de nouvel email");
    } else if (j.ok) {
      console.log("‚úÖ Nouveau code envoy√© par email");
    }

    if (j.error === "DAILY_LIMIT_REACHED") {
      if (j.minutesRestantes && j.minutesRestantes > 0) {
        const heures = Math.floor(j.minutesRestantes / 60);
        const minutes = j.minutesRestantes % 60;
        const tempsRestant = heures > 0
          ? `${heures}h${minutes > 0 ? minutes + 'min' : ''}`
          : `${minutes} minutes`;

        emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Vous avez d√©j√† demand√© trois codes aujourd'hui</span><br>
          <span style="color:#6b7280">Le dernier vous a √©t√© envoy√© il y a moins de 15 minutes. Il est encore valable pendant environ ${tempsRestant}.</span>`;
      } else {
        emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ùå Limite quotidienne atteinte</span><br>
          <span style="color:#6b7280">Vous avez d√©j√† demand√© ${j.codesEnvoyes || 3} codes aujourd'hui. Maximum autoris√© : 3 codes par jour. R√©essayez demain.</span>`;
      }
      sendCodeBtn.disabled = false;
      return;
    }

    if (j.error === "COOLDOWN_ACTIVE") {
      const heures = Math.floor(j.minutesRestantes / 60);
      const minutes = j.minutesRestantes % 60;
      const tempsRestant = heures > 0 ? `${heures}h${minutes > 0 ? minutes + 'min' : ''}` : `${minutes} minutes`;
      
      emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Veuillez patienter</span><br>
        <span style="color:#6b7280">Vous avez r√©cemment soumis le formulaire. Vous pourrez redemander un code dans environ ${tempsRestant}.</span>`;
      sendCodeBtn.disabled = false;
      return;
    }

    if (j.error === "SERVICE_QUOTA_EXCEEDED") {
      emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ö†Ô∏è Service temporairement indisponible</span><br>
        <span style="color:#6b7280">Le quota d'emails quotidien est atteint. Merci de r√©essayer demain.</span>`;
      sendCodeBtn.disabled = false;
      return;
    }
    
    if (j.ok) {
        if (j.alreadySent) {
          emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Code d√©j√† envoy√©</span><br>
          <span style="color:#6b7280">Un code vous a d√©j√† √©t√© envoy√© il y a moins de 15 minutes. Le code est encore valable.</span>`;
          codeMsg.textContent = "";
        } else {
          emailMsg.innerHTML = `<span style="color:#059669;font-weight:600">‚úì Code envoy√© avec succ√®s</span><br>
          <span style="color:#6b7280">V√©rifiez votre bo√Æte mail (pensez aux spams).</span>`;
          codeMsg.textContent = ""; 
        }
      
      CURRENT_EMAIL = mail;
      codeArea.classList.remove("hidden");
      sendCodeBtn.style.display = "none";
      codeEl.focus();
    } else {
      emailMsg.innerHTML = `<span style="color:#dc2626">Erreur : ${j.error || "Impossible d'envoyer le code"}</span>`;
    }
  } catch (err) {
    console.error("Erreur r√©seau:", err);
    emailMsg.innerHTML = `<span style="color:#dc2626">Erreur r√©seau lors de l'envoi du code</span>`;
  } finally {
    sendCodeBtn.disabled = false;
  }
});

emailEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendCodeBtn.click();
  }
});

/* ========== RESEND ========== */
resendBtn.addEventListener("click", async () => {
  emailMsg.textContent = "Renvoi du code en cours...";
  codeMsg.textContent = ""; 
  resendBtn.disabled = true;
  
  const mail = (emailEl.value || "").trim().toLowerCase();
  
  try {
    const r = await fetch(`${SCRIPT_URL}?action=sendCode&email=${encodeURIComponent(mail)}&_t=${Date.now()}`);
    const j = await r.json();
    
    if (j.alreadySent) {
      emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Code d√©j√† envoy√© r√©cemment</span><br>
      <span style="color:#6b7280">Un code vous a d√©j√† √©t√© envoy√© il y a moins de 15 minutes. Le code est encore valable.</span>`;
    } else if (j.ok) {
      emailMsg.innerHTML = `<span style="color:#059669;font-weight:600">‚úì Code renvoy√© avec succ√®s</span><br>
      <span style="color:#6b7280">V√©rifiez votre bo√Æte mail (pensez aux spams).</span>`;
    } else if (j.error === "DAILY_LIMIT_REACHED") {
      if (j.minutesRestantes && j.minutesRestantes > 0) {
        const heures = Math.floor(j.minutesRestantes / 60);
        const minutes = j.minutesRestantes % 60;
        const tempsRestant = heures > 0
          ? `${heures}h${minutes > 0 ? minutes + 'min' : ''}`
          : `${minutes} minutes`;
        
        emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Vous avez d√©j√† demand√© trois codes aujourd'hui</span><br>
          <span style="color:#6b7280">Le dernier vous a √©t√© envoy√© il y a moins de 15 minutes. Il est encore valable pendant environ ${tempsRestant}.</span>`;
      } else {
        emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ùå Limite quotidienne atteinte</span><br>
        <span style="color:#6b7280">Maximum 3 codes par jour. R√©essayez demain.</span>`;
      }
    } else {
      emailMsg.innerHTML = `<span style="color:#dc2626">Erreur : ${j.error || "Impossible de renvoyer"}</span>`;
    }
  } catch (err) {
    emailMsg.innerHTML = `<span style="color:#dc2626">Erreur r√©seau</span>`;
  } finally {
    resendBtn.disabled = false;
  }
});

/* ========== TOUCHE ENTR√âE POUR VALIDER LE CODE ========== */
codeEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    verifyBtn.click();
  }
});

/* ========== VERIFY CODE ========== */
verifyBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  const code = (codeEl.value || "").trim();
  if (!mail || !code) { codeMsg.textContent = "Merci d'indiquer l'adresse e-mail et le code."; return; }
  codeMsg.textContent = "V√©rification...";
  try {
    const r = await fetch(`${SCRIPT_URL}?action=verifyCode&email=${encodeURIComponent(mail)}&code=${encodeURIComponent(code)}&_t=${Date.now()}`);
    const j = await r.json();
    if (!j.ok) { codeMsg.textContent = "Erreur : " + (j.error||"code invalide"); return; }
    
    codeMsg.textContent = "‚úÖ E-mail v√©rifi√© avec succ√®s !";
    CURRENT_EMAIL = mail;
    codeArea.style.display = "none";
    emailMsg.style.display = "none";
    emailEl.disabled = true;
    sendCodeBtn.style.display = "none";
    
    await loadDepartements();
    
    if (j.existing && j.data) {
      EXISTING = true;
      EXISTING_DATA = j.data;
      existingUserChoice.classList.remove("hidden");
    } else {
      EXISTING = false;
      EXISTING_DATA = null;
      newUserMessage.classList.remove("hidden");
      formEl.classList.remove("hidden");
      rest.classList.add("hidden");
    }
  } catch (err) {
    codeMsg.textContent = "Erreur r√©seau lors de la v√©rification.";
  }
});

/* ========== BOUTON MODIFIER (utilisateur existant) ========== */
modifyBtn.addEventListener("click", async () => {
  existingUserChoice.classList.add("hidden");
  await showFormAndPrefill(EXISTING_DATA);
});

/* ========== BOUTON SUPPRIMER (utilisateur existant) ========== */
deleteBtn.addEventListener("click", () => {
  existingUserChoice.classList.add("hidden");
  deleteConfirmation.classList.remove("hidden");
});

/* ========== ANNULER LA SUPPRESSION ========== */
cancelDeleteBtn.addEventListener("click", () => {
  deleteConfirmation.classList.add("hidden");
  existingUserChoice.classList.remove("hidden");
  deleteMsg.textContent = "";
});

/* ========== CONFIRMER LA SUPPRESSION ========== */
confirmDeleteBtn.addEventListener("click", async () => {
  deleteMsg.textContent = "Suppression en cours...";
  confirmDeleteBtn.disabled = true;
  
  try {
    const fd = new FormData();
    fd.append("action", "deleteUser");
    fd.append("email", CURRENT_EMAIL);
    
    const res = await fetch(SCRIPT_URL, { method: "POST", body: fd });
    const j = await res.json();
    
    if (j.ok) {
      deleteMsg.innerHTML = '<span style="color:#059669;font-weight:600">‚úÖ Vos informations ont √©t√© supprim√©es avec succ√®s.</span>';
      setTimeout(() => {
        location.reload();
      }, 2000);
    } else {
      deleteMsg.innerHTML = '<span style="color:#dc2626">‚ùå Erreur : ' + (j.error || "Impossible de supprimer") + '</span>';
      confirmDeleteBtn.disabled = false;
    }
  } catch (err) {
    deleteMsg.innerHTML = '<span style="color:#dc2626">‚ùå Erreur r√©seau lors de la suppression.</span>';
    confirmDeleteBtn.disabled = false;
  }
});

/* ========== PREFILL FUNCTION ========== */
async function showFormAndPrefill(data) {
  console.log("Donn√©es re√ßues pour pr√©-remplissage:", data);

  formEl.classList.remove("hidden");
  rest.classList.remove("hidden");
  
  const numType = data.numType || "";
  if (numType === "siret") {
    document.querySelector('input[name="numType"][value="siret"]').checked = true;
    siretBlock.classList.remove("hidden");
    noNum.classList.add("hidden");
    siretNum.value = data.numPro || "";
  }
  
  document.getElementById("nom").value = data.nom || "";
  document.getElementById("prenom").value = data.prenom || "";
  document.getElementById("phone").value = data.phone || "";
  document.getElementById("profession").value = data.profession || "";
  
  if (data.publics) {
    const publicsArr = data.publics.split(",").map(s => s.trim()).filter(Boolean);
    document.querySelectorAll('input[name="public"]').forEach(ch => {
      ch.checked = publicsArr.includes(ch.value);
    });
  }
  
  if (data.modes) {
    const modesArr = data.modes.split(",").map(s => s.trim()).filter(Boolean);
    document.querySelectorAll('input[name="mode"]').forEach(ch => {
      ch.checked = modesArr.includes(ch.value);
    });
  }
  
  if (data.visio) {
    const visioRadio = document.querySelector(`input[name="visio"][value="${data.visio}"]`);
    if (visioRadio) visioRadio.checked = true;
  }
  
  if (data.departement) {
    let deptCode = String(data.departement).trim();
    if (deptCode.length === 1) deptCode = "0" + deptCode;
    
    setTimeout(() => {
      departSelect.value = deptCode;
      
      if (data.commune) {
        loadCommunes(deptCode, data.commune);
      }
    }, 100);
  }
  
  document.getElementById("rayon").value = data.rayon || "";
  
  if (data.disponibilite) {
    const dispoRadio = document.querySelector(`input[name="dispo"][value="${data.disponibilite}"]`);
    if (dispoRadio) {
      dispoRadio.checked = true;
      if (data.disponibilite === "oui") {
        dateBlock.classList.remove("hidden");
        if (data.dateDisponibilite) {
          dateInput.value = data.dateDisponibilite;
        }
      }
    }
  }
  
  const consentValue = String(data.consentement || "").toLowerCase();
  document.getElementById("consent").checked = (consentValue === "oui" || consentValue === "true");
  submitBtn.textContent = "‚úì Mettre √† jour mes informations";
}

/* ========== LISTENERS: numType toggles ========== */
document.querySelectorAll('input[name="numType"]').forEach(r => r.addEventListener('change', e => {
  const v = e.target.value;
  siretErr.textContent = "";
  siretNum.value = "";
  siretBlock.classList.add("hidden"); noNum.classList.add("hidden");
  rest.classList.add("hidden");
  if (v === "siret") siretBlock.classList.remove("hidden");
  else noNum.classList.remove("hidden");
}));

/* ========== VALIDATION on blur for SIRET ========== */
siretNum.addEventListener('input', () => {
  const v = siretNum.value.trim();
  if (v.length === 14 && validSiret(v)) {
    siretErr.textContent = ""; 
    rest.classList.remove("hidden");
  } else if (v.length === 14) {
    siretErr.textContent = "Un num√©ro SIRET doit contenir exactement 14 chiffres."; 
    rest.classList.add("hidden");
  }
});

siretNum.addEventListener('blur', () => {
  const v = siretNum.value.trim();
  if (!validSiret(v)) { 
    siretErr.textContent = "Un num√©ro SIRET doit contenir exactement 14 chiffres."; 
    rest.classList.add("hidden"); 
  } else { 
    siretErr.textContent = ""; 
    rest.classList.remove("hidden");
  }
});

/* ========== DISPO date logic ========== */
document.querySelectorAll('input[name="dispo"]').forEach(r => r.addEventListener('change', e => {
  const show = e.target.value === "oui";
  dateBlock.classList.toggle("hidden", !show);
  if (show) dateInput.setAttribute("min", new Date().toISOString().split("T")[0]);
  else dateInput.value = "";
}));

/* ========== DEPARTEMENTS / COMMUNES ========== */
async function loadDepartements(){
  departSelect.innerHTML = '<option value="">-- chargement --</option>';
  try {
    const r = await fetch(DEPT_API);
    const list = await r.json();
    departSelect.innerHTML = '<option value="">-- s√©lectionnez --</option>';
    list.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.code;
      opt.textContent = `${d.code} ‚Äî ${d.nom}`;
      departSelect.appendChild(opt);
    });
  } catch (err) {
    departSelect.innerHTML = '<option value="">Erreur de chargement</option>';
  }
}

async function loadCommunes(deptCode, preselect){
  communeSelect.innerHTML = '<option>Chargement...</option>';
  try {
    const r = await fetch(COMMUNE_API(deptCode));
    const list = await r.json();
    communeSelect.innerHTML = '<option value="">-- s√©lectionnez --</option>';
    list.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.nom;
      opt.textContent = c.nom;
      communeSelect.appendChild(opt);
    });
    if (preselect) {
      communeSelect.value = preselect;
    }
  } catch (err) {
    communeSelect.innerHTML = '<option value="">Erreur chargement</option>';
  }
}

departSelect.addEventListener('change', e => {
  const v = e.target.value;
  if (!v) { 
    communeSelect.innerHTML = '<option value="">-- choisissez d\'abord le d√©partement --</option>'; 
    return; 
  }
  loadCommunes(v);
});

/* ========== SUBMIT FORM ========== */
submitBtn.addEventListener('click', async () => {
  // R√©initialiser les messages
  submitMsg.textContent = "";
  successBanner.classList.add("hidden");
  
  // Validations
  const numTypeChecked = document.querySelector('input[name="numType"]:checked');
  if (!numTypeChecked) { submitMsg.textContent = "Vous devez indiquer votre type de num√©ro professionnel."; return; }
  const numType = numTypeChecked.value;
  if (numType === "siret" && !validSiret(siretNum.value.trim())) { submitMsg.textContent = "Num√©ro SIRET invalide."; return; }
  if (!document.getElementById("nom").value.trim()) { submitMsg.textContent = "Nom requis."; return; }
  if (!document.getElementById("prenom").value.trim()) { submitMsg.textContent = "Pr√©nom requis."; return; }
  if (!validPhone(document.getElementById("phone").value.trim())) { submitMsg.textContent = "T√©l√©phone invalide."; return; }
  if (!document.getElementById("profession").value) { submitMsg.textContent = "Profession requise."; return; }
  if (!Array.from(document.querySelectorAll('input[name="public"]:checked')).length) { submitMsg.textContent = "S√©lectionnez au moins un public."; return; }
  if (!Array.from(document.querySelectorAll('input[name="mode"]:checked')).length) { submitMsg.textContent = "S√©lectionnez au moins un mode d'intervention."; return; }
  if (!document.querySelector('input[name="visio"]:checked')) { submitMsg.textContent = "Indiquez si vous proposez des RDV en visio."; return; }
  if (!departSelect.value) { submitMsg.textContent = "D√©partement requis."; return; }
  if (!communeSelect.value) { submitMsg.textContent = "Commune requise."; return; }
  if (!document.getElementById("rayon").value) { submitMsg.textContent = "Indiquez un rayon d'intervention."; return; }
  const dispoChecked = document.querySelector('input[name="dispo"]:checked');
  if (!dispoChecked) { submitMsg.textContent = "R√©pondez √† la question disponibilit√©s."; return; }
  if (dispoChecked.value === "oui" && !dateInput.value) { submitMsg.textContent = "Indiquez la date de disponibilit√©."; return; }
  if (!document.getElementById("consent").checked) { submitMsg.textContent = "Le consentement est obligatoire."; return; }
  
  // D√©sactiver le bouton et afficher le message de chargement
  submitBtn.disabled = true;
  submitMsg.innerHTML = '<span style="color:#6b7280">‚è≥ Envoi en cours...</span>';
  
  // Pr√©parer les donn√©es
  const fd = new FormData();
  fd.append("action", "submitForm");
  fd.append("email", (CURRENT_EMAIL || emailEl.value || "").trim().toLowerCase());
  fd.append("numType", numType);
  fd.append("siretNum", siretNum.value.trim());
  fd.append("nom", document.getElementById("nom").value.trim());
  fd.append("prenom", document.getElementById("prenom").value.trim());
  fd.append("phone", document.getElementById("phone").value.trim());
  fd.append("profession", document.getElementById("profession").value);
  fd.append("publics", Array.from(document.querySelectorAll('input[name="public"]:checked')).map(i=>i.value).join(","));
  fd.append("modes", Array.from(document.querySelectorAll('input[name="mode"]:checked')).map(i=>i.value).join(","));
  fd.append("visio", document.querySelector('input[name="visio"]:checked').value);
  fd.append("departement", departSelect.value);
  fd.append("commune", communeSelect.value);
  fd.append("rayon", document.getElementById("rayon").value);
  fd.append("dispo", document.querySelector('input[name="dispo"]:checked').value);
  fd.append("dateDispo", dateInput.value);
  fd.append("consent", document.getElementById("consent").checked ? "oui" : "non");
  
  // Ajouter un timeout de 30 secondes
  const timeoutPromise = new Promise((_, reject) => 
    setTimeout(() => reject(new Error('TIMEOUT')), 30000)
  );
  
  const fetchPromise = fetch(SCRIPT_URL, { method: "POST", body: fd });
  
  try {
    const res = await Promise.race([fetchPromise, timeoutPromise]);
    const j = await res.json();
    
    console.log("R√©ponse serveur submitForm:", j);
    
    if (j.ok) {
      // Verrouiller et afficher uniquement la banni√®re
      lockForm();
          } else {
      // R√©activer le bouton en cas d'erreur
      submitBtn.disabled = false;
      
      if (j.error === "SIRET_ALREADY_EXISTS") {
        submitMsg.innerHTML = '<span style="color:#dc2626;font-weight:600">‚ùå SIRET d√©j√† enregistr√©</span><br>' +
          '<span style="color:#6b7280">Ce num√©ro SIRET est d√©j√† utilis√© par un autre professionnel. ' +
          'Si vous pensez qu\'il s\'agit d\'une erreur, contactez-nous.</span>';
      } else {
        submitMsg.innerHTML = '<span style="color:#dc2626;font-weight:600">‚ùå Erreur lors de l\'envoi</span><br>' +
          '<span style="color:#6b7280">' + (j.error || j.detail || "Erreur inconnue") + '</span>';
      }
    }
  } catch (err) {
    console.error("Erreur r√©seau:", err);
    submitBtn.disabled = false;
    
    if (err.message === 'TIMEOUT') {
      submitMsg.innerHTML = '<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è D√©lai d\'attente d√©pass√©</span><br>' +
        '<span style="color:#6b7280">Le serveur met trop de temps √† r√©pondre. Vos donn√©es ont peut-√™tre √©t√© enregistr√©es. V√©rifiez vos emails de confirmation.</span>';
    } else {
      submitMsg.innerHTML = '<span style="color:#dc2626;font-weight:600">‚ùå Erreur r√©seau</span><br>' +
        '<span style="color:#6b7280">Impossible de communiquer avec le serveur. V√©rifiez votre connexion et r√©essayez.</span>';
    }
  }
});

/* ========== RESET ========== */
resetBtn.addEventListener('click', () => {
  formEl.reset();
  document.getElementById("consent").checked = false;
  rest.classList.add("hidden");
  siretBlock.classList.add("hidden");
  noNum.classList.add("hidden");
  submitMsg.textContent = "";
  successBanner.classList.add("hidden");
  unlockForm();
});

document.getElementById("visualiserLink").addEventListener("click", function (e) {
    e.preventDefault();

    const dep = document.getElementById("departement").value;
    const commune = document.getElementById("commune").value;
    const rayon = document.getElementById("rayon").value;

    const url = `visualisation.html?dep=${dep}&commune=${commune}&rayon=${rayon}`;
    window.open(url, "_blank");
});

</script>
</body>
</html>
