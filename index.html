<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Questionnaire — Professionnels</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--primary:#0ea5a4;--muted:#6b7280}
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:24px}
  .wrap{max-width:980px;margin:18px auto}
  .card{background:var(--card);border-radius:12px;padding:20px 22px;box-shadow:0 8px 30px rgba(2,6,23,0.06)}
  h1{margin:0 0 6px;font-size:20px}
  p.lead{margin:0 0 12px;color:var(--muted)}
  label{display:block;margin-top:12px;font-weight:600;color:#0f1724}
  input[type=text],input[type=email],input[type=tel],input[type=date],select,textarea{
    width:100%;padding:10px;border:1px solid #e6eef6;border-radius:8px;margin-top:6px;font-size:14px;
  }
  .row{display:flex;gap:12px}
  .col{flex:1}
  .actions{display:flex;gap:8px;align-items:center;margin-top:12px}
  button{background:var(--primary);color:#fff;padding:10px 14px;border-radius:8px;border:0;cursor:pointer}
  .btn-ghost{background:#eef2f7;color:#0f1724}
  .small{font-size:13px;color:var(--muted);margin-top:6px}
  .error{color:#b91c1c;margin-top:6px}
  fieldset{margin-top:14px;border:1px solid #eef2f4;padding:12px;border-radius:8px}
  legend{font-weight:700}
  .inline{display:inline-block;margin-right:10px}
  .hidden{display:none}
  .tag{display:inline-block;padding:6px 8px;border-radius:8px;background:#f1f5f9;margin-right:6px;font-size:13px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Questionnaire — Mise en relation (professionnels)</h1>
      <p class="lead">Commencez par vérifier votre e-mail — un code sera envoyé. Si vous avez déjà rempli le formulaire auparavant, il sera pré-rempli.</p>

      <!-- EMAIL -->
      <label for="email">Adresse e-mail</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="email" type="email" placeholder="votre@email.com" autocomplete="email"/>
        <button id="sendCodeBtn" type="button">Vérifier mon mail</button>
        <button id="openHelp" class="btn-ghost" type="button">Aide</button>
      </div>
      <div id="emailMsg" class="small"></div>

      <!-- CODE -->
      <div id="codeArea" class="hidden" style="margin-top:12px">
        <label for="code">Code de vérification (envoyé par e-mail)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="code" type="text" placeholder="000000" inputmode="numeric"/>
          <button id="verifyBtn" type="button">Valider le code</button>
          <button id="resendBtn" class="btn-ghost" type="button">Renvoyer</button>
        </div>
        <div id="codeMsg" class="small"></div>
      </div>

      <!-- FORM -->
      <form id="form" class="hidden" onsubmit="return false;">
        <!-- Numéro professionnel (toujours shown first for new) -->
        <fieldset id="numField">
          <legend>Numéro professionnel <span class="small">(obligatoire)</span></legend>
          <div>
            <label class="inline"><input type="radio" name="numType" value="adeli"> Oui, j’ai un numéro ADELI</label>
            <label class="inline"><input type="radio" name="numType" value="siret"> Oui, j’ai un numéro SIRET</label>
            <label class="inline"><input type="radio" name="numType" value="none"> Non, je n’ai pas de numéro</label>
          </div>

          <div id="adeliBlock" class="hidden">
            <label for="adeliNum">Quel est votre numéro ADELI ?</label>
            <input id="adeliNum" name="adeliNum" type="text" maxlength="9" inputmode="numeric" placeholder="9 chiffres"/>
            <div id="adeliErr" class="error"></div>
          </div>

          <div id="siretBlock" class="hidden">
            <label for="siretNum">Quel est votre numéro SIRET ?</label>
            <input id="siretNum" name="siretNum" type="text" maxlength="14" inputmode="numeric" placeholder="14 chiffres"/>
            <div id="siretErr" class="error"></div>
          </div>

          <div id="noNum" class="error hidden">Ce questionnaire n'est autorisé que pour les professionnels ayant un numéro ADELI ou SIRET.</div>
        </fieldset>

        <!-- Rest of form (shown only when ADELI/SIRET valid for new users; always shown for returning users) -->
        <div id="rest" class="hidden">
          <label for="nom">Nom (obligatoire)</label>
          <input id="nom" name="nom" type="text"/>

          <label for="prenom">Prénom (obligatoire)</label>
          <input id="prenom" name="prenom" type="text"/>

          <label for="phone">Téléphone (optionnel)</label>
          <input id="phone" name="phone" type="tel" placeholder="0X XX XX XX XX ou +33..."/>
          <div class="small">Numéro France métropole : 10 chiffres ; outre-mer : parfois 10+ chiffres. +33... accepté.</div>

          <label for="profession">Profession (obligatoire)</label>
          <select id="profession" name="profession">
            <option value="">-- sélectionnez --</option>
            <option>Éducateur spécialisé</option>
            <option>Ergothérapeute</option>
            <option>Psychologue</option>
            <option>Psychomotricien</option>
            <option>Orthophoniste</option>
          </select>

          <label>Auprès de quel(s) public(s) intervenez-vous ? (obligatoire)</label>
          <div>
            <label><input type="checkbox" name="public" value="0-6"> Enfants (0-6 ans)</label>
            <label><input type="checkbox" name="public" value="7-12"> Enfants (7-12 ans)</label>
            <label><input type="checkbox" name="public" value="13-18"> Adolescents (13-18 ans)</label>
            <label><input type="checkbox" name="public" value="18+"> Adultes (18+)</label>
          </div>

          <label>Quel(s) sont vos modes d'intervention ? (obligatoire)</label>
          <div>
            <label><input type="checkbox" name="mode" value="domicile"> Se déplace à domicile</label>
            <label><input type="checkbox" name="mode" value="cabinet"> En cabinet</label>
          </div>

          <label>Proposez-vous des rendez-vous en visio ? (obligatoire)</label>
          <div>
            <label><input type="radio" name="visio" value="oui"> Oui</label>
            <label><input type="radio" name="visio" value="non"> Non</label>
          </div>

          <label for="departement">Dans quel département intervenez-vous principalement ? (obligatoire)</label>
          <select id="departement" name="departement"><option value="">-- chargement --</option></select>

          <label for="commune">Quelle est votre commune principale d'intervention ? (obligatoire)</label>
          <select id="commune" name="commune"><option value="">-- choisissez le département --</option></select>

          <label for="rayon">Quel est votre rayon d'intervention ? (obligatoire)</label>
          <select id="rayon" name="rayon">
            <option value="">-- sélectionnez --</option>
            <option>0-5 km</option>
            <option>5-15 km</option>
            <option>15-30 km</option>
            <option>30+ km</option>
          </select>

          <label>Avez-vous des disponibilités pour de nouveaux bénéficiaires ? (obligatoire)</label>
          <div>
            <label><input type="radio" name="dispo" value="oui"> Oui</label>
            <label><input type="radio" name="dispo" value="non"> Non</label>
          </div>

          <div id="dateBlock" class="hidden">
            <label for="dateDispo">À partir de quelle date êtes-vous disponible ?</label>
            <input id="dateDispo" name="dateDispo" type="date"/>
            <div class="small">La première date disponible est aujourd'hui.</div>
          </div>

          <label style="margin-top:12px"><input id="consent" name="consent" type="checkbox"/> J'accepte que mes données soient utilisées uniquement dans le cadre de cette mise en relation. (obligatoire)</label>

          <div class="actions">
            <button id="submit" type="button">Valider le formulaire</button>
            <button id="resetBtn" type="button" class="btn-ghost">Réinitialiser</button>
            <div id="submitMsg" class="small"></div>
          </div>
        </div>
      </form>
    </div>
  </div>

<script>
/* ========== CONFIG ========== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwL1JPKuzm9LvqUT2fTYfxBsyFtlpltBczMjAbSzcC4Gzi10EGm0VsGDsPnfEdZEGA/exec"; 
const DEPT_API = "https://geo.api.gouv.fr/departements";
const COMMUNE_API = code => `https://geo.api.gouv.fr/departements/${code}/communes`;

/* ========== HELPERS VALIDATION ========== */
const isDigits = s => /^\d+$/.test(s||"");
const validAdeli = v => isDigits(v) && v.length === 9;
const validSiret = v => isDigits(v) && v.length === 14;
const validPhone = v => {
  if(!v) return true;
  const c = v.replace(/\s|\-|\(|\)|\./g,"");
  return /^(0[1-9]\d{8}|\+33[1-9]\d{8})$/.test(c) || /^[0-9]{10,15}$/.test(c);
};

/* ========== DOM ========= */
const emailEl = document.getElementById("email");
const sendCodeBtn = document.getElementById("sendCodeBtn");
const emailMsg = document.getElementById("emailMsg");
const codeArea = document.getElementById("codeArea");
const codeEl = document.getElementById("code");
const verifyBtn = document.getElementById("verifyBtn");
const resendBtn = document.getElementById("resendBtn");
const codeMsg = document.getElementById("codeMsg");
const formEl = document.getElementById("form");
const adeliBlock = document.getElementById("adeliBlock");
const siretBlock = document.getElementById("siretBlock");
const noNum = document.getElementById("noNum");
const rest = document.getElementById("rest");
const adeliNum = document.getElementById("adeliNum");
const siretNum = document.getElementById("siretNum");
const adeliErr = document.getElementById("adeliErr");
const siretErr = document.getElementById("siretErr");
const submitBtn = document.getElementById("submit");
const submitMsg = document.getElementById("submitMsg");
const departSelect = document.getElementById("departement");
const communeSelect = document.getElementById("commune");
const dateBlock = document.getElementById("dateBlock");
const dateInput = document.getElementById("dateDispo");
const resetBtn = document.getElementById("resetBtn");

let CURRENT_EMAIL = null;
let EXISTING = false;
let EXISTING_DATA = null;

/* ========== SEND CODE ========== */
sendCodeBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  if (!mail) { emailMsg.textContent = "Merci d'indiquer une adresse e-mail."; return; }
  emailMsg.textContent = "Envoi du code...";
  try {
    const r = await fetch(`${SCRIPT_URL}?action=sendCode&email=${encodeURIComponent(mail)}`);
    const j = await r.json();
    if (j.ok) {
      emailMsg.textContent = "Code envoyé. Vérifiez votre boîte mail.";
      CURRENT_EMAIL = mail;
      codeArea.classList.remove("hidden");
    } else {
      emailMsg.textContent = "Erreur : " + (j.error || "impossible d'envoyer le code");
    }
  } catch (err) {
    emailMsg.textContent = "Erreur réseau lors de l'envoi du code.";
  }
});

/* ========== RESEND ========== */
resendBtn.addEventListener("click", () => {
  sendCodeBtn.click();
});

/* ========== VERIFY CODE ========== */
verifyBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  const code = (codeEl.value || "").trim();
  if (!mail || !code) { codeMsg.textContent = "Merci d'indiquer l'adresse e-mail et le code."; return; }
  codeMsg.textContent = "Vérification...";
  try {
    const r = await fetch(`${SCRIPT_URL}?action=verifyCode&email=${encodeURIComponent(mail)}&code=${encodeURIComponent(code)}`);
    const j = await r.json();
    if (!j.ok) { codeMsg.textContent = "Erreur : " + (j.error||"code invalide"); return; }
    // success
    codeMsg.textContent = "E-mail vérifié.";
    CURRENT_EMAIL = mail;
    // if existing user -> prefill
    if (j.existing && j.data) {
      EXISTING = true;
      EXISTING_DATA = j.data;
      showFormAndPrefill(j.data);
    } else {
      EXISTING = false;
      EXISTING_DATA = null;
      // new user: show form but keep rest hidden until valid number
      formEl.classList.remove("hidden");
      rest.classList.add("hidden");
      // show number fieldset already visible (numField)
    }
  } catch (err) {
    codeMsg.textContent = "Erreur réseau lors de la vérification.";
  }
});

/* ========== PREFILL FUNCTION ========== */
function showFormAndPrefill(data) {
  formEl.classList.remove("hidden");
  rest.classList.remove("hidden");
  // map server keys to front fields (expected keys from Apps Script: typeNum,numPro,nom,prenom,phone,profession,publics,modes,visio,departement,commune,rayon,disponibilite,dateDisponibilite,consentement)
  const type = data.typeNum || data.numType || "";
  if (type === "adeli") {
    document.querySelector('input[name="numType"][value="adeli"]').checked = true;
    adeliBlock.classList.remove("hidden");
    siretBlock.classList.add("hidden");
    adeliNum.value = data.numPro || "";
  } else if (type === "siret") {
    document.querySelector('input[name="numType"][value="siret"]').checked = true;
    siretBlock.classList.remove("hidden");
    adeliBlock.classList.add("hidden");
    siretNum.value = data.numPro || "";
  }
  // basic fields
  document.getElementById("nom").value = data.nom || "";
  document.getElementById("prenom").value = data.prenom || "";
  document.getElementById("phone").value = data.phone || "";
  document.getElementById("profession").value = data.profession || "";
  // publics (csv)
  const publics = (data.publics || "").split(",").map(s=>s.trim());
  document.querySelectorAll('input[name="public"]').forEach(ch => ch.checked = publics.includes(ch.value));
  // modes
  const modes = (data.modes || "").split(",").map(s=>s.trim());
  document.querySelectorAll('input[name="mode"]').forEach(ch => ch.checked = modes.includes(ch.value));
  // visio
  if (data.visio) {
    const v = document.querySelector(`input[name="visio"][value="${data.visio}"]`);
    if (v) v.checked = true;
  }
  // depart/commune -> load depts then set
  loadDepartements().then(()=> {
    if (data.departement) {
      departSelect.value = data.departement;
      return loadCommunes(data.departement, data.commune);
    }
  }).catch(()=>{});
  // rayon
  document.getElementById("rayon").value = data.rayon || "";
  // dispo/date
  if (data.disponibilite) {
    const dEl = document.querySelector(`input[name="dispo"][value="${data.disponibilite}"]`);
    if (dEl) dEl.checked = true;
    dateBlock.classList.toggle("hidden", data.disponibilite !== "oui");
  }
  dateInput.value = data.dateDisponibilite || "";
  // consent
  document.getElementById("consent").checked = ((""+(data.consentement||"")).toLowerCase() === "oui" || (data.consentement||"").toLowerCase()==="true");
}

/* ========== LISTENERS: numType toggles ========== */
document.querySelectorAll('input[name="numType"]').forEach(r => r.addEventListener('change', e => {
  const v = e.target.value;
  adeliErr.textContent = ""; siretErr.textContent = "";
  adeliNum.value = ""; siretNum.value = "";
  adeliBlock.classList.add("hidden"); siretBlock.classList.add("hidden"); noNum.classList.add("hidden");
  rest.classList.add("hidden");
  if (v === "adeli") adeliBlock.classList.remove("hidden");
  else if (v === "siret") siretBlock.classList.remove("hidden");
  else noNum.classList.remove("hidden");
}));

/* ========== VALIDATION on blur for ADELI/SIRET to reveal form for new users ========== */
adeliNum.addEventListener('blur', () => {
  const v = adeliNum.value.trim();
  if (!validAdeli(v)) { adeliErr.textContent = "Un numéro ADELI doit contenir exactement 9 chiffres."; rest.classList.add("hidden"); }
  else { adeliErr.textContent = ""; rest.classList.remove("hidden"); loadDepartements(); }
});
siretNum.addEventListener('blur', () => {
  const v = siretNum.value.trim();
  if (!validSiret(v)) { siretErr.textContent = "Un numéro SIRET doit contenir exactement 14 chiffres."; rest.classList.add("hidden"); }
  else { siretErr.textContent = ""; rest.classList.remove("hidden"); loadDepartements(); }
});

/* ========== DISPO date logic ========== */
document.querySelectorAll('input[name="dispo"]').forEach(r => r.addEventListener('change', e => {
  const show = e.target.value === "oui";
  dateBlock.classList.toggle("hidden", !show);
  if (show) dateInput.setAttribute("min", new Date().toISOString().split("T")[0]);
  else dateInput.value = "";
}));

/* ========== DEPARTEMENTS / COMMUNES ========== */
async function loadDepartements(){
  departSelect.innerHTML = '<option value="">-- chargement --</option>';
  try {
    const r = await fetch(DEPT_API);
    const list = await r.json();
    departSelect.innerHTML = '<option value="">-- sélectionnez --</option>';
    list.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.code;
      opt.textContent = `${d.code} — ${d.nom}`;
      departSelect.appendChild(opt);
    });
  } catch (err) {
    departSelect.innerHTML = '<option value="">Erreur de chargement</option>';
  }
}
async function loadCommunes(deptCode, preselect){
  communeSelect.innerHTML = '<option>Chargement...</option>';
  try {
    const r = await fetch(COMMUNE_API(deptCode));
    const list = await r.json();
    communeSelect.innerHTML = '<option value="">-- sélectionnez --</option>';
    list.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.nom;
      opt.textContent = c.nom;
      communeSelect.appendChild(opt);
    });
    if (preselect) communeSelect.value = preselect;
  } catch (err) {
    communeSelect.innerHTML = '<option value="">Erreur chargement</option>';
  }
}
departSelect.addEventListener('change', e => {
  const v = e.target.value;
  if (!v) { communeSelect.innerHTML = '<option value="">-- choisissez d\'abord le département --</option>'; return; }
  loadCommunes(v);
});

/* ========== SUBMIT FORM ========== */
submitBtn.addEventListener('click', async () => {
  submitMsg.textContent = "";
  // validations (client-side)
  const numTypeChecked = document.querySelector('input[name="numType"]:checked');
  if (!numTypeChecked) { submitMsg.textContent = "Vous devez indiquer votre type de numéro professionnel."; return; }
  const numType = numTypeChecked.value;
  if (numType === "adeli" && !validAdeli(adeliNum.value.trim())) { submitMsg.textContent = "Numéro ADELI invalide."; return; }
  if (numType === "siret" && !validSiret(siretNum.value.trim())) { submitMsg.textContent = "Numéro SIRET invalide."; return; }
  if (!document.getElementById("nom").value.trim()) { submitMsg.textContent = "Nom requis."; return; }
  if (!document.getElementById("prenom").value.trim()) { submitMsg.textContent = "Prénom requis."; return; }
  if (!validPhone(document.getElementById("phone").value.trim())) { submitMsg.textContent = "Téléphone invalide."; return; }
  if (!document.getElementById("profession").value) { submitMsg.textContent = "Profession requise."; return; }
  if (!Array.from(document.querySelectorAll('input[name="public"]:checked')).length) { submitMsg.textContent = "Sélectionnez au moins un public."; return; }
  if (!Array.from(document.querySelectorAll('input[name="mode"]:checked')).length) { submitMsg.textContent = "Sélectionnez au moins un mode d'intervention."; return; }
  if (!document.querySelector('input[name="visio"]:checked')) { submitMsg.textContent = "Indiquez si vous proposez des RDV en visio."; return; }
  if (!departSelect.value) { submitMsg.textContent = "Département requis."; return; }
  if (!communeSelect.value) { submitMsg.textContent = "Commune requise."; return; }
  if (!document.getElementById("rayon").value) { submitMsg.textContent = "Indiquez un rayon d'intervention."; return; }
  const dispoChecked = document.querySelector('input[name="dispo"]:checked');
  if (!dispoChecked) { submitMsg.textContent = "Répondez à la question disponibilités."; return; }
  if (dispoChecked.value === "oui" && !dateInput.value) { submitMsg.textContent = "Indiquez la date de disponibilité."; return; }
  if (!document.getElementById("consent").checked) { submitMsg.textContent = "Le consentement est obligatoire."; return; }

  // build FormData to send
  const fd = new FormData();
  fd.append("action", "submitForm");
  fd.append("email", (CURRENT_EMAIL || emailEl.value || "").trim().toLowerCase());
  fd.append("numType", numType);
  fd.append("adeliNum", adeliNum.value.trim());
  fd.append("siretNum", siretNum.value.trim());
  fd.append("nom", document.getElementById("nom").value.trim());
  fd.append("prenom", document.getElementById("prenom").value.trim());
  fd.append("phone", document.getElementById("phone").value.trim());
  fd.append("profession", document.getElementById("profession").value);
  fd.append("publics", Array.from(document.querySelectorAll('input[name="public"]:checked')).map(i=>i.value).join(","));
  fd.append("modes", Array.from(document.querySelectorAll('input[name="mode"]:checked')).map(i=>i.value).join(","));
  fd.append("visio", document.querySelector('input[name="visio"]:checked').value);
  fd.append("departement", departSelect.value);
  fd.append("commune", communeSelect.value);
  fd.append("rayon", document.getElementById("rayon").value);
  fd.append("dispo", document.querySelector('input[name="dispo"]:checked').value);
  fd.append("dateDispo", dateInput.value);
  fd.append("consent", document.getElementById("consent").checked ? "oui" : "non");

  submitMsg.textContent = "Envoi en cours...";
  try {
    const res = await fetch(SCRIPT_URL, { method: "POST", body: fd });
    const j = await res.json();
    if (j.ok) {
      submitMsg.textContent = "✅ Formulaire envoyé !";
    } else {
      submitMsg.textContent = "❌ Erreur : " + (j.error || "erreur inconnue");
    }
  } catch (err) {
    submitMsg.textContent = "❌ Erreur réseau lors de l'envoi.";
  }
});

/* ========== RESET ========== */
resetBtn.addEventListener('click', () => {
  formEl.reset();
  document.getElementById("consent").checked = false;
  rest.classList.add("hidden");
  adeliBlock.classList.add("hidden");
  siretBlock.classList.add("hidden");
  noNum.classList.add("hidden");
  submitMsg.textContent = "";
});

/* ========== UX: help (small) ========== */
document.getElementById("openHelp").addEventListener('click', () => {
  alert("Procédure : 1) entrez votre email 2) demandez le code 3) validez le code 4) remplissez le formulaire. Si vous avez déjà validé une fois, le formulaire sera prérempli après la validation du code.");
});

</script>
</body>
</html>


