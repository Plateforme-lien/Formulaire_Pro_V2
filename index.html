<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Questionnaire ‚Äî Professionnels</title>
<style>
  :root{--bg:#f6f8fb;--card:#fff;--primary:#0ea5a4;--primary-dark:#0d8887;--muted:#6b7280;--section-bg:#f9fafb;--prereq-bg:#e6f7f7;}
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);margin:0;padding:24px;line-height:1.6}
  .wrap{max-width:980px;margin:18px auto}
  .card{background:var(--card);border-radius:16px;padding:32px 36px;box-shadow:0 8px 30px rgba(2,6,23,0.06)}
  h1{margin:0 0 8px;font-size:24px;color:#0f1724}
  h2{margin:0 0 24px;color:var(--muted);font-size:17px;font-weight:600;line-height:1.6}
  p.lead{margin:0 0 24px;color:var(--muted);font-size:15px}
  
  label{display:block;margin-top:24px;font-weight:600;color:#0f1724;font-size:15px}
  label:first-of-type{margin-top:0}
  
  .required::after{content:" *";color:#dc2626;font-weight:700}
  
  input[type=text],input[type=email],input[type=tel],input[type=date],select,textarea{
    width:100%;
    padding:12px 14px;
    border:2px solid #e6eef6;
    border-radius:8px;
    margin-top:8px;
    font-size:15px;
    transition:border-color 0.2s;
    box-sizing:border-box;  
  }
  input[type=text]:focus,input[type=email]:focus,input[type=tel]:focus,input[type=date]:focus,select:focus{
    outline:none;border-color:var(--primary);
  }
  
  .question-section{
    background:var(--section-bg);
    padding:24px;
    border-radius:12px;
    margin-top:32px;
    border-left:4px solid var(--primary);
  }
  .question-section:first-child{margin-top:24px}
  .section-title{
    font-size:17px;
    font-weight:700;
    color:#0f1724;
    margin:0 0 20px 0;
    display:flex;
    align-items:center;
    gap:10px;
  }
  
  .section-number{
    background:var(--primary);
    color:white;
    min-width:28px;     
    width:28px;
    height:28px;
    border-radius:50%;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:14px;
    font-weight:700;
    flex-shrink:0;      
  }

  /* Style sp√©cial pour les pr√©requis */
  .prereq-section{
    background:var(--prereq-bg);
    padding:24px;
    border-radius:12px;
    margin-top:24px;
    border:2px solid #b3e5e4;
    border-left:4px solid var(--primary);
  }
  
  .prereq-title{
    font-size:17px;
    font-weight:700;
    color:#0f1724;
    margin:0 0 20px 0;
  }
  
  fieldset{margin-top:0;border:2px solid #e6eef6;padding:20px;border-radius:12px;background:white}
  legend{font-weight:700;font-size:16px;color:#0f1724;padding:0 8px}
  
  button{background:var(--primary);color:#fff;padding:12px 20px;border-radius:8px;border:0;cursor:pointer;
    font-size:15px;font-weight:600;transition:all 0.2s}
  button:hover{background:var(--primary-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(14,165,164,0.3)}
  button:active{transform:translateY(0)}
  button:disabled{opacity:0.5;cursor:not-allowed;transform:none}
  .btn-ghost{background:#eef2f7;color:#0f1724}
  .btn-ghost:hover{background:#e1e7ef;transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
  
  #submit{
    background:linear-gradient(135deg, #0ea5a4 0%, #0d8887 100%);
    padding:16px 40px;
    font-size:17px;
    font-weight:700;
    border-radius:12px;
    box-shadow:0 4px 16px rgba(14,165,164,0.4);
    margin-top:32px;
  }
  #submit:hover{
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(14,165,164,0.5);
  }
  
  .actions{display:flex;gap:12px;align-items:center;margin-top:32px;flex-wrap:wrap}
  
  .small{font-size:13px;color:var(--muted);margin-top:8px;line-height:1.5}
  .error{color:#dc2626;margin-top:8px;font-weight:500}
  
  .inline{display:inline-block;margin-right:16px;margin-bottom:8px}
  input[type=radio],input[type=checkbox]{margin-right:6px;cursor:pointer}
  label:has(input[type=radio]),label:has(input[type=checkbox]){font-weight:500;cursor:pointer}
  
  .hidden{display:none}
  
  @media(max-width:768px){
    .card{padding:24px 20px}
    .question-section{padding:20px}
    h1{font-size:20px}
    #submit{padding:14px 32px;font-size:16px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>R√©f√©rencement de professionnels sp√©cialis√©s TSA</h1>
      <h2>Renseignez ou actualisez vos informations pour que les particuliers puissent vous trouver selon votre secteur d'intervention, vos disponibilit√©s et le public que vous accompagnez.</h2>
      <!-- üÜï ZONE ADMIN QUOTA -->
      <div id="adminQuota" style="display:none; background:#fff3cd; border:2px solid #ffc107; padding:16px; border-radius:8px; margin-bottom:20px;">
        <strong>üìä Admin - Quota emails :</strong> 
        <span id="quotaDisplay">Chargement...</span>
        <button id="refreshQuota" type="button" style="padding:6px 12px; font-size:13px; margin-left:10px;">üîÑ Actualiser</button>
      </div>
      <p class="lead">Commencez par v√©rifier votre e-mail ‚Äî un code sera envoy√©. Si vous avez d√©j√† rempli le formulaire auparavant, il sera pr√©-rempli.</p>
      <p class="small" style="margin-top:-16px;margin-bottom:16px">Les champs marqu√©s d'un <span style="color:#dc2626;font-weight:700">*</span> sont obligatoires.</p>

      <!-- EMAIL -->
      <label for="email" class="required">Adresse e-mail</label>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="email" type="email" placeholder="votre@email.com" autocomplete="email"/>
        <button id="sendCodeBtn" type="button">V√©rifier mon mail</button>
      </div>
      <div id="emailMsg" class="small"></div>

      <!-- CODE -->
      <div id="codeArea" class="hidden" style="margin-top:12px">
        <label for="code" class="required">Code de v√©rification (envoy√© par e-mail)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="code" type="text" placeholder="000000" inputmode="numeric"/>
          <button id="verifyBtn" type="button">Valider le code</button>
          <button id="resendBtn" class="btn-ghost" type="button">Renvoyer</button>
        </div>
        <div id="codeMsg" class="small"></div>
      </div>

      <!-- FORM -->
      <form id="form" class="hidden" onsubmit="return false;">
        <!-- Num√©ro professionnel -->
         <div class="prereq-section">
          <div class="prereq-title">
            Pr√©requis
          </div>
          
          <label style="margin-top:0" class="required">Avez-vous un num√©ro professionnel ?</label>
          <div style="margin-top:12px">
            <label class="inline"><input type="radio" name="numType" value="adeli"> Oui, j'ai un num√©ro ADELI</label>
            <label class="inline"><input type="radio" name="numType" value="siret"> Oui, j'ai un num√©ro SIRET</label>
            <label class="inline"><input type="radio" name="numType" value="none"> Non, je n'ai pas de num√©ro</label>
          </div>
          
          <div id="adeliBlock" class="hidden">
            <label for="adeliNum" class="required">Quel est votre num√©ro ADELI ?</label>
            <input id="adeliNum" name="adeliNum" type="text" maxlength="9" inputmode="numeric" placeholder="9 chiffres"/>
            <div id="adeliErr" class="error"></div>
          </div>
          
          <div id="siretBlock" class="hidden">
            <label for="siretNum" class="required">Quel est votre num√©ro SIRET ?</label>
            <input id="siretNum" name="siretNum" type="text" maxlength="14" inputmode="numeric" placeholder="14 chiffres"/>
            <div id="siretErr" class="error"></div>
          </div>
          
          <div id="noNum" class="error hidden">Ce questionnaire n'est autoris√© que pour les professionnels ayant un num√©ro ADELI ou SIRET.</div>
        </div>

        <!-- Rest of form -->
        <div id="rest" class="hidden">
          <!-- Section 1 : Identit√© -->
          <div class="question-section">
            <div class="section-title">
              <span class="section-number">1</span>
              Identit√© et coordonn√©es
            </div>
            
            <label for="nom" class="required">Nom</label>
            <input id="nom" name="nom" type="text"/>

            <label for="prenom" class="required">Pr√©nom</label>
            <input id="prenom" name="prenom" type="text"/>

            <label for="phone">T√©l√©phone (optionnel)</label>
            <input id="phone" name="phone" type="tel" placeholder="0X XX XX XX XX ou +33..."/>
          </div>

          <!-- Section 2 : Profession -->
          <div class="question-section">
            <div class="section-title">
              <span class="section-number">2</span>
                Activit√© professionnelle
            </div>
            
            <label for="profession" class="required">Profession</label>
            <select id="profession" name="profession">
              <option value="">-- s√©lectionnez --</option>
              <option>√âducateur sp√©cialis√©</option>
              <option>Ergoth√©rapeute</option>
              <option>Psychologue</option>
              <option>Psychomotricien</option>
              <option>Orthophoniste</option>
            </select>

            <label style="margin-top:24px" class="required">Aupr√®s de quel(s) public(s) intervenez-vous ?</label>
            <div class="small" style="margin-top:4px">Vous pouvez s√©lectionner plusieurs r√©ponses.</div>
            <div style="margin-top:12px">
              <label><input type="checkbox" name="public" value="0-6"> Enfants (0-6 ans)</label>
              <label><input type="checkbox" name="public" value="7-12"> Enfants (7-12 ans)</label>
              <label><input type="checkbox" name="public" value="13-18"> Adolescents (13-18 ans)</label>
              <label><input type="checkbox" name="public" value="18+"> Adultes (18+)</label>
            </div>
          </div>
          
          <label class="required">Quel(s) sont vos modes d'intervention ?</label>
          <div class="small" style="margin-top:4px">Vous pouvez s√©lectionner plusieurs r√©ponses.</div>
          <div style="margin-top:12px">
            <label><input type="checkbox" name="mode" value="domicile"> Se d√©place √† domicile</label>
            <label><input type="checkbox" name="mode" value="cabinet"> En cabinet</label>
          </div>
            
          <label style="margin-top:24px" class="required">Proposez-vous des rendez-vous en visio ?</label>
          <div style="margin-top:12px">
            <label><input type="radio" name="visio" value="oui"> Oui</label>
            <label><input type="radio" name="visio" value="non"> Non</label>
          </div>
          </div>

          <!-- Section 3 : Zone g√©ographique -->
          <div class="question-section">
            <div class="section-title">
              <span class="section-number">3</span>
              Zone g√©ographique d'intervention
            </div>
            
            <label for="departement" class="required">Dans quel d√©partement intervenez-vous principalement ?</label>
            <select id="departement" name="departement"><option value="">-- chargement --</option></select>

            <label for="commune" class="required">Quelle est votre commune principale d'intervention ?</label>
            <select id="commune" name="commune"><option value="">-- choisissez le d√©partement --</option></select>

            <label for="rayon" class="required">Quel est votre rayon d'intervention ?</label>
            <select id="rayon" name="rayon">
              <option value="">-- s√©lectionnez --</option>
              <option>Aucun - en cabinet</option>
              <option>10 km</option>
              <option>15 km</option>
              <option>20 km</option>
              <option>25 km</option>
              <option>30 km</option>
              <option>40 km</option>
              <option>Tout mon d√©partement</option>
            </select>
            <div class="small">Si vous intervenez uniquement en cabinet, s√©lectionnez "Aucun - en cabinet".</div>
          </div>

          <!-- Section 4 : Disponibilit√©s -->
          <div class="question-section">
            <div class="section-title">
              <span class="section-number">4</span>
              Disponibilit√©s
            </div>
            
            <label class="required">Avez-vous des disponibilit√©s pour de nouveaux b√©n√©ficiaires ?</label>
            <div style="margin-top:12px">
              <label><input type="radio" name="dispo" value="oui"> Oui</label>
              <label><input type="radio" name="dispo" value="non"> Non</label>
            </div>

            <div id="dateBlock" class="hidden">
              <label for="dateDispo" class="required">√Ä partir de quelle date √™tes-vous disponible ?</label>
              <input id="dateDispo" name="dateDispo" type="date"/>
            </div>
          </div>

          <!-- Section 5 : Consentement -->
          <div class="question-section">
            <div class="section-title">
              <span class="section-number">5</span>
              Consentement
            </div>
            
            <label style="margin-top:0;display:flex;align-items:start;gap:8px" class="required">
              <input id="consent" name="consent" type="checkbox" style="margin-top:4px"/> 
              <span>J'accepte que mes donn√©es soient utilis√©es uniquement dans le cadre de cette mise en relation.</span>
            </label>
          </div>

          <div class="actions">
            <button id="submit" type="button">‚úì Valider mon inscription ou les modifications</button>
            <button id="resetBtn" type="button" class="btn-ghost">R√©initialiser</button>
          </div>
          <div id="submitMsg" class="small"></div>
        </div>
      </form>
    </div>
  </div>

<script>
/* ========== CONFIG ========== */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwL1JPKuzm9LvqUT2fTYfxBsyFtlpltBczMjAbSzcC4Gzi10EGm0VsGDsPnfEdZEGA/exec"; 
const DEPT_API = "https://geo.api.gouv.fr/departements";
const COMMUNE_API = code => `https://geo.api.gouv.fr/departements/${code}/communes`;

/* ========== HELPERS VALIDATION ========== */
const isDigits = s => /^\d+$/.test(s||"");
const validAdeli = v => isDigits(v) && v.length === 9;
const validSiret = v => isDigits(v) && v.length === 14;
const validPhone = v => {
  if(!v) return true;
  const c = v.replace(/\s|\-|\(|\)|\./g,"");
  return /^(0[1-9]\d{8}|\+33[1-9]\d{8})$/.test(c) || /^[0-9]{10,15}$/.test(c);
};

/* ========== DOM ========= */
const emailEl = document.getElementById("email");
const sendCodeBtn = document.getElementById("sendCodeBtn");
const emailMsg = document.getElementById("emailMsg");
const codeArea = document.getElementById("codeArea");
const codeEl = document.getElementById("code");
const verifyBtn = document.getElementById("verifyBtn");
const resendBtn = document.getElementById("resendBtn");
const codeMsg = document.getElementById("codeMsg");
const formEl = document.getElementById("form");
const adeliBlock = document.getElementById("adeliBlock");
const siretBlock = document.getElementById("siretBlock");
const noNum = document.getElementById("noNum");
const rest = document.getElementById("rest");
const adeliNum = document.getElementById("adeliNum");
const siretNum = document.getElementById("siretNum");
const adeliErr = document.getElementById("adeliErr");
const siretErr = document.getElementById("siretErr");
const submitBtn = document.getElementById("submit");
const submitMsg = document.getElementById("submitMsg");
const departSelect = document.getElementById("departement");
const communeSelect = document.getElementById("commune");
const dateBlock = document.getElementById("dateBlock");
const dateInput = document.getElementById("dateDispo");
const resetBtn = document.getElementById("resetBtn");

let CURRENT_EMAIL = null;
let EXISTING = false;
let EXISTING_DATA = null;

/* ========== SEND CODE ========== */
sendCodeBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  if (!mail) { 
    emailMsg.textContent = "Merci d'indiquer une adresse e-mail."; 
    return; 
  }
  
  emailMsg.textContent = "Envoi du code en cours...";
  sendCodeBtn.disabled = true;
  
  try {
    const r = await fetch(`${SCRIPT_URL}?action=sendCode&email=${encodeURIComponent(mail)}`);
    const j = await r.json();
    
    console.log("R√©ponse serveur sendCode:", j);
    console.log("üîç DEBUG - alreadySent =", j.alreadySent);

      //  Gestion du cooldown
    if (j.error === "COOLDOWN_ACTIVE") {
      const heures = Math.floor(j.minutesRestantes / 60);
      const minutes = j.minutesRestantes % 60;
      const tempsRestant = heures > 0 ? `${heures}h${minutes > 0 ? minutes + 'min' : ''}` : `${minutes} minutes`;
      
      emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">‚è±Ô∏è Veuillez patienter</span><br>
        <span style="color:#6b7280">Vous avez r√©cemment soumis le formulaire. Vous pourrez redemander un code dans environ ${tempsRestant}.</span>`;
      sendCodeBtn.disabled = false;
      return;
    }
    // V√©rifier si le quota est d√©pass√© (prioritaire)
    if (j.error === "SERVICE_QUOTA_EXCEEDED") {
      emailMsg.innerHTML = `<span style="color:#dc2626;font-weight:600">‚ö†Ô∏è Service temporairement indisponible</span><br>
        <span style="color:#6b7280">Le quota d'emails quotidien est atteint. Merci de r√©essayer demain.</span>`;
      sendCodeBtn.disabled = false;
      return;
    }
    
    // Si vraiment ok
    if (j.ok) {
      // V√©rifier si c'est un code d√©j√† envoy√© ou un nouveau code
      if (j.alreadySent) {
        emailMsg.innerHTML = `<span style="color:#f59e0b;font-weight:600">Code d√©j√† envoy√©</span><br>
          <span style="color:#6b7280">Un code vous a d√©j√† √©t√© envoy√© il y a moins de 15 minutes. Le code est encore valable. V√©rifiez votre bo√Æte mail (pensez aux spams).</span>`;
      } else {
        emailMsg.innerHTML = `<span style="color:#059669;font-weight:600">‚úì Code envoy√© avec succ√®s</span><br>
          <span style="color:#6b7280">V√©rifiez votre bo√Æte mail (pensez aux spams).</span>`;
      }
      
      CURRENT_EMAIL = mail;
      codeArea.classList.remove("hidden");
      codeEl.focus();
    } else {
      // Autres erreurs
      emailMsg.innerHTML = `<span style="color:#dc2626">Erreur : ${j.error || "Impossible d'envoyer le code"}</span>`;
    }
  } catch (err) {
    console.error("Erreur r√©seau:", err);
    emailMsg.innerHTML = `<span style="color:#dc2626">Erreur r√©seau lors de l'envoi du code</span>`;
  } finally {
    sendCodeBtn.disabled = false;
  }
});

// permet d'appuyer sur Entr√©e)
emailEl.addEventListener("keypress", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    sendCodeBtn.click();
  }
});

/* ========== RESEND ========== */
resendBtn.addEventListener("click", () => {
  sendCodeBtn.click();
});

/* ========== VERIFY CODE ========== */
verifyBtn.addEventListener("click", async () => {
  const mail = (emailEl.value || "").trim().toLowerCase();
  const code = (codeEl.value || "").trim();
  if (!mail || !code) { codeMsg.textContent = "Merci d'indiquer l'adresse e-mail et le code."; return; }
  codeMsg.textContent = "V√©rification...";
  try {
    const r = await fetch(`${SCRIPT_URL}?action=verifyCode&email=${encodeURIComponent(mail)}&code=${encodeURIComponent(code)}`);
    const j = await r.json();
    if (!j.ok) { codeMsg.textContent = "Erreur : " + (j.error||"code invalide"); return; }
    
    codeMsg.textContent = "‚úÖ E-mail v√©rifi√© avec succ√®s !";
    CURRENT_EMAIL = mail;
    // üÜï Masquer UNIQUEMENT la zone du code (garder l'email visible)
    codeArea.style.display = "none";
    emailMsg.style.display = "none";  
    
    await loadDepartements();
    
    if (j.existing && j.data) {
      EXISTING = true;
      EXISTING_DATA = j.data;
      await showFormAndPrefill(j.data);
    } else {
      EXISTING = false;
      EXISTING_DATA = null;
      formEl.classList.remove("hidden");
      rest.classList.add("hidden");
    }
  } catch (err) {
    codeMsg.textContent = "Erreur r√©seau lors de la v√©rification.";
  }
});

/* ========== PREFILL FUNCTION ========== */
async function showFormAndPrefill(data) {
  console.log("Donn√©es re√ßues pour pr√©-remplissage:", data);
  
  formEl.classList.remove("hidden");
  rest.classList.remove("hidden");
  
  const numType = data.numType || "";
  if (numType === "adeli") {
    document.querySelector('input[name="numType"][value="adeli"]').checked = true;
    adeliBlock.classList.remove("hidden");
    siretBlock.classList.add("hidden");
    noNum.classList.add("hidden");
    adeliNum.value = data.numPro || "";
  } else if (numType === "siret") {
    document.querySelector('input[name="numType"][value="siret"]').checked = true;
    siretBlock.classList.remove("hidden");
    adeliBlock.classList.add("hidden");
    noNum.classList.add("hidden");
    siretNum.value = data.numPro || "";
  }
  
  document.getElementById("nom").value = data.nom || "";
  document.getElementById("prenom").value = data.prenom || "";
  document.getElementById("phone").value = data.phone || "";
  document.getElementById("profession").value = data.profession || "";
  
  if (data.publics) {
    const publicsArr = data.publics.split(",").map(s => s.trim()).filter(Boolean);
    document.querySelectorAll('input[name="public"]').forEach(ch => {
      ch.checked = publicsArr.includes(ch.value);
    });
  }
  
  if (data.modes) {
    const modesArr = data.modes.split(",").map(s => s.trim()).filter(Boolean);
    document.querySelectorAll('input[name="mode"]').forEach(ch => {
      ch.checked = modesArr.includes(ch.value);
    });
  }
  
  if (data.visio) {
    const visioRadio = document.querySelector(`input[name="visio"][value="${data.visio}"]`);
    if (visioRadio) visioRadio.checked = true;
  }
  
  if (data.departement) {
    let deptCode = String(data.departement).trim();
    if (deptCode.length === 1) deptCode = "0" + deptCode;
    
    setTimeout(() => {
      departSelect.value = deptCode;
      
      if (data.commune) {
        loadCommunes(deptCode, data.commune);
      }
    }, 100);
  }
  
  document.getElementById("rayon").value = data.rayon || "";
  
  const consentValue = String(data.consentement || "").toLowerCase();
  document.getElementById("consent").checked = (consentValue === "oui" || consentValue === "true");
}

/* ========== LISTENERS: numType toggles ========== */
document.querySelectorAll('input[name="numType"]').forEach(r => r.addEventListener('change', e => {
  const v = e.target.value;
  adeliErr.textContent = ""; siretErr.textContent = "";
  adeliNum.value = ""; siretNum.value = "";
  adeliBlock.classList.add("hidden"); siretBlock.classList.add("hidden"); noNum.classList.add("hidden");
  rest.classList.add("hidden");
  if (v === "adeli") adeliBlock.classList.remove("hidden");
  else if (v === "siret") siretBlock.classList.remove("hidden");
  else noNum.classList.remove("hidden");
}));

/* ========== VALIDATION on blur for ADELI/SIRET ========== */
adeliNum.addEventListener('blur', () => {
  const v = adeliNum.value.trim();
  if (!validAdeli(v)) { 
    adeliErr.textContent = "Un num√©ro ADELI doit contenir exactement 9 chiffres."; 
    rest.classList.add("hidden"); 
  } else { 
    adeliErr.textContent = ""; 
    rest.classList.remove("hidden");
  }
});

siretNum.addEventListener('blur', () => {
  const v = siretNum.value.trim();
  if (!validSiret(v)) { 
    siretErr.textContent = "Un num√©ro SIRET doit contenir exactement 14 chiffres."; 
    rest.classList.add("hidden"); 
  } else { 
    siretErr.textContent = ""; 
    rest.classList.remove("hidden");
  }
});

/* ========== DISPO date logic ========== */
document.querySelectorAll('input[name="dispo"]').forEach(r => r.addEventListener('change', e => {
  const show = e.target.value === "oui";
  dateBlock.classList.toggle("hidden", !show);
  if (show) dateInput.setAttribute("min", new Date().toISOString().split("T")[0]);
  else dateInput.value = "";
}));

/* ========== DEPARTEMENTS / COMMUNES ========== */
async function loadDepartements(){
  departSelect.innerHTML = '<option value="">-- chargement --</option>';
  try {
    const r = await fetch(DEPT_API);
    const list = await r.json();
    departSelect.innerHTML = '<option value="">-- s√©lectionnez --</option>';
    list.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.code;
      opt.textContent = `${d.code} ‚Äî ${d.nom}`;
      departSelect.appendChild(opt);
    });
  } catch (err) {
    departSelect.innerHTML = '<option value="">Erreur de chargement</option>';
  }
}

async function loadCommunes(deptCode, preselect){
  communeSelect.innerHTML = '<option>Chargement...</option>';
  try {
    const r = await fetch(COMMUNE_API(deptCode));
    const list = await r.json();
    communeSelect.innerHTML = '<option value="">-- s√©lectionnez --</option>';
    list.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c.nom;
      opt.textContent = c.nom;
      communeSelect.appendChild(opt);
    });
    if (preselect) {
      communeSelect.value = preselect;
    }
  } catch (err) {
    communeSelect.innerHTML = '<option value="">Erreur chargement</option>';
  }
}

departSelect.addEventListener('change', e => {
  const v = e.target.value;
  if (!v) { 
    communeSelect.innerHTML = '<option value="">-- choisissez d\'abord le d√©partement --</option>'; 
    return; 
  }
  loadCommunes(v);
});

/* ========== SUBMIT FORM ========== */
submitBtn.addEventListener('click', async () => {
  submitMsg.textContent = "";
  
  const numTypeChecked = document.querySelector('input[name="numType"]:checked');
  if (!numTypeChecked) { submitMsg.textContent = "Vous devez indiquer votre type de num√©ro professionnel."; return; }
  const numType = numTypeChecked.value;
  if (numType === "adeli" && !validAdeli(adeliNum.value.trim())) { submitMsg.textContent = "Num√©ro ADELI invalide."; return; }
  if (numType === "siret" && !validSiret(siretNum.value.trim())) { submitMsg.textContent = "Num√©ro SIRET invalide."; return; }
  if (!document.getElementById("nom").value.trim()) { submitMsg.textContent = "Nom requis."; return; }
  if (!document.getElementById("prenom").value.trim()) { submitMsg.textContent = "Pr√©nom requis."; return; }
  if (!validPhone(document.getElementById("phone").value.trim())) { submitMsg.textContent = "T√©l√©phone invalide."; return; }
  if (!document.getElementById("profession").value) { submitMsg.textContent = "Profession requise."; return; }
  if (!Array.from(document.querySelectorAll('input[name="public"]:checked')).length) { submitMsg.textContent = "S√©lectionnez au moins un public."; return; }
  if (!Array.from(document.querySelectorAll('input[name="mode"]:checked')).length) { submitMsg.textContent = "S√©lectionnez au moins un mode d'intervention."; return; }
  if (!document.querySelector('input[name="visio"]:checked')) { submitMsg.textContent = "Indiquez si vous proposez des RDV en visio."; return; }
  if (!departSelect.value) { submitMsg.textContent = "D√©partement requis."; return; }
  if (!communeSelect.value) { submitMsg.textContent = "Commune requise."; return; }
  if (!document.getElementById("rayon").value) { submitMsg.textContent = "Indiquez un rayon d'intervention."; return; }
  const dispoChecked = document.querySelector('input[name="dispo"]:checked');
  if (!dispoChecked) { submitMsg.textContent = "R√©pondez √† la question disponibilit√©s."; return; }
  if (dispoChecked.value === "oui" && !dateInput.value) { submitMsg.textContent = "Indiquez la date de disponibilit√©."; return; }
  if (!document.getElementById("consent").checked) { submitMsg.textContent = "Le consentement est obligatoire."; return; }

  const fd = new FormData();
  fd.append("action", "submitForm");
  fd.append("email", (CURRENT_EMAIL || emailEl.value || "").trim().toLowerCase());
  fd.append("numType", numType);
  fd.append("adeliNum", adeliNum.value.trim());
  fd.append("siretNum", siretNum.value.trim());
  fd.append("nom", document.getElementById("nom").value.trim());
  fd.append("prenom", document.getElementById("prenom").value.trim());
  fd.append("phone", document.getElementById("phone").value.trim());
  fd.append("profession", document.getElementById("profession").value);
  fd.append("publics", Array.from(document.querySelectorAll('input[name="public"]:checked')).map(i=>i.value).join(","));
  fd.append("modes", Array.from(document.querySelectorAll('input[name="mode"]:checked')).map(i=>i.value).join(","));
  fd.append("visio", document.querySelector('input[name="visio"]:checked').value);
  fd.append("departement", departSelect.value);
  fd.append("commune", communeSelect.value);
  fd.append("rayon", document.getElementById("rayon").value);
  fd.append("dispo", document.querySelector('input[name="dispo"]:checked').value);
  fd.append("dateDispo", dateInput.value);
  fd.append("consent", document.getElementById("consent").checked ? "oui" : "non");

  submitMsg.textContent = "Envoi en cours...";
  try {
    const res = await fetch(SCRIPT_URL, { method: "POST", body: fd });
    const j = await res.json();
    if (j.ok) {
      submitMsg.textContent = "‚úÖ Formulaire envoy√© !";
    } else {
      submitMsg.textContent = "‚ùå Erreur : " + (j.error || "erreur inconnue");
    }
  } catch (err) {
    submitMsg.textContent = "‚ùå Erreur r√©seau lors de l'envoi.";
  }
});

/* ========== RESET ========== */
resetBtn.addEventListener('click', () => {
  formEl.reset();
  document.getElementById("consent").checked = false;
  rest.classList.add("hidden");
  adeliBlock.classList.add("hidden");
  siretBlock.classList.add("hidden");
  noNum.classList.add("hidden");
  submitMsg.textContent = "";
});

</script>
</body>
</html>
